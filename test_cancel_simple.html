<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –æ—Ç–º–µ–Ω—ã –∞–Ω–∞–ª–∏–∑–∞ - –ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            padding: 12px 24px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .variables {
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .variable {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .variable:last-child {
            border-bottom: none;
        }
        
        .variable-name {
            font-weight: bold;
        }
        
        .variable-value {
            font-family: monospace;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç –æ—Ç–º–µ–Ω—ã –∞–Ω–∞–ª–∏–∑–∞ - –ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è</h1>
        
        <div class="status info">
            <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–º–æ–∂–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å –æ—Ç–º–µ–Ω–æ–π –∞–Ω–∞–ª–∏–∑–∞
        </div>
        
        <!-- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è -->
        <div class="variables">
            <h3>üìä –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:</h3>
            <div class="variable">
                <span class="variable-name">currentTaskId:</span>
                <span class="variable-value" id="currentTaskId-value">–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ</span>
            </div>
            <div class="variable">
                <span class="variable-name">currentUploadXHR:</span>
                <span class="variable-value" id="currentUploadXHR-value">–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ</span>
            </div>
            <div class="variable">
                <span class="variable-name">analysisStatusInterval:</span>
                <span class="variable-value" id="analysisStatusInterval-value">–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ</span>
            </div>
            <div class="variable">
                <span class="variable-name">localStorage.currentTaskId:</span>
                <span class="variable-value" id="localStorage-value">–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ</span>
            </div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div>
            <button class="btn btn-primary" onclick="checkVariables()">
                üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            </button>
            <button class="btn btn-warning" onclick="simulateTaskId()">
                üéØ –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å taskId
            </button>
            <button class="btn btn-danger" onclick="testCancel()">
                ‚èπÔ∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–º–µ–Ω—É
            </button>
            <button class="btn btn-success" onclick="clearLog()">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥
            </button>
        </div>
        
        <!-- –õ–æ–≥ -->
        <div class="log" id="log">
            <div><strong>üìù –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</strong></div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#495057';
            entry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            updateVariablesDisplay();
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '<div><strong>üìù –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</strong></div>';
        }
        
        function updateVariablesDisplay() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –æ–∫–Ω–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            let currentTaskId = '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
            let currentUploadXHR = '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
            let analysisStatusInterval = '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
            let localStorageValue = '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
            
            try {
                if (window.parent && window.parent !== window) {
                    // –ï—Å–ª–∏ –º—ã –≤ iframe, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ –æ–∫–Ω–æ
                    currentTaskId = window.parent.currentTaskId || 'null';
                    currentUploadXHR = window.parent.currentUploadXHR ? '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : 'null';
                    analysisStatusInterval = window.parent.analysisStatusInterval ? '–∞–∫—Ç–∏–≤–µ–Ω' : 'null';
                } else {
                    // –ï—Å–ª–∏ –º—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –æ–∫–Ω–µ, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                    currentTaskId = typeof window.currentTaskId !== 'undefined' ? window.currentTaskId : '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
                    currentUploadXHR = typeof window.currentUploadXHR !== 'undefined' ? (window.currentUploadXHR ? '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : 'null') : '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
                    analysisStatusInterval = typeof window.analysisStatusInterval !== 'undefined' ? (window.analysisStatusInterval ? '–∞–∫—Ç–∏–≤–µ–Ω' : 'null') : '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
                }
                
                localStorageValue = localStorage.getItem('currentTaskId') || 'null';
            } catch (e) {
                log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: ' + e.message, 'error');
            }
            
            document.getElementById('currentTaskId-value').textContent = currentTaskId;
            document.getElementById('currentUploadXHR-value').textContent = currentUploadXHR;
            document.getElementById('analysisStatusInterval-value').textContent = analysisStatusInterval;
            document.getElementById('localStorage-value').textContent = localStorageValue;
        }
        
        function checkVariables() {
            log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ —Ç–µ–∫—É—â–µ–º –æ–∫–Ω–µ
                log('üìä –¢–µ–∫—É—â–µ–µ –æ–∫–Ω–æ:');
                log(`   currentTaskId: ${typeof currentTaskId !== 'undefined' ? currentTaskId : 'UNDEFINED'}`);
                log(`   currentUploadXHR: ${typeof currentUploadXHR !== 'undefined' ? !!currentUploadXHR : 'UNDEFINED'}`);
                log(`   analysisStatusInterval: ${typeof analysisStatusInterval !== 'undefined' ? !!analysisStatusInterval : 'UNDEFINED'}`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –æ–∫–Ω–µ
                if (window.parent && window.parent !== window) {
                    log('üìä –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ –æ–∫–Ω–æ:');
                    log(`   parent.currentTaskId: ${window.parent.currentTaskId || 'UNDEFINED'}`);
                    log(`   parent.currentUploadXHR: ${!!window.parent.currentUploadXHR || 'UNDEFINED'}`);
                    log(`   parent.analysisStatusInterval: ${!!window.parent.analysisStatusInterval || 'UNDEFINED'}`);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage
                const storedTaskId = localStorage.getItem('currentTaskId');
                log(`üìä localStorage: ${storedTaskId || 'EMPTY'}`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = document.getElementById('processing-modal') || (window.parent && window.parent.document.getElementById('processing-modal'));
                if (modal) {
                    log(`üìä –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: ${modal.classList.contains('active') ? '–ê–ö–¢–ò–í–ù–û' : '–ù–ï–ê–ö–¢–ò–í–ù–û'}`);
                } else {
                    log('üìä –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ù–ï –ù–ê–ô–î–ï–ù–û');
                }
                
                updateVariablesDisplay();
                
            } catch (e) {
                log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: ' + e.message, 'error');
            }
        }
        
        function simulateTaskId() {
            log('üéØ –°–∏–º—É–ª–∏—Ä—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É taskId...');
            
            const taskId = Math.floor(Math.random() * 1000) + 1;
            
            try {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤ —Ç–µ–∫—É—â–µ–º –æ–∫–Ω–µ
                window.currentTaskId = taskId;
                log(`‚úÖ currentTaskId —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${taskId}`);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                localStorage.setItem('currentTaskId', taskId);
                log(`‚úÖ currentTaskId —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage: ${taskId}`);
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ –æ–∫–Ω–æ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —Ç–∞–º
                if (window.parent && window.parent !== window) {
                    window.parent.currentTaskId = taskId;
                    log(`‚úÖ parent.currentTaskId —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${taskId}`);
                }
                
                updateVariablesDisplay();
                
            } catch (e) {
                log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–º—É–ª—è—Ü–∏–∏ taskId: ' + e.message, 'error');
            }
        }
        
        function testCancel() {
            log('‚èπÔ∏è –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–º–µ–Ω—É –∞–Ω–∞–ª–∏–∑–∞...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ cancelAnalysis
                let cancelFunction = null;
                
                if (typeof cancelAnalysis === 'function') {
                    cancelFunction = cancelAnalysis;
                    log('‚úÖ –§—É–Ω–∫—Ü–∏—è cancelAnalysis –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ç–µ–∫—É—â–µ–º –æ–∫–Ω–µ');
                } else if (window.parent && typeof window.parent.cancelAnalysis === 'function') {
                    cancelFunction = window.parent.cancelAnalysis;
                    log('‚úÖ –§—É–Ω–∫—Ü–∏—è cancelAnalysis –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –æ–∫–Ω–µ');
                } else {
                    log('‚ùå –§—É–Ω–∫—Ü–∏—è cancelAnalysis –ù–ï –ù–ê–ô–î–ï–ù–ê', 'error');
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
                    const cancelBtn = document.querySelector('button[onclick*="cancelAnalysis"]') || 
                                    (window.parent && window.parent.document.querySelector('button[onclick*="cancelAnalysis"]'));
                    
                    if (cancelBtn) {
                        log('üîç –ù–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã, –ø—ã—Ç–∞–µ–º—Å—è –∫–ª–∏–∫–Ω—É—Ç—å...');
                        cancelBtn.click();
                        return;
                    } else {
                        log('‚ùå –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                        return;
                    }
                }
                
                // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–º–µ–Ω—ã
                log('üîÑ –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é cancelAnalysis...');
                cancelFunction();
                log('‚úÖ –§—É–Ω–∫—Ü–∏—è cancelAnalysis –≤—ã–∑–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
                
            } catch (e) {
                log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–º–µ–Ω—ã: ' + e.message, 'error');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            log('üéØ –¢–µ—Å—Ç –æ—Ç–º–µ–Ω—ã –∞–Ω–∞–ª–∏–∑–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            checkVariables();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                updateVariablesDisplay();
            }, 5000);
        });
        
        // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'variableUpdate') {
                log(`üì° –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π: ${event.data.name} = ${event.data.value}`);
                updateVariablesDisplay();
            }
        });
    </script>
</body>
</html>