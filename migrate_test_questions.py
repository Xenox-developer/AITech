#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
"""

import sqlite3
import json
import os
import sys
from datetime import datetime

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –º–æ–¥—É–ª—è–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞
from dotenv import load_dotenv
load_dotenv()

def generate_test_questions(result_data):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞
        api_key = os.environ.get('OPENAI_API_KEY')
        if not api_key:
            print("‚ö†Ô∏è OpenAI API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã")
            return get_demo_questions()
        
        from openai import OpenAI
        client = OpenAI(api_key=api_key)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–∞
        full_text = result_data.get('full_text', '')
        summary = result_data.get('summary', '')
        topics_data = result_data.get('topics_data', {})
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
        context = f"""
        –†–µ–∑—é–º–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: {summary}
        
        –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç: {full_text[:3000]}...
        
        –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã: {json.dumps(topics_data, ensure_ascii=False)}
        """
        
        prompt = f"""
        –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —É—á–µ–±–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ —Å–æ–∑–¥–∞–π 25 —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ —Ä–∞–∑–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.
        
        –ú–∞—Ç–µ—Ä–∏–∞–ª:
        {context}
        
        –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –≤–æ–ø—Ä–æ—Å–∞–º:
        1. 8 –ª–µ–≥–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–±–∞–∑–æ–≤—ã–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏ —Ñ–∞–∫—Ç—ã)
        2. 12 —Å—Ä–µ–¥–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–ø–æ–Ω–∏–º–∞–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–π –∏ —Å–≤—è–∑–µ–π)
        3. 5 —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–∞–Ω–∞–ª–∏–∑ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π)
        
        –ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å:
        - –ß–µ—Ç–∫—É—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
        - 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞ (A, B, C, D)
        - –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        - –í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω—ã–º–∏
        
        –í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
        {{
            "questions": [
                {{
                    "id": 1,
                    "question": "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞",
                    "options": {{
                        "A": "–í–∞—Ä–∏–∞–Ω—Ç A",
                        "B": "–í–∞—Ä–∏–∞–Ω—Ç B", 
                        "C": "–í–∞—Ä–∏–∞–Ω—Ç C",
                        "D": "–í–∞—Ä–∏–∞–Ω—Ç D"
                    }},
                    "correct_answer": "A",
                    "explanation": "–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞",
                    "difficulty": 1,
                    "topic": "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã"
                }}
            ]
        }}
        
        –°–ª–æ–∂–Ω–æ—Å—Ç—å: 1 = –ª–µ–≥–∫–æ, 2 = —Å—Ä–µ–¥–Ω–µ, 3 = —Å–ª–æ–∂–Ω–æ
        """
        
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤. –°–æ–∑–¥–∞–≤–∞–π –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞–Ω–∏–π."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
            max_tokens=4000
        )
        
        # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
        response_text = response.choices[0].message.content
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
        import re
        json_match = re.search(r'\{.*\}', response_text, re.DOTALL)
        if json_match:
            json_text = json_match.group()
            try:
                questions_data = json.loads(json_text)
                return questions_data.get('questions', [])
            except json.JSONDecodeError as e:
                print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
                print(f"–ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å JSON...")
                
                # –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ JSON
                try:
                    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø—è—Ç—ã–µ –º–µ–∂–¥—É –æ–±—ä–µ–∫—Ç–∞–º–∏
                    fixed_json = re.sub(r'}\s*{', '},{', json_text)
                    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø—è—Ç—ã–µ –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫
                    fixed_json = re.sub(r'"\s*\n\s*"', '",\n"', fixed_json)
                    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø—è—Ç—ã–µ –ø–æ—Å–ª–µ —á–∏—Å–µ–ª
                    fixed_json = re.sub(r'(\d)\s*\n\s*"', r'\1,\n"', fixed_json)
                    
                    questions_data = json.loads(fixed_json)
                    print("‚úÖ JSON —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω")
                    return questions_data.get('questions', [])
                except json.JSONDecodeError:
                    print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã")
                    return get_demo_questions()
        else:
            print("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ GPT")
            print(f"–û—Ç–≤–µ—Ç GPT: {response_text[:500]}...")
            return get_demo_questions()
            
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤: {str(e)}")
        return get_demo_questions()

def get_demo_questions():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    return [
        {
            "id": 1,
            "question": "–ß—Ç–æ —Ç–∞–∫–æ–µ –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ?",
            "options": {
                "A": "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –º–∞—à–∏–Ω —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –æ–±—É—á–∞—Ç—å—Å—è –Ω–æ–≤—ã–º –¥–≤–∏–∂–µ–Ω–∏—è–º",
                "B": "–†–∞–∑–¥–µ–ª –ò–ò, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –∫–æ–º–ø—å—é—Ç–µ—Ä–∞–º –æ–±—É—á–∞—Ç—å—Å—è –Ω–∞ –¥–∞–Ω–Ω—ã—Ö",
                "C": "–ü—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è –ª—é–¥–µ–π —Ä–∞–±–æ—Ç–µ —Å –º–∞—à–∏–Ω–∞–º–∏",
                "D": "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è"
            },
            "correct_answer": "B",
            "explanation": "–ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ ‚Äî —ç—Ç–æ —Ä–∞–∑–¥–µ–ª –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä–∞–º –æ–±—É—á–∞—Ç—å—Å—è –∏ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ —è–≤–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è.",
            "difficulty": 1,
            "topic": "–û—Å–Ω–æ–≤—ã ML"
        },
        {
            "id": 2,
            "question": "–ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç?",
            "options": {
                "A": "–ë—ã—Å—Ç—Ä–æ–µ, –º–µ–¥–ª–µ–Ω–Ω–æ–µ –∏ —Å—Ä–µ–¥–Ω–µ–µ –æ–±—É—á–µ–Ω–∏–µ",
                "B": "–û–±—É—á–µ–Ω–∏–µ —Å —É—á–∏—Ç–µ–ª–µ–º, –±–µ–∑ —É—á–∏—Ç–µ–ª—è –∏ —Å –ø–æ–¥–∫—Ä–µ–ø–ª–µ–Ω–∏–µ–º",
                "C": "–õ–∏–Ω–µ–π–Ω–æ–µ, –Ω–µ–ª–∏–Ω–µ–π–Ω–æ–µ –∏ —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–µ –æ–±—É—á–µ–Ω–∏–µ",
                "D": "–ü—Ä–æ—Å—Ç–æ–µ, —Å–ª–æ–∂–Ω–æ–µ –∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ"
            },
            "correct_answer": "B",
            "explanation": "–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã: supervised learning (—Å —É—á–∏—Ç–µ–ª–µ–º), unsupervised learning (–±–µ–∑ —É—á–∏—Ç–µ–ª—è) –∏ reinforcement learning (—Å –ø–æ–¥–∫—Ä–µ–ø–ª–µ–Ω–∏–µ–º).",
            "difficulty": 2,
            "topic": "–¢–∏–ø—ã –æ–±—É—á–µ–Ω–∏—è"
        },
        {
            "id": 3,
            "question": "–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–∏ –º–æ–¥–µ–ª–∏?",
            "options": {
                "A": "–ú–æ–¥–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ",
                "B": "–ú–æ–¥–µ–ª—å –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç –º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏",
                "C": "–ú–æ–¥–µ–ª—å —Å–ª–∏—à–∫–æ–º —Ö–æ—Ä–æ—à–æ –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –æ–±—É—á–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ",
                "D": "–ú–æ–¥–µ–ª—å –æ–±—É—á–∞–µ—Ç—Å—è –¥–æ–ª—å—à–µ –æ–±—ã—á–Ω–æ–≥–æ"
            },
            "correct_answer": "C",
            "explanation": "–ü—Ä–∏ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–∏ –º–æ–¥–µ–ª—å —Å–ª–∏—à–∫–æ–º —Ö–æ—Ä–æ—à–æ –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –æ–±—É—á–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ, –≤–∫–ª—é—á–∞—è —à—É–º, —á—Ç–æ —É—Ö—É–¥—à–∞–µ—Ç –µ—ë —Ä–∞–±–æ—Ç—É –Ω–∞ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.",
            "difficulty": 2,
            "topic": "–ü—Ä–æ–±–ª–µ–º—ã –æ–±—É—á–µ–Ω–∏—è"
        },
        {
            "id": 4,
            "question": "–ß—Ç–æ —Ç–∞–∫–æ–µ –Ω–µ–π—Ä–æ–Ω–Ω–∞—è —Å–µ—Ç—å?",
            "options": {
                "A": "–°–µ—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö",
                "B": "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å, –∏–º–∏—Ç–∏—Ä—É—é—â–∞—è —Ä–∞–±–æ—Ç—É –Ω–µ–π—Ä–æ–Ω–æ–≤ –º–æ–∑–≥–∞",
                "C": "–ü—Ä–æ–≥—Ä–∞–º–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤",
                "D": "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
            },
            "correct_answer": "B",
            "explanation": "–ù–µ–π—Ä–æ–Ω–Ω–∞—è —Å–µ—Ç—å ‚Äî —ç—Ç–æ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –Ω–µ–π—Ä–æ–Ω–Ω—ã—Ö —Å–µ—Ç–µ–π.",
            "difficulty": 1,
            "topic": "–ù–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–µ—Ç–∏"
        },
        {
            "id": 5,
            "question": "–ß—Ç–æ —Ç–∞–∫–æ–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Å–ø—É—Å–∫?",
            "options": {
                "A": "–ú–µ—Ç–æ–¥ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π",
                "B": "–ê–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å",
                "C": "–°–ø–æ—Å–æ–± —Å–∂–∞—Ç–∏—è –¥–∞–Ω–Ω—ã—Ö",
                "D": "–¢–µ—Ö–Ω–∏–∫–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö"
            },
            "correct_answer": "B",
            "explanation": "–ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Å–ø—É—Å–∫ ‚Äî —ç—Ç–æ –∏—Ç–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å –ø—É—Ç–µ–º –¥–≤–∏–∂–µ–Ω–∏—è –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –Ω–∞–∏–±–æ–ª—å—à–µ–≥–æ —É–±—ã–≤–∞–Ω–∏—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞.",
            "difficulty": 2,
            "topic": "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è"
        }
    ]

def migrate_test_questions():
    """–ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤"""
    print("üîÑ –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤...")
    
    conn = sqlite3.connect('ai_study.db')
    c = conn.cursor()
    
    # –ù–∞—Ö–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–µ–∑ —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    c.execute('''
        SELECT id, filename, topics_json, summary, full_text
        FROM result 
        WHERE test_questions_json IS NULL OR test_questions_json = ''
    ''')
    
    results_to_migrate = c.fetchall()
    total_results = len(results_to_migrate)
    
    if total_results == 0:
        print("‚úÖ –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —É–∂–µ –∏–º–µ—é—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã")
        conn.close()
        return
    
    print(f"üìä –ù–∞–π–¥–µ–Ω–æ {total_results} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏")
    
    success_count = 0
    error_count = 0
    
    for i, (result_id, filename, topics_json, summary, full_text) in enumerate(results_to_migrate, 1):
        print(f"üîÑ [{i}/{total_results}] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º: {filename}")
        
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ
            print(f"   üìä ID: {result_id}, topics_json: {bool(topics_json)}, summary: {bool(summary)}, full_text: {bool(full_text)}")
            
            if topics_json:
                try:
                    topics_data = json.loads(topics_json)
                    print(f"   ‚úÖ Topics JSON —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω")
                except json.JSONDecodeError as e:
                    print(f"   ‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ topics_json: {e}")
                    topics_data = {}
            else:
                topics_data = {}
            
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
            result_data = {
                'full_text': full_text or '',
                'summary': summary or '',
                'topics_data': topics_data
            }
            
            print(f"   üìù –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: —Ç–µ–∫—Å—Ç={len(result_data['full_text'])} —Å–∏–º–≤–æ–ª–æ–≤, —Ä–µ–∑—é–º–µ={len(result_data['summary'])} —Å–∏–º–≤–æ–ª–æ–≤")
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã
            test_questions = generate_test_questions(result_data)
            
            if test_questions:
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                test_questions_json = json.dumps(test_questions, ensure_ascii=False)
                c.execute('UPDATE result SET test_questions_json = ? WHERE id = ?', 
                         (test_questions_json, result_id))
                
                print(f"‚úÖ [{i}/{total_results}] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(test_questions)} –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è {filename}")
                success_count += 1
            else:
                print(f"‚ùå [{i}/{total_results}] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è {filename}")
                error_count += 1
                
        except Exception as e:
            print(f"‚ùå [{i}/{total_results}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ {filename}: {str(e)}")
            error_count += 1
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    conn.commit()
    conn.close()
    
    print(f"\nüìà –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞:")
    print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {success_count}")
    print(f"‚ùå –û—à–∏–±–æ–∫: {error_count}")
    print(f"üìä –í—Å–µ–≥–æ: {total_results}")

if __name__ == '__main__':
    migrate_test_questions()