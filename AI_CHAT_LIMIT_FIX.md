# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ–º –ª–∏–º–∏—Ç–∞ AI —á–∞—Ç–∞

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø–ª–∞–Ω–æ–º STARTER –º–æ–≥–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –±–æ–ª—å—à–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ AI —á–∞—Ç, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ª–∏–º–∏—Ç. –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–æ—Å—å "7/5" —Å–æ–æ–±—â–µ–Ω–∏–π, —á—Ç–æ —É–∫–∞–∑—ã–≤–∞–ª–æ –Ω–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞, –Ω–æ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∞ —Ä–∞–∑—Ä–µ—à–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.

## üîç –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ –ø–æ—Ä—è–¥–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –ª–æ–≥–∏–∫–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–æ–≤:

### –ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
```python
@app.route('/api/chat/<int:result_id>', methods=['POST'])
@login_required
@require_subscription_limit('ai_chat')  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –î–û –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
@track_usage('ai_chat')                 # –ó–∞–ø–∏—Å—å –ü–û–°–õ–ï –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
def chat_with_lecture(result_id):
    # –õ–æ–≥–∏–∫–∞ —á–∞—Ç–∞
    pass
```

### –ü—Ä–æ–±–ª–µ–º—ã —Å—Ç–∞—Ä–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:
1. **–ì–æ–Ω–∫–∞ —É—Å–ª–æ–≤–∏–π**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∞ –¥–æ –∑–∞–ø–∏—Å–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å**: –ü—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö —Å—á–µ—Ç—á–∏–∫ –Ω–µ —É—Å–ø–µ–≤–∞–ª –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è
3. **–ü–æ—Ä—è–¥–æ–∫ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤**: `@track_usage` –≤—ã–ø–æ–ª–Ω—è–ª—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
```python
@app.route('/api/chat/<int:result_id>', methods=['POST'])
@login_required
def chat_with_lecture(result_id):
    """–ß–∞—Ç —Å ChatGPT –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –ª–µ–∫—Ü–∏–∏"""
    try:
        # 1. –ü–†–û–í–ï–†–Ø–ï–ú –õ–ò–ú–ò–¢ –ü–ï–†–ï–î –û–ë–†–ê–ë–û–¢–ö–û–ô
        allowed, message = subscription_manager.check_ai_chat_limit(current_user.id)
        if not allowed:
            return jsonify({
                "success": False, 
                "error": message, 
                "limit_exceeded": True,
                "upgrade_required": True
            }), 403
        
        # 2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å
        # ... –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç AI ...
        
        # 3. –ó–ê–ü–ò–°–´–í–ê–ï–ú –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –ü–û–°–õ–ï –£–°–ü–ï–®–ù–û–ì–û –û–¢–í–ï–¢–ê
        subscription_manager.record_usage(current_user.id, 'ai_chat', 1, f'chat_message_{result_id}')
        
        # 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        return jsonify({"success": True, "response": ai_response})
        
    except Exception as e:
        # –ü—Ä–∏ –æ—à–∏–±–∫–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ù–ï –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
        return jsonify({"success": False, "error": str(e)}), 500
```

## üîß –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. –§–∞–π–ª `app.py` - –º–∞—Ä—à—Ä—É—Ç `/api/chat/<int:result_id>`

**–£–±—Ä–∞–Ω–æ:**
- –î–µ–∫–æ—Ä–∞—Ç–æ—Ä `@require_subscription_limit('ai_chat')`
- –î–µ–∫–æ—Ä–∞—Ç–æ—Ä `@track_usage('ai_chat')`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
- –ó–∞–ø–∏—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç AI
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π JSON –æ—Ç–≤–µ—Ç —Å —Ñ–ª–∞–≥–∞–º–∏ `limit_exceeded` –∏ `upgrade_required`

### 2. –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–∞

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ü–ï–†–ï–î –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞
allowed, message = subscription_manager.check_ai_chat_limit(current_user.id)
if not allowed:
    return jsonify({
        "success": False, 
        "error": message, 
        "limit_exceeded": True,
        "upgrade_required": True
    }), 403
```

### 3. –ó–∞–ø–∏—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```python
# –ó–∞–ø–∏—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ü–û–°–õ–ï —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
ai_response = get_chat_response(user_message, full_text, result_data)
subscription_manager.record_usage(current_user.id, 'ai_chat', 1, f'chat_message_{result_id}')
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç `test_simple_ai_chat_limit.py` –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç:

```
üí¨ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏–º–∏—Ç–∞ AI —á–∞—Ç–∞:
‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ 1/5: —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ 2/5: —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ 3/5: —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ 4/5: —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ 5/5: —Ä–∞–∑—Ä–µ—à–µ–Ω–æ

üö´ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞:
‚úÖ 6-–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ
   –°–æ–æ–±—â–µ–Ω–∏–µ: –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ AI —á–∞—Ç–µ (5/–º–µ—Å—è—Ü)

üìä –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: 5
   –õ–∏–º–∏—Ç: 5
   –ü—Ä–µ–≤—ã—à–µ–Ω: True
```

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

1. **–¢–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞**: –õ–∏–º–∏—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
2. **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ—Ç–≤–µ—Ç–µ
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ò—Å–∫–ª—é—á–µ–Ω—ã –≥–æ–Ω–∫–∏ —É—Å–ª–æ–≤–∏–π –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
4. **–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ—Å—Ç—å**: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
5. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö AI –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –õ–∏–º–∏—Ç –≤ 5 —Å–æ–æ–±—â–µ–Ω–∏–π —Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è
- ‚úÖ 6-–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å –ø–ª–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏
- ‚úÖ –°—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ—á–Ω–æ

## üìã –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —Å–ø–∏—Å–æ–∫

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–ª–∞–Ω–æ–º STARTER
2. ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å 5 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ AI —á–∞—Ç (–¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏)
3. ‚úÖ –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å 6-–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å—á–µ—Ç—á–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 5/5
5. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
6. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∞

## üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã:
- API –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–µ–º –∂–µ (`POST /api/chat/<result_id>`)
- –§–æ—Ä–º–∞—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
- –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –ø–æ–ª—è –≤ –æ—Ç–≤–µ—Ç –æ–± –æ—à–∏–±–∫–µ
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ! üéâ