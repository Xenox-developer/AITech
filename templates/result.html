{% extends "base.html" %}

{% block title %}AI-–∫–æ–Ω—Å–ø–µ–∫—Ç Pro - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞{% endblock %}

{% block extra_styles %}
<style>
    .quality-badge {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: bold;
        color: white;
    }

    .quality-excellent {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .quality-good {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .quality-fair {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .topic-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }

    .topic-card:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .subtopic {
        padding: 8px 15px;
        background: #f8f9fa;
        border-left: 3px solid #dee2e6;
        margin: 5px 0 5px 20px;
        font-size: 0.9rem;
    }

    .concept-badge {
        display: inline-block;
        padding: 5px 12px;
        background: #e9ecef;
        border-radius: 15px;
        margin: 2px;
        font-size: 0.85rem;
    }

    .flashcard-advanced {
        border: none;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .flashcard-header {
        background: #f8f9fa;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .difficulty-1 {
        border-left: 5px solid #28a745;
    }

    .difficulty-2 {
        border-left: 5px solid #ffc107;
    }

    .difficulty-3 {
        border-left: 5px solid #dc3545;
    }

    .study-session {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
    }

    .mind-map-container {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        min-height: 400px;
        position: relative;
    }

    .mind-map-modern {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .mind-map-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .mind-map-svg-container {
        position: relative;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .mind-map-svg-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
            radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3), transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3), transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.3), transparent 50%);
        pointer-events: none;
        z-index: 1;
    }

    #mindMapSvg {
        position: relative;
        z-index: 2;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
    }

    /* Mind Map Node Styles */
    .mind-node {
        transition: all 0.3s ease;
    }

    .mind-node:hover {
        filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
    }

    .mind-node circle {
        transition: all 0.3s ease;
    }

    .mind-node text {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-weight: 500;
        pointer-events: none;
    }

    .mind-link {
        transition: all 0.3s ease;
    }

    .mind-link:hover {
        stroke-width: 4 !important;
        opacity: 1 !important;
    }

    /* Node Details Panel */
    #nodeDetailsPanel {
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            max-height: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            max-height: 1000px;
            transform: translateY(0);
        }
    }

    @keyframes slideUpHide {
        from {
            opacity: 1;
            max-height: 1000px;
            transform: translateY(0);
        }

        to {
            opacity: 0;
            max-height: 0;
            transform: translateY(-10px);
        }
    }

    #nodeDetailsPanel .card {
        border: none;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-radius: 15px;
    }

    #nodeDetailsPanel .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0 !important;
        border: none;
    }

    /* Loading Animation */
    #mindMapLoading {
        z-index: 10;
    }

    #mindMapLoading .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3em;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .mind-map-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .mind-map-controls .btn-group {
            width: 100%;
        }

        .mind-map-controls .btn-group .btn {
            flex: 1;
        }

        .mind-map-svg-container {
            margin: 0 -10px;
        }

        #mindMapSvg {
            width: 100%;
            height: 400px;
        }
    }

    .video-timeline {
        background: #343a40;
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
    }

    .key-moment {
        padding: 10px 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        margin-bottom: 10px;
        cursor: pointer;
    }

    .key-moment:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .progress-ring {
        transform: rotate(-90deg);
    }

    .nav-pills .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    /* Enhanced Summary Styles */
    .summary-modern {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .summary-header {
        border-bottom: 2px solid #f8f9fa;
        padding-bottom: 20px;
    }

    .summary-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .summary-content-enhanced {
        line-height: 1.8;
        font-size: 16px;
        color: #2c3e50;
    }

    .summary-content-enhanced h2 {
        color: #667eea;
        font-size: 1.5rem;
        font-weight: 600;
        margin: 25px 0 15px 0;
        padding-left: 15px;
        border-left: 4px solid #667eea;
        display: flex;
        align-items: center;
    }

    .summary-content-enhanced h3 {
        color: #4a5568;
        font-size: 1.25rem;
        font-weight: 500;
        margin: 20px 0 12px 0;
    }

    .summary-content-enhanced p {
        margin-bottom: 15px;
        text-align: justify;
    }

    .summary-content-enhanced ul {
        padding-left: 25px;
        margin-bottom: 20px;
    }

    .summary-content-enhanced li {
        margin-bottom: 8px;
        position: relative;
    }

    .summary-content-enhanced li::marker {
        color: #667eea;
        font-weight: bold;
    }

    .summary-content-enhanced strong {
        color: #2d3748;
        font-weight: 600;
    }

    .summary-content-enhanced .emoji-section {
        background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        border-left: 5px solid #667eea;
    }

    .summary-content-enhanced .key-point {
        background: #fff5f5;
        border: 1px solid #fed7d7;
        border-radius: 8px;
        padding: 12px 16px;
        margin: 10px 0;
        position: relative;
    }

    .summary-content-enhanced .key-point::before {
        content: "üí°";
        position: absolute;
        left: -10px;
        top: 50%;
        transform: translateY(-50%);
        background: white;
        padding: 4px;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .reading-progress {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
    }

    .summary-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 20px;
        color: white;
    }

    .stat-item {
        padding: 10px;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: white;
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .summary-compact .summary-content-enhanced {
        font-size: 14px;
        line-height: 1.6;
    }

    .summary-compact .summary-content-enhanced h2 {
        font-size: 1.2rem;
        margin: 15px 0 10px 0;
    }

    .summary-compact .summary-content-enhanced h3 {
        font-size: 1.1rem;
        margin: 12px 0 8px 0;
    }

    .summary-compact .emoji-section {
        padding: 15px;
        margin: 15px 0;
    }

    /* Enhanced Summary Section Styles */
    .summary-section {
        background: white;
        border-radius: 12px;
        margin: 20px 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .summary-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .section-header:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
    }

    .section-header.collapsed {
        background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
    }

    .section-icon {
        font-size: 1.5rem;
        margin-right: 12px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .section-header h2 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 600;
        color: white !important;
        border: none !important;
        padding: 0 !important;
    }

    .reading-time {
        opacity: 0.8;
        font-weight: 400;
        margin-left: 10px;
    }

    .section-content {
        padding: 20px;
        background: #fafbfc;
    }

    .concept-item {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }

    .concept-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .concept-title {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
        font-size: 1.1rem;
    }

    .concept-description {
        color: #4a5568;
        line-height: 1.6;
    }

    .bullet-item {
        display: flex;
        align-items: flex-start;
        margin: 8px 0;
        padding: 8px 0;
    }

    .bullet-icon {
        color: #667eea;
        font-weight: bold;
        margin-right: 10px;
        margin-top: 2px;
        flex-shrink: 0;
    }

    .highlight-text {
        background: linear-gradient(135deg, #fef5e7 0%, #fed7aa 100%);
        color: #92400e;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        border: 1px solid rgba(146, 64, 14, 0.2);
    }

    .summary-paragraph {
        margin-bottom: 15px;
        line-height: 1.7;
        color: #2d3748;
    }

    /* Different colors for different section types */
    .main-idea .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .key-concepts .section-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .relationships .section-header {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .practical .section-header {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #2d3748 !important;
    }

    .practical .section-header h2 {
        color: #2d3748 !important;
    }

    .critical-facts .section-header {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        color: #2d3748 !important;
    }

    .critical-facts .section-header h2 {
        color: #2d3748 !important;
    }

    .formulas .section-header {
        background: linear-gradient(135deg, #a8caba 0%, #5d4e75 100%);
    }

    .results .section-header {
        background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
        color: #2d3748 !important;
    }

    .results .section-header h2 {
        color: #2d3748 !important;
    }

    /* Responsive Design for Summary */
    @media (max-width: 768px) {
        .summary-actions {
            justify-content: center;
            width: 100%;
        }

        .summary-actions .btn {
            flex: 1;
            min-width: 0;
        }

        .summary-stats .row {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
        }

        .section-header {
            padding: 12px 15px;
        }

        .section-header h2 {
            font-size: 1.1rem;
        }

        .section-content {
            padding: 15px;
        }

        .concept-item {
            padding: 12px;
        }
    }

    /* Enhanced Study Plan Styles */
    .study-plan-modern {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
    }

    .study-plan-header {
        border-bottom: 3px solid #f8f9fa;
        padding-bottom: 25px;
    }

    .study-stats .stat-item {
        text-align: center;
        padding: 15px;
    }

    .study-stats .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #667eea;
        display: block;
    }

    .study-stats .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Material Analysis Cards */
    .material-analysis {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 25px;
    }

    .analysis-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease;
    }

    .analysis-card:hover {
        transform: translateY(-5px);
    }

    .analysis-icon {
        font-size: 2rem;
        margin-bottom: 10px;
    }

    .analysis-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
    }

    .analysis-value {
        font-size: 1.1rem;
        font-weight: bold;
    }

    /* Learning Path Timeline */
    .learning-path {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
    }

    .path-timeline {
        display: flex;
        overflow-x: auto;
        padding: 20px 0;
        gap: 20px;
    }

    .timeline-item {
        min-width: 120px;
        text-align: center;
        position: relative;
    }

    .timeline-item:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 25px;
        right: -20px;
        width: 20px;
        height: 2px;
        background: #dee2e6;
    }

    .timeline-marker {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .timeline-number {
        color: white;
        font-weight: bold;
        font-size: 1.1rem;
    }

    .timeline-content {
        font-size: 0.9rem;
    }

    .timeline-phase {
        font-weight: 600;
        color: #495057;
    }

    .timeline-date {
        color: #6c757d;
        font-size: 0.8rem;
    }

    /* Enhanced Session Cards */
    .sessions-container {
        /* Removed max-height to allow full page display */
        overflow-y: visible;
        padding-right: 10px;
    }

    .session-card.enhanced {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .session-card.enhanced:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    .session-header {
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .session-info {
        flex-grow: 1;
    }

    .session-title h6 {
        margin-bottom: 5px;
        color: #2d3748;
        font-weight: 600;
    }

    .session-phase {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .phase-foundation {
        background: #d4edda;
        color: #155724;
    }

    .phase-development {
        background: #d1ecf1;
        color: #0c5460;
    }

    .phase-mastery {
        background: #f8d7da;
        color: #721c24;
    }

    .session-meta {
        display: flex;
        gap: 15px;
        margin-top: 8px;
        font-size: 0.85rem;
        color: #6c757d;
    }

    .session-meta span {
        display: flex;
        align-items: center;
    }

    .session-difficulty {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
    }

    .difficulty-basic {
        background: #d4edda;
        color: #155724;
    }

    .difficulty-intermediate {
        background: #fff3cd;
        color: #856404;
    }

    .difficulty-advanced {
        background: #f8d7da;
        color: #721c24;
    }

    .session-actions {
        display: flex;
        gap: 10px;
    }

    .session-details {
        padding: 25px;
        background: #fafbfc;
        border-top: 1px solid #e9ecef;
        transition: all 0.4s ease;
    }

    .session-card.expanded {
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        transform: translateY(-5px);
    }

    .session-card.expanded .session-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .session-card.expanded .session-title h6,
    .session-card.expanded .session-meta {
        color: white;
    }

    .session-card.expanded .session-phase {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    .session-card.expanded .session-difficulty {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    /* Activities Timeline */
    .activities-timeline {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .activity-item {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        padding: 15px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .activity-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .activity-content {
        flex-grow: 1;
    }

    .activity-name {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 4px;
    }

    .activity-duration {
        font-size: 0.8rem;
        color: #667eea;
        font-weight: 500;
        margin-bottom: 6px;
    }

    .activity-description {
        font-size: 0.9rem;
        color: #6c757d;
        line-height: 1.4;
    }

    /* Objectives and Exercises */
    .objectives-list {
        list-style: none;
        padding: 0;
    }

    .objectives-list li {
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
        position: relative;
        padding-left: 25px;
    }

    .objectives-list li:before {
        content: "üéØ";
        position: absolute;
        left: 0;
        top: 8px;
    }

    .exercises-grid {
        display: grid;
        gap: 12px;
    }

    .exercise-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .exercise-check {
        color: #28a745;
        margin-top: 2px;
        flex-shrink: 0;
    }

    .success-criteria {
        display: grid;
        gap: 10px;
    }

    .criterion-item {
        padding: 10px 15px;
        background: #fff5f5;
        border-radius: 8px;
        border-left: 4px solid #ffc107;
        font-size: 0.9rem;
    }

    /* Study Sidebar */
    .study-sidebar {
        position: sticky;
        top: 20px;
    }

    .milestones-card,
    .success-metrics-card,
    .repetition-schedule-card,
    .completion-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .milestones-card .card-title,
    .success-metrics-card .card-title,
    .repetition-schedule-card .card-title,
    .completion-card .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }

    /* Milestone Items */
    .milestone-item {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        padding: 15px 0;
        border-bottom: 1px solid #f1f3f4;
    }

    .milestone-item:last-child {
        border-bottom: none;
    }

    .milestone-progress {
        flex-shrink: 0;
    }

    .progress-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: conic-gradient(#667eea 0deg, #667eea calc(var(--progress, 0) * 3.6deg), #e9ecef calc(var(--progress, 0) * 3.6deg));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
        color: #667eea;
    }

    .milestone-content h6 {
        margin-bottom: 5px;
        color: #2d3748;
    }

    .milestone-content p {
        margin-bottom: 5px;
        font-size: 0.9rem;
        color: #6c757d;
    }

    /* Success Metrics */
    .metrics-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .metric-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .metric-label {
        font-size: 0.9rem;
        color: #495057;
    }

    .metric-value {
        font-weight: 600;
        color: #667eea;
    }

    /* Repetition Schedule */
    .repetition-intervals {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .interval-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    /* Completion Card */
    .completion-date {
        font-size: 1.1rem;
        font-weight: 600;
        color: #28a745;
        margin-bottom: 15px;
    }

    .adaptive-features h6 {
        font-size: 0.9rem;
        color: #495057;
        margin-bottom: 10px;
    }

    .feature-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .feature-list li {
        padding: 5px 0;
        font-size: 0.85rem;
        color: #6c757d;
    }

    /* Responsive Design for Study Plan */
    @media (max-width: 768px) {
        .study-plan-modern {
            padding: 20px;
        }

        .path-timeline {
            justify-content: flex-start;
        }

        .timeline-item {
            min-width: 100px;
        }

        .session-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .session-actions {
            width: 100%;
            justify-content: space-between;
        }

        .session-meta {
            flex-direction: column;
            gap: 8px;
        }

        .activities-timeline {
            gap: 10px;
        }

        .activity-item {
            padding: 12px;
        }

        .exercises-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Enhanced Math Support Styles - Beautiful Typography */
    .math-formula {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: 2px solid #e3f2fd;
        border-radius: 15px;
        padding: 25px 30px;
        margin: 20px 0;
        font-family: 'Cambria', 'Times New Roman', serif;
        font-size: 1.4em;
        text-align: center;
        position: relative;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        border-left: 6px solid #667eea;
        line-height: 1.6;
        color: #2c3e50;
        transition: all 0.3s ease;
    }

    .math-formula:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
    }

    .math-formula::before {
        content: "üìê";
        position: absolute;
        top: 12px;
        right: 18px;
        font-size: 1.4rem;
        opacity: 0.7;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    .math-inline {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        padding: 4px 10px;
        border-radius: 8px;
        font-family: 'Cambria', 'Times New Roman', serif;
        color: #1565c0;
        font-weight: 600;
        margin: 0 4px;
        display: inline-block;
        transition: all 0.3s ease;
        border: 1px solid rgba(21, 101, 192, 0.2);
        font-size: 1.05em;
    }

    .math-inline:hover {
        background: linear-gradient(135deg, #bbdefb 0%, #e1bee7 100%);
        transform: scale(1.08);
        box-shadow: 0 4px 12px rgba(21, 101, 192, 0.3);
        border-color: #1565c0;
    }

    .math-symbol {
        font-family: 'Cambria', 'Times New Roman', serif;
        font-size: 1.3em;
        color: #667eea;
        font-weight: 700;
        background: linear-gradient(135deg, #e8eaf6 0%, #f3e5f5 100%);
        padding: 3px 8px;
        border-radius: 6px;
        margin: 0 3px;
        display: inline-block;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.2);
        transition: all 0.2s ease;
    }

    .math-symbol:hover {
        transform: scale(1.1);
        background: linear-gradient(135deg, #c5cae9 0%, #e1bee7 100%);
    }

    .math-fraction {
        font-family: 'Cambria', 'Times New Roman', serif;
        color: #667eea;
        font-weight: 600;
        background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%);
        padding: 6px 12px;
        border-radius: 8px;
        margin: 0 4px;
        display: inline-block;
        position: relative;
        border: 1px solid rgba(156, 39, 176, 0.2);
        font-size: 1.1em;
    }

    /* Beautiful fraction display */
    .math-frac {
        display: inline-block;
        vertical-align: middle;
        text-align: center;
        margin: 0 6px;
        position: relative;
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 152, 0, 0.3);
    }

    .math-frac .numerator {
        display: block;
        font-size: 0.9em;
        padding-bottom: 3px;
        border-bottom: 2px solid #667eea;
        margin-bottom: 3px;
        color: #2c3e50;
        font-weight: 700;
    }

    .math-frac .denominator {
        display: block;
        font-size: 0.9em;
        padding-top: 3px;
        color: #2c3e50;
        font-weight: 700;
    }

    /* Superscript and subscript styling */
    .math-sup {
        font-size: 0.7em;
        vertical-align: super;
        color: #e91e63;
        font-weight: 700;
        margin-left: 1px;
        background: rgba(233, 30, 99, 0.1);
        padding: 1px 3px;
        border-radius: 3px;
    }

    .math-sub {
        font-size: 0.7em;
        vertical-align: sub;
        color: #3f51b5;
        font-weight: 700;
        margin-left: 1px;
        background: rgba(63, 81, 181, 0.1);
        padding: 1px 3px;
        border-radius: 3px;
    }

    /* Parentheses styling */
    .math-paren {
        font-size: 1.3em;
        color: #795548;
        font-weight: 600;
        margin: 0 2px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Function names styling */
    .math-func {
        font-family: 'Cambria', serif;
        color: #4caf50;
        font-weight: 700;
        font-style: italic;
        margin-right: 2px;
        background: rgba(76, 175, 80, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
    }

    .math-toolbar {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 15px;
        border: 1px solid #dee2e6;
    }

    .math-toolbar .alert {
        margin-bottom: 0;
        border: none;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
    }

    /* MathJax Override Styles */
    mjx-container[jax="CHTML"][display="true"] {
        margin: 1.5em 0 !important;
        padding: 20px !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        border-radius: 12px !important;
        border-left: 5px solid #667eea !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
        position: relative !important;
    }

    mjx-container[jax="CHTML"][display="true"]::before {
        content: "üìê";
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        opacity: 0.6;
    }

    mjx-container[jax="CHTML"] {
        color: #2c3e50 !important;
        font-size: 1.1em !important;
    }

    mjx-container[jax="CHTML"]:not([display="true"]) {
        background: #e3f2fd !important;
        padding: 3px 8px !important;
        border-radius: 6px !important;
        margin: 0 3px !important;
        display: inline-block !important;
        color: #1565c0 !important;
        font-weight: 500 !important;
        transition: all 0.2s ease !important;
    }

    mjx-container[jax="CHTML"]:not([display="true"]):hover {
        background: #bbdefb !important;
        transform: scale(1.05) !important;
        box-shadow: 0 2px 8px rgba(21, 101, 192, 0.2) !important;
    }

    /* Math in different contexts */
    .summary-content-enhanced mjx-container[jax="CHTML"][display="true"] {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%) !important;
        border-left-color: #ff9800 !important;
    }

    .flashcard-advanced mjx-container[jax="CHTML"][display="true"] {
        background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%) !important;
        border-left-color: #9c27b0 !important;
    }

    .accordion-body mjx-container[jax="CHTML"][display="true"] {
        background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%) !important;
        border-left-color: #4caf50 !important;
    }

    /* Math processing indicators */
    .math-processing {
        position: relative;
    }

    .math-processing::after {
        content: "‚ö° –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—É–ª...";
        position: absolute;
        top: 0;
        right: 0;
        background: #667eea;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    .math-processed {
        position: relative;
    }

    .math-processed::after {
        content: "‚úì";
        position: absolute;
        top: -5px;
        right: -5px;
        background: #28a745;
        color: white;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        animation: fadeInOut 2s ease-in-out;
    }

    @keyframes fadeInOut {

        0%,
        100% {
            opacity: 0;
        }

        20%,
        80% {
            opacity: 1;
        }
    }

    /* Math toolbar responsive */
    @media (max-width: 768px) {
        .math-toolbar .row {
            flex-direction: column;
        }

        .math-toolbar .col-md-6 {
            margin-bottom: 10px;
        }

        mjx-container[jax="CHTML"][display="true"] {
            padding: 15px !important;
            margin: 1em 0 !important;
        }

        mjx-container[jax="CHTML"]:not([display="true"]) {
            font-size: 0.9em !important;
            padding: 2px 6px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Header with Quality Score -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-success mb-2">
                <i class="fas fa-check-circle me-2"></i>–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!
            </h2>
            <p class="text-muted mb-0">
                <i class="fas fa-file me-2"></i>{{ filename }}
                {% if file_type == '.mp4' or file_type == '.mov' or file_type == '.mkv' %}
                <span class="badge bg-info ms-2">–í–∏–¥–µ–æ</span>
                {% else %}
                <span class="badge bg-danger ms-2">PDF</span>
                {% if page_info and page_info.page_range %}
                    <span class="badge bg-primary ms-1">
                        <i class="fas fa-file-alt me-1"></i>–°—Ç—Ä–∞–Ω–∏—Ü—ã: {{ page_info.page_range }}
                    </span>
                {% endif %}
                {% endif %}
            </p>
        </div>
        <div class="text-center">
            <div
                class="quality-badge {% if quality_assessment.overall_score >= 0.8 %}quality-excellent{% elif quality_assessment.overall_score >= 0.6 %}quality-good{% else %}quality-fair{% endif %}">
                <i class="fas fa-star me-2"></i>
                –ö–∞—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–∞: {{ (quality_assessment.overall_score * 100)|round }}%
            </div>
            <div class="mt-2">
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-plus me-2"></i>–ù–æ–≤—ã–π —Ñ–∞–π–ª
                </a>
            </div>
        </div>
    </div>

    <!-- Quality Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <svg width="60" height="60">
                        <circle cx="30" cy="30" r="25" stroke="#e9ecef" stroke-width="5" fill="none"></circle>
                        <circle class="progress-ring" cx="30" cy="30" r="25" stroke="#667eea" stroke-width="5"
                            fill="none" stroke-dasharray="{{ quality_assessment.depth_score * 157 }} 157"></circle>
                    </svg>
                    <h6 class="mt-2 mb-0">–ì–ª—É–±–∏–Ω–∞</h6>
                    <small class="text-muted">{{ (quality_assessment.depth_score * 100)|round }}%</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <svg width="60" height="60">
                        <circle cx="30" cy="30" r="25" stroke="#e9ecef" stroke-width="5" fill="none"></circle>
                        <circle class="progress-ring" cx="30" cy="30" r="25" stroke="#4facfe" stroke-width="5"
                            fill="none" stroke-dasharray="{{ quality_assessment.coverage_score * 157 }} 157"></circle>
                    </svg>
                    <h6 class="mt-2 mb-0">–û—Ö–≤–∞—Ç</h6>
                    <small class="text-muted">{{ (quality_assessment.coverage_score * 100)|round }}%</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <svg width="60" height="60">
                        <circle cx="30" cy="30" r="25" stroke="#e9ecef" stroke-width="5" fill="none"></circle>
                        <circle class="progress-ring" cx="30" cy="30" r="25" stroke="#fa709a" stroke-width="5"
                            fill="none" stroke-dasharray="{{ quality_assessment.practical_score * 157 }} 157"></circle>
                    </svg>
                    <h6 class="mt-2 mb-0">–ü—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å</h6>
                    <small class="text-muted">{{ (quality_assessment.practical_score * 100)|round }}%</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <svg width="60" height="60">
                        <circle cx="30" cy="30" r="25" stroke="#e9ecef" stroke-width="5" fill="none"></circle>
                        <circle class="progress-ring" cx="30" cy="30" r="25" stroke="#00f2fe" stroke-width="5"
                            fill="none" stroke-dasharray="{{ quality_assessment.clarity_score * 157 }} 157"></circle>
                    </svg>
                    <h6 class="mt-2 mb-0">–Ø—Å–Ω–æ—Å—Ç—å</h6>
                    <small class="text-muted">{{ (quality_assessment.clarity_score * 100)|round }}%</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-pills mb-4" id="resultTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="topics-tab" data-bs-toggle="tab" data-bs-target="#topics" type="button">
                <i class="fas fa-sitemap me-2"></i>–¢–µ–º—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button">
                <i class="fas fa-file-text me-2"></i>–†–µ–∑—é–º–µ
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="flashcards-tab" data-bs-toggle="tab" data-bs-target="#flashcards"
                type="button">
                <i class="fas fa-layer-group me-2"></i>–§–ª–µ—à-–∫–∞—Ä—Ç—ã
                <span class="badge bg-danger ms-1">{{ flashcards|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="mindmap-tab" data-bs-toggle="tab" data-bs-target="#mindmap" type="button">
                <i class="fas fa-project-diagram me-2"></i>Mind Map
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="studyplan-tab" data-bs-toggle="tab" data-bs-target="#studyplan" type="button">
                <i class="fas fa-calendar-check me-2"></i>–ü–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è
            </button>
        </li>
        {% if key_moments %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="video-tab" data-bs-toggle="tab" data-bs-target="#video" type="button">
                <i class="fas fa-video me-2"></i>–í–∏–¥–µ–æ
            </button>
        </li>
        {% endif %}
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="resultTabContent">
        <!-- Topics Tab -->
        <div class="tab-pane fade show active" id="topics" role="tabpanel">
            <h4 class="mb-3">
                <i class="fas fa-sitemap me-2"></i>–ò–µ—Ä–∞—Ä—Ö–∏—è —Ç–µ–º
                <small class="text-muted">({{ topics_data.main_topics|length }} –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–µ–º)</small>
            </h4>

            {% for topic in topics_data.main_topics %}
            <div class="topic-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h5 class="mb-2">
                            <i class="fas fa-lightbulb text-warning me-2"></i>
                            {{ topic.title }}
                        </h5>
                        <p class="text-muted mb-3">{{ topic.summary }}</p>

                        {% if topic.subtopics %}
                        <h6 class="text-secondary mb-2">–ü–æ–¥—Ç–µ–º—ã:</h6>
                        {% for subtopic in topic.subtopics %}
                        <div class="subtopic">{{ subtopic }}</div>
                        {% endfor %}
                        {% endif %}

                        {% if topic.key_concepts %}
                        <h6 class="text-secondary mb-2 mt-3">–ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏:</h6>
                        <div>
                            {% for concept in topic.key_concepts %}
                            <span class="concept-badge">{{ concept }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {% if topic.examples %}
                        <h6 class="text-secondary mb-2 mt-3">–ü—Ä–∏–º–µ—Ä—ã:</h6>
                        <ul class="mb-0">
                            {% for example in topic.examples %}
                            <li class="text-muted">{{ example }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    <div>
                        <span
                            class="badge bg-{% if topic.complexity == 'advanced' %}danger{% elif topic.complexity == 'intermediate' %}warning{% else %}success{% endif %}">
                            {{ topic.complexity }}
                        </span>
                    </div>
                </div>
            </div>
            {% endfor %}

            {% if topics_data.concept_map.relationships %}
            <h5 class="mt-4 mb-3"><i class="fas fa-link me-2"></i>–°–≤—è–∑–∏ –º–µ–∂–¥—É —Ç–µ–º–∞–º–∏</h5>
            <div class="card">
                <div class="card-body">
                    {% for rel in topics_data.concept_map.relationships %}
                    <p class="mb-2">
                        <span class="badge bg-secondary">{{ rel.from[:30] }}</span>
                        <i class="fas fa-arrow-right mx-2 text-muted"></i>
                        <span class="badge bg-primary">{{ rel.type }}</span>
                        <i class="fas fa-arrow-right mx-2 text-muted"></i>
                        <span class="badge bg-secondary">{{ rel.to[:30] }}</span>
                    </p>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Summary Tab -->
        <div class="tab-pane fade" id="summary" role="tabpanel">
            <div class="summary-modern">
                <div class="summary-header mb-4">
                    <h4 class="mb-2">
                        <i class="fas fa-file-text text-primary me-2"></i>
                        –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ–∑—é–º–µ
                    </h4>
                    <div class="summary-actions">
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="toggleSummaryView()">
                            <i class="fas fa-eye me-1"></i>
                            <span id="viewToggleText">–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥</span>
                        </button>
                        <button class="btn btn-outline-success btn-sm me-2" onclick="copySummary()">
                            <i class="fas fa-copy me-1"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="printSummary()">
                            <i class="fas fa-print me-1"></i>–ü–µ—á–∞—Ç—å
                        </button>
                    </div>
                </div>

                <div class="summary-content-enhanced" id="summaryContent">
                    <!-- Content will be populated by JavaScript -->
                </div>

                <!-- Reading Progress -->
                <div class="reading-progress mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">–ü—Ä–æ–≥—Ä–µ—Å—Å —á—Ç–µ–Ω–∏—è</small>
                        <small class="text-muted" id="readingProgress">0%</small>
                    </div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-gradient-primary" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Summary Stats -->
                <div class="summary-stats mt-4">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number" id="wordCount">-</div>
                                <div class="stat-label">–°–ª–æ–≤</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number" id="readingTime">-</div>
                                <div class="stat-label">–ú–∏–Ω. —á—Ç–µ–Ω–∏—è</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number" id="sectionCount">-</div>
                                <div class="stat-label">–†–∞–∑–¥–µ–ª–æ–≤</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number" id="keyPoints">-</div>
                                <div class="stat-label">–ö–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Flashcards Tab -->
        <div class="tab-pane fade" id="flashcards" role="tabpanel">
            <!-- Header with Statistics -->
            <div class="flashcards-header mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>
                        <i class="fas fa-layer-group me-2"></i>–£–º–Ω—ã–µ —Ñ–ª–µ—à-–∫–∞—Ä—Ç—ã
                        <small class="text-muted">({{ flashcards|length }} –∫–∞—Ä—Ç)</small>
                    </h4>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm" onclick="startInteractiveStudy()">
                            <i class="fas fa-play me-1"></i>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ
                        </button>
                        <button class="btn btn-info btn-sm" onclick="startQuizMode()">
                            <i class="fas fa-question-circle me-1"></i>–†–µ–∂–∏–º —Ç–µ—Å—Ç–∞
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="showCreateCardModal()">
                            <i class="fas fa-plus me-1"></i>–°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç—É
                        </button>
                        <a href="{{ url_for('download_flashcards', result_id=result_id) }}"
                            class="btn btn-success btn-sm">
                            <i class="fas fa-download me-1"></i>–≠–∫—Å–ø–æ—Ä—Ç
                        </a>
                    </div>
                </div>

                <!-- Progress Statistics -->
                <div class="flashcards-stats mb-3">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card text-center p-3 bg-success text-white rounded">
                                <div class="stat-number" id="masteredCount">0</div>
                                <div class="stat-label">–ò–∑—É—á–µ–Ω–æ</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center p-3 bg-warning text-white rounded">
                                <div class="stat-number" id="reviewCount">0</div>
                                <div class="stat-label">–ù–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center p-3 bg-info text-white rounded">
                                <div class="stat-number" id="newCount">{{ flashcards|length }}</div>
                                <div class="stat-label">–ù–æ–≤—ã–µ</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center p-3 bg-primary text-white rounded">
                                <div class="stat-number" id="progressPercent">0%</div>
                                <div class="stat-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Controls -->
            <div class="flashcards-controls mb-4">
                <div class="row">
                    <div class="col-md-8">
                        <!-- Search and Filters -->
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                            <!-- Search -->
                            <div class="input-group" style="width: 250px;">
                                <input type="text" class="form-control form-control-sm" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ä—Ç–∞–º..."
                                    id="flashcardSearch">
                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                    onclick="searchFlashcards()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>

                            <!-- Type Filters -->
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-secondary active" onclick="filterCards('all')"
                                    data-filter="all">–í—Å–µ</button>
                                <button class="btn btn-outline-success" onclick="filterCards('definition')"
                                    data-filter="definition">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è</button>
                                <button class="btn btn-outline-info" onclick="filterCards('concept')"
                                    data-filter="concept">–ö–æ–Ω—Ü–µ–ø—Ü–∏–∏</button>
                                <button class="btn btn-outline-warning" onclick="filterCards('application')"
                                    data-filter="application">–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ</button>
                                <button class="btn btn-outline-danger" onclick="filterCards('comparison')"
                                    data-filter="comparison">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</button>
                                <button class="btn btn-outline-primary" onclick="filterCards('problem')"
                                    data-filter="problem">–ó–∞–¥–∞—á–∏</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- View Controls -->
                        <div class="d-flex gap-2 justify-content-end">
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-secondary" onclick="sortCards('difficulty')">
                                    <i class="fas fa-sort-amount-up me-1"></i>–ü–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                                </button>
                                <button class="btn btn-outline-secondary" onclick="sortCards('type')">
                                    <i class="fas fa-tags me-1"></i>–ü–æ —Ç–∏–ø—É
                                </button>
                                <button class="btn btn-outline-secondary" onclick="sortCards('progress')">
                                    <i class="fas fa-chart-line me-1"></i>–ü–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É
                                </button>
                            </div>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-success" onclick="expandAll()">
                                    <i class="fas fa-expand me-1"></i>–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å
                                </button>
                                <button class="btn btn-outline-warning" onclick="collapseAll()">
                                    <i class="fas fa-compress me-1"></i>–°–≤–µ—Ä–Ω—É—Ç—å
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Flashcards Container -->
            <div class="flashcards-container">
                <div class="accordion" id="flashcardsAccordion">
                    {% for card in flashcards %}
                    <div class="accordion-item flashcard-advanced difficulty-{{ card.difficulty }}"
                        id="flashcard-{{ loop.index0 }}"
                        data-type="{{ card.type }}" data-difficulty="{{ card.difficulty }}"
                        data-card-id="{{ loop.index0 }}"
                        data-card="{{ loop.index0 }}">
                        <div class="flashcard-header">
                            <div class="d-flex align-items-center flex-grow-1">
                                <button class="accordion-button collapsed p-0 bg-transparent border-0 text-start"
                                    type="button" data-bs-toggle="collapse" data-bs-target="#card{{ loop.index }}">
                                    <div class="flashcard-question-container">
                                        <div class="d-flex align-items-center mb-1">
                                            <i class="fas fa-question-circle text-primary me-2"></i>
                                            <span class="card-number text-muted me-2">#{{ loop.index }}</span>
                                            <span class="flashcard-question">{{ card.q }}</span>
                                        </div>
                                        {% if card.hint %}
                                        <small class="text-muted d-block">
                                            <i class="fas fa-lightbulb me-1"></i>–ü–æ–¥—Å–∫–∞–∑–∫–∞: {{ card.hint }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </button>
                            </div>
                            <div class="flashcard-meta d-flex align-items-center gap-2">
                                <span class="badge bg-secondary">{{ card.type }}</span>
                                <span
                                    class="badge bg-{% if card.difficulty == 3 %}danger{% elif card.difficulty == 2 %}warning{% else %}success{% endif %}">
                                    <i
                                        class="fas fa-{% if card.difficulty == 3 %}fire{% elif card.difficulty == 2 %}bolt{% else %}leaf{% endif %} me-1"></i>
                                    –£—Ä–æ–≤–µ–Ω—å {{ card.difficulty }}
                                </span>
                                <div class="flashcard-progress-indicator" data-card="{{ loop.index0 }}">
                                    <i class="fas fa-circle text-muted" title="–ù–µ –∏–∑—É—á–µ–Ω–æ"></i>
                                </div>
                            </div>
                        </div>
                        <div id="card{{ loop.index }}" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <!-- Answer Section -->
                                <div class="flashcard-answer mb-3">
                                    <h6 class="text-success mb-2">
                                        <i class="fas fa-check-circle me-2"></i>–û—Ç–≤–µ—Ç:
                                    </h6>
                                    <div class="answer-content p-3 bg-light rounded">
                                        {{ card.a }}
                                    </div>
                                </div>

                                <!-- Additional Information -->
                                {% if card.memory_hook %}
                                <div class="alert alert-info mb-3">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-brain me-2 mt-1"></i>
                                        <div>
                                            <strong>–ó–∞–ø–æ–º–∏–Ω–∞–ª–∫–∞:</strong>
                                            <p class="mb-0 mt-1">{{ card.memory_hook }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                {% if card.common_mistakes %}
                                <div class="alert alert-warning mb-3">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                                        <div>
                                            <strong>–ß–∞—Å—Ç–∞—è –æ—à–∏–±–∫–∞:</strong>
                                            <p class="mb-0 mt-1">{{ card.common_mistakes }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Related Topics -->
                                {% if card.related_topics %}
                                <div class="related-topics mb-3">
                                    <h6 class="text-secondary mb-2">
                                        <i class="fas fa-tags me-1"></i>–°–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ–º—ã:
                                    </h6>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% for topic in card.related_topics %}
                                        <span class="badge bg-light text-dark border">{{ topic }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Action Buttons -->
                                <div
                                    class="flashcard-actions d-flex justify-content-between align-items-center pt-3 border-top">
                                    <div class="confidence-buttons">
                                        <small class="text-muted me-2">–ù–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ –∑–Ω–∞–µ—Ç–µ?</small>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-danger"
                                                onclick="markCardReviewed('{{ result_id }}', '{{ loop.index0 }}', false, 1)">
                                                <i class="fas fa-times me-1"></i>–ù–µ –∑–Ω–∞—é
                                            </button>
                                            <button class="btn btn-outline-warning"
                                                onclick="markCardReviewed('{{ result_id }}', '{{ loop.index0 }}', true, 2)">
                                                <i class="fas fa-question me-1"></i>–ß–∞—Å—Ç–∏—á–Ω–æ
                                            </button>
                                            <button class="btn btn-outline-success"
                                                onclick="markCardReviewed('{{ result_id }}', '{{ loop.index0 }}', true, 3)">
                                                <i class="fas fa-check me-1"></i>–•–æ—Ä–æ—à–æ –∑–Ω–∞—é
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-tools">
                                        <button class="btn btn-sm btn-outline-primary"
                                            onclick="addToFavorites('{{ loop.index0 }}')" title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info"
                                            onclick="shareCard('{{ loop.index0 }}')" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                                            <i class="fas fa-share"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- No cards message -->
                <div id="noCardsMessage" class="text-center py-5" style="display: none;">
                    <i class="fas fa-search text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3">–ö–∞—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h5>
                    <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>
                </div>
            </div>

            <!-- Interactive Study Modal -->
            <div class="modal fade" id="interactiveStudyModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-play me-2"></i>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="studyModalBody">
                            <!-- Study content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Card Modal -->
            <div class="modal fade" id="createCardModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å —Ñ–ª–µ—à-–∫–∞—Ä—Ç—É
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="createCardForm">
                                <div class="mb-3">
                                    <label class="form-label">–í–æ–ø—Ä–æ—Å</label>
                                    <textarea class="form-control" id="newCardQuestion" rows="2" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">–û—Ç–≤–µ—Ç</label>
                                    <textarea class="form-control" id="newCardAnswer" rows="3" required></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">–¢–∏–ø</label>
                                        <select class="form-select" id="newCardType">
                                            <option value="definition">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</option>
                                            <option value="concept">–ö–æ–Ω—Ü–µ–ø—Ü–∏—è</option>
                                            <option value="application">–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ</option>
                                            <option value="comparison">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</option>
                                            <option value="problem">–ó–∞–¥–∞—á–∞</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                                        <select class="form-select" id="newCardDifficulty">
                                            <option value="1">–õ–µ–≥–∫–∞—è</option>
                                            <option value="2">–°—Ä–µ–¥–Ω—è—è</option>
                                            <option value="3">–°–ª–æ–∂–Ω–∞—è</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3 mt-3">
                                    <label class="form-label">–ü–æ–¥—Å–∫–∞–∑–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                    <input type="text" class="form-control" id="newCardHint">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                            <button type="button" class="btn btn-primary" onclick="createNewCard()">–°–æ–∑–¥–∞—Ç—å
                                –∫–∞—Ä—Ç—É</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mind Map Tab -->
        <div class="tab-pane fade" id="mindmap" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="fas fa-project-diagram me-2"></i>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞</h4>
                <div>
                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="resetMindMapView()">
                        <i class="fas fa-expand-arrows-alt me-1"></i>–°–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="downloadMindMap()">
                        <i class="fas fa-download me-1"></i>–°–∫–∞—á–∞—Ç—å PNG
                    </button>
                </div>
            </div>

            <div class="mind-map-modern" id="mindMapContainer">
                <!-- Enhanced Controls -->
                <div class="mind-map-controls mb-3">
                    <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
                        <!-- Layout Controls -->
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active"
                                onclick="setMindMapLayout('radial')">
                                <i class="fas fa-sun me-1"></i>–†–∞–¥–∏–∞–ª—å–Ω–∞—è
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="setMindMapLayout('tree')">
                                <i class="fas fa-sitemap me-1"></i>–î–µ—Ä–µ–≤–æ
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="setMindMapLayout('force')">
                                <i class="fas fa-project-diagram me-1"></i>–°–µ—Ç—å
                            </button>
                        </div>

                        <!-- Search -->
                        <div class="input-group input-group-sm" style="width: 200px;">
                            <input type="text" class="form-control" placeholder="–ü–æ–∏—Å–∫ —É–∑–ª–æ–≤..." id="mindMapSearch">
                            <button class="btn btn-outline-secondary" type="button" onclick="searchMindMapNodes()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>

                        <!-- Filter Controls -->
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-info active" onclick="filterNodes('all')"
                                data-filter="all">
                                <i class="fas fa-eye me-1"></i>–í—Å–µ
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="filterNodes('branch')"
                                data-filter="branch">
                                <i class="fas fa-sitemap me-1"></i>–í–µ—Ç–∫–∏
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="filterNodes('child')"
                                data-filter="child">
                                <i class="fas fa-leaf me-1"></i>–ü–æ–¥—Ç–µ–º—ã
                            </button>
                        </div>

                        <!-- Size Controls -->
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="adjustMindMapSize('small')">
                                <i class="fas fa-compress-arrows-alt me-1"></i>–ú–∞–ª.
                            </button>
                            <button type="button" class="btn btn-outline-secondary active"
                                onclick="adjustMindMapSize('medium')">
                                <i class="fas fa-arrows-alt me-1"></i>–°—Ä–µ–¥.
                            </button>
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="adjustMindMapSize('large')">
                                <i class="fas fa-expand-arrows-alt me-1"></i>–ë–æ–ª.
                            </button>
                        </div>
                    </div>

                    <!-- Statistics and Info -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex gap-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —É–∑–µ–ª –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                            </small>
                            <small class="text-muted" id="mindMapStats">
                                <i class="fas fa-chart-bar me-1"></i>
                                –£–∑–ª–æ–≤: <span id="nodeCount">0</span> | –°–≤—è–∑–µ–π: <span id="linkCount">0</span>
                            </small>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-success" onclick="fitToScreen()">
                                <i class="fas fa-expand me-1"></i>–ü–æ —Ä–∞–∑–º–µ—Ä—É
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="centerView()">
                                <i class="fas fa-crosshairs me-1"></i>–¶–µ–Ω—Ç—Ä
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mind-map-svg-container"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 20px; position: relative; overflow: hidden;">
                    <svg id="mindMapSvg" width="100%" height="600"
                        style="background: rgba(255,255,255,0.95); border-radius: 10px;">
                        <!-- Mind map will be rendered here -->
                    </svg>

                    <!-- Loading indicator -->
                    <div id="mindMapLoading" class="position-absolute top-50 start-50 translate-middle text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <div class="mt-2 text-white">–°–æ–∑–¥–∞–Ω–∏–µ –º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã...</div>
                    </div>
                </div>

                <!-- Enhanced Node details panel -->
                <div id="nodeDetailsPanel" class="mt-3" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0" id="nodeTitle">
                                <i class="fas fa-info-circle me-2"></i>–î–µ—Ç–∞–ª–∏ —É–∑–ª–∞
                            </h6>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-light"
                                    onclick="createFlashcardFromNode()" title="–°–æ–∑–¥–∞—Ç—å —Ñ–ª–µ—à-–∫–∞—Ä—Ç—É">
                                    <i class="fas fa-layer-group"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-light" onclick="addToStudyPlan()"
                                    title="–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è">
                                    <i class="fas fa-calendar-plus"></i>
                                </button>
                                <button type="button" class="btn-close" onclick="hideNodeDetails()"></button>
                            </div>
                        </div>
                        <div class="card-body" id="nodeContent">
                            <!-- Enhanced node details will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Study Plan Tab -->
        <div class="tab-pane fade" id="studyplan" role="tabpanel">
            <div class="study-plan-modern">
                <!-- Header with Analytics -->
                <div class="study-plan-header mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="mb-2">
                                <i class="fas fa-graduation-cap text-primary me-2"></i>
                                –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è
                            </h4>
                            <p class="text-muted mb-0">
                                –ù–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Å —É—á–µ—Ç–æ–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∏ –∫—Ä–∏–≤–æ–π –∑–∞–±—ã–≤–∞–Ω–∏—è
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="study-stats">
                                <div class="stat-item">
                                    <div class="stat-number">{{ study_plan.total_hours|round(1) }}</div>
                                    <div class="stat-label">—á–∞—Å–æ–≤</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Material Analysis -->
                {% if study_plan.material_analysis %}
                <div class="material-analysis mb-4">
                    <h5 class="mb-3"><i class="fas fa-chart-bar me-2"></i>–ê–Ω–∞–ª–∏–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="analysis-card">
                                <div class="analysis-icon">üìä</div>
                                <div class="analysis-title">–°–ª–æ–∂–Ω–æ—Å—Ç—å</div>
                                <div class="analysis-value">
                                    {% if study_plan.difficulty_level < 1.5 %} <span class="badge bg-success">
                                        –ë–∞–∑–æ–≤—ã–π</span>
                                        {% elif study_plan.difficulty_level < 2.5 %} <span class="badge bg-warning">
                                            –°—Ä–µ–¥–Ω–∏–π</span>
                                            {% else %}
                                            <span class="badge bg-danger">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π</span>
                                            {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="analysis-card">
                                <div class="analysis-icon">‚è±Ô∏è</div>
                                <div class="analysis-title">–í—Ä–µ–º—è –∏–∑—É—á–µ–Ω–∏—è</div>
                                <div class="analysis-value">{{
                                    study_plan.material_analysis.estimated_study_time.study_time }} –º–∏–Ω</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="analysis-card">
                                <div class="analysis-icon">üîÑ</div>
                                <div class="analysis-title">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</div>
                                <div class="analysis-value">{{
                                    study_plan.material_analysis.estimated_study_time.review_time }} –º–∏–Ω</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="analysis-card">
                                <div class="analysis-icon">üìö</div>
                                <div class="analysis-title">–ß—Ç–µ–Ω–∏–µ</div>
                                <div class="analysis-value">{{
                                    study_plan.material_analysis.estimated_study_time.reading_time }} –º–∏–Ω</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Learning Path Visualization -->
                <div class="learning-path mb-4">
                    <h5 class="mb-3"><i class="fas fa-route me-2"></i>–ü—É—Ç—å –æ–±—É—á–µ–Ω–∏—è</h5>
                    <div class="path-timeline">
                        {% for session in study_plan.sessions %}
                        <div class="timeline-item" data-session="{{ session.session_number }}">
                            <div class="timeline-marker">
                                <div class="timeline-number">{{ session.session_number }}</div>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-phase">{{ session.phase_name }}</div>
                                <div class="timeline-date">{{ session.date }} ({{ session.day_of_week }})</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Study Sessions -->
                <div class="row">
                    <div class="col-lg-8">
                        <div class="sessions-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>–£—á–µ–±–Ω—ã–µ —Å–µ—Å—Å–∏–∏</h5>
                                <div class="session-controls">
                                    <button class="btn btn-sm btn-outline-primary" onclick="toggleSessionView()">
                                        <i class="fas fa-list me-1"></i>–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥
                                    </button>
                                </div>
                            </div>

                            {% for session in study_plan.sessions %}
                            <div class="session-card enhanced" data-session="{{ session.session_number }}">
                                <div class="session-header">
                                    <div class="session-info">
                                        <div class="session-title">
                                            <span class="session-phase phase-{{ session.phase }}">{{ session.phase_name
                                                }}</span>
                                            <h6 class="mb-1">–°–µ—Å—Å–∏—è {{ session.session_number }}: {{
                                                session.main_topic.title }}</h6>
                                        </div>
                                        <div class="session-meta">
                                            <span class="session-date">
                                                <i class="fas fa-calendar me-1"></i>{{ session.date }}
                                            </span>
                                            <span class="session-duration">
                                                <i class="fas fa-clock me-1"></i>{{ session.duration_minutes }} –º–∏–Ω
                                            </span>
                                            <span
                                                class="session-difficulty difficulty-{{ session.estimated_difficulty }}">
                                                <i class="fas fa-signal me-1"></i>{{ session.estimated_difficulty }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="session-actions">
                                        <button class="btn btn-primary btn-sm"
                                            onclick="startSession({{ session.session_number }})">
                                            <i class="fas fa-play me-1"></i>–ù–∞—á–∞—Ç—å
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm session-toggle-btn"
                                            data-session="{{ session.session_number }}" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å">
                                            <i class="fas fa-chevron-down me-1"></i>–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å
                                        </button>
                                    </div>
                                </div>

                                <div class="session-details" id="sessionDetails{{ session.session_number }}"
                                    style="display: none;">
                                    <div class="session-focus mb-3">
                                        <h6><i class="fas fa-bullseye me-2"></i>–§–æ–∫—É—Å —Å–µ—Å—Å–∏–∏</h6>
                                        <p class="text-muted">{{ session.focus }}</p>
                                    </div>

                                    {% if session.activities %}
                                    <div class="session-activities mb-3">
                                        <h6><i class="fas fa-tasks me-2"></i>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h6>
                                        <div class="activities-timeline">
                                            {% for activity in session.activities %}
                                            <div class="activity-item">
                                                <div class="activity-icon">{{ activity.icon }}</div>
                                                <div class="activity-content">
                                                    <div class="activity-name">{{ activity.name }}</div>
                                                    <div class="activity-duration">{{ activity.duration }} –º–∏–Ω</div>
                                                    <div class="activity-description">{{ activity.description }}</div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if session.learning_objectives %}
                                    <div class="session-objectives mb-3">
                                        <h6><i class="fas fa-target me-2"></i>–¶–µ–ª–∏ –æ–±—É—á–µ–Ω–∏—è</h6>
                                        <ul class="objectives-list">
                                            {% for objective in session.learning_objectives %}
                                            <li>{{ objective }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}

                                    {% if session.exercises %}
                                    <div class="session-exercises mb-3">
                                        <h6><i class="fas fa-dumbbell me-2"></i>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h6>
                                        <div class="exercises-grid">
                                            {% for exercise in session.exercises %}
                                            <div class="exercise-card">
                                                <i class="fas fa-check-circle exercise-check"></i>
                                                <span>{{ exercise }}</span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if session.success_criteria %}
                                    <div class="session-success">
                                        <h6><i class="fas fa-trophy me-2"></i>–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞</h6>
                                        <div class="success-criteria">
                                            {% for criterion in session.success_criteria %}
                                            <div class="criterion-item">
                                                <i class="fas fa-medal me-2"></i>{{ criterion }}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Sidebar with Milestones and Progress -->
                    <div class="col-lg-4">
                        <div class="study-sidebar">
                            <!-- Milestones -->
                            <div class="milestones-card mb-4">
                                <h5 class="card-title">
                                    <i class="fas fa-flag-checkered me-2"></i>–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏
                                </h5>
                                {% for milestone in study_plan.milestones %}
                                <div class="milestone-item">
                                    <div class="milestone-progress">
                                        <div class="progress-circle">
                                            <span>{{ milestone.progress_percent }}%</span>
                                        </div>
                                    </div>
                                    <div class="milestone-content">
                                        <h6>{{ milestone.title }}</h6>
                                        <p class="text-muted">{{ milestone.description }}</p>
                                        <small class="text-info">–°–µ—Å—Å–∏—è {{ milestone.session }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Success Metrics -->
                            {% if study_plan.success_metrics %}
                            <div class="success-metrics-card mb-4">
                                <h5 class="card-title">
                                    <i class="fas fa-chart-line me-2"></i>–¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
                                </h5>
                                <div class="metrics-list">
                                    <div class="metric-item">
                                        <span class="metric-label">–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∑–Ω–∞–Ω–∏–π</span>
                                        <span class="metric-value">{{ study_plan.success_metrics.target_retention
                                            }}%</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫—É—Ä—Å–∞</span>
                                        <span class="metric-value">{{ study_plan.success_metrics.target_completion
                                            }}%</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å</span>
                                        <span class="metric-value">{{ study_plan.success_metrics.target_satisfaction
                                            }}/10</span>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Spaced Repetition Schedule -->
                            <div class="repetition-schedule-card mb-4">
                                <h5 class="card-title">
                                    <i class="fas fa-redo me-2"></i>–ì—Ä–∞—Ñ–∏–∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
                                </h5>
                                <p class="text-muted mb-3">–ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –ø–æ –∫—Ä–∏–≤–æ–π –≠–±–±–∏–Ω–≥–∞—É–∑–∞</p>
                                <div class="repetition-intervals">
                                    {% for interval in study_plan.review_schedule %}
                                    <span class="interval-badge">{{ interval }} –¥–Ω.</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Completion Info -->
                            <div class="completion-card">
                                <h5 class="card-title">
                                    <i class="fas fa-calendar-check me-2"></i>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
                                </h5>
                                <div class="completion-date">
                                    <i class="fas fa-flag-checkered me-2"></i>
                                    {{ study_plan.completion_date }}
                                </div>
                                {% if study_plan.adaptive_features %}
                                <div class="adaptive-features mt-3">
                                    <h6>–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</h6>
                                    <ul class="feature-list">
                                        {% if study_plan.adaptive_features.difficulty_adjustment %}
                                        <li><i class="fas fa-adjust me-1"></i>–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</li>
                                        {% endif %}
                                        {% if study_plan.adaptive_features.personalized_pace %}
                                        <li><i class="fas fa-tachometer-alt me-1"></i>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ–º–ø</li>
                                        {% endif %}
                                        {% if study_plan.adaptive_features.progress_tracking %}
                                        <li><i class="fas fa-chart-bar me-1"></i>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</li>
                                        {% endif %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Video Tab (if applicable) -->
        {% if key_moments %}
        <div class="tab-pane fade" id="video" role="tabpanel">
            <h4 class="mb-3"><i class="fas fa-video me-2"></i>–ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ</h4>

            <div class="video-timeline">
                <h5 class="mb-3">üéØ –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã</h5>
                {% for moment in key_moments %}
                <div class="key-moment" onclick="seekToTime('{{ moment.time }}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-play-circle me-2"></i>
                            <strong>{{ (moment.time // 60)|int }}:{{ '%02d'|format(moment.time % 60|int) }}</strong>
                            - {{ moment.description }}
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Study Progress Card -->
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">
                <i class="fas fa-chart-line me-2"></i>–ü—Ä–æ–≥—Ä–µ—Å—Å –∏–∑—É—á–µ–Ω–∏—è
            </h5>
            <div id="progressContainer">
                <div class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Load study progress
    fetch(`/api/study_progress/{{ result_id }}`)
        .then(response => response.json())
        .then(data => {
            const progressHtml = `
                <div class="row text-center">
                    <div class="col-md-4">
                        <h3 class="text-primary">${data.total_cards}</h3>
                        <p class="text-muted mb-0">–í—Å–µ–≥–æ –∫–∞—Ä—Ç–æ—á–µ–∫</p>
                    </div>
                    <div class="col-md-4">
                        <h3 class="text-info">${data.reviewed_cards}</h3>
                        <p class="text-muted mb-0">–ò–∑—É—á–µ–Ω–æ</p>
                    </div>
                    <div class="col-md-4">
                        <h3 class="text-success">${data.mastered_cards}</h3>
                        <p class="text-muted mb-0">–û—Å–≤–æ–µ–Ω–æ</p>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 25px;">
                    <div class="progress-bar bg-success" style="width: ${data.progress_percentage}%">
                        ${data.progress_percentage}%
                    </div>
                </div>
            `;
            document.getElementById('progressContainer').innerHTML = progressHtml;
        });

    // Enhanced Flashcard Functions
    let flashcardProgress = {};
    let currentStudySession = null;

    function filterCards(type) {
        const cards = document.querySelectorAll('.flashcard-advanced');
        let visibleCount = 0;

        cards.forEach(card => {
            if (type === 'all' || card.dataset.type === type) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        // Update active button
        document.querySelectorAll('[data-filter]').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-filter="${type}"]`).classList.add('active');

        // Show/hide no cards message
        document.getElementById('noCardsMessage').style.display = visibleCount === 0 ? 'block' : 'none';

        updateFlashcardStats();
    }

    function searchFlashcards() {
        const searchTerm = document.getElementById('flashcardSearch').value.toLowerCase();
        const cards = document.querySelectorAll('.flashcard-advanced');
        let visibleCount = 0;

        cards.forEach(card => {
            const question = card.querySelector('.flashcard-question').textContent.toLowerCase();
            const answer = card.querySelector('.answer-content').textContent.toLowerCase();

            if (question.includes(searchTerm) || answer.includes(searchTerm)) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        document.getElementById('noCardsMessage').style.display = visibleCount === 0 ? 'block' : 'none';
    }

    function sortCards(criteria) {
        const container = document.getElementById('flashcardsAccordion');
        const cards = Array.from(container.querySelectorAll('.flashcard-advanced'));

        cards.sort((a, b) => {
            switch (criteria) {
                case 'difficulty':
                    return parseInt(a.dataset.difficulty) - parseInt(b.dataset.difficulty);
                case 'type':
                    return a.dataset.type.localeCompare(b.dataset.type);
                case 'progress':
                    const progressA = flashcardProgress[a.dataset.cardId] || 0;
                    const progressB = flashcardProgress[b.dataset.cardId] || 0;
                    return progressB - progressA;
                default:
                    return 0;
            }
        });

        // Re-append sorted cards
        cards.forEach(card => container.appendChild(card));

        // Show toast notification
        showToast(`–ö–∞—Ä—Ç—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ ${criteria === 'difficulty' ? '—Å–ª–æ–∂–Ω–æ—Å—Ç–∏' : criteria === 'type' ? '—Ç–∏–ø—É' : '–ø—Ä–æ–≥—Ä–µ—Å—Å—É'}`, 'info');
    }

    function startInteractiveStudy() {
        const modal = new bootstrap.Modal(document.getElementById('interactiveStudyModal'));
        const modalBody = document.getElementById('studyModalBody');

        // Get cards that need review
        const cards = Array.from(document.querySelectorAll('.flashcard-advanced')).filter(card =>
            card.style.display !== 'none'
        );

        if (cards.length === 0) {
            showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ä—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è', 'warning');
            return;
        }

        currentStudySession = {
            cards: cards,
            currentIndex: 0,
            correct: 0,
            total: cards.length
        };

        modalBody.innerHTML = `
            <div class="study-session-container">
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%" id="studyProgress"></div>
                </div>
                <div class="text-center mb-3">
                    <span class="badge bg-primary">–ö–∞—Ä—Ç–∞ 1 –∏–∑ ${cards.length}</span>
                </div>
                <div class="study-card" id="studyCard">
                    <!-- Study card content will be loaded here -->
                </div>
                <div class="study-controls mt-4 text-center">
                    <button class="btn btn-outline-secondary" onclick="showStudyAnswer()" id="showAnswerBtn">
                        <i class="fas fa-eye me-1"></i>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
                    </button>
                    <div id="studyAnswerControls" style="display: none;">
                        <button class="btn btn-danger me-2" onclick="studyCardResult(false)">
                            <i class="fas fa-times me-1"></i>–ù–µ –∑–Ω–∞—é
                        </button>
                        <button class="btn btn-success" onclick="studyCardResult(true)">
                            <i class="fas fa-check me-1"></i>–ó–Ω–∞—é
                        </button>
                    </div>
                </div>
            </div>
        `;

        loadStudyCard();
        modal.show();
    }

    function loadStudyCard() {
        if (!currentStudySession) return;

        const card = currentStudySession.cards[currentStudySession.currentIndex];
        const question = card.querySelector('.flashcard-question').textContent;
        const cardNumber = currentStudySession.currentIndex + 1;
        const total = currentStudySession.total;

        document.getElementById('studyCard').innerHTML = `
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-question-circle text-primary me-2"></i>
                        ${question}
                    </h5>
                    <div id="studyAnswer" style="display: none;">
                        <hr>
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            ${card.querySelector('.answer-content').textContent}
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Update progress
        const progress = (cardNumber / total) * 100;
        document.getElementById('studyProgress').style.width = progress + '%';
        document.querySelector('.badge.bg-primary').textContent = `–ö–∞—Ä—Ç–∞ ${cardNumber} –∏–∑ ${total}`;

        // Reset controls
        document.getElementById('showAnswerBtn').style.display = 'block';
        document.getElementById('studyAnswerControls').style.display = 'none';
    }

    function showStudyAnswer() {
        document.getElementById('studyAnswer').style.display = 'block';
        document.getElementById('showAnswerBtn').style.display = 'none';
        document.getElementById('studyAnswerControls').style.display = 'block';
    }

    function studyCardResult(correct) {
        if (!currentStudySession) return;

        if (correct) {
            currentStudySession.correct++;
        }

        currentStudySession.currentIndex++;

        if (currentStudySession.currentIndex >= currentStudySession.total) {
            // Session complete
            const accuracy = Math.round((currentStudySession.correct / currentStudySession.total) * 100);
            document.getElementById('studyModalBody').innerHTML = `
                <div class="text-center">
                    <i class="fas fa-trophy text-warning" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h4>
                    <p class="lead">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${currentStudySession.correct} –∏–∑ ${currentStudySession.total}</p>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-${accuracy >= 80 ? 'success' : accuracy >= 60 ? 'warning' : 'danger'}" 
                             style="width: ${accuracy}%">${accuracy}%</div>
                    </div>
                    <button class="btn btn-primary" onclick="startInteractiveStudy()">
                        <i class="fas fa-redo me-1"></i>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Å–µ—Å—Å–∏—é
                    </button>
                </div>
            `;
            currentStudySession = null;
        } else {
            loadStudyCard();
        }
    }

    function startQuizMode() {
        showToast('–†–µ–∂–∏–º —Ç–µ—Å—Ç–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏', 'info');
    }

    function showCreateCardModal() {
        const modal = new bootstrap.Modal(document.getElementById('createCardModal'));
        modal.show();
    }

    function createNewCard() {
        const question = document.getElementById('newCardQuestion').value.trim();
        const answer = document.getElementById('newCardAnswer').value.trim();
        const type = document.getElementById('newCardType').value;
        const difficulty = parseInt(document.getElementById('newCardDifficulty').value);
        const hint = document.getElementById('newCardHint').value.trim();

        if (!question || !answer) {
            showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç', 'warning');
            return;
        }

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É
        const newCard = {
            q: question,
            a: answer,
            type: type,
            difficulty: difficulty,
            hint: hint || '–ü–æ–¥—Å–∫–∞–∑–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞',
            related_topics: [],
            memory_hook: '',
            common_mistakes: '',
            text_reference: '–°–æ–∑–¥–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º',
            next_review: new Date().toISOString(),
            ease_factor: 2.5
        };

        console.log('Creating new card:', newCard);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch('/api/create_flashcard', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                result_id: {{ result_id }},
                card: newCard
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç—É –≤ DOM
                addCardToDOM(newCard, data.card_id);
                
                showToast('–§–ª–µ—à-–∫–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateFlashcardStats();
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                bootstrap.Modal.getInstance(document.getElementById('createCardModal')).hide();
                document.getElementById('createCardForm').reset();
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã');
            }
        })
        .catch(error => {
            console.error('Error creating flashcard:', error);
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞—Ä—Ç—ã: ' + error.message, 'danger');
        });
    }

    function addCardToDOM(card, cardId) {
        const flashcardsContainer = document.getElementById('flashcardsAccordion');
        if (!flashcardsContainer) {
            console.error('Flashcards container not found');
            return;
        }

        const cardIndex = flashcardsContainer.children.length;
        const difficultyClass = `difficulty-${card.difficulty}`;
        const difficultyText = card.difficulty === 1 ? '–õ–µ–≥–∫–∞—è' : card.difficulty === 2 ? '–°—Ä–µ–¥–Ω—è—è' : '–°–ª–æ–∂–Ω–∞—è';
        const typeText = {
            'definition': '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ',
            'concept': '–ö–æ–Ω—Ü–µ–ø—Ü–∏—è', 
            'application': '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ',
            'comparison': '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ',
            'problem': '–ó–∞–¥–∞—á–∞'
        }[card.type] || card.type;

        const cardHtml = `
            <div class="accordion-item flashcard-advanced ${difficultyClass}">
                <h2 class="accordion-header" id="heading${cardIndex}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse${cardIndex}" aria-expanded="false" aria-controls="collapse${cardIndex}">
                        <div class="flashcard-header w-100">
                            <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                <div class="flashcard-question">
                                    <strong>${card.q}</strong>
                                </div>
                                <div class="flashcard-meta">
                                    <span class="badge bg-secondary me-2">${typeText}</span>
                                    <span class="badge bg-info">${difficultyText}</span>
                                </div>
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="collapse${cardIndex}" class="accordion-collapse collapse" aria-labelledby="heading${cardIndex}"
                    data-bs-parent="#flashcardsAccordion">
                    <div class="accordion-body">
                        <div class="answer-content mb-3">
                            <h6><i class="fas fa-lightbulb me-2"></i>–û—Ç–≤–µ—Ç:</h6>
                            <p>${card.a}</p>
                        </div>
                        ${card.hint && card.hint !== '–ü–æ–¥—Å–∫–∞–∑–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞' ? `
                        <div class="hint-content mb-3">
                            <h6><i class="fas fa-question-circle me-2"></i>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</h6>
                            <p class="text-muted">${card.hint}</p>
                        </div>
                        ` : ''}
                        <div class="card-actions d-flex justify-content-between align-items-center">
                            <div class="review-buttons">
                                <small class="text-muted me-2">–ù–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ –∑–Ω–∞–µ—Ç–µ?</small>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-danger"
                                        onclick="markCardReviewed('{{ result_id }}', '${cardIndex}', false, 1)">
                                        <i class="fas fa-times me-1"></i>–ù–µ –∑–Ω–∞—é
                                    </button>
                                    <button class="btn btn-outline-warning"
                                        onclick="markCardReviewed('{{ result_id }}', '${cardIndex}', true, 2)">
                                        <i class="fas fa-question me-1"></i>–ß–∞—Å—Ç–∏—á–Ω–æ
                                    </button>
                                    <button class="btn btn-outline-success"
                                        onclick="markCardReviewed('{{ result_id }}', '${cardIndex}', true, 3)">
                                        <i class="fas fa-check me-1"></i>–•–æ—Ä–æ—à–æ –∑–Ω–∞—é
                                    </button>
                                </div>
                            </div>
                            <div class="card-tools">
                                <button class="btn btn-sm btn-outline-primary"
                                    onclick="addToFavorites('${cardIndex}')" title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                                    <i class="fas fa-star"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info"
                                    onclick="shareCard('${cardIndex}')" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                                    <i class="fas fa-share"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        flashcardsContainer.insertAdjacentHTML('beforeend', cardHtml);
        
        // –°–∫—Ä—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–∫–∞—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã" –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        const noCardsMessage = document.getElementById('noCardsMessage');
        if (noCardsMessage) {
            noCardsMessage.style.display = 'none';
        }
    }

    function updateFlashcardStats() {
        const totalCards = document.querySelectorAll('#flashcardsAccordion .accordion-item').length;
        
        // –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∏–∫–æ–Ω–∫–∞–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        let masteredCards = 0;
        let reviewCards = 0;
        let newCards = 0;
        
        document.querySelectorAll('[data-card]').forEach(indicator => {
            const icon = indicator.querySelector('i');
            if (icon) {
                if (icon.classList.contains('fa-check-circle')) {
                    masteredCards++;
                } else if (icon.classList.contains('fa-clock')) {
                    reviewCards++;
                } else {
                    newCards++;
                }
            }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
        const masteredElement = document.getElementById('masteredCount');
        const reviewElement = document.getElementById('reviewCount');
        const newElement = document.getElementById('newCount');
        const progressElement = document.getElementById('progressPercent');
        
        if (masteredElement) masteredElement.textContent = masteredCards;
        if (reviewElement) reviewElement.textContent = reviewCards;
        if (newElement) newElement.textContent = newCards;
        
        // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        const progressPercent = totalCards > 0 ? Math.round((masteredCards / totalCards) * 100) : 0;
        if (progressElement) progressElement.textContent = progressPercent + '%';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –≤–∫–ª–∞–¥–∫–∏
        const flashcardsTab = document.querySelector('[href="#flashcards"]');
        if (flashcardsTab) {
            const badge = flashcardsTab.querySelector('.badge');
            if (badge) {
                badge.textContent = totalCards;
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ —Å–µ–∫—Ü–∏–∏
        const flashcardsHeader = document.querySelector('#flashcards h4');
        if (flashcardsHeader) {
            const countSpan = flashcardsHeader.querySelector('.text-muted');
            if (countSpan) {
                countSpan.textContent = `(${totalCards} –∫–∞—Ä—Ç)`;
            }
        }
        
        console.log(`Updated flashcard stats: ${totalCards} total, ${masteredCards} mastered, ${reviewCards} review, ${newCards} new`);
    }

    function showToast(message, type = 'info') {
        // –°–æ–∑–¥–∞–µ–º toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const toastId = 'toast-' + Date.now();
        const bgClass = {
            'success': 'bg-success',
            'danger': 'bg-danger', 
            'warning': 'bg-warning',
            'info': 'bg-info'
        }[type] || 'bg-info';
        
        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è toast –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º toast
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 3000
        });
        toast.show();
        
        // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è
        toastElement.addEventListener('hidden.bs.toast', function() {
            this.remove();
        });
    }

    function addCardToDOM(card, cardId) {
        const accordion = document.getElementById('flashcardsAccordion');
        const cardIndex = accordion.children.length;
        
        const cardHtml = `
            <div class="accordion-item flashcard-advanced difficulty-${card.difficulty}"
                 id="flashcard-${cardId}"
                 data-type="${card.type}" 
                 data-difficulty="${card.difficulty}"
                 data-card-id="${cardId}"
                 data-card="${cardId}">
                <div class="flashcard-header">
                    <div class="d-flex align-items-center flex-grow-1">
                        <button class="accordion-button collapsed p-0 bg-transparent border-0 text-start"
                                type="button" data-bs-toggle="collapse" data-bs-target="#card${cardIndex + 1}">
                            <div class="flashcard-question-container">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-question-circle text-primary me-2"></i>
                                    <span class="card-number text-muted me-2">#${cardIndex + 1}</span>
                                    <span class="flashcard-question">${card.q}</span>
                                </div>
                                <div class="flashcard-meta">
                                    <span class="badge bg-${getTypeColor(card.type)} me-1">${getTypeLabel(card.type)}</span>
                                    <span class="badge bg-${getDifficultyColor(card.difficulty)} me-1">
                                        ${'‚òÖ'.repeat(card.difficulty)}
                                    </span>
                                    <span class="badge bg-success">–ù–æ–≤–∞—è</span>
                                </div>
                            </div>
                        </button>
                        <div class="flashcard-actions ms-2">
                            <i class="fas fa-circle text-muted" data-card="${cardId}" title="–ù–µ –∏–∑—É—á–µ–Ω–∞"></i>
                        </div>
                    </div>
                </div>
                <div id="card${cardIndex + 1}" class="accordion-collapse collapse" data-bs-parent="#flashcardsAccordion">
                    <div class="accordion-body">
                        <div class="answer-content">
                            <h6><i class="fas fa-lightbulb text-warning me-2"></i>–û—Ç–≤–µ—Ç:</h6>
                            <div class="answer-text">${card.a}</div>
                        </div>
                        ${card.hint ? `
                        <div class="hint-content mt-3">
                            <h6><i class="fas fa-info-circle text-info me-2"></i>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</h6>
                            <div class="hint-text">${card.hint}</div>
                        </div>
                        ` : ''}
                        <div class="card-actions mt-4">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="mb-2">–ù–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ –∑–Ω–∞–µ—Ç–µ?</h6>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-danger"
                                                onclick="markCardReviewed('{{ result_id }}', '${cardId}', false, 1)">
                                            <i class="fas fa-times me-1"></i>–ù–µ –∑–Ω–∞—é
                                        </button>
                                        <button class="btn btn-outline-warning"
                                                onclick="markCardReviewed('{{ result_id }}', '${cardId}', true, 2)">
                                            <i class="fas fa-question me-1"></i>–ß–∞—Å—Ç–∏—á–Ω–æ
                                        </button>
                                        <button class="btn btn-outline-success"
                                                onclick="markCardReviewed('{{ result_id }}', '${cardId}', true, 3)">
                                            <i class="fas fa-check me-1"></i>–•–æ—Ä–æ—à–æ –∑–Ω–∞—é
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" onclick="addToFavorites('${cardId}')" title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                                            <i class="fas fa-heart"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="shareCard('${cardId}')" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                                            <i class="fas fa-share"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        accordion.insertAdjacentHTML('beforeend', cardHtml);
    }

    function getTypeColor(type) {
        const colors = {
            'definition': 'success',
            'concept': 'info', 
            'application': 'warning',
            'comparison': 'danger',
            'problem': 'primary'
        };
        return colors[type] || 'secondary';
    }

    function getTypeLabel(type) {
        const labels = {
            'definition': '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ',
            'concept': '–ö–æ–Ω—Ü–µ–ø—Ü–∏—è',
            'application': '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ', 
            'comparison': '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ',
            'problem': '–ó–∞–¥–∞—á–∞'
        };
        return labels[type] || '–î—Ä—É–≥–æ–µ';
    }

    function getDifficultyColor(difficulty) {
        const colors = {
            1: 'success',
            2: 'warning', 
            3: 'danger'
        };
        return colors[difficulty] || 'secondary';
    }

    function addToFavorites(cardId) {
        showToast('–ö–∞—Ä—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ', 'success');
        // Here you would save to favorites
    }

    function shareCard(cardId) {
        if (navigator.share) {
            navigator.share({
                title: '–§–ª–µ—à-–∫–∞—Ä—Ç–∞',
                text: '–ò–∑—É—á–∞–µ–º –≤–º–µ—Å—Ç–µ!',
                url: window.location.href
            });
        } else {
            // Fallback - copy to clipboard
            navigator.clipboard.writeText(window.location.href);
            showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'info');
        }
    }



    // Enhanced mark card as reviewed with confidence levels
    function markCardReviewed(resultId, cardId, correct, confidence = 2) {
        console.log('Marking card as reviewed:', { resultId, cardId, correct, confidence });
        
        fetch('/api/flashcard_progress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                result_id: parseInt(resultId),
                flashcard_id: parseInt(cardId),
                correct: correct,
                confidence: confidence
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Progress update response:', data);
                
                if (data.success) {
                    // Update progress indicator
                    const progressIndicator = document.querySelector(`.flashcard-progress-indicator[data-card="${cardId}"]`);
                    if (progressIndicator) {
                        const icon = progressIndicator.querySelector('i');
                        if (icon) {
                            if (correct && confidence >= 3) {
                                icon.className = 'fas fa-check-circle text-success';
                                icon.title = '–ò–∑—É—á–µ–Ω–æ';
                            } else if (correct && confidence >= 2) {
                                icon.className = 'fas fa-clock text-warning';
                                icon.title = '–ù–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ';
                            } else {
                                icon.className = 'fas fa-times-circle text-danger';
                                icon.title = '–¢—Ä–µ–±—É–µ—Ç –∏–∑—É—á–µ–Ω–∏—è';
                            }
                        }
                    }

                    // Find and update buttons for this specific card
                    const cardElement = document.querySelector(`#flashcard-${cardId}`);
                    if (cardElement) {
                        const buttons = cardElement.querySelectorAll('.btn-group button');
                        buttons.forEach(btn => {
                            btn.disabled = true;
                            btn.classList.remove('btn-outline-danger', 'btn-outline-warning', 'btn-outline-success');
                            btn.classList.add('btn-secondary');
                        });
                    }

                    // Update progress in memory
                    if (typeof flashcardProgress !== 'undefined') {
                        flashcardProgress[cardId] = confidence;
                    }

                    // Show feedback
                    let message = '';
                    let nextReview = '';

                    if (correct && confidence >= 3) {
                        message = '–û—Ç–ª–∏—á–Ω–æ! –ö–∞—Ä—Ç–∞ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ –∏–∑—É—á–µ–Ω–Ω–∞—è.';
                        nextReview = data.next_review_days ? `–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${data.next_review_days} –¥–Ω–µ–π` : '';
                    } else if (correct && confidence >= 2) {
                        message = '–•–æ—Ä–æ—à–æ! –ö–∞—Ä—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ.';
                        nextReview = '–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –∑–∞–≤—Ç—Ä–∞';
                    } else {
                        message = '–ö–∞—Ä—Ç–∞ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ —Å–Ω–æ–≤–∞ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è.';
                        nextReview = '–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è';
                    }

                    showToast(message + (nextReview ? ' ' + nextReview : ''), 'success');

                    // Update statistics
                    updateFlashcardStats();
                } else {
                    console.error('Server returned error:', data);
                    showToast(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞', 'danger');
                }
            })
            .catch(error => {
                console.error('Error updating flashcard progress:', error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.', 'danger');
            });
    }

    // Modern Mind Map Implementation
    let mindMapData = null;
    let currentLayout = 'radial';
    let mindMapNodes = [];
    let mindMapLinks = [];

    function initMindMap() {
        // Show loading
        document.getElementById('mindMapLoading').style.display = 'block';

        fetch(`/api/mind_map/{{ result_id }}`)
            .then(response => response.json())
            .then(data => {
                mindMapData = data;
                document.getElementById('mindMapLoading').style.display = 'none';
                drawModernMindMap();
            })
            .catch(error => {
                console.error('Error loading mind map:', error);
                document.getElementById('mindMapLoading').innerHTML =
                    '<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            });
    }

    function drawModernMindMap() {
        if (!mindMapData || !mindMapData.branches) return;

        const svg = d3.select('#mindMapSvg');
        svg.selectAll('*').remove(); // Clear previous content

        const width = document.getElementById('mindMapSvg').clientWidth;
        const height = 500;

        // Prepare data
        prepareGraphData();

        // Update statistics
        updateMindMapStats();

        // Create main group with zoom capability
        const g = svg.append('g').attr('class', 'mind-map-group');

        // Add zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.3, 3])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });

        svg.call(zoom);

        // Draw based on layout
        if (currentLayout === 'radial') {
            drawRadialLayout(g, width, height);
        } else if (currentLayout === 'tree') {
            drawTreeLayout(g, width, height);
        } else {
            drawForceLayout(g, width, height);
        }
    }

    function prepareGraphData() {
        mindMapNodes = [];
        mindMapLinks = [];

        // Central node
        mindMapNodes.push({
            id: 'central',
            name: mindMapData.central_topic || '–û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞',
            type: 'central',
            level: 0,
            color: '#667eea',
            size: 35,
            details: {
                title: mindMapData.central_topic || '–û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞',
                description: '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–µ–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞',
                type: '–û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞'
            }
        });

        // Branch nodes and their children
        mindMapData.branches.forEach((branch, branchIndex) => {
            const branchId = `branch-${branchIndex}`;

            mindMapNodes.push({
                id: branchId,
                name: branch.name,
                type: 'branch',
                level: 1,
                color: branch.color || '#4ECDC4',
                size: 25,
                details: {
                    title: branch.name,
                    description: `–í–∞–∂–Ω–æ—Å—Ç—å: ${Math.round((branch.importance || 0.5) * 100)}%`,
                    type: '–û—Å–Ω–æ–≤–Ω–∞—è –≤–µ—Ç–∫–∞',
                    children: branch.children ? branch.children.length : 0
                }
            });

            // Link from central to branch
            mindMapLinks.push({
                source: 'central',
                target: branchId,
                type: 'main'
            });

            // Child nodes
            if (branch.children) {
                branch.children.forEach((child, childIndex) => {
                    const childId = `child-${branchIndex}-${childIndex}`;

                    mindMapNodes.push({
                        id: childId,
                        name: child.name,
                        type: 'child',
                        level: 2,
                        color: child.color || branch.color || '#96CEB4',
                        size: 18,
                        parent: branchId,
                        details: {
                            title: child.name,
                            description: `–ü–æ–¥—Ç–µ–º–∞ —Ä–∞–∑–¥–µ–ª–∞ "${branch.name}"`,
                            type: '–ü–æ–¥—Ç–µ–º–∞',
                            parent: branch.name
                        }
                    });

                    // Link from branch to child
                    mindMapLinks.push({
                        source: branchId,
                        target: childId,
                        type: 'sub'
                    });
                });
            }
        });
    }

    function drawRadialLayout(g, width, height) {
        const centerX = width / 2;
        const centerY = height / 2;

        // Position nodes
        const branches = mindMapNodes.filter(n => n.type === 'branch');
        const angleStep = (2 * Math.PI) / Math.max(branches.length, 1);

        // Position central node
        const centralNode = mindMapNodes.find(n => n.type === 'central');
        centralNode.x = centerX;
        centralNode.y = centerY;

        // Position branch nodes in circle
        branches.forEach((branch, index) => {
            const angle = index * angleStep - Math.PI / 2; // Start from top
            branch.x = centerX + Math.cos(angle) * 120;
            branch.y = centerY + Math.sin(angle) * 120;
        });

        // Position child nodes around their parents
        mindMapNodes.filter(n => n.type === 'child').forEach(child => {
            const parent = mindMapNodes.find(n => n.id === child.parent);
            if (parent) {
                const siblings = mindMapNodes.filter(n => n.parent === child.parent);
                const childIndex = siblings.indexOf(child);
                const totalSiblings = siblings.length;

                const angleOffset = (childIndex - (totalSiblings - 1) / 2) * (Math.PI / 6);
                const distance = 70;

                // Calculate angle from center to parent
                const parentAngle = Math.atan2(parent.y - centerY, parent.x - centerX);
                const childAngle = parentAngle + angleOffset;

                child.x = parent.x + Math.cos(childAngle) * distance;
                child.y = parent.y + Math.sin(childAngle) * distance;
            }
        });

        drawStaticNodes(g);
    }

    function drawTreeLayout(g, width, height) {
        // Simple tree layout
        const levels = [
            mindMapNodes.filter(n => n.level === 0),
            mindMapNodes.filter(n => n.level === 1),
            mindMapNodes.filter(n => n.level === 2)
        ];

        const levelHeight = height / (levels.length + 1);

        levels.forEach((levelNodes, levelIndex) => {
            const y = levelHeight * (levelIndex + 1);
            const spacing = width / (levelNodes.length + 1);

            levelNodes.forEach((node, nodeIndex) => {
                node.x = spacing * (nodeIndex + 1);
                node.y = y;
            });
        });

        drawStaticNodes(g);
    }

    function drawForceLayout(g, width, height) {
        // Force-directed layout
        const simulation = d3.forceSimulation(mindMapNodes)
            .force('link', d3.forceLink(mindMapLinks).id(d => d.id).distance(80))
            .force('charge', d3.forceManyBody().strength(-200))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(d => d.size + 5));

        drawDynamicNodes(g, simulation);
    }

    function drawStaticNodes(g) {
        // Draw links
        const links = g.selectAll('.mind-link')
            .data(mindMapLinks)
            .enter()
            .append('line')
            .attr('class', 'mind-link')
            .attr('x1', d => {
                const source = mindMapNodes.find(n => n.id === d.source);
                return source ? source.x : 0;
            })
            .attr('y1', d => {
                const source = mindMapNodes.find(n => n.id === d.source);
                return source ? source.y : 0;
            })
            .attr('x2', d => {
                const target = mindMapNodes.find(n => n.id === d.target);
                return target ? target.x : 0;
            })
            .attr('y2', d => {
                const target = mindMapNodes.find(n => n.id === d.target);
                return target ? target.y : 0;
            })
            .attr('stroke', d => d.type === 'main' ? '#667eea' : '#dee2e6')
            .attr('stroke-width', d => d.type === 'main' ? 3 : 2)
            .attr('opacity', 0.7);

        // Draw nodes
        const nodeGroups = g.selectAll('.mind-node')
            .data(mindMapNodes)
            .enter()
            .append('g')
            .attr('class', 'mind-node')
            .attr('transform', d => `translate(${d.x}, ${d.y})`)
            .style('cursor', 'pointer')
            .on('click', (event, d) => showNodeDetails(d))
            .on('mouseover', function (event, d) {
                d3.select(this).select('circle')
                    .transition().duration(200)
                    .attr('r', d.size * 1.3)
                    .attr('stroke-width', 4);
            })
            .on('mouseout', function (event, d) {
                d3.select(this).select('circle')
                    .transition().duration(200)
                    .attr('r', d.size)
                    .attr('stroke-width', 2);
            });

        // Node circles with gradient
        const defs = g.append('defs');
        mindMapNodes.forEach(node => {
            const gradient = defs.append('radialGradient')
                .attr('id', `gradient-${node.id}`)
                .attr('cx', '30%')
                .attr('cy', '30%');

            gradient.append('stop')
                .attr('offset', '0%')
                .attr('stop-color', d3.color(node.color).brighter(0.5));

            gradient.append('stop')
                .attr('offset', '100%')
                .attr('stop-color', node.color);
        });

        nodeGroups.append('circle')
            .attr('r', d => d.size)
            .attr('fill', d => `url(#gradient-${d.id})`)
            .attr('stroke', '#fff')
            .attr('stroke-width', 2)
            .style('filter', 'drop-shadow(0 3px 6px rgba(0,0,0,0.2))');

        // Node labels with better positioning
        nodeGroups.append('text')
            .attr('text-anchor', 'middle')
            .attr('dy', d => d.size + 18)
            .attr('font-size', d => d.type === 'central' ? '13px' : d.type === 'branch' ? '11px' : '9px')
            .attr('font-weight', d => d.type === 'central' ? 'bold' : 'normal')
            .attr('fill', '#333')
            .style('text-shadow', '1px 1px 2px rgba(255,255,255,0.8)')
            .text(d => {
                const maxLength = d.type === 'central' ? 25 : d.type === 'branch' ? 20 : 15;
                return d.name.length > maxLength ? d.name.substring(0, maxLength) + '...' : d.name;
            });
    }

    function drawDynamicNodes(g, simulation) {
        // Similar to drawStaticNodes but with simulation updates
        const links = g.selectAll('.mind-link')
            .data(mindMapLinks)
            .enter()
            .append('line')
            .attr('class', 'mind-link')
            .attr('stroke', d => d.type === 'main' ? '#667eea' : '#dee2e6')
            .attr('stroke-width', d => d.type === 'main' ? 3 : 2)
            .attr('opacity', 0.7);

        const nodeGroups = g.selectAll('.mind-node')
            .data(mindMapNodes)
            .enter()
            .append('g')
            .attr('class', 'mind-node')
            .style('cursor', 'pointer')
            .on('click', (event, d) => showNodeDetails(d))
            .call(d3.drag()
                .on('start', (event, d) => {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                })
                .on('drag', (event, d) => {
                    d.fx = event.x;
                    d.fy = event.y;
                })
                .on('end', (event, d) => {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }));

        nodeGroups.append('circle')
            .attr('r', d => d.size)
            .attr('fill', d => d.color)
            .attr('stroke', '#fff')
            .attr('stroke-width', 2);

        nodeGroups.append('text')
            .attr('text-anchor', 'middle')
            .attr('dy', d => d.size + 15)
            .attr('font-size', '10px')
            .attr('fill', '#333')
            .text(d => d.name.length > 15 ? d.name.substring(0, 15) + '...' : d.name);

        simulation.on('tick', () => {
            links
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            nodeGroups
                .attr('transform', d => `translate(${d.x}, ${d.y})`);
        });
    }

    function showNodeDetails(d) {
        const panel = document.getElementById('nodeDetailsPanel');
        const title = document.getElementById('nodeTitle');
        const content = document.getElementById('nodeContent');

        title.innerHTML = `<i class="fas fa-info-circle me-2"></i>${d.details.title}`;

        let detailsHtml = `
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-tag me-2 text-primary"></i>
                        <strong>–¢–∏–ø:</strong>
                        <span class="badge ms-2" style="background-color: ${d.color}; color: white;">
                            ${d.type === 'central' ? '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–µ–º–∞' : d.type === 'branch' ? '–û—Å–Ω–æ–≤–Ω–∞—è –≤–µ—Ç–∫–∞' : '–ü–æ–¥—Ç–µ–º–∞'}
                        </span>
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-align-left me-2 text-info"></i>
                        <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong>
                        <p class="mt-1 text-muted">${d.details.description}</p>
                    </div>
                </div>
                <div class="col-md-6">
        `;

        if (d.details.children !== undefined) {
            detailsHtml += `
                <div class="mb-2">
                    <i class="fas fa-sitemap me-2 text-success"></i>
                    <strong>–ü–æ–¥—Ç–µ–º:</strong> 
                    <span class="badge bg-success ms-1">${d.details.children}</span>
                </div>`;
        }
        if (d.details.parent) {
            detailsHtml += `
                <div class="mb-2">
                    <i class="fas fa-level-up-alt me-2 text-warning"></i>
                    <strong>–†–æ–¥–∏—Ç–µ–ª—å:</strong> 
                    <span class="text-primary">${d.details.parent}</span>
                </div>`;
        }

        // Add connection info
        const connections = mindMapLinks.filter(link =>
            link.source === d.id || link.target === d.id
        ).length;

        detailsHtml += `
                <div class="mb-2">
                    <i class="fas fa-link me-2 text-secondary"></i>
                    <strong>–°–≤—è–∑–µ–π:</strong> 
                    <span class="badge bg-secondary ms-1">${connections}</span>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="border-top pt-3">
            <h6 class="mb-2"><i class="fas fa-bolt me-2"></i>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h6>
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-sm btn-outline-primary" onclick="focusOnNode('${d.id}')">
                    <i class="fas fa-crosshairs me-1"></i>–§–æ–∫—É—Å
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="highlightConnections('${d.id}')">
                    <i class="fas fa-project-diagram me-1"></i>–°–≤—è–∑–∏
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="createFlashcardFromNode('${d.id}')">
                    <i class="fas fa-layer-group me-1"></i>–§–ª–µ—à-–∫–∞—Ä—Ç–∞
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="addToStudyPlan('${d.id}')">
                    <i class="fas fa-calendar-plus me-1"></i>–í –ø–ª–∞–Ω
                </button>
            </div>
        </div>
        `;

        content.innerHTML = detailsHtml;
        panel.style.display = 'block';
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        // Store current selected node
        window.selectedNode = d;
    }

    function hideNodeDetails() {
        document.getElementById('nodeDetailsPanel').style.display = 'none';
    }

    function setMindMapLayout(layout) {
        currentLayout = layout;

        // Update active button
        document.querySelectorAll('.mind-map-controls .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        drawModernMindMap();
    }

    function resetMindMapView() {
        const svg = d3.select('#mindMapSvg');
        svg.transition().duration(750).call(
            d3.zoom().transform,
            d3.zoomIdentity
        );
    }

    function downloadMindMap() {
        const svgElement = document.getElementById('mindMapSvg');
        const svgData = new XMLSerializer().serializeToString(svgElement);

        // Create canvas for export
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = svgElement.clientWidth;
        canvas.height = 500;

        // Create image from SVG
        const img = new Image();
        img.onload = function () {
            // White background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);

            // Download
            const link = document.createElement('a');
            link.download = 'mind_map.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        };

        const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
        img.src = URL.createObjectURL(blob);
    }

    // New Enhanced Mind Map Functions
    function searchMindMapNodes() {
        const searchTerm = document.getElementById('mindMapSearch').value.toLowerCase();
        if (!searchTerm) {
            // Reset all nodes
            d3.selectAll('.mind-node').style('opacity', 1);
            return;
        }

        d3.selectAll('.mind-node').style('opacity', function (d) {
            return d.name.toLowerCase().includes(searchTerm) ? 1 : 0.3;
        });
    }

    function filterNodes(type) {
        // Update active button
        document.querySelectorAll('[data-filter]').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-filter="${type}"]`).classList.add('active');

        if (type === 'all') {
            d3.selectAll('.mind-node').style('opacity', 1);
            d3.selectAll('.mind-link').style('opacity', 0.6);
        } else {
            d3.selectAll('.mind-node').style('opacity', function (d) {
                return d.type === type ? 1 : 0.3;
            });
            d3.selectAll('.mind-link').style('opacity', function (d) {
                const sourceNode = mindMapNodes.find(n => n.id === d.source);
                const targetNode = mindMapNodes.find(n => n.id === d.target);
                return (sourceNode && sourceNode.type === type) || (targetNode && targetNode.type === type) ? 0.6 : 0.1;
            });
        }
    }

    function adjustMindMapSize(size) {
        // Update active button
        document.querySelectorAll('.mind-map-controls .btn-group:last-child .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        const svg = d3.select('#mindMapSvg');
        let scale;

        switch (size) {
            case 'small': scale = 0.7; break;
            case 'large': scale = 1.3; break;
            default: scale = 1; break;
        }

        svg.transition().duration(500).call(
            d3.zoom().transform,
            d3.zoomIdentity.scale(scale)
        );
    }

    function focusOnNode(nodeId) {
        const node = mindMapNodes.find(n => n.id === nodeId);
        if (!node) return;

        const svg = d3.select('#mindMapSvg');
        const width = document.getElementById('mindMapSvg').clientWidth;
        const height = 500;

        const scale = 1.5;
        const x = width / 2 - node.x * scale;
        const y = height / 2 - node.y * scale;

        svg.transition().duration(750).call(
            d3.zoom().transform,
            d3.zoomIdentity.translate(x, y).scale(scale)
        );

        // Highlight the node
        d3.selectAll('.mind-node').style('opacity', 0.3);
        d3.select(`[data-node-id="${nodeId}"]`).style('opacity', 1);

        setTimeout(() => {
            d3.selectAll('.mind-node').style('opacity', 1);
        }, 2000);
    }

    function highlightConnections(nodeId) {
        const connectedLinks = mindMapLinks.filter(link =>
            link.source === nodeId || link.target === nodeId
        );

        const connectedNodeIds = new Set();
        connectedLinks.forEach(link => {
            connectedNodeIds.add(link.source);
            connectedNodeIds.add(link.target);
        });

        // Highlight connected nodes and links
        d3.selectAll('.mind-node').style('opacity', function (d) {
            return connectedNodeIds.has(d.id) ? 1 : 0.3;
        });

        d3.selectAll('.mind-link').style('opacity', function (d) {
            return connectedLinks.includes(d) ? 1 : 0.1;
        }).style('stroke-width', function (d) {
            return connectedLinks.includes(d) ? 3 : 1;
        });

        // Reset after 3 seconds
        setTimeout(() => {
            d3.selectAll('.mind-node').style('opacity', 1);
            d3.selectAll('.mind-link').style('opacity', 0.6).style('stroke-width', 1);
        }, 3000);
    }

    function createFlashcardFromNode(nodeId) {
        const node = window.selectedNode || mindMapNodes.find(n => n.id === nodeId);
        if (!node) return;

        // Create a simple flashcard modal or redirect to flashcards tab
        const flashcardData = {
            question: `–ß—Ç–æ —Ç–∞–∫–æ–µ "${node.name}"?`,
            answer: node.details.description,
            difficulty: node.type === 'central' ? 3 : node.type === 'branch' ? 2 : 1
        };

        // Show success message
        const toast = document.createElement('div');
        toast.className = 'alert alert-success position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            –§–ª–µ—à-–∫–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è "${node.name}"
            <button type="button" class="btn-close ms-2" onclick="this.parentElement.remove()"></button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => toast.remove(), 3000);
    }

    function addToStudyPlan(nodeId) {
        const node = window.selectedNode || mindMapNodes.find(n => n.id === nodeId);
        if (!node) return;

        // Show success message
        const toast = document.createElement('div');
        toast.className = 'alert alert-info position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <i class="fas fa-calendar-plus me-2"></i>
            "${node.name}" –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è
            <button type="button" class="btn-close ms-2" onclick="this.parentElement.remove()"></button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => toast.remove(), 3000);
    }

    function fitToScreen() {
        const svg = d3.select('#mindMapSvg');
        svg.transition().duration(750).call(
            d3.zoom().transform,
            d3.zoomIdentity.scale(0.8)
        );
    }

    function centerView() {
        const svg = d3.select('#mindMapSvg');
        svg.transition().duration(750).call(
            d3.zoom().transform,
            d3.zoomIdentity
        );
    }

    function updateMindMapStats() {
        document.getElementById('nodeCount').textContent = mindMapNodes.length;
        document.getElementById('linkCount').textContent = mindMapLinks.length;
    }

    // Start study session
    function startStudySession() {
        // TODO: Implement interactive study mode
        alert('–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º –∏–∑—É—á–µ–Ω–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
    }

    // Start specific session
    function startSession(day) {
        // TODO: Implement session start
        alert(`–ù–∞—á–∞—Ç—å —Å–µ—Å—Å–∏—é –¥–Ω—è ${day}`);
    }

    // Seek to video time
    function seekToTime(seconds) {
        // TODO: Implement video player integration
        alert(`–ü–µ—Ä–µ–π—Ç–∏ –∫ ${Math.floor(seconds / 60)}:${Math.floor(seconds % 60).toString().padStart(2, '0')}`);
    }

    // Load progress function
    function loadProgress() {
        fetch(`/api/study_progress/{{ result_id }}`)
            .then(response => response.json())
            .then(data => {
                const progressHtml = `
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h3 class="text-primary">${data.total_cards}</h3>
                            <p class="text-muted mb-0">–í—Å–µ–≥–æ –∫–∞—Ä—Ç–æ—á–µ–∫</p>
                        </div>
                        <div class="col-md-4">
                            <h3 class="text-info">${data.reviewed_cards}</h3>
                            <p class="text-muted mb-0">–ò–∑—É—á–µ–Ω–æ</p>
                        </div>
                        <div class="col-md-4">
                            <h3 class="text-success">${data.mastered_cards}</h3>
                            <p class="text-muted mb-0">–û—Å–≤–æ–µ–Ω–æ</p>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 25px;">
                        <div class="progress-bar bg-success" style="width: ${data.progress_percentage}%">
                            ${data.progress_percentage}%
                        </div>
                    </div>
                `;
                document.getElementById('progressContainer').innerHTML = progressHtml;
            });
    }

    // Initialize on tab change
    document.getElementById('mindmap-tab').addEventListener('shown.bs.tab', function () {
        initMindMap();
    });

    // Expand/collapse all flashcards
    function expandAll() {
        document.querySelectorAll('.accordion-collapse').forEach(el => {
            new bootstrap.Collapse(el, { show: true });
        });
    }

    function collapseAll() {
        document.querySelectorAll('.accordion-collapse').forEach(el => {
            new bootstrap.Collapse(el, { hide: true });
        });
    }

    // Enhanced Summary Functionality
    let isCompactView = false;
    let summaryText = `{{ summary|replace('\n', '\\n')|replace('"', '\\"')|safe }}`;

    function initSummary() {
        processSummaryContent();
        calculateSummaryStats();
        initReadingProgress();
    }

    function processSummaryContent() {
        const summaryContainer = document.getElementById('summaryContent');
        if (!summaryContainer || !summaryText) return;

        // Process the enhanced summary text to create beautiful structured HTML
        let processedContent = summaryText;

        // Convert ALL emoji headers to structured sections with enhanced styling
        processedContent = processedContent.replace(/üéØ ([^:]+):/g, '<div class="summary-section main-idea"><div class="section-header"><span class="section-icon">üéØ</span><h2>$1</h2></div><div class="section-content">');
        processedContent = processedContent.replace(/üìä ([^:]+):/g, '</div></div><div class="summary-section key-concepts"><div class="section-header"><span class="section-icon">üìä</span><h2>$1</h2></div><div class="section-content">');
        processedContent = processedContent.replace(/üîó ([^:]+):/g, '</div></div><div class="summary-section relationships"><div class="section-header"><span class="section-icon">üîó</span><h2>$1</h2></div><div class="section-content">');
        processedContent = processedContent.replace(/üí° ([^:]+):/g, '</div></div><div class="summary-section practical"><div class="section-header"><span class="section-icon">üí°</span><h2>$1</h2></div><div class="section-content">');
        processedContent = processedContent.replace(/‚ö° ([^:]+):/g, '</div></div><div class="summary-section critical-facts"><div class="section-header"><span class="section-icon">‚ö°</span><h2>$1</h2></div><div class="section-content">');
        processedContent = processedContent.replace(/üßÆ ([^:]+):/g, '</div></div><div class="summary-section formulas"><div class="section-header"><span class="section-icon">üßÆ</span><h2>$1</h2></div><div class="section-content">');
        processedContent = processedContent.replace(/üìà ([^:]+):/g, '</div></div><div class="summary-section results"><div class="section-header"><span class="section-icon">üìà</span><h2>$1</h2></div><div class="section-content">');

        // Enhanced bullet points with different styles
        processedContent = processedContent.replace(/‚Ä¢ ([^:]+): ([^\n]+)/g, '<div class="concept-item"><div class="concept-title">$1</div><div class="concept-description">$2</div></div>');
        processedContent = processedContent.replace(/‚Ä¢ ([^\n]+)/g, '<div class="bullet-item"><span class="bullet-icon">‚ñ∏</span>$1</div>');

        // Convert bold text with enhanced styling
        processedContent = processedContent.replace(/\*\*([^*]+)\*\*/g, '<span class="highlight-text">$1</span>');

        // Convert line breaks to proper paragraphs
        processedContent = processedContent.replace(/\n\n/g, '</p><p class="summary-paragraph">');
        processedContent = processedContent.replace(/\n/g, '<br>');

        // Wrap in paragraphs and close all sections
        processedContent = '<p class="summary-paragraph">' + processedContent + '</p></div></div>';

        // Clean up empty elements
        processedContent = processedContent.replace(/<p class="summary-paragraph"><\/p>/g, '');
        processedContent = processedContent.replace(/<p class="summary-paragraph"><br><\/p>/g, '');

        summaryContainer.innerHTML = processedContent;
        
        // Add enhanced styling and interactivity
        enhanceSummaryDisplay();
    }
    
    function enhanceSummaryDisplay() {
        // Add click-to-expand functionality for sections
        document.querySelectorAll('.section-header').forEach(header => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', function() {
                const content = this.nextElementSibling;
                const isCollapsed = content.style.display === 'none';
                
                content.style.display = isCollapsed ? 'block' : 'none';
                this.classList.toggle('collapsed', !isCollapsed);
            });
        });
        
        // Add hover effects to concept items
        document.querySelectorAll('.concept-item').forEach(item => {
            item.addEventListener('mouseenter', function() {
                this.style.transform = 'translateX(5px)';
                this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            });
            
            item.addEventListener('mouseleave', function() {
                this.style.transform = 'translateX(0)';
                this.style.boxShadow = 'none';
            });
        });
        
        // Add reading time estimation for each section
        document.querySelectorAll('.summary-section').forEach(section => {
            const wordCount = section.textContent.split(/\s+/).length;
            const readingTime = Math.ceil(wordCount / 200);
            const header = section.querySelector('.section-header h2');
            if (header && readingTime > 0) {
                header.innerHTML += ` <small class="reading-time">(${readingTime} –º–∏–Ω)</small>`;
            }
        });
    }

    function calculateSummaryStats() {
        const wordCount = summaryText.split(/\s+/).length;
        const readingTime = Math.ceil(wordCount / 200); // Average reading speed
        const sectionCount = (summaryText.match(/##/g) || []).length;
        const keyPoints = (summaryText.match(/‚Ä¢/g) || []).length;

        document.getElementById('wordCount').textContent = wordCount;
        document.getElementById('readingTime').textContent = readingTime;
        document.getElementById('sectionCount').textContent = sectionCount;
        document.getElementById('keyPoints').textContent = keyPoints;
    }

    function initReadingProgress() {
        const summaryContainer = document.getElementById('summaryContent');
        if (!summaryContainer) return;

        // Simulate reading progress based on scroll
        summaryContainer.addEventListener('scroll', function () {
            const scrollTop = this.scrollTop;
            const scrollHeight = this.scrollHeight - this.clientHeight;
            const progress = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;

            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('readingProgress').textContent = Math.round(progress) + '%';
        });

        // Auto-progress simulation for demonstration
        let autoProgress = 0;
        const progressInterval = setInterval(() => {
            if (autoProgress < 100) {
                autoProgress += 2;
                document.getElementById('progressBar').style.width = autoProgress + '%';
                document.getElementById('readingProgress').textContent = autoProgress + '%';
            } else {
                clearInterval(progressInterval);
            }
        }, 100);
    }

    function toggleSummaryView() {
        const summaryContainer = document.querySelector('.summary-modern');
        const toggleText = document.getElementById('viewToggleText');

        isCompactView = !isCompactView;

        if (isCompactView) {
            summaryContainer.classList.add('summary-compact');
            toggleText.textContent = '–ü–æ–ª–Ω—ã–π –≤–∏–¥';
        } else {
            summaryContainer.classList.remove('summary-compact');
            toggleText.textContent = '–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥';
        }
    }

    function copySummary() {
        const textToCopy = summaryText.replace(/\*\*/g, '').replace(/##/g, '').replace(/‚Ä¢/g, '-');

        if (navigator.clipboard) {
            navigator.clipboard.writeText(textToCopy).then(() => {
                showNotification('–†–µ–∑—é–º–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
            }).catch(() => {
                fallbackCopyText(textToCopy);
            });
        } else {
            fallbackCopyText(textToCopy);
        }
    }

    function fallbackCopyText(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            document.execCommand('copy');
            showNotification('–†–µ–∑—é–º–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
        } catch (err) {
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç', 'error');
        }

        document.body.removeChild(textArea);
    }

    function printSummary() {
        const printContent = document.getElementById('summaryContent').innerHTML;
        const printWindow = window.open('', '_blank');

        printWindow.document.write(`
            <html>
                <head>
                    <title>–†–µ–∑—é–º–µ - AI-–∫–æ–Ω—Å–ø–µ–∫—Ç</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; margin: 40px; }
                        h2 { color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
                        .emoji-section { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
                        .key-point { background: #fff5f5; border: 1px solid #fed7d7; border-radius: 5px; padding: 10px; margin: 8px 0; }
                        strong { color: #2d3748; }
                        @media print { body { margin: 20px; } }
                    </style>
                </head>
                <body>
                    <h1>üìÑ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ–∑—é–º–µ</h1>
                    <div>${printContent}</div>
                    <div style="margin-top: 40px; text-align: center; color: #666; font-size: 12px;">
                        –°–æ–∑–¥–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é AI-–∫–æ–Ω—Å–ø–µ–∫—Ç Pro
                    </div>
                </body>
            </html>
        `);

        printWindow.document.close();
        printWindow.focus();

        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 250);
    }

    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        // Auto remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }

    // Initialize summary when tab is shown
    document.getElementById('summary-tab').addEventListener('shown.bs.tab', function () {
        setTimeout(initSummary, 100); // Small delay to ensure content is rendered
    });

    // Initialize if summary tab is already active
    if (document.getElementById('summary-tab').classList.contains('active')) {
        setTimeout(initSummary, 100);
    }

    // Enhanced Study Plan Functionality
    let isCompactSessionView = false;

    function initStudyPlan() {
        // Initialize progress circles for milestones
        initMilestoneProgress();

        // Set up session interactions
        setupSessionInteractions();

        // Initialize timeline interactions
        initTimelineInteractions();
    }

    function initMilestoneProgress() {
        const progressCircles = document.querySelectorAll('.progress-circle');
        progressCircles.forEach(circle => {
            const progressText = circle.textContent.trim();
            const progressValue = parseInt(progressText.replace('%', ''));
            circle.style.setProperty('--progress', progressValue);
        });
    }

    function setupSessionInteractions() {
        console.log('Session interactions will be handled by event delegation');
        // Event delegation is handled globally, no need for individual listeners
    }

    function initTimelineInteractions() {
        const timelineItems = document.querySelectorAll('.timeline-item');
        timelineItems.forEach(item => {
            item.addEventListener('click', function () {
                const sessionNumber = this.dataset.session;
                scrollToSession(sessionNumber);
                highlightSession(sessionNumber);
            });
        });
    }

    function toggleSessionDetails(sessionNumber) {
        console.log('Toggling session details for session:', sessionNumber);
        const detailsElement = document.getElementById(`sessionDetails${sessionNumber}`);
        const toggleButton = document.querySelector(`.session-toggle-btn[data-session="${sessionNumber}"]`);
        const sessionCard = detailsElement ? detailsElement.closest('.session-card') : null;

        if (!detailsElement || !toggleButton) {
            console.error('Elements not found:', { detailsElement, toggleButton });
            return;
        }

        console.log('Details element found:', detailsElement);
        console.log('Toggle button found:', toggleButton);
        console.log('Current display:', detailsElement.style.display);

        const isHidden = detailsElement.style.display === 'none' ||
            getComputedStyle(detailsElement).display === 'none';

        if (isHidden) {
            console.log('Showing details...');
            // Show details
            detailsElement.style.display = 'block';
            detailsElement.style.maxHeight = '0';
            detailsElement.style.opacity = '0';
            detailsElement.style.overflow = 'hidden';
            detailsElement.style.transition = 'all 0.4s ease-out';

            // Force reflow
            detailsElement.offsetHeight;

            // Animate in
            detailsElement.style.maxHeight = '2000px';
            detailsElement.style.opacity = '1';

            // Update button
            toggleButton.innerHTML = '<i class="fas fa-chevron-up me-1"></i>–°–≤–µ—Ä–Ω—É—Ç—å';
            toggleButton.setAttribute('title', '–°–≤–µ—Ä–Ω—É—Ç—å');

            // Add expanded class for styling
            if (sessionCard) {
                sessionCard.classList.add('expanded');
            }

            // Clean up after animation
            setTimeout(() => {
                detailsElement.style.maxHeight = '';
                detailsElement.style.overflow = 'visible';
                detailsElement.style.transition = '';
            }, 400);

        } else {
            console.log('Hiding details...');
            // Hide details
            detailsElement.style.maxHeight = detailsElement.scrollHeight + 'px';
            detailsElement.style.overflow = 'hidden';
            detailsElement.style.transition = 'all 0.4s ease-out';

            // Force reflow
            detailsElement.offsetHeight;

            // Animate out
            detailsElement.style.maxHeight = '0';
            detailsElement.style.opacity = '0';

            // Update button
            toggleButton.innerHTML = '<i class="fas fa-chevron-down me-1"></i>–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
            toggleButton.setAttribute('title', '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å');

            setTimeout(() => {
                detailsElement.style.display = 'none';
                detailsElement.style.maxHeight = '';
                detailsElement.style.opacity = '';
                detailsElement.style.transition = '';
                if (sessionCard) {
                    sessionCard.classList.remove('expanded');
                }
            }, 400);
        }
    }

    function toggleSessionView() {
        const sessionsContainer = document.querySelector('.sessions-container');
        const toggleButton = document.querySelector('[onclick="toggleSessionView()"]');

        isCompactSessionView = !isCompactSessionView;

        if (isCompactSessionView) {
            sessionsContainer.classList.add('compact-view');
            toggleButton.innerHTML = '<i class="fas fa-expand me-1"></i>–ü–æ–ª–Ω—ã–π –≤–∏–¥';

            // Hide all expanded details
            document.querySelectorAll('.session-details').forEach(details => {
                details.style.display = 'none';
            });
        } else {
            sessionsContainer.classList.remove('compact-view');
            toggleButton.innerHTML = '<i class="fas fa-list me-1"></i>–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥';
        }
    }

    function startSession(sessionNumber) {
        // Create session modal or redirect to session page
        showSessionModal(sessionNumber);
    }

    function showSessionModal(sessionNumber) {
        // Find session data
        const sessionCard = document.querySelector(`[data-session="${sessionNumber}"]`);
        if (!sessionCard) return;

        const sessionTitle = sessionCard.querySelector('.session-title h6').textContent;
        const sessionPhase = sessionCard.querySelector('.session-phase').textContent;
        const sessionDuration = sessionCard.querySelector('.session-duration').textContent;

        // Create modal content
        const modalContent = `
            <div class="modal fade" id="sessionModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-play-circle me-2"></i>
                                –ù–∞—á–∞—Ç—å ${sessionTitle}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="session-start-info">
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="info-card">
                                            <div class="info-icon">üìö</div>
                                            <div class="info-label">–§–∞–∑–∞</div>
                                            <div class="info-value">${sessionPhase}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="info-card">
                                            <div class="info-icon">‚è±Ô∏è</div>
                                            <div class="info-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                                            <div class="info-value">${sessionDuration}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="info-card">
                                            <div class="info-icon">üéØ</div>
                                            <div class="info-label">–°–µ—Å—Å–∏—è</div>
                                            <div class="info-value">#${sessionNumber}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="session-checklist">
                                    <h6><i class="fas fa-clipboard-check me-2"></i>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–µ—Å—Å–∏–∏</h6>
                                    <div class="checklist-items">
                                        <label class="checklist-item">
                                            <input type="checkbox" class="form-check-input me-2">
                                            –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ä–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
                                        </label>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="form-check-input me-2">
                                            –£–±—Ä–∞—Ç—å –æ—Ç–≤–ª–µ–∫–∞—é—â–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã (—Ç–µ–ª–µ—Ñ–æ–Ω, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
                                        </label>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="form-check-input me-2">
                                            –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–∞–π–º–µ—Ä –Ω–∞ ${sessionDuration}
                                        </label>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="form-check-input me-2">
                                            –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –≤–æ–¥—É –∏ –ø–µ—Ä–µ–∫—É—Å
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>–û—Ç–º–µ–Ω–∞
                            </button>
                            <button type="button" class="btn btn-success" onclick="beginSession(${sessionNumber})">
                                <i class="fas fa-rocket me-1"></i>–ù–∞—á–∞—Ç—å –∏–∑—É—á–µ–Ω–∏–µ!
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal
        const existingModal = document.getElementById('sessionModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalContent);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('sessionModal'));
        modal.show();

        // Add styles for modal content
        const modalStyles = `
            <style>
                .session-start-info .info-card {
                    text-align: center;
                    padding: 15px;
                    background: #f8f9fa;
                    border-radius: 10px;
                    margin-bottom: 15px;
                }
                .session-start-info .info-icon {
                    font-size: 2rem;
                    margin-bottom: 8px;
                }
                .session-start-info .info-label {
                    font-size: 0.9rem;
                    color: #6c757d;
                    margin-bottom: 4px;
                }
                .session-start-info .info-value {
                    font-weight: 600;
                    color: #495057;
                }
                .session-checklist {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 10px;
                    margin-top: 20px;
                }
                .checklist-items {
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                    margin-top: 15px;
                }
                .checklist-item {
                    display: flex;
                    align-items: center;
                    padding: 8px 12px;
                    background: white;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: background-color 0.2s;
                }
                .checklist-item:hover {
                    background: #e9ecef;
                }
            </style>
        `;

        if (!document.getElementById('sessionModalStyles')) {
            document.head.insertAdjacentHTML('beforeend', modalStyles.replace('<style>', '<style id="sessionModalStyles">'));
        }
    }

    function beginSession(sessionNumber) {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('sessionModal'));
        modal.hide();

        // Mark session as started
        const sessionCard = document.querySelector(`[data-session="${sessionNumber}"]`);
        if (sessionCard) {
            sessionCard.classList.add('session-started');

            // Update button
            const startButton = sessionCard.querySelector('[onclick*="startSession"]');
            if (startButton) {
                startButton.innerHTML = '<i class="fas fa-check me-1"></i>–í –ø—Ä–æ—Ü–µ—Å—Å–µ';
                startButton.classList.remove('btn-primary');
                startButton.classList.add('btn-success');
            }
        }

        // Show success notification
        showNotification('–°–µ—Å—Å–∏—è –Ω–∞—á–∞—Ç–∞! –£–¥–∞—á–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è! üöÄ', 'success');

        // Optional: Start timer or redirect to study interface
        startSessionTimer(sessionNumber);
    }

    function startSessionTimer(sessionNumber) {
        // This could integrate with a Pomodoro timer or study tracker
        console.log(`Starting timer for session ${sessionNumber}`);

        // Example: Show a floating timer
        const timerHtml = `
            <div id="studyTimer" class="study-timer">
                <div class="timer-content">
                    <div class="timer-icon">‚è±Ô∏è</div>
                    <div class="timer-text">
                        <div class="timer-session">–°–µ—Å—Å–∏—è ${sessionNumber}</div>
                        <div class="timer-time" id="timerDisplay">45:00</div>
                    </div>
                    <button class="timer-close" onclick="closeTimer()">√ó</button>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', timerHtml);

        // Add timer styles
        const timerStyles = `
            <style id="timerStyles">
                .study-timer {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 1050;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 15px;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
                    animation: slideInRight 0.3s ease-out;
                }
                .timer-content {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }
                .timer-icon {
                    font-size: 1.5rem;
                }
                .timer-session {
                    font-size: 0.8rem;
                    opacity: 0.9;
                }
                .timer-time {
                    font-size: 1.2rem;
                    font-weight: bold;
                }
                .timer-close {
                    background: none;
                    border: none;
                    color: white;
                    font-size: 1.2rem;
                    cursor: pointer;
                    opacity: 0.7;
                    margin-left: 10px;
                }
                .timer-close:hover {
                    opacity: 1;
                }
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            </style>
        `;

        if (!document.getElementById('timerStyles')) {
            document.head.insertAdjacentHTML('beforeend', timerStyles);
        }
    }

    function closeTimer() {
        const timer = document.getElementById('studyTimer');
        if (timer) {
            timer.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => timer.remove(), 300);
        }
    }

    function scrollToSession(sessionNumber) {
        const sessionCard = document.querySelector(`[data-session="${sessionNumber}"]`);
        if (sessionCard) {
            sessionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function highlightSession(sessionNumber) {
        // Remove previous highlights
        document.querySelectorAll('.session-card.highlighted').forEach(card => {
            card.classList.remove('highlighted');
        });

        // Add highlight to selected session
        const sessionCard = document.querySelector(`[data-session="${sessionNumber}"]`);
        if (sessionCard) {
            sessionCard.classList.add('highlighted');
            setTimeout(() => {
                sessionCard.classList.remove('highlighted');
            }, 2000);
        }
    }

    // Initialize study plan when tab is shown
    document.getElementById('studyplan-tab').addEventListener('shown.bs.tab', function () {
        setTimeout(initStudyPlan, 100);
    });

    // Add CSS animations for session interactions
    const studyPlanStyles = `
        <style id="studyPlanInteractionStyles">
            @keyframes slideDown {
                from { opacity: 0; max-height: 0; }
                to { opacity: 1; max-height: 1000px; }
            }
            @keyframes slideUp {
                from { opacity: 1; max-height: 1000px; }
                to { opacity: 0; max-height: 0; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .session-card.highlighted {
                transform: scale(1.02);
                box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3) !important;
                border: 2px solid #667eea;
                transition: all 0.3s ease;
            }
            .session-card.session-started {
                border-left: 5px solid #28a745;
            }
            .sessions-container.compact-view .session-details {
                display: none !important;
            }
            .sessions-container.compact-view .session-card {
                margin-bottom: 10px;
            }
            .sessions-container.compact-view .session-header {
                padding: 15px;
            }
        </style>
    `;

    if (!document.getElementById('studyPlanInteractionStyles')) {
        document.head.insertAdjacentHTML('beforeend', studyPlanStyles);
    }

    // Simple direct event delegation for session toggle buttons
    let isToggling = false;

    document.addEventListener('click', function (e) {
        // Check if clicked element is a session toggle button
        if (e.target.closest('.session-toggle-btn')) {
            e.preventDefault();
            e.stopPropagation();

            // Prevent double clicks
            if (isToggling) {
                console.log('Toggle already in progress, ignoring click');
                return;
            }

            const button = e.target.closest('.session-toggle-btn');
            const sessionNumber = button.getAttribute('data-session');

            console.log('Session toggle clicked for session:', sessionNumber);
            isToggling = true;

            toggleSessionDetails(sessionNumber);

            // Reset flag after animation
            setTimeout(() => {
                isToggling = false;
            }, 500);
        }
    });

    // Initialize study plan functionality when page loads
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM loaded, initializing study plan...');
        initStudyPlan();
        initMathSupport();
    });

    // Beautiful Math Support - Enhanced Visual Display
    function initMathSupport() {
        console.log('Initializing beautiful MathJax support...');

        // Wait for MathJax to be ready
        if (window.MathJax && window.MathJax.typesetPromise) {
            processBeautifulMath();
        } else {
            // Listen for MathJax ready event
            document.addEventListener('mathjax-ready', function () {
                console.log('MathJax ready event received');
                processBeautifulMath();
            });

            // Fallback timeout
            setTimeout(() => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    processBeautifulMath();
                } else {
                    console.log('MathJax not available, trying again...');
                    setTimeout(initMathSupport, 2000);
                }
            }, 2000);
        }

        // Also process when tabs are switched
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function () {
                setTimeout(() => {
                    processBeautifulMath();
                }, 500);
            });
        });
    }

    function processBeautifulMath() {
        console.log('Processing math with beautiful MathJax formatting...');

        // Find all text content that might contain math formulas
        const contentElements = document.querySelectorAll(
            '.summary-content-enhanced, .flashcard-question, .answer-content, .accordion-body, .topic-card'
        );

        contentElements.forEach(element => {
            if (element.textContent && !element.classList.contains('math-processed')) {
                element.classList.add('math-processing');

                let content = element.innerHTML;

                // Process LaTeX formulas only (conservative approach)
                content = createBeautifulMathFormulas(content);
                content = conservativeMathDetection(content);

                element.innerHTML = content;
                element.classList.remove('math-processing');
                element.classList.add('math-processed');
            }
        });

        // Re-render math with MathJax
        renderMathWithMathJax();
    }

    // –ü—Ä–æ—Å—Ç–∞—è –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏
    function smartMathDetection(content) {
        console.log('Smart math detection starting...');

        // –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –Ω–∞–π—Ç–∏ —Ü–µ–ª—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –º–∞—Ç–µ–º–∞—Ç–∏–∫–æ–π –∏ –æ–±–µ—Ä–Ω—É—Ç—å –∏—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é

        // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
        const patterns = [
            // –£—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –≥—Ä–µ—á–µ—Å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏ –∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏
            /([^.!?\n]*(?:Œæi|Œªi|œÉ|max|min|exp|sign)[^.!?\n]*[.!?]?)/gi,
            // –í—ã—Ä–∞–∂–µ–Ω–∏—è —Å –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–∞–º–∏ –∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏  
            /([^.!?\n]*(?:[<>=]|[*+\-/]|\^|\|)[^.!?\n]*(?:Œª|œÉ|Œæ|C)[^.!?\n]*[.!?]?)/gi,
            // –§—É–Ω–∫—Ü–∏–∏ –∏ —Ñ–æ—Ä–º—É–ª—ã
            /([^.!?\n]*(?:[a-zA-Z]\([^)]*\)|K\([^)]*\))[^.!?\n]*[.!?]?)/gi
        ];

        patterns.forEach(pattern => {
            content = content.replace(pattern, (match) => {
                const trimmed = match.trim();

                // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –µ—Å–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ
                if (trimmed.includes('<') || trimmed.includes('mjx-') || trimmed.length < 10) {
                    return match;
                }

                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                if (containsMathElements(trimmed)) {
                    console.log('Converting to math:', trimmed);
                    return `$${cleanMathExpression(trimmed)}$`;
                }

                return match;
            });
        });

        return content;
    }

    function containsMathElements(text) {
        const mathIndicators = [
            /[ŒæŒªœÉœÄœÜŒºœâŒ±Œ≤Œ≥Œ¥Œ∏]/i,  // –ì—Ä–µ—á–µ—Å–∫–∏–µ –±—É–∫–≤—ã
            /exp\(|sign\(|max\s|min\s/i,  // –§—É–Ω–∫—Ü–∏–∏
            /[<>=]/,  // –û–ø–µ—Ä–∞—Ç–æ—Ä—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            /\^[0-9]/,  // –°—Ç–µ–ø–µ–Ω–∏
            /_[a-zA-Z0-9]/,  // –ò–Ω–¥–µ–∫—Å—ã
            /\|\|/,  // –ù–æ—Ä–º—ã
            /[*]/  // –£–º–Ω–æ–∂–µ–Ω–∏–µ
        ];

        return mathIndicators.some(pattern => pattern.test(text));
    }

    function cleanMathExpression(text) {
        let cleaned = text;

        // –£–±—Ä–∞—Ç—å —Ç–æ—á–∫–∏ –≤ –∫–æ–Ω—Ü–µ
        cleaned = cleaned.replace(/[.!?]+$/, '');

        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ LaTeX
        cleaned = cleaned.replace(/Œæi/g, '\\xi_i');
        cleaned = cleaned.replace(/Œªi/g, '\\lambda_i');
        cleaned = cleaned.replace(/œÉ¬≤/g, '\\sigma^2');
        cleaned = cleaned.replace(/œÉ/g, '\\sigma');
        cleaned = cleaned.replace(/Œª/g, '\\lambda');
        cleaned = cleaned.replace(/Œº/g, '\\mu');
        cleaned = cleaned.replace(/Œæ/g, '\\xi');
        cleaned = cleaned.replace(/exp\(/g, '\\exp(');
        cleaned = cleaned.replace(/sign\(/g, '\\text{sign}(');
        cleaned = cleaned.replace(/max\s/g, '\\max ');
        cleaned = cleaned.replace(/min\s/g, '\\min ');
        cleaned = cleaned.replace(/\*/g, ' \\cdot ');
        cleaned = cleaned.replace(/\|\|/g, '\\|');
        cleaned = cleaned.replace(/\^2/g, '^2');
        cleaned = cleaned.replace(/\^([0-9]+)/g, '^{$1}');
        cleaned = cleaned.replace(/([0-9]+)\/([0-9]+)/g, '\\frac{$1}{$2}');

        return cleaned;
    }

    // –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –õ–Æ–ë–´–ï —Ñ–æ—Ä–º—É–ª—ã
    function universalMathDetection(content) {
        console.log('Universal math detection starting...');
        
        // –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –Ω–∞–π—Ç–∏ –í–°–ï –≤–æ–∑–º–æ–∂–Ω—ã–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        
        // 1. –°–Ω–∞—á–∞–ª–∞ –∑–∞—â–∏—Ç–∏–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ LaTeX —Ñ–æ—Ä–º—É–ª—ã
        const protectedMath = [];
        content = content.replace(/\$\$([^$]+)\$\$/g, (match) => {
            protectedMath.push(match);
            return `__PROTECTED_DISPLAY_${protectedMath.length - 1}__`;
        });
        content = content.replace(/\$([^$]+)\$/g, (match) => {
            protectedMath.push(match);
            return `__PROTECTED_INLINE_${protectedMath.length - 1}__`;
        });
        
        // 2. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –õ–Æ–ë–´–• –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
        const universalPatterns = [
            // –õ—é–±—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Å –≥—Ä–µ—á–µ—Å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏
            /([^<>\n]*[ŒæŒªœÉŒºœÄœÜœâŒ±Œ≤Œ≥Œ¥Œ∏Œ¶Œ†Œ©ŒõŒîŒìŒíŒë][^<>\n]*)/gi,
            
            // –õ—é–±—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏
            /([^<>\n]*(?:exp|sign|cos|sin|tan|log|ln|sqrt|max|min)\s*\([^)]*\)[^<>\n]*)/gi,
            
            // –õ—é–±—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ –∏ —Å–∏–º–≤–æ–ª–∞–º–∏
            /([^<>\n]*(?:[=<>‚â§‚â•‚â†¬±‚àû‚àë‚àè‚à´]|[*+\-/\^]|[0-9]+\/[0-9]+|\|\|)[^<>\n]*)/gi,
            
            // –õ—é–±—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ –∏ —Å—Ç–µ–ø–µ–Ω—è–º–∏
            /([^<>\n]*[a-zA-Z][_\^][a-zA-Z0-9]+[^<>\n]*)/gi,
            
            // –õ—é–±—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–∫–æ–±–∫–∞—Ö —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
            /([a-zA-Z]\s*\([^)]*[a-zA-Z][^)]*\)\s*[=<>][^<>\n]*)/gi,
            
            // –õ—é–±—ã–µ —á–∏—Å–ª–æ–≤—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏
            /([^<>\n]*[0-9]+\s*[+\-*/\^]\s*[0-9]+[^<>\n]*)/gi
        ];
        
        universalPatterns.forEach((pattern, index) => {
            content = content.replace(pattern, (match) => {
                const trimmed = match.trim();
                
                // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –µ—Å–ª–∏ —É–∂–µ –∑–∞—â–∏—â–µ–Ω–æ –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
                if (trimmed.includes('__PROTECTED_') || trimmed.includes('<') || 
                    trimmed.includes('mjx-') || trimmed.length < 3) {
                    return match;
                }
                
                // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –µ—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç (—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –±—É–∫–≤ –ø–æ–¥—Ä—è–¥)
                if (isPlainText(trimmed)) {
                    return match;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —ç—Ç–æ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
                if (isMathematicalContent(trimmed)) {
                    console.log(`Pattern ${index + 1} found math:`, trimmed);
                    return `$${universalLatexConversion(trimmed)}$`;
                }
                
                return match;
            });
        });
        
        // 3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã
        protectedMath.forEach((formula, index) => {
            content = content.replace(`__PROTECTED_DISPLAY_${index}__`, formula);
            content = content.replace(`__PROTECTED_INLINE_${index}__`, formula);
        });
        
        return content;
    }
    
    function isPlainText(text) {
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –æ–±—ã—á–Ω—ã–º (–Ω–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º)
        const plainTextIndicators = [
            /^[–∞-—è—ëa-z\s]{15,}$/gi,  // –î–ª–∏–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–±—ã—á–Ω—ã—Ö –±—É–∫–≤
            /\b(?:–∏|–≤|–Ω–∞|—Å|–¥–ª—è|–æ—Ç|–ø–æ|–∫|–∏–∑|–ø—Ä–∏|—á—Ç–æ|–∫–∞–∫|–µ—Å–ª–∏|—Ç–æ|–∏–ª–∏|–Ω–æ|–∞|–¥–∞|–Ω–µ—Ç)\b/gi,  // –û–±—ã—á–Ω—ã–µ —Å–ª–æ–≤–∞
            /[.!?]{2,}/,  // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è
        ];
        
        return plainTextIndicators.some(pattern => pattern.test(text));
    }
    
    function isMathematicalContent(text) {
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        const mathScore = [
            /[ŒæŒªœÉŒºœÄœÜœâŒ±Œ≤Œ≥Œ¥Œ∏Œ¶Œ†Œ©ŒõŒîŒìŒíŒë]/.test(text) ? 3 : 0,  // –ì—Ä–µ—á–µ—Å–∫–∏–µ –±—É–∫–≤—ã
            /(?:exp|sign|cos|sin|tan|log|ln|sqrt|max|min)\s*\(/.test(text) ? 3 : 0,  // –§—É–Ω–∫—Ü–∏–∏
            /[=<>‚â§‚â•‚â†¬±‚àû‚àë‚àè‚à´]/.test(text) ? 2 : 0,  // –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
            /[a-zA-Z][_\^][a-zA-Z0-9]/.test(text) ? 2 : 0,  // –ò–Ω–¥–µ–∫—Å—ã/—Å—Ç–µ–ø–µ–Ω–∏
            /\|\|/.test(text) ? 2 : 0,  // –ù–æ—Ä–º—ã
            /[0-9]+\/[0-9]+/.test(text) ? 1 : 0,  // –î—Ä–æ–±–∏
            /[*+\-/\^]/.test(text) ? 1 : 0,  // –ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
        ].reduce((a, b) => a + b, 0);
        
        return mathScore >= 2;  // –ú–∏–Ω–∏–º—É–º 2 –±–∞–ª–ª–∞ –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏
    }
    
    function universalLatexConversion(text) {
        let latex = text;
        
        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ LaTeX
        
        // –ì—Ä–µ—á–µ—Å–∫–∏–µ –±—É–∫–≤—ã (–≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ)
        const greekLetters = {
            'Œ±': '\\alpha', 'Œ≤': '\\beta', 'Œ≥': '\\gamma', 'Œ¥': '\\delta',
            'Œµ': '\\varepsilon', 'Œ∂': '\\zeta', 'Œ∑': '\\eta', 'Œ∏': '\\theta',
            'Œπ': '\\iota', 'Œ∫': '\\kappa', 'Œª': '\\lambda', 'Œº': '\\mu',
            'ŒΩ': '\\nu', 'Œæ': '\\xi', 'Œø': 'o', 'œÄ': '\\pi',
            'œÅ': '\\rho', 'œÉ': '\\sigma', 'œÑ': '\\tau', 'œÖ': '\\upsilon',
            'œÜ': '\\phi', 'œá': '\\chi', 'œà': '\\psi', 'œâ': '\\omega',
            'Œë': 'A', 'Œí': 'B', 'Œì': '\\Gamma', 'Œî': '\\Delta',
            'Œï': 'E', 'Œñ': 'Z', 'Œó': 'H', 'Œò': '\\Theta',
            'Œô': 'I', 'Œö': 'K', 'Œõ': '\\Lambda', 'Œú': 'M',
            'Œù': 'N', 'Œû': '\\Xi', 'Œü': 'O', 'Œ†': '\\Pi',
            'Œ°': 'P', 'Œ£': '\\Sigma', 'Œ§': 'T', 'Œ•': '\\Upsilon',
            'Œ¶': '\\Phi', 'Œß': 'X', 'Œ®': '\\Psi', 'Œ©': '\\Omega'
        };
        
        Object.entries(greekLetters).forEach(([greek, latexCmd]) => {
            latex = latex.replace(new RegExp(greek, 'g'), latexCmd);
        });
        
        // –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
        latex = latex.replace(/\b(exp|sin|cos|tan|log|ln|sqrt|max|min|sign)\s*\(/g, '\\$1(');
        
        // –û–ø–µ—Ä–∞—Ç–æ—Ä—ã
        latex = latex.replace(/‚â§/g, '\\leq');
        latex = latex.replace(/‚â•/g, '\\geq');
        latex = latex.replace(/‚â†/g, '\\neq');
        latex = latex.replace(/¬±/g, '\\pm');
        latex = latex.replace(/‚àû/g, '\\infty');
        latex = latex.replace(/‚àë/g, '\\sum');
        latex = latex.replace(/‚àè/g, '\\prod');
        latex = latex.replace(/‚à´/g, '\\int');
        
        // –ò–Ω–¥–µ–∫—Å—ã –∏ —Å—Ç–µ–ø–µ–Ω–∏
        latex = latex.replace(/([a-zA-Z\\]+)_([a-zA-Z0-9]+)/g, '$1_{$2}');
        latex = latex.replace(/([a-zA-Z\\]+)\^([a-zA-Z0-9]+)/g, '$1^{$2}');
        
        // –î—Ä–æ–±–∏
        latex = latex.replace(/([a-zA-Z0-9\\]+)\/([a-zA-Z0-9\\]+)/g, '\\frac{$1}{$2}');
        
        // –ù–æ—Ä–º—ã
        latex = latex.replace(/\|\|([^|]+)\|\|/g, '\\|$1\\|');
        
        // –£–º–Ω–æ–∂–µ–Ω–∏–µ
        latex = latex.replace(/\*/g, '\\cdot');
        
        // –£–±—Ä–∞—Ç—å –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –≤ –∫–æ–Ω—Ü–µ
        latex = latex.replace(/[.!?]+$/, '').trim();
        
        return latex;
    }

    // –ö–û–ù–°–ï–†–í–ê–¢–ò–í–ù–ê–Ø —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ - —Ç–æ–ª—å–∫–æ –æ—á–µ–≤–∏–¥–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã
    function conservativeMathDetection(content) {
        console.log('Conservative math detection starting...');
        
        // –û—á–µ–Ω—å –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã - —Ç–æ–ª—å–∫–æ —è–≤–Ω—ã–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
        const conservativePatterns = [
            // –¢–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–∞: Œæi = 0, 0 < Œªi < C
            /(\b[ŒæŒªœÉŒº][a-zA-Z0-9]*\s*[=<>]\s*[0-9]+(?:\s*[,;]\s*[0-9]+\s*[<>]\s*[ŒæŒªœÉŒº][a-zA-Z0-9]*\s*[<>]\s*[A-Z])?)/g,
            
            // –¢–æ–ª—å–∫–æ —Ñ—É–Ω–∫—Ü–∏–∏ —Å —è–≤–Ω—ã–º–∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏: exp(-||x||^2)
            /(\b(?:exp|sign|cos|sin|log|max|min)\s*\([^)]*(?:\|\||[ŒæŒªœÉŒºœÄ]|[0-9]+\/[0-9]+)[^)]*\))/gi,
            
            // –¢–æ–ª—å–∫–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Å –Ω–æ—Ä–º–∞–º–∏: ||w||^2
            /(\|\|[a-zA-Z]+\|\|(?:\^[0-9]+)?)/g,
            
            // –¢–æ–ª—å–∫–æ –¥—Ä–æ–±–∏ —Å —á–∏—Å–ª–∞–º–∏: 1/2, 3/4
            /(\b[0-9]+\/[0-9]+\b)/g
        ];
        
        conservativePatterns.forEach((pattern, index) => {
            content = content.replace(pattern, (match) => {
                const trimmed = match.trim();
                
                // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –µ—Å–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
                if (trimmed.includes('<') || trimmed.includes('mjx-') || trimmed.length < 3) {
                    return match;
                }
                
                console.log(`Conservative pattern ${index + 1} found:`, trimmed);
                return `$${cleanMathExpression(trimmed)}$`;
            });
        });
        
        return content;
    }

    // –¢–æ—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ - –∏–∑–±–µ–≥–∞–µ—Ç –æ–±—ã—á–Ω—ã—Ö —Å–ª–æ–≤
    function preciseMathDetection(content) {
        console.log('Precise math detection starting...');

        // –û—á–µ–Ω—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
        const precisePatterns = [
            // –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–∞ —Å –≥—Ä–µ—á–µ—Å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏: Œæi = 0, 0 < Œªi < C
            /([ŒæŒªœÉŒº][a-zA-Z0-9]*\s*[=<>]\s*[0-9.,\s<>ŒæŒªœÉŒºCa-zA-Z]*[,;.]?)/g,
            // –í—ã—Ä–∞–∂–µ–Ω–∏—è —Å max/min –∏ —Å—É–º–º–∞–º–∏: max Œª Œ£(Œªi) - 1/2 Œ£Œ£(...)
            /((?:max|min)\s+[ŒªœÉŒæŒº][^.!?\n]*(?:Œ£|‚àë)[^.!?\n]*)/gi,
            // –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏: exp(-||x||^2)
            /([a-zA-Z]*\s*(?:exp|sign|cos|sin|log)\s*\([^)]*\|\|[^)]*\)[^.!?\n]*)/gi,
            // –§—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å: L(w, b, Œæ, Œª, Œº) = ...
            /([L]\s*\([^)]*[ŒæŒªœÉŒº][^)]*\)\s*=\s*[^.!?\n]*(?:Œ£|‚àë|exp|sign)[^.!?\n]*)/gi,
            // –§—É–Ω–∫—Ü–∏–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏: a(x) = sign(...)
            /([a-zA-Z]\s*\([^)]*\)\s*=\s*(?:sign|exp|cos|sin)\s*\([^.!?\n]*\))/gi,
            // –í—ã—Ä–∞–∂–µ–Ω–∏—è —Å –Ω–æ—Ä–º–∞–º–∏: ||w||^2
            /([^.!?\n]*\|\|[^|]*\|\|(?:\^[0-9])?[^.!?\n]*)/gi
        ];

        precisePatterns.forEach(pattern => {
            content = content.replace(pattern, (match) => {
                const trimmed = match.trim();

                // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –µ—Å–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
                if (trimmed.includes('<') || trimmed.includes('mjx-') || trimmed.length < 5) {
                    return match;
                }

                // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ–±—ã—á–Ω—ã—Ö –±—É–∫–≤ –ø–æ–¥—Ä—è–¥
                if (hasLongWordSequences(trimmed)) {
                    return match;
                }

                console.log('Converting precise math:', trimmed);
                return `$${cleanMathExpression(trimmed)}$`;
            });
        });

        return content;
    }

    function hasLongWordSequences(text) {
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –¥–ª–∏–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–±—ã—á–Ω—ã—Ö –±—É–∫–≤ (–≤–µ—Ä–æ—è—Ç–Ω–æ, —Å–ª–æ–≤–∞)
        const longWordPattern = /[–∞-—è—ëa-z]{8,}/gi;
        const matches = text.match(longWordPattern);
        return matches && matches.length > 0;
    }

    function autoDetectMathExpressions(content) {
        console.log('Auto-detecting math in content:', content.substring(0, 200));

        // Improved math detection - wrap mathematical expressions in MathJax delimiters
        // This will catch expressions like: w(i,x) = Œª(i) exp(-||x - x(i)||^2 / (2œÉ^2))

        // Pattern to match mathematical expressions
        const mathPatterns = [
            // Complex expressions with functions and Greek letters
            /([a-zA-Z]\s*\([^)]+\)\s*=\s*[^.]*(?:[Œ£œÉŒªœÄœÜŒºœâŒ±Œ≤Œ≥Œ¥Œ∏Œ¶Œ†Œ©ŒõŒîŒìŒíŒë]|exp|sign|cos|sin|log|sqrt)[^.]*)/gi,
            // Expressions with Greek letters and mathematical operators
            /([^<>\n]*(?:[Œ£œÉŒªœÄœÜŒºœâŒ±Œ≤Œ≥Œ¥Œ∏Œ¶Œ†Œ©ŒõŒîŒìŒíŒë]|exp|sign|cos|sin|log|sqrt)[^<>\n]*(?:\^[0-9]|_[a-zA-Z0-9]|\|\|)[^<>\n]*)/gi,
            // Simple expressions with powers and subscripts
            /([a-zA-Z]+(?:\^[0-9]+|_[a-zA-Z0-9]+))/g
        ];

        mathPatterns.forEach(pattern => {
            content = content.replace(pattern, (match) => {
                // Skip if already processed or contains HTML
                if (match.includes('<') || match.includes('mjx-') || match.includes('class=') || match.trim().length < 5) {
                    return match;
                }

                // Skip if it's just a single character
                if (match.trim().length < 3) {
                    return match;
                }

                console.log('Found math expression:', match.trim());

                // Convert to proper LaTeX and wrap in MathJax delimiters
                const latexFormula = convertToLatex(match.trim());
                return `$${latexFormula}$`;
            });
        });

        return content;
    }

    function convertToLatex(text) {
        let latex = text;

        // Convert common mathematical expressions to LaTeX

        // Greek letters
        latex = latex.replace(/Œª/g, '\\lambda');
        latex = latex.replace(/œÉ/g, '\\sigma');
        latex = latex.replace(/Œ£/g, '\\sum');
        latex = latex.replace(/œÄ/g, '\\pi');
        latex = latex.replace(/œÜ/g, '\\phi');
        latex = latex.replace(/Œº/g, '\\mu');
        latex = latex.replace(/œâ/g, '\\omega');
        latex = latex.replace(/Œ±/g, '\\alpha');
        latex = latex.replace(/Œ≤/g, '\\beta');
        latex = latex.replace(/Œ≥/g, '\\gamma');
        latex = latex.replace(/Œ¥/g, '\\delta');
        latex = latex.replace(/Œ∏/g, '\\theta');

        // Functions
        latex = latex.replace(/exp\(/g, '\\exp(');
        latex = latex.replace(/sign\(/g, '\\text{sign}(');
        latex = latex.replace(/cos\(/g, '\\cos(');
        latex = latex.replace(/sin\(/g, '\\sin(');
        latex = latex.replace(/log\(/g, '\\log(');
        latex = latex.replace(/sqrt\(/g, '\\sqrt{');

        // Norms and absolute values
        latex = latex.replace(/\|\|([^|]+)\|\|/g, '\\|$1\\|');

        // Powers and subscripts
        latex = latex.replace(/\^([0-9]+)/g, '^{$1}');
        latex = latex.replace(/\^([a-zA-Z])/g, '^{$1}');
        latex = latex.replace(/_([a-zA-Z0-9]+)/g, '_{$1}');

        // Fractions
        latex = latex.replace(/(\d+)\/(\d+)/g, '\\frac{$1}{$2}');
        latex = latex.replace(/([a-zA-Z]+)\/([a-zA-Z0-9]+)/g, '\\frac{$1}{$2}');

        // Special cases for your example
        latex = latex.replace(/w\s*\(\s*i\s*,\s*x\s*\)/g, 'w(i,x)');
        latex = latex.replace(/x\s*-\s*x\s*\(\s*i\s*\)/g, 'x - x(i)');

        return latex;
    }

    function containsMathSymbols(text) {
        // Check if text contains mathematical symbols
        const mathIndicators = [
            /[Œ£œÉŒªœÄœÜŒºœâŒ±Œ≤Œ≥Œ¥Œ∏]/,  // Greek letters
            /\^[0-9]/,           // Powers like ^2
            /[a-zA-Z]_[a-zA-Z0-9]/, // Subscripts like x_i
            /exp\(/,             // Functions like exp(
            /sin\(|cos\(|tan\(/, // Trig functions
            /\|\|/,              // Norms like ||x||
            /sqrt\(/,            // Square root
            /log\(|ln\(/,        // Logarithms
            /sign\(/             // Sign function
        ];

        return mathIndicators.some(pattern => pattern.test(text));
    }

    function beautifyAutoDetectedFormula(formula) {
        let processed = formula;

        // Replace Greek letters
        processed = processed.replace(/Œ£/g, '<span class="math-symbol">Œ£</span>');
        processed = processed.replace(/œÉ/g, '<span class="math-symbol">œÉ</span>');
        processed = processed.replace(/Œª/g, '<span class="math-symbol">Œª</span>');
        processed = processed.replace(/œÄ/g, '<span class="math-symbol">œÄ</span>');
        processed = processed.replace(/œÜ/g, '<span class="math-symbol">œÜ</span>');
        processed = processed.replace(/Œº/g, '<span class="math-symbol">Œº</span>');
        processed = processed.replace(/œâ/g, '<span class="math-symbol">œâ</span>');
        processed = processed.replace(/Œ±/g, '<span class="math-symbol">Œ±</span>');
        processed = processed.replace(/Œ≤/g, '<span class="math-symbol">Œ≤</span>');
        processed = processed.replace(/Œ≥/g, '<span class="math-symbol">Œ≥</span>');
        processed = processed.replace(/Œ¥/g, '<span class="math-symbol">Œ¥</span>');
        processed = processed.replace(/Œ∏/g, '<span class="math-symbol">Œ∏</span>');

        // Replace mathematical functions
        processed = processed.replace(/\b(sin|cos|tan|log|ln|exp|sign)\(/g, '<span class="math-func">$1</span>(');

        // Replace powers
        processed = processed.replace(/\^([0-9]+)/g, '<span class="math-sup">$1</span>');
        processed = processed.replace(/\^2/g, '<span class="math-sup">2</span>');
        processed = processed.replace(/\^3/g, '<span class="math-sup">3</span>');

        // Replace subscripts
        processed = processed.replace(/([a-zA-Z])_([a-zA-Z0-9]+)/g, '$1<span class="math-sub">$2</span>');
        processed = processed.replace(/([a-zA-Z])i/g, '$1<span class="math-sub">i</span>');

        // Replace norms and absolute values
        processed = processed.replace(/\|\|([^|]+)\|\|/g, '<span class="math-symbol">||</span>$1<span class="math-symbol">||</span>');

        // Replace fractions (simple pattern like a/b)
        processed = processed.replace(/([^/\s]+)\s*\/\s*([^/\s]+)/g, (match, num, den) => {
            // Only if it looks like a mathematical fraction
            if (/^[0-9a-zA-Z^_œÉŒªœÄœÜŒºœâŒ±Œ≤Œ≥Œ¥Œ∏Œ£\s]+$/.test(num + den)) {
                return `<span class="math-frac"><span class="numerator">${num.trim()}</span><span class="denominator">${den.trim()}</span></span>`;
            }
            return match;
        });

        // Style parentheses
        processed = processed.replace(/\(/g, '<span class="math-paren">(</span>');
        processed = processed.replace(/\)/g, '<span class="math-paren">)</span>');

        return processed;
    }

    function createBeautifulMathFormulas(content) {
        // Handle display formulas ($$...$$) with beautiful formatting
        content = content.replace(/\$\$([^$]+)\$\$/g, (match, formula) => {
            console.log('Processing formula:', formula);
            return `<div class="math-formula">${beautifyFormula(formula)}</div>`;
        });

        // Handle inline formulas ($...$)
        content = content.replace(/\$([^$]+)\$/g, (match, formula) => {
            return `<span class="math-inline">${beautifyFormula(formula, true)}</span>`;
        });

        return content;
    }

    function beautifyFormula(formula, isInline = false) {
        let processed = formula;

        // Handle fractions with beautiful styling
        processed = processed.replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, (match, num, den) => {
            if (isInline) {
                return `<span class="math-fraction"><sup>${beautifyContent(num)}</sup>‚ÅÑ<sub>${beautifyContent(den)}</sub></span>`;
            } else {
                return `<span class="math-frac"><span class="numerator">${beautifyContent(num)}</span><span class="denominator">${beautifyContent(den)}</span></span>`;
            }
        });

        // Handle parentheses with styling
        processed = processed.replace(/\\left\(/g, '<span class="math-paren">(</span>');
        processed = processed.replace(/\\right\)/g, '<span class="math-paren">)</span>');
        processed = processed.replace(/\\left\[/g, '<span class="math-paren">[</span>');
        processed = processed.replace(/\\right\]/g, '<span class="math-paren">]</span>');
        processed = processed.replace(/\\left\{/g, '<span class="math-paren">{</span>');
        processed = processed.replace(/\\right\}/g, '<span class="math-paren">}</span>');

        // Handle mathematical functions
        processed = processed.replace(/\\?(sin|cos|tan|log|ln|exp|sign)\b/g, '<span class="math-func">$1</span>');

        // Handle Greek letters with beautiful styling
        const greekReplacements = [
            ['\\\\sum', '<span class="math-symbol">Œ£</span>'],
            ['\\\\Sigma', '<span class="math-symbol">Œ£</span>'],
            ['\\\\lambda', '<span class="math-symbol">Œª</span>'],
            ['\\\\sigma', '<span class="math-symbol">œÉ</span>'],
            ['\\\\pi', '<span class="math-symbol">œÄ</span>'],
            ['\\\\alpha', '<span class="math-symbol">Œ±</span>'],
            ['\\\\beta', '<span class="math-symbol">Œ≤</span>'],
            ['\\\\gamma', '<span class="math-symbol">Œ≥</span>'],
            ['\\\\delta', '<span class="math-symbol">Œ¥</span>'],
            ['\\\\phi', '<span class="math-symbol">œÜ</span>'],
            ['\\\\Phi', '<span class="math-symbol">Œ¶</span>'],
            ['\\\\mu', '<span class="math-symbol">Œº</span>'],
            ['\\\\omega', '<span class="math-symbol">œâ</span>'],
            ['\\\\theta', '<span class="math-symbol">Œ∏</span>']
        ];

        greekReplacements.forEach(([pattern, replacement]) => {
            processed = processed.replace(new RegExp(pattern, 'g'), replacement);
        });

        // Handle superscripts and subscripts with beautiful styling
        processed = processed.replace(/([a-zA-Z0-9]+)\^([a-zA-Z0-9]+)/g, '$1<span class="math-sup">$2</span>');
        processed = processed.replace(/([a-zA-Z0-9]+)_([a-zA-Z0-9]+)/g, '$1<span class="math-sub">$2</span>');

        // Handle special cases
        processed = processed.replace(/\^2/g, '<span class="math-sup">2</span>');
        processed = processed.replace(/\^3/g, '<span class="math-sup">3</span>');
        processed = processed.replace(/_i/g, '<span class="math-sub">i</span>');
        processed = processed.replace(/_j/g, '<span class="math-sub">j</span>');

        // Handle mathematical operators
        processed = processed.replace(/\|\|/g, '<span class="math-symbol">||</span>');
        processed = processed.replace(/\*/g, '<span class="math-symbol">¬∑</span>');

        return processed;
    }

    function beautifyContent(content) {
        // Process content inside fractions, superscripts, etc.
        let processed = content;

        // Greek letters (simple replacements)
        const simpleGreek = [
            ['\\sum', 'Œ£'], ['\\lambda', 'Œª'], ['\\sigma', 'œÉ'], ['\\pi', 'œÄ'],
            ['\\alpha', 'Œ±'], ['\\beta', 'Œ≤'], ['\\gamma', 'Œ≥'], ['\\delta', 'Œ¥'],
            ['\\phi', 'œÜ'], ['\\Phi', 'Œ¶'], ['\\mu', 'Œº'], ['\\omega', 'œâ']
        ];

        simpleGreek.forEach(([latex, symbol]) => {
            processed = processed.replace(new RegExp(latex, 'g'), symbol);
        });

        // Subscripts and superscripts
        processed = processed.replace(/([a-zA-Z0-9]+)_([a-zA-Z0-9]+)/g, '$1<sub>$2</sub>');
        processed = processed.replace(/([a-zA-Z0-9]+)\^([a-zA-Z0-9]+)/g, '$1<sup>$2</sup>');
        processed = processed.replace(/\^2/g, '¬≤');
        processed = processed.replace(/\^3/g, '¬≥');
        processed = processed.replace(/_i/g, '·µ¢');
        processed = processed.replace(/_j/g, '‚±º');

        return processed;

        // Wait for KaTeX to be ready
        if (window.katex && window.renderMathInElement) {
            processMathFormulas();
        } else {
            // Wait for KaTeX to load
            setTimeout(() => {
                if (window.katex && window.renderMathInElement) {
                    processMathFormulas();
                } else {
                    console.log('KaTeX not available, trying again...');
                    setTimeout(initMathSupport, 1000);
                }
            }, 1000);
        }
    }

    function processMathFormulas() {
        console.log('Processing math formulas with advanced recognition...');

        // Find all text content that might contain math formulas
        const contentElements = document.querySelectorAll(
            '.summary-content-enhanced, .flashcard-question, .answer-content, .accordion-body, .topic-card'
        );

        contentElements.forEach(element => {
            if (element.textContent && !element.classList.contains('math-processed')) {
                element.classList.add('math-processing');

                let content = element.innerHTML;

                // Advanced Wolfram-style pattern matching
                content = enhanceMathContentAdvanced(content);

                element.innerHTML = content;
                element.classList.remove('math-processing');
                element.classList.add('math-processed');
            }
        });

        // Render math with MathJax
        renderMathWithMathJax();
    }

    function enhanceMathContentAdvanced(content) {
        // Protect existing math expressions
        const mathExpressions = [];
        content = content.replace(/\$\$([^$]+)\$\$/g, (match) => {
            mathExpressions.push(match);
            return `__MATH_DISPLAY_${mathExpressions.length - 1}__`;
        });
        content = content.replace(/\$([^$]+)\$/g, (match) => {
            mathExpressions.push(match);
            return `__MATH_INLINE_${mathExpressions.length - 1}__`;
        });

        // Advanced mathematical pattern recognition (Wolfram-style)
        const advancedPatterns = [
            // Complex functions like œÜ(x) = (1/‚àön)(cos(w1^{T} x), ..., cos(wn^{T} x), sin(w1^{T} x), ..., sin(wn^{T} x))
            {
                pattern: /([œÜœïŒ¶])\s*\(\s*([^)]+)\)\s*=\s*\(([^)]+)\)\s*\\\s*\(([^)]+)\)/g,
                replacement: '$$\\$1($2) = \\left(\\frac{1}{\\sqrt{n}}\\right)\\left(\\cos(w_1^T x), \\ldots, \\cos(w_n^T x), \\sin(w_1^T x), \\ldots, \\sin(w_n^T x)\\right)$$'
            },
            // Functions with equals like K(x, z) = ...
            {
                pattern: /([A-Za-zœÜœïŒ¶]+)\s*\(\s*([^)]+)\)\s*=\s*([^.]+\.[^.]*)/g,
                replacement: (match, func, args, expr) => {
                    // Clean up the expression
                    let cleanExpr = expr.replace(/\.$/, ''); // Remove trailing dot
                    cleanExpr = processComplexExpression(cleanExpr);
                    return `$$${func}(${args}) = ${cleanExpr}$$`;
                }
            },
            // Fractions with square root like 1/‚àön
            {
                pattern: /(\d+)\/‚àö([a-zA-Z]+)/g,
                replacement: '\\frac{$1}{\\sqrt{$2}}'
            },
            // Regular fractions
            {
                pattern: /(\d+)\/([a-zA-Z]+)/g,
                replacement: '\\frac{$1}{$2}'
            },
            // Powers with braces like w1^{T}
            {
                pattern: /([a-zA-Z0-9]+)\^\{([^}]+)\}/g,
                replacement: '$1^{$2}'
            },
            // Simple powers like w1^T
            {
                pattern: /([a-zA-Z0-9]+)\^([A-Za-z])/g,
                replacement: '$1^{$2}'
            },
            // Subscripts like w_j
            {
                pattern: /([a-zA-Z]+)_([a-zA-Z0-9]+)/g,
                replacement: '$1_{$2}'
            },
            // Greek letters
            {
                pattern: /\bphi\b/g,
                replacement: '\\phi'
            },
            {
                pattern: /\bPhi\b/g,
                replacement: '\\Phi'
            },
            {
                pattern: /\bSigma\b/g,
                replacement: '\\Sigma'
            },
            {
                pattern: /\bsum\b/g,
                replacement: '\\sum'
            },
            // Trigonometric functions
            {
                pattern: /\\cos\(/g,
                replacement: '\\cos('
            },
            {
                pattern: /\\sin\(/g,
                replacement: '\\sin('
            },
            {
                pattern: /\bcos\(/g,
                replacement: '\\cos('
            },
            {
                pattern: /\bsin\(/g,
                replacement: '\\sin('
            },
            // Mathematical operators
            {
                pattern: /\*\s*/g,
                replacement: ' \\cdot '
            },
            {
                pattern: /\+\/-/g,
                replacement: '\\pm'
            },
            {
                pattern: /<=/g,
                replacement: '\\leq'
            },
            {
                pattern: />=/g,
                replacement: '\\geq'
            },
            {
                pattern: /!=/g,
                replacement: '\\neq'
            },
            // Ellipsis
            {
                pattern: /\.\.\./g,
                replacement: '\\ldots'
            },
            {
                pattern: /,\s*\.\.\.\s*,/g,
                replacement: ', \\ldots, '
            }
        ];

        // Apply advanced patterns
        advancedPatterns.forEach(({ pattern, replacement }) => {
            if (typeof replacement === 'function') {
                content = content.replace(pattern, replacement);
            } else {
                content = content.replace(pattern, replacement);
            }
        });

        // Restore protected math expressions
        mathExpressions.forEach((expr, index) => {
            content = content.replace(`__MATH_DISPLAY_${index}__`, expr);
            content = content.replace(`__MATH_INLINE_${index}__`, expr);
        });

        return content;
    }

    function processComplexExpression(expr) {
        // Process complex mathematical expressions
        let processed = expr;

        // Handle parentheses with fractions
        processed = processed.replace(/\(([^)]+)\/([^)]+)\)/g, '\\left(\\frac{$1}{$2}\\right)');

        // Handle Œ£ summation
        processed = processed.replace(/Œ£/g, '\\sum');

        // Handle multiplication
        processed = processed.replace(/\s*\*\s*/g, ' \\cdot ');

        // Handle trigonometric functions
        processed = processed.replace(/cos\(/g, '\\cos(');
        processed = processed.replace(/sin\(/g, '\\sin(');

        // Handle subscripts and superscripts
        processed = processed.replace(/([a-zA-Z]+)_([a-zA-Z0-9]+)/g, '$1_{$2}');
        processed = processed.replace(/([a-zA-Z0-9]+)\^([A-Za-z])/g, '$1^{$2}');

        // Handle square root
        processed = processed.replace(/‚àö([a-zA-Z]+)/g, '\\sqrt{$1}');

        return processed;
    }

    function renderMathWithMathJax() {
        if (window.MathJax && window.MathJax.typesetPromise) {
            try {
                // Get all processed elements
                const processedElements = document.querySelectorAll('.math-processed');

                if (processedElements.length > 0) {
                    // Re-render math in processed elements
                    window.MathJax.typesetPromise(processedElements).then(() => {
                        console.log('Math formulas rendered successfully with MathJax');
                        addMathInteractivity();
                    }).catch((error) => {
                        console.error('MathJax rendering error:', error);
                    });
                } else {
                    // Render all math on the page
                    window.MathJax.typesetPromise().then(() => {
                        console.log('Math formulas rendered successfully with MathJax');
                        addMathInteractivity();
                    }).catch((error) => {
                        console.error('MathJax rendering error:', error);
                    });
                }
            } catch (error) {
                console.error('MathJax rendering error:', error);
            }
        }
    }

    function addMathInteractivity() {
        // Add click handlers to MathJax expressions for copying
        document.querySelectorAll('mjx-container[jax="CHTML"]').forEach(mathElement => {
            mathElement.style.cursor = 'pointer';
            mathElement.title = '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É–ª—É';

            mathElement.addEventListener('click', function () {
                // Try to get the original LaTeX source
                const mathText = this.getAttribute('data-mjx-texclass') || this.textContent || this.innerText;
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(mathText);
                    showToast('–§–æ—Ä–º—É–ª–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
                }
            });
        });

        // Add hover effects to math expressions
        document.querySelectorAll('mjx-container[jax="CHTML"]').forEach(mathElement => {
            mathElement.addEventListener('mouseenter', function () {
                this.style.filter = 'brightness(1.1)';
            });

            mathElement.addEventListener('mouseleave', function () {
                this.style.filter = 'brightness(1)';
            });
        });
    }

    // Additional utility functions that might be called from HTML
    function expandAll() {
        document.querySelectorAll('.accordion-collapse').forEach(el => {
            new bootstrap.Collapse(el, { show: true });
        });
    }

    function collapseAll() {
        document.querySelectorAll('.accordion-collapse').forEach(el => {
            new bootstrap.Collapse(el, { hide: true });
        });
    }

    function filterCards(type) {
        const cards = document.querySelectorAll('.flashcard-advanced');
        cards.forEach(card => {
            if (type === 'all' || card.dataset.type === type) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    function searchCards() {
        const searchTerm = document.getElementById('cardSearch')?.value.toLowerCase() || '';
        const cards = document.querySelectorAll('.flashcard-advanced');
        
        cards.forEach(card => {
            const question = card.querySelector('.flashcard-question')?.textContent.toLowerCase() || '';
            const answer = card.querySelector('.answer-text')?.textContent.toLowerCase() || '';
            
            if (question.includes(searchTerm) || answer.includes(searchTerm)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    function startStudySession() {
        showToast('–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º –∏–∑—É—á–µ–Ω–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏', 'info');
    }

    function startSession(sessionNumber) {
        showToast(`–ù–∞—á–∏–Ω–∞–µ–º —Å–µ—Å—Å–∏—é ${sessionNumber}`, 'info');
    }

    function seekToTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        showToast(`–ü–µ—Ä–µ—Ö–æ–¥ –∫ ${minutes}:${remainingSeconds.toString().padStart(2, '0')}`, 'info');
    }

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing application...');
        
        // Initialize math support
        if (typeof initMathSupport === 'function') {
            initMathSupport();
        }
        
        // Initialize study plan if on that tab
        if (typeof initStudyPlan === 'function') {
            initStudyPlan();
        }
        
        // Load progress data
        if (typeof loadProgress === 'function') {
            loadProgress();
        }
        
        console.log('Application initialized successfully');
    });

</script>
{% endblock %}