{% extends "base.html" %}

{% block title %}AI-конспект Pro - Результаты анализа{% endblock %}

{% block extra_styles %}
<style>
    /* Убираем градиентный фон с навигации и возвращаем обычный белый */
    .navbar {
        background: white !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .navbar-brand,
    .navbar-brand strong,
    .nav-link,
    .navbar-nav .nav-link,
    .dropdown-toggle {
        color: #374151 !important;
    }
    
    .navbar-brand:hover,
    .nav-link:hover,
    .navbar-nav .nav-link:hover,
    .dropdown-toggle:hover {
        color: #6366f1 !important;
    }
    
    .badge.bg-warning {
        background-color: #fbbf24 !important;
        color: #92400e !important;
    }
    /* Равномерное распределение вкладок */
    #resultTabs {
        display: flex;
        justify-content: space-between;
        width: 100%;
    }

    #resultTabs .nav-item {
        flex: 1;
        text-align: center;
    }

    #resultTabs .nav-link {
        width: 100%;
        text-align: center;
        white-space: nowrap;
        padding: 12px 8px;
        font-size: 0.9rem;
        border-radius: 25px;
        transition: all 0.3s ease;
    }

    /* Адаптивность для мобильных устройств */
    @media (max-width: 768px) {
        #resultTabs .nav-link {
            font-size: 0.8rem;
            padding: 10px 6px;
        }
        
        #resultTabs .nav-link i {
            display: block;
            margin-bottom: 4px;
            margin-right: 0 !important;
        }
        
        #resultTabs .nav-link .badge {
            display: block;
            margin-top: 2px;
            margin-left: 0 !important;
        }
    }

    @media (max-width: 576px) {
        #resultTabs .nav-link {
            font-size: 0.7rem;
            padding: 8px 4px;
        }
    }

    .quality-badge {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: bold;
        color: white;
    }

    .quality-excellent {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .quality-good {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .quality-fair {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .topic-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }

    .topic-card:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .subtopic {
        padding: 8px 15px;
        background: #f8f9fa;
        border-left: 3px solid #dee2e6;
        margin: 5px 0 5px 20px;
        font-size: 0.9rem;
    }

    .concept-badge {
        display: inline-block;
        padding: 5px 12px;
        background: #e9ecef;
        border-radius: 15px;
        margin: 2px;
        font-size: 0.85rem;
    }

    /* Enhanced Relationship Styles */
    .relationship-item {
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border: 2px solid #e2e8f0;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 16px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .relationship-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-radius: 2px 0 0 2px;
    }

    .relationship-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
        border-color: #6366f1;
    }

    .relationship-from .badge,
    .relationship-to .badge {
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 500;
        white-space: normal;
        max-width: none;
        display: inline-block;
        line-height: 1.4;
        box-shadow: 0 2px 8px rgba(100, 116, 139, 0.3);
    }

    .relationship-to .badge {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .relationship-type .badge {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
        white-space: normal;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .relationship-arrow {
        color: #6366f1;
        font-size: 1.2rem;
        margin: 0 8px;
        transition: all 0.3s ease;
    }

    .relationship-item:hover .relationship-arrow {
        transform: scale(1.2);
        color: #8b5cf6;
    }

    /* Compact Relationships Styles */
    .relationships-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 20px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .relationship-flow {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-bottom: 16px;
        padding: 12px 16px;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
        flex-wrap: wrap;
    }

    .relationship-flow:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.1);
        border-color: #6366f1;
    }

    .relationship-flow:last-child {
        margin-bottom: 0;
    }

    .rel-from,
    .rel-to {
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 10px;
        font-size: 0.85rem;
        font-weight: 500;
        white-space: normal;
        word-wrap: break-word;
        line-height: 1.4;
        text-align: center;
        min-width: 80px;
        max-width: 300px;
        flex: 1;
        box-shadow: 0 2px 6px rgba(100, 116, 139, 0.2);
    }

    .rel-to {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 2px 6px rgba(16, 185, 129, 0.2);
    }

    .rel-type {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 10px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: normal;
        word-wrap: break-word;
        line-height: 1.4;
        text-align: center;
        min-width: 60px;
        max-width: 200px;
        flex-shrink: 0;
        box-shadow: 0 2px 6px rgba(99, 102, 241, 0.2);
    }

    .rel-arrow {
        color: #6366f1;
        font-size: 1rem;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .relationship-flow:hover .rel-arrow {
        transform: scale(1.2);
        color: #8b5cf6;
    }

    @media (max-width: 768px) {
        .relationships-container {
            padding: 16px;
        }

        .relationship-flow {
            flex-direction: column;
            gap: 8px;
            padding: 16px 12px;
            text-align: center;
        }

        .rel-from,
        .rel-to,
        .rel-type {
            max-width: none;
            width: 100%;
            text-align: center;
        }

        .rel-arrow {
            transform: rotate(90deg);
            font-size: 0.9rem;
        }

        .relationship-flow:hover .rel-arrow {
            transform: rotate(90deg) scale(1.1);
        }
    }

    @media (max-width: 576px) {
        .rel-from,
        .rel-to {
            font-size: 0.8rem;
            padding: 5px 10px;
        }

        .rel-type {
            font-size: 0.75rem;
            padding: 5px 10px;
        }

        .relationship-flow {
            padding: 12px 8px;
            margin-bottom: 12px;
        }
    }

    .flashcard-advanced {
        border: none;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* Enhanced Flashcard Statistics Styles */
    .flashcards-stats {
        margin-bottom: 2rem;
    }

    .stat-card-modern {
        background: white;
        border-radius: 20px;
        padding: 25px 20px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
        border: 2px solid transparent;
        height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .stat-card-modern:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .stat-card-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--card-gradient));
        border-radius: 20px 20px 0 0;
    }

    .stat-icon-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 50px;
        height: 50px;
        border-radius: 15px;
        background: linear-gradient(135deg, var(--card-gradient));
        margin-bottom: 15px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
    }

    .stat-card-modern:hover .stat-icon-wrapper {
        transform: rotate(10deg) scale(1.1);
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
    }

    .stat-icon {
        font-size: 1.5rem;
        color: white;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .stat-content {
        flex-grow: 1;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 800;
        color: #2c3e50;
        line-height: 1;
        margin-bottom: 5px;
        background: linear-gradient(135deg, var(--card-gradient));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stat-label {
        font-size: 0.9rem !important;
        font-weight: 900 !important;
        color: #000000 !important;
        text-transform: uppercase !important;
        letter-spacing: 1px !important;
        margin-bottom: 10px !important;
        opacity: 1 !important;
        visibility: visible !important;
        display: block !important;
        text-shadow: none !important;
        background: rgba(255, 255, 255, 0.9) !important;
        padding: 2px 4px !important;
        border-radius: 4px !important;
    }

    .stat-progress {
        height: 6px;
        background: #f1f5f9;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }

    .progress-bar {
        height: 100%;
        border-radius: 10px;
        background: linear-gradient(90deg, var(--card-gradient));
        transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    /* Individual card color schemes */
    .mastered-card {
        --card-gradient: #10b981, #059669;
        border-color: rgba(16, 185, 129, 0.2);
    }

    .mastered-card:hover {
        border-color: #10b981;
        box-shadow: 0 20px 40px rgba(16, 185, 129, 0.2);
    }

    .review-card {
        --card-gradient: #f59e0b, #d97706;
        border-color: rgba(245, 158, 11, 0.2);
    }

    .review-card:hover {
        border-color: #f59e0b;
        box-shadow: 0 20px 40px rgba(245, 158, 11, 0.2);
    }

    .new-card {
        --card-gradient: #06b6d4, #0891b2;
        border-color: rgba(6, 182, 212, 0.2);
    }

    .new-card:hover {
        border-color: #06b6d4;
        box-shadow: 0 20px 40px rgba(6, 182, 212, 0.2);
    }

    .progress-card {
        --card-gradient: #6366f1, #4f46e5;
        border-color: rgba(99, 102, 241, 0.2);
    }

    .progress-card:hover {
        border-color: #6366f1;
        box-shadow: 0 20px 40px rgba(99, 102, 241, 0.2);
    }

    /* Responsive design for stats */
    @media (max-width: 768px) {
        .stat-card-modern {
            height: 120px;
            padding: 20px 15px;
        }

        .stat-number {
            font-size: 2rem;
        }

        .stat-icon-wrapper {
            width: 40px;
            height: 40px;
            margin-bottom: 10px;
        }

        .stat-icon {
            font-size: 1.2rem;
        }

        .stat-label {
            font-size: 0.7rem;
        }
    }

    @media (max-width: 576px) {
        .flashcards-stats .row {
            gap: 15px;
        }

        .stat-card-modern {
            height: 100px;
            padding: 15px 12px;
        }

        .stat-number {
            font-size: 1.8rem;
        }

        .stat-label {
            font-size: 0.65rem;
        }
    }

    /* Enhanced Flashcards Controls Styles */
    .flashcards-controls-modern {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* Search Section */
    .search-section {
        margin-bottom: 20px;
    }

    .search-container {
        display: flex;
        justify-content: center;
        max-width: 500px;
        margin: 0 auto;
    }

    .search-input-wrapper {
        position: relative;
        width: 100%;
        display: flex;
        align-items: center;
        background: #f8f9fa;
        border-radius: 25px;
        padding: 0 20px;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .search-input-wrapper:focus-within {
        background: white;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 0 4px 20px rgba(0, 0, 0, 0.1);
        border-color: #6366f1;
        transform: translateY(-2px);
    }

    .search-icon {
        color: #9ca3af;
        font-size: 1.1rem;
        margin-right: 12px;
        transition: color 0.3s ease;
    }

    .search-input-wrapper:focus-within .search-icon {
        color: #6366f1;
    }

    .search-input {
        flex: 1;
        border: none;
        background: transparent;
        padding: 15px 0;
        font-size: 1rem;
        color: #374151;
        outline: none;
        font-weight: 500;
    }

    .search-input::placeholder {
        color: #9ca3af;
        font-weight: 400;
    }

    .search-clear-btn {
        background: none;
        border: none;
        color: #9ca3af;
        font-size: 1rem;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: all 0.3s ease;
        margin-left: 8px;
    }

    .search-clear-btn:hover {
        background: #f3f4f6;
        color: #6b7280;
        transform: scale(1.1);
    }

    /* Filters Section */
    .filters-section {
        border-top: 1px solid #f1f5f9;
        padding-top: 20px;
    }

    .filters-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
    }

    .filter-group {
        flex: 1;
        min-width: 300px;
    }

    .filter-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
    }

    .filter-pill {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 500;
        color: #64748b;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .filter-pill::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transition: left 0.5s ease;
    }

    .filter-pill:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border-color: #cbd5e1;
    }

    .filter-pill:hover::before {
        left: 100%;
    }

    .filter-pill.active {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-color: #6366f1;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
    }

    .filter-pill.active:hover {
        background: linear-gradient(135deg, #5b21b6 0%, #7c3aed 100%);
        box-shadow: 0 12px 30px rgba(99, 102, 241, 0.4);
    }

    .filter-pill i {
        font-size: 1rem;
        transition: transform 0.3s ease;
    }

    .filter-pill:hover i {
        transform: scale(1.1);
    }

    .filter-pill.active i {
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    /* Control Group */
    .control-group {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .sort-dropdown {
        position: relative;
    }

    .sort-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 18px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 15px;
        font-size: 0.9rem;
        font-weight: 500;
        color: #64748b;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 140px;
        justify-content: space-between;
    }

    .sort-btn:hover {
        border-color: #cbd5e1;
        background: #f8fafc;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .sort-btn:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .dropdown-menu {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        padding: 8px;
        margin-top: 8px;
        min-width: 200px;
    }

    .dropdown-item {
        border-radius: 10px;
        padding: 10px 15px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
    }

    .dropdown-item:hover {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        transform: translateX(5px);
    }

    .view-controls {
        display: flex;
        gap: 6px;
    }

    .view-btn {
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        color: #64748b;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
    }

    .view-btn:hover {
        border-color: #6366f1;
        color: #6366f1;
        background: #f8fafc;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
    }

    .view-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    /* Results Counter */
    .results-counter {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #f1f5f9;
        text-align: center;
    }

    .counter-text {
        font-size: 0.9rem;
        color: #64748b;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .counter-text i {
        color: #6366f1;
    }

    /* Responsive Design for Controls */
    @media (max-width: 1024px) {
        .filters-row {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }

        .filter-group {
            min-width: auto;
        }

        .control-group {
            justify-content: space-between;
            width: 100%;
        }
    }

    @media (max-width: 768px) {
        .flashcards-controls-modern {
            padding: 20px;
            border-radius: 15px;
        }

        .search-container {
            max-width: none;
        }

        .search-input-wrapper {
            padding: 0 15px;
        }

        .search-input {
            padding: 12px 0;
            font-size: 0.95rem;
        }

        .filter-pills {
            justify-content: center;
        }

        .filter-pill {
            padding: 8px 12px;
            font-size: 0.85rem;
        }

        .filter-pill span {
            display: none;
        }

        .filter-pill i {
            margin: 0;
        }

        .control-group {
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .sort-btn {
            width: 100%;
            justify-content: center;
        }

        .view-controls {
            justify-content: center;
            width: 100%;
        }

        .view-btn {
            flex: 1;
            max-width: 60px;
        }
    }

    @media (max-width: 576px) {
        .flashcards-controls-modern {
            padding: 15px;
            margin-bottom: 1.5rem;
        }

        .search-section {
            margin-bottom: 15px;
        }

        .filters-section {
            padding-top: 15px;
        }

        .filter-pill {
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .sort-btn {
            padding: 10px 15px;
            font-size: 0.85rem;
        }

        .view-btn {
            width: 40px;
            height: 40px;
            font-size: 0.9rem;
        }

        .results-counter {
            margin-top: 15px;
            padding-top: 12px;
        }

        .counter-text {
            font-size: 0.85rem;
        }
    }

    /* Animation for filter changes */
    @keyframes filterChange {
        0% {
            opacity: 0;
            transform: translateY(10px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .flashcards-container {
        animation: filterChange 0.3s ease-out;
    }

    /* Enhanced Interactive Buttons Styles */
    .btn-interactive-study,
    .btn-test-mode {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 18px 25px;
        border-radius: 20px;
        text-decoration: none;
        color: white;
        font-weight: 600;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        min-width: 280px;
        backdrop-filter: blur(10px);
    }

    .btn-interactive-study {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: 2px solid rgba(102, 126, 234, 0.3);
    }

    .btn-test-mode {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        border: 2px solid rgba(17, 153, 142, 0.3);
    }

    .btn-interactive-study:hover,
    .btn-test-mode:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
        color: white;
        text-decoration: none;
    }

    .btn-interactive-study:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        border-color: #667eea;
    }

    .btn-test-mode:hover {
        background: linear-gradient(135deg, #0f7b6c 0%, #2dd4bf 100%);
        border-color: #11998e;
    }

    .btn-interactive-study:active,
    .btn-test-mode:active {
        transform: translateY(-2px) scale(0.98);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .btn-icon-wrapper {
        position: relative;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        backdrop-filter: blur(10px);
        box-shadow: inset 0 2px 10px rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }

    .btn-interactive-study:hover .btn-icon-wrapper,
    .btn-test-mode:hover .btn-icon-wrapper {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(10deg) scale(1.1);
        box-shadow: inset 0 2px 15px rgba(255, 255, 255, 0.2);
    }

    .btn-icon-wrapper i {
        font-size: 1.5rem;
        color: white;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        transition: all 0.3s ease;
    }

    .btn-sparkle,
    .btn-pulse {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 15px;
        pointer-events: none;
    }

    .btn-sparkle {
        background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.4) 0%, transparent 50%);
        animation: sparkle 2s ease-in-out infinite;
    }

    .btn-pulse {
        background: radial-gradient(circle at center, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes sparkle {
        0%, 100% {
            opacity: 0;
            transform: scale(0.8) rotate(0deg);
        }
        50% {
            opacity: 1;
            transform: scale(1.2) rotate(180deg);
        }
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 0.3;
            transform: scale(1);
        }
        50% {
            opacity: 0.8;
            transform: scale(1.1);
        }
    }

    .btn-content {
        flex: 1;
        text-align: left;
    }

    .btn-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 4px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        line-height: 1.2;
    }

    .btn-subtitle {
        font-size: 0.85rem;
        opacity: 0.9;
        font-weight: 400;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        line-height: 1.3;
    }

    .btn-badge {
        position: absolute;
        top: 1px;
        right: 4px;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        font-size: 0.7rem;
        font-weight: 800;
        padding: 4px 8px;
        border-radius: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 
            0 4px 15px rgba(255, 107, 107, 0.5),
            0 2px 8px rgba(0, 0, 0, 0.3);
        animation: badgeBounce 2s ease-in-out infinite;
        border: 2px solid rgba(255, 255, 255, 1);
        min-width: 48px;
        text-align: center;
        white-space: nowrap;
        z-index: 25;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 24px;
    }

    @keyframes badgeBounce {
        0%, 100% {
            transform: scale(1) rotate(-3deg);
        }
        50% {
            transform: scale(1.1) rotate(3deg);
        }
    }

    .secondary-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .btn-secondary {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 18px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 15px;
        color: #64748b;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .btn-secondary:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
        color: #475569;
        text-decoration: none;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .btn-secondary:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Responsive Design for Enhanced Buttons */
    @media (max-width: 1024px) {
        .btn-interactive-study,
        .btn-test-mode {
            min-width: 250px;
            padding: 16px 20px;
        }

        .btn-title {
            font-size: 1rem;
        }

        .btn-subtitle {
            font-size: 0.8rem;
        }

        .btn-icon-wrapper {
            width: 45px;
            height: 45px;
        }

        .btn-icon-wrapper i {
            font-size: 1.3rem;
        }

        .btn-badge {
            top: -12px;
            right: -12px;
            font-size: 0.75rem;
            padding: 6px 10px;
            min-width: 55px;
            height: 28px;
            border-radius: 16px;
        }
    }

    @media (max-width: 768px) {
        .btn-interactive-study,
        .btn-test-mode {
            min-width: 220px;
            padding: 14px 18px;
            flex-direction: column;
            text-align: center;
            gap: 12px;
        }

        .btn-content {
            text-align: center;
        }

        .btn-title {
            font-size: 0.95rem;
        }

        .btn-subtitle {
            font-size: 0.75rem;
        }

        .btn-icon-wrapper {
            width: 40px;
            height: 40px;
        }

        .btn-icon-wrapper i {
            font-size: 1.2rem;
        }

        .secondary-buttons {
            width: 100%;
            justify-content: center;
            margin-top: 10px;
        }

        .btn-secondary {
            flex: 1;
            justify-content: center;
            min-width: 120px;
        }
    }

    @media (max-width: 576px) {
        .btn-interactive-study,
        .btn-test-mode {
            min-width: 200px;
            padding: 12px 15px;
            gap: 10px;
        }

        .btn-title {
            font-size: 0.9rem;
        }

        .btn-subtitle {
            font-size: 0.7rem;
        }

        .btn-icon-wrapper {
            width: 35px;
            height: 35px;
        }

        .btn-icon-wrapper i {
            font-size: 1.1rem;
        }

        .btn-badge {
            font-size: 0.7rem;
            padding: 5px 9px;
            top: -10px;
            right: -10px;
            min-width: 50px;
            height: 26px;
            border-radius: 14px;
            border: 2px solid rgba(255, 255, 255, 0.6);
        }

        .secondary-buttons {
            flex-direction: column;
            width: 100%;
            gap: 8px;
        }

        .btn-secondary {
            width: 100%;
            justify-content: center;
        }
    }

    /* Enhanced Button Layout Styles */
    .buttons-layout {
        display: flex;
        flex-direction: column;
        gap: 20px;
        align-items: center;
        width: 100%;
    }

    .primary-buttons-row {
        display: flex;
        gap: 20px;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        width: 100%;
    }

    .secondary-buttons-row {
        display: flex;
        gap: 12px;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
    }

    /* Enhanced Primary Buttons */
    .btn-interactive-study,
    .btn-test-mode {
        flex: 0 0 auto;
        min-width: 320px;
        max-width: 380px;
        padding: 20px 28px;
        border-radius: 22px;
        font-size: 1.05rem;
    }

    /* Enhanced Secondary Buttons */
    .btn-secondary-enhanced {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 14px 20px;
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid rgba(99, 102, 241, 0.2);
        border-radius: 18px;
        color: #6366f1;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.1);
        backdrop-filter: blur(10px);
        min-width: 140px;
        justify-content: center;
    }

    .btn-secondary-enhanced:hover {
        background: rgba(99, 102, 241, 0.05);
        border-color: #6366f1;
        color: #4f46e5;
        text-decoration: none;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
    }

    .btn-secondary-enhanced:active {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.15);
    }

    .btn-secondary-enhanced i {
        font-size: 1.1rem;
        transition: transform 0.3s ease;
    }

    .btn-secondary-enhanced:hover i {
        transform: scale(1.1);
    }

    /* Responsive Design for Enhanced Layout */
    @media (max-width: 1200px) {
        .btn-interactive-study,
        .btn-test-mode {
            min-width: 280px;
            max-width: 320px;
            padding: 18px 24px;
        }
    }

    @media (max-width: 992px) {
        .primary-buttons-row {
            gap: 15px;
        }

        .btn-interactive-study,
        .btn-test-mode {
            min-width: 260px;
            max-width: 300px;
            padding: 16px 22px;
        }

        .secondary-buttons-row {
            gap: 10px;
        }

        .btn-secondary-enhanced {
            min-width: 130px;
            padding: 12px 18px;
            font-size: 0.9rem;
        }
    }

    @media (max-width: 768px) {
        .buttons-layout {
            gap: 18px;
        }

        .primary-buttons-row {
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .btn-interactive-study,
        .btn-test-mode {
            width: 100%;
            max-width: none;
            min-width: auto;
            padding: 16px 20px;
            flex-direction: row;
            text-align: left;
            gap: 15px;
        }

        .btn-content {
            text-align: left;
        }

        .secondary-buttons-row {
            width: 100%;
            justify-content: space-between;
        }

        .btn-secondary-enhanced {
            flex: 1;
            min-width: auto;
            max-width: 48%;
        }
    }

    @media (max-width: 576px) {
        .buttons-layout {
            gap: 15px;
        }

        .btn-interactive-study,
        .btn-test-mode {
            padding: 14px 18px;
            font-size: 1rem;
        }

        .btn-title {
            font-size: 1rem;
        }

        .btn-subtitle {
            font-size: 0.8rem;
        }

        .secondary-buttons-row {
            flex-direction: column;
            gap: 8px;
        }

        .btn-secondary-enhanced {
            width: 100%;
            max-width: none;
            padding: 12px 16px;
        }
    }

    /* Header Actions Section Updates */
    .header-actions-section {
        position: relative;
        z-index: 2;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        margin-top: 10px;
    }

    /* Animation for button appearance */
    @keyframes buttonSlideIn {
        0% {
            opacity: 0;
            transform: translateY(20px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .primary-buttons-row .btn-interactive-study {
        animation: buttonSlideIn 0.6s ease-out 0.1s both;
    }

    .primary-buttons-row .btn-test-mode {
        animation: buttonSlideIn 0.6s ease-out 0.2s both;
    }

    .secondary-buttons-row .btn-secondary-enhanced:first-child {
        animation: buttonSlideIn 0.6s ease-out 0.3s both;
    }

    .secondary-buttons-row .btn-secondary-enhanced:last-child {
        animation: buttonSlideIn 0.6s ease-out 0.4s both;
    }

    /* Enhanced Flashcards Header Styles */
    .flashcards-header-modern {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #e2e8f0 100%);
        border-radius: 30px;
        padding: 35px;
        margin-bottom: 2.5rem;
        box-shadow: 
            0 20px 60px rgba(0, 0, 0, 0.08),
            0 8px 25px rgba(99, 102, 241, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.3);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(20px);
    }

    .flashcards-header-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 15% 15%, rgba(99, 102, 241, 0.15) 0%, transparent 40%),
            radial-gradient(circle at 85% 85%, rgba(139, 92, 246, 0.15) 0%, transparent 40%),
            radial-gradient(circle at 50% 50%, rgba(236, 72, 153, 0.08) 0%, transparent 60%);
        pointer-events: none;
        z-index: 1;
        animation: backgroundShift 8s ease-in-out infinite;
    }

    @keyframes backgroundShift {
        0%, 100% {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }
        50% {
            opacity: 0.8;
            transform: scale(1.05) rotate(2deg);
        }
    }

    .flashcards-header-modern::after {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: conic-gradient(from 0deg, transparent, rgba(99, 102, 241, 0.03), transparent, rgba(139, 92, 246, 0.03), transparent);
        animation: rotate 20s linear infinite;
        pointer-events: none;
        z-index: 1;
    }

    @keyframes rotate {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .header-top-section {
        position: relative;
        z-index: 2;
        margin-bottom: 25px;
    }

    .header-title-wrapper {
        display: flex;
        align-items: center;
        gap: 20px;
        justify-content: center;
        text-align: center;
    }

    .title-icon-container {
        position: relative;
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
        border-radius: 25px;
        box-shadow: 
            0 15px 40px rgba(99, 102, 241, 0.4),
            0 5px 15px rgba(139, 92, 246, 0.3),
            inset 0 2px 0 rgba(255, 255, 255, 0.3);
        transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border: 3px solid rgba(255, 255, 255, 0.2);
    }

    .title-icon-container:hover {
        transform: rotate(15deg) scale(1.15);
        box-shadow: 
            0 20px 50px rgba(99, 102, 241, 0.5),
            0 10px 25px rgba(139, 92, 246, 0.4),
            0 0 30px rgba(236, 72, 153, 0.3);
    }

    .title-icon {
        font-size: 2rem;
        color: white;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        transition: all 0.3s ease;
    }

    .icon-glow {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 20px;
        background: radial-gradient(circle at center, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
        animation: iconGlow 3s ease-in-out infinite;
        pointer-events: none;
    }

    @keyframes iconGlow {
        0%, 100% {
            opacity: 0.3;
            transform: scale(1);
        }
        50% {
            opacity: 0.8;
            transform: scale(1.1);
        }
    }

    .title-content {
        flex: 1;
        max-width: 600px;
    }

    .main-title {
        font-size: 2.8rem;
        font-weight: 900;
        background: linear-gradient(135deg, #1e293b 0%, #475569 50%, #6366f1 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 15px;
        position: relative;
        line-height: 1.1;
        text-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        filter: drop-shadow(0 2px 4px rgba(99, 102, 241, 0.2));
        animation: titleShine 4s ease-in-out infinite;
    }

    @keyframes titleShine {
        0%, 100% {
            filter: drop-shadow(0 2px 4px rgba(99, 102, 241, 0.2));
        }
        50% {
            filter: drop-shadow(0 4px 8px rgba(99, 102, 241, 0.4));
        }
    }

    .title-underline {
        height: 6px;
        background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 30%, #ec4899 70%, #f59e0b 100%);
        border-radius: 3px;
        margin: 12px auto 0;
        width: 85%;
        animation: underlineGlow 3s ease-in-out infinite;
        position: relative;
        overflow: hidden;
    }

    .title-underline::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
        animation: underlineShimmer 2s ease-in-out infinite;
    }

    @keyframes underlineShimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    @keyframes underlineGlow {
        0%, 100% {
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.3);
            transform: scaleX(1);
        }
        50% {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.6);
            transform: scaleX(1.05);
        }
    }

    .cards-counter {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 12px 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        position: relative;
        overflow: hidden;
    }

    .counter-number {
        font-size: 1.8rem;
        font-weight: 800;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
        animation: numberPulse 3s ease-in-out infinite;
    }

    @keyframes numberPulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }

    .counter-label {
        font-size: 1rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .counter-pulse {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 20px;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        animation: counterPulse 3s ease-in-out infinite;
        pointer-events: none;
    }

    @keyframes counterPulse {
        0%, 100% {
            opacity: 0;
            transform: scale(1);
        }
        50% {
            opacity: 1;
            transform: scale(1.05);
        }
    }

    .header-actions-section {
        position: relative;
        z-index: 2;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    /* Floating particles effect */
    .flashcards-header-modern .floating-particle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: linear-gradient(45deg, #6366f1, #8b5cf6);
        border-radius: 50%;
        opacity: 0.6;
        animation: float 6s ease-in-out infinite;
        pointer-events: none;
        z-index: 1;
    }

    .floating-particle:nth-child(1) {
        top: 20%;
        left: 10%;
        animation-delay: 0s;
    }

    .floating-particle:nth-child(2) {
        top: 60%;
        left: 80%;
        animation-delay: 2s;
    }

    .floating-particle:nth-child(3) {
        top: 80%;
        left: 20%;
        animation-delay: 4s;
    }

    @keyframes float {
        0%, 100% {
            transform: translateY(0px) rotate(0deg);
            opacity: 0.6;
        }
        50% {
            transform: translateY(-20px) rotate(180deg);
            opacity: 1;
        }
    }

    /* Enhanced glass morphism effect */
    .flashcards-header-modern {
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        background: 
            linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.8) 50%, rgba(226, 232, 240, 0.7) 100%),
            radial-gradient(circle at 30% 30%, rgba(99, 102, 241, 0.05) 0%, transparent 50%),
            radial-gradient(circle at 70% 70%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
    }

    /* Responsive Design for Enhanced Header */
    @media (max-width: 1024px) {
        .flashcards-header-modern {
            padding: 25px;
        }

        .header-title-wrapper {
            flex-direction: column;
            gap: 15px;
        }

        .title-icon-container {
            width: 60px;
            height: 60px;
        }

        .title-icon {
            font-size: 1.8rem;
        }

        .main-title {
            font-size: 2.2rem;
        }

        .counter-number {
            font-size: 1.6rem;
        }
    }

    @media (max-width: 768px) {
        .flashcards-header-modern {
            padding: 20px;
            border-radius: 20px;
        }

        .header-title-wrapper {
            gap: 12px;
        }

        .title-icon-container {
            width: 50px;
            height: 50px;
        }

        .title-icon {
            font-size: 1.5rem;
        }

        .main-title {
            font-size: 1.8rem;
        }

        .counter-number {
            font-size: 1.4rem;
        }

        .counter-label {
            font-size: 0.9rem;
        }

        .cards-counter {
            padding: 10px 16px;
        }

        .header-actions-section {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }

        .header-actions-section .d-flex {
            flex-direction: column;
            align-items: stretch;
            gap: 12px !important;
        }
    }

    @media (max-width: 576px) {
        .flashcards-header-modern {
            padding: 15px;
            margin-bottom: 1.5rem;
        }

        .header-top-section {
            margin-bottom: 20px;
        }

        .title-icon-container {
            width: 45px;
            height: 45px;
            border-radius: 15px;
        }

        .title-icon {
            font-size: 1.3rem;
        }

        .main-title {
            font-size: 1.5rem;
        }

        .counter-number {
            font-size: 1.2rem;
        }

        .counter-label {
            font-size: 0.8rem;
        }

        .cards-counter {
            padding: 8px 12px;
            border-radius: 15px;
        }

        .title-underline {
            width: 90%;
        }
    }

    /* Animation for header appearance */
    @keyframes headerFadeIn {
        0% {
            opacity: 0;
            transform: translateY(-20px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .flashcards-header-modern {
        animation: headerFadeIn 0.6s ease-out;
    }

    /* Additional premium effects */
    .flashcards-header-modern:hover {
        transform: translateY(-2px);
        box-shadow: 
            0 25px 70px rgba(0, 0, 0, 0.12),
            0 10px 30px rgba(99, 102, 241, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.9);
    }

    .flashcards-header-modern:hover .title-underline {
        animation-duration: 1.5s;
    }

    .flashcards-header-modern:hover .counter-pulse {
        animation-duration: 2s;
    }

    .counter-label {
        font-size: 1rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .counter-pulse {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 20px;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        animation: counterPulse 3s ease-in-out infinite;
        pointer-events: none;
    }

    @keyframes counterPulse {
        0%, 100% {
            opacity: 0;
            transform: scale(1);
        }
        50% {
            opacity: 1;
            transform: scale(1.05);
        }
    }

    .header-actions-section {
        position: relative;
        z-index: 2;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    /* Responsive Design for Enhanced Header */
    @media (max-width: 1024px) {
        .flashcards-header-modern {
            padding: 25px;
        }

        .header-title-wrapper {
            flex-direction: column;
            gap: 15px;
        }

        .title-icon-container {
            width: 60px;
            height: 60px;
        }

        .title-icon {
            font-size: 1.8rem;
        }

        .main-title {
            font-size: 2.2rem;
        }

        .counter-number {
            font-size: 1.6rem;
        }
    }

    @media (max-width: 768px) {
        .flashcards-header-modern {
            padding: 20px;
            border-radius: 20px;
        }

        .header-title-wrapper {
            gap: 12px;
        }

        .title-icon-container {
            width: 50px;
            height: 50px;
        }

        .title-icon {
            font-size: 1.5rem;
        }

        .main-title {
            font-size: 1.8rem;
        }

        .counter-number {
            font-size: 1.4rem;
        }

        .counter-label {
            font-size: 0.9rem;
        }

        .cards-counter {
            padding: 10px 16px;
        }

        .header-actions-section {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }

        .header-actions-section .d-flex {
            flex-direction: column;
            align-items: stretch;
            gap: 12px !important;
        }
    }

    @media (max-width: 576px) {
        .flashcards-header-modern {
            padding: 15px;
            margin-bottom: 1.5rem;
        }

        .header-top-section {
            margin-bottom: 20px;
        }

        .title-icon-container {
            width: 45px;
            height: 45px;
            border-radius: 15px;
        }

        .title-icon {
            font-size: 1.3rem;
        }

        .main-title {
            font-size: 1.5rem;
        }

        .counter-number {
            font-size: 1.2rem;
        }

        .counter-label {
            font-size: 0.8rem;
        }

        .cards-counter {
            padding: 8px 12px;
            border-radius: 15px;
        }

        .title-underline {
            width: 90%;
        }
    }

    /* Animation for header appearance */
    @keyframes headerFadeIn {
        0% {
            opacity: 0;
            transform: translateY(-20px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .flashcards-header-modern {
        animation: headerFadeIn 0.6s ease-out;
    }

    .flashcard-header {
        background: #f8f9fa;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .difficulty-1 {
        border-left: 5px solid #28a745;
    }

    .difficulty-2 {
        border-left: 5px solid #ffc107;
    }

    .difficulty-3 {
        border-left: 5px solid #dc3545;
    }

    .study-session {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
    }

    /* Enhanced Mind Map Styles */
    .mind-map-header-modern {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 25px;
        color: white;
        box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);
        margin-bottom: 25px;
    }

    .mind-map-header-modern .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    .mind-map-header-modern .header-title-section {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .mind-map-header-modern .title-icon-container {
        width: 60px;
        height: 60px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        backdrop-filter: blur(10px);
    }

    .mind-map-header-modern .title-icon {
        font-size: 2rem;
        color: white;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .mind-map-header-modern .icon-glow {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 18px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
        animation: iconGlow 2s ease-in-out infinite alternate;
    }

    .mind-map-header-modern .main-title {
        font-size: 2.2rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .mind-map-header-modern .title-underline {
        width: 60px;
        height: 4px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 2px;
        margin-top: 8px;
    }

    .mind-map-header-modern .subtitle {
        margin: 8px 0 0 0;
        opacity: 0.9;
        font-size: 1rem;
    }

    .mind-map-header-modern .header-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .btn-action-modern {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 18px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        cursor: pointer;
    }

    .btn-action-modern:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        color: white;
        text-decoration: none;
    }

    .btn-action-modern.primary {
        background: rgba(16, 185, 129, 0.2);
        border-color: rgba(16, 185, 129, 0.4);
    }

    .btn-action-modern.secondary {
        background: rgba(245, 158, 11, 0.2);
        border-color: rgba(245, 158, 11, 0.4);
    }

    .btn-action-modern.success {
        background: rgba(34, 197, 94, 0.2);
        border-color: rgba(34, 197, 94, 0.4);
    }

    /* Mind Map Container */
    .mind-map-container-modern {
        background: white;
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    /* Controls Panel */
    .mind-map-controls-panel {
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-bottom: 1px solid #e2e8f0;
        padding: 25px;
    }

    .controls-row {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        align-items: flex-start;
    }

    .control-group {
        flex: 1;
        min-width: 250px;
    }

    .control-label {
        display: flex;
        align-items: center;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Layout Buttons */
    .layout-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .layout-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        padding: 12px 16px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        color: #64748b;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 80px;
    }

    .layout-btn:hover {
        border-color: #6366f1;
        color: #6366f1;
        background: #f8fafc;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
    }

    .layout-btn.active {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-color: #6366f1;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
    }

    .layout-btn i {
        font-size: 1.2rem;
    }

    /* Search and Filter Container */
    .search-filter-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 0 16px;
        transition: all 0.3s ease;
    }

    .search-input-wrapper:focus-within {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .search-input-wrapper .search-icon {
        color: #9ca3af;
        margin-right: 12px;
    }

    .search-input-wrapper .search-input {
        flex: 1;
        border: none;
        background: transparent;
        padding: 12px 0;
        font-size: 0.9rem;
        color: #374151;
        outline: none;
    }

    .search-input-wrapper .search-clear-btn {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.3s ease;
    }

    .search-input-wrapper .search-clear-btn:hover {
        background: #f3f4f6;
        color: #6b7280;
    }

    /* Filter Buttons */
    .filter-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .filter-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        color: #64748b;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .filter-btn:hover {
        border-color: #6366f1;
        color: #6366f1;
        background: #f8fafc;
    }

    .filter-btn.active {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-color: #6366f1;
        color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    /* View Options */
    .view-options {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .view-option-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        color: #64748b;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .view-option-btn:hover {
        border-color: #6366f1;
        color: #6366f1;
        background: #f8fafc;
    }

    .view-option-btn.active {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-color: #10b981;
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    /* Statistics Panel */
    .mind-map-stats {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
    }

    .mind-map-stats .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
    }

    .mind-map-stats .stat-icon {
        color: #6366f1;
        font-size: 1.1rem;
    }

    .mind-map-stats .stat-value {
        font-weight: 700;
        color: #1f2937;
        font-size: 1.1rem;
    }

    .mind-map-stats .stat-label {
        color: #6b7280;
        font-size: 0.85rem;
    }

    /* Visualization Area */
    .mind-map-visualization {
        position: relative;
        min-height: 600px;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    }

    .visualization-container {
        position: relative;
        width: 100%;
        height: 600px;
        overflow: hidden;
    }

    /* Loading State */
    .mind-map-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.95);
        z-index: 10;
    }

    .loading-content {
        text-align: center;
        color: #6b7280;
    }

    .loading-spinner {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
    }

    .spinner-ring {
        position: absolute;
        width: 100%;
        height: 100%;
        border: 3px solid transparent;
        border-top: 3px solid #6366f1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .spinner-ring:nth-child(2) {
        width: 60px;
        height: 60px;
        top: 10px;
        left: 10px;
        border-top-color: #8b5cf6;
        animation-duration: 1.5s;
        animation-direction: reverse;
    }

    .spinner-ring:nth-child(3) {
        width: 40px;
        height: 40px;
        top: 20px;
        left: 20px;
        border-top-color: #a855f7;
        animation-duration: 2s;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* SVG Styles */
    .mind-map-svg {
        width: 100%;
        height: 100%;
    }
    
    /* Enhanced text styles for better multi-line display */
    .mind-map-svg text {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        font-weight: 600;
        fill: #374151;
        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    }
    
    .mind-map-svg text tspan {
        dominant-baseline: central;
        text-anchor: middle;
        line-height: 1.3;
        word-spacing: 0.1em;
        letter-spacing: 0.02em;
    }
    
    /* Node styles */
    .mind-node {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .mind-node:hover text {
        font-weight: 900;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
    }
    
    .mind-node circle {
        transition: all 0.3s ease;
    }
    
    .mind-node:hover circle {
        stroke-width: 3;
        filter: drop-shadow(0 3px 6px rgba(0,0,0,0.3));
    }
    
    /* Link styles */
    .mind-link {
        transition: all 0.3s ease;
        background: radial-gradient(circle at 30% 30%, rgba(99, 102, 241, 0.05) 0%, transparent 50%),
                    radial-gradient(circle at 70% 70%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
    }

    /* Zoom Controls */
    .zoom-controls {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 5;
    }

    .zoom-btn {
        width: 40px;
        height: 40px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        color: #64748b;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .zoom-btn:hover {
        border-color: #6366f1;
        color: #6366f1;
        background: #f8fafc;
        transform: scale(1.05);
    }

    /* Minimap */
    .mind-map-minimap {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 150px;
        height: 100px;
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        z-index: 5;
    }

    .minimap-viewport {
        position: absolute;
        border: 2px solid #6366f1;
        background: rgba(99, 102, 241, 0.1);
        cursor: move;
    }

    /* Node Details Panel */
    .node-details-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        width: 300px;
        max-height: 400px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        z-index: 10;
        overflow: hidden;
    }

    .panel-header {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .panel-title {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
    }

    .panel-close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.3s ease;
    }

    .panel-close-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .panel-content {
        padding: 20px;
        max-height: 320px;
        overflow-y: auto;
    }

    /* Legend */
    .mind-map-legend {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
    }

    .mind-map-legend h6 {
        margin: 0 0 15px 0;
        color: #374151;
        font-weight: 600;
    }

    .legend-items {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: #6b7280;
    }

    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .legend-color.main-topic {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }

    .legend-color.subtopic {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .legend-color.concept {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .legend-line {
        width: 20px;
        height: 3px;
        border-radius: 2px;
    }

    .legend-line.strong {
        background: #6366f1;
    }

    .legend-line.weak {
        background: #d1d5db;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .controls-row {
            flex-direction: column;
            gap: 20px;
        }

        .control-group {
            min-width: auto;
        }

        .mind-map-stats {
            flex-wrap: wrap;
            gap: 15px;
        }
    }

    @media (max-width: 768px) {
        .mind-map-header-modern .header-content {
            flex-direction: column;
            text-align: center;
        }

        .mind-map-header-modern .header-title-section {
            flex-direction: column;
            gap: 15px;
        }

        .mind-map-controls-panel {
            padding: 20px;
        }

        .layout-buttons,
        .filter-buttons,
        .view-options {
            justify-content: center;
        }

        .visualization-container {
            height: 500px;
        }

        .node-details-panel {
            position: relative;
            width: 100%;
            margin-top: 20px;
        }

        .zoom-controls {
            flex-direction: row;
            top: auto;
            bottom: 20px;
            left: 20px;
            right: auto;
        }

        .mind-map-minimap {
            display: none;
        }
    }

    @media (max-width: 576px) {
        .mind-map-header-modern {
            padding: 20px;
        }

        .mind-map-header-modern .main-title {
            font-size: 1.8rem;
        }

        .mind-map-controls-panel {
            padding: 15px;
        }

        .layout-btn,
        .filter-btn,
        .view-option-btn {
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .layout-btn span,
        .filter-btn span,
        .view-option-btn span {
            display: none;
        }

        .visualization-container {
            height: 400px;
        }

        .mind-map-stats {
            justify-content: center;
        }

        .mind-map-stats .stat-item {
            padding: 8px 12px;
        }
    }

    .video-timeline {
        background: #343a40;
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
    }

    .key-moment {
        padding: 10px 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        margin-bottom: 10px;
        cursor: pointer;
    }

    .key-moment:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .progress-ring {
        transform: rotate(-90deg);
    }

    /* Navigation tabs with gradient background */
    #resultTabs {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 15px;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    }

    .nav-pills .nav-link {
        color: white !important;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }

    .nav-pills .nav-link:hover {
        color: white !important;
        background-color: rgba(255, 255, 255, 0.2);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        transform: translateY(-2px);
    }

    .nav-pills .nav-link.active {
        background: rgba(255, 255, 255, 0.3) !important;
        color: white !important;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5), 0 1px 2px rgba(0, 0, 0, 0.3);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.4);
        transform: translateY(-2px);
    }

    /* Enhanced Summary Styles */
    .summary-modern {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .summary-header {
        border-bottom: 2px solid #f8f9fa;
        padding-bottom: 20px;
    }

    .summary-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .summary-content-enhanced {
        line-height: 1.8;
        font-size: 16px;
        color: #2c3e50;
    }

    .summary-content-enhanced h2 {
        color: #667eea;
        font-size: 1.5rem;
        font-weight: 600;
        margin: 25px 0 15px 0;
        padding-left: 15px;
        border-left: 4px solid #667eea;
        display: flex;
        align-items: center;
    }

    .summary-content-enhanced h3 {
        color: #2d3748;
        font-size: 1.25rem;
        font-weight: 500;
        margin: 20px 0 12px 0;
    }

    .summary-content-enhanced p {
        margin-bottom: 15px;
        text-align: justify;
    }

    .summary-content-enhanced ul {
        padding-left: 25px;
        margin-bottom: 20px;
    }

    .summary-content-enhanced li {
        margin-bottom: 8px;
        position: relative;
    }

    .summary-content-enhanced li::marker {
        color: #667eea;
        font-weight: bold;
    }

    .summary-content-enhanced strong {
        color: #2d3748;
        font-weight: 600;
    }

    .summary-content-enhanced .emoji-section {
        background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        border-left: 5px solid #667eea;
    }

    .summary-content-enhanced .key-point {
        background: #fff5f5;
        border: 1px solid #fed7d7;
        border-radius: 8px;
        padding: 12px 16px;
        margin: 10px 0;
        position: relative;
    }

    .summary-content-enhanced .key-point::before {
        content: "💡";
        position: absolute;
        left: -10px;
        top: 50%;
        transform: translateY(-50%);
        background: white;
        padding: 4px;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .reading-progress {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
    }

    .summary-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 20px;
        color: white !important;
    }

    .summary-stats * {
        color: white !important;
    }

    .stat-item {
        padding: 10px;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: white !important;
    }

    /* Специфичные правила для элементов статистики */
    .summary-stats #wordCount,
    .summary-stats #readingTime,
    .summary-stats #sectionCount,
    .summary-stats #keyPoints {
        color: white !important;
        font-size: 2rem !important;
        font-weight: bold !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
    }

    /* Дополнительные правила для всех элементов внутри stat-item */
    .summary-stats .stat-item * {
        color: white !important;
    }

    .summary-stats .stat-number {
        color: white !important;
        font-size: 2rem !important;
        font-weight: bold !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
    }

    /* Максимально специфичные правила для переопределения любых других стилей */
    div.summary-stats div.stat-item div.stat-number#wordCount,
    div.summary-stats div.stat-item div.stat-number#readingTime,
    div.summary-stats div.stat-item div.stat-number#sectionCount,
    div.summary-stats div.stat-item div.stat-number#keyPoints {
        color: white !important;
        font-size: 2rem !important;
        font-weight: bold !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
        background: transparent !important;
    }

    .summary-stats .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: white !important;
    }

    .summary-compact .summary-content-enhanced {
        font-size: 14px;
        line-height: 1.6;
    }

    .summary-compact .summary-content-enhanced h2 {
        font-size: 1.2rem;
        margin: 15px 0 10px 0;
    }

    .summary-compact .summary-content-enhanced h3 {
        font-size: 1.1rem;
        margin: 12px 0 8px 0;
    }

    .summary-compact .emoji-section {
        padding: 15px;
        margin: 15px 0;
    }

    /* Enhanced Summary Section Styles */
    .summary-section {
        background: white;
        border-radius: 12px;
        margin: 20px 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .summary-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .section-header:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
    }

    .section-header.collapsed {
        background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
    }

    .section-icon {
        font-size: 1.5rem;
        margin-right: 12px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .section-header h2 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 600;
        color: white !important;
        border: none !important;
        padding: 0 !important;
    }

    .reading-time {
        opacity: 0.8;
        font-weight: 400;
        margin-left: 10px;
    }

    .section-content {
        padding: 20px;
        background: #fafbfc;
    }

    .concept-item {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }

    .concept-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .concept-title {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
        font-size: 1.1rem;
    }

    .concept-description {
        color: #2d3748;
        line-height: 1.6;
    }

    .bullet-item {
        display: flex;
        align-items: flex-start;
        margin: 8px 0;
        padding: 8px 0;
    }

    .bullet-icon {
        color: #667eea;
        font-weight: bold;
        margin-right: 10px;
        margin-top: 2px;
        flex-shrink: 0;
    }

    .highlight-text {
        background: linear-gradient(135deg, #fef5e7 0%, #fed7aa 100%);
        color: #92400e;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        border: 1px solid rgba(146, 64, 14, 0.2);
    }

    .summary-paragraph {
        margin-bottom: 15px;
        line-height: 1.7;
        color: #2d3748;
    }

    /* Different colors for different section types */
    .main-idea .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .key-concepts .section-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .relationships .section-header {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .practical .section-header {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #2d3748 !important;
    }

    .practical .section-header h2 {
        color: #2d3748 !important;
    }

    .critical-facts .section-header {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        color: #2d3748 !important;
    }

    .critical-facts .section-header h2 {
        color: #2d3748 !important;
    }

    .formulas .section-header {
        background: linear-gradient(135deg, #a8caba 0%, #5d4e75 100%);
    }

    .results .section-header {
        background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
        color: #2d3748 !important;
    }

    .results .section-header h2 {
        color: #2d3748 !important;
    }

    /* Responsive Design for Summary */
    @media (max-width: 768px) {
        .summary-actions {
            justify-content: center;
            width: 100%;
        }

        .summary-actions .btn {
            flex: 1;
            min-width: 0;
        }

        .summary-stats .row {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
        }

        .section-header {
            padding: 12px 15px;
        }

        .section-header h2 {
            font-size: 1.1rem;
        }

        .section-content {
            padding: 15px;
        }

        .concept-item {
            padding: 12px;
        }
    }

    /* Enhanced Study Plan Styles */
    .study-plan-modern {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
    }

    .study-plan-header {
        border-bottom: 3px solid #f8f9fa;
        padding-bottom: 25px;
    }

    .study-stats {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 1000 !important;
    }

    .study-stats .stat-item {
        text-align: center !important;
        padding: 25px !important;
        background: #ff0000 !important;
        border-radius: 12px !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5) !important;
        border: 5px solid #00ff00 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        min-height: 100px !important;
        min-width: 150px !important;
        position: relative !important;
        z-index: 1001 !important;
    }

    .study-stats .stat-number {
        font-size: 2.8rem !important;
        font-weight: 900 !important;
        color: #000000 !important;
        display: block !important;
        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8) !important;
        line-height: 1 !important;
        margin-bottom: 6px !important;
        visibility: visible !important;
        opacity: 1 !important;
        z-index: 999 !important;
        position: relative !important;
    }

    .study-stats .stat-label {
        font-size: 1rem !important;
        color: #1a202c !important;
        text-transform: uppercase !important;
        letter-spacing: 0.8px !important;
        font-weight: 700 !important;
        opacity: 1 !important;
        visibility: visible !important;
        z-index: 999 !important;
        position: relative !important;
    }

    /* Material Analysis Cards */
    .material-analysis {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 25px;
    }

    .analysis-card {
        background: white;
        border-radius: 12px;
        padding: 25px 20px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border: 1px solid #f1f5f9;
        position: relative;
        overflow: hidden;
    }

    .analysis-card:hover {
        transform: translateY(-5px);
    }

    .analysis-icon {
        font-size: 2.2rem;
        margin-bottom: 12px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        opacity: 0.9;
    }

    .analysis-title {
        font-weight: 600;
        color: #374151;
        margin-bottom: 10px;
        font-size: 0.95rem;
        letter-spacing: 0.3px;
    }

    .analysis-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: #2d3748;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        line-height: 1.2;
    }

    /* Learning Path Timeline */
    .learning-path {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
    }

    .path-timeline {
        display: flex;
        overflow-x: auto;
        padding: 20px 0;
        gap: 20px;
    }

    .timeline-item {
        min-width: 120px;
        text-align: center;
        position: relative;
    }

    .timeline-item:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 25px;
        right: -20px;
        width: 20px;
        height: 2px;
        background: #dee2e6;
    }

    .timeline-marker {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .timeline-number {
        color: white;
        font-weight: bold;
        font-size: 1.1rem;
    }

    .timeline-content {
        font-size: 0.9rem;
    }

    .timeline-phase {
        font-weight: 600;
        color: #495057;
    }

    .timeline-date {
        color: #495057;
        font-size: 0.8rem;
    }

    /* Enhanced Session Cards */
    .sessions-container {
        /* Removed max-height to allow full page display */
        overflow-y: visible;
        padding-right: 10px;
    }

    .session-card.enhanced {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .session-card.enhanced:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    .session-header {
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .session-info {
        flex-grow: 1;
    }

    .session-title h6 {
        margin-bottom: 5px;
        color: #2d3748;
        font-weight: 600;
    }

    .session-phase {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .phase-foundation {
        background: #d4edda;
        color: #155724;
    }

    .phase-development {
        background: #d1ecf1;
        color: #0c5460;
    }

    .phase-mastery {
        background: #f8d7da;
        color: #721c24;
    }

    .session-meta {
        display: flex;
        gap: 15px;
        margin-top: 8px;
        font-size: 0.85rem;
        color: #495057;
    }

    .session-meta span {
        display: flex;
        align-items: center;
    }

    .session-difficulty {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
    }

    .difficulty-basic {
        background: #d4edda;
        color: #155724;
    }

    .difficulty-intermediate {
        background: #fff3cd;
        color: #856404;
    }

    .difficulty-advanced {
        background: #f8d7da;
        color: #721c24;
    }

    .session-actions {
        display: flex;
        gap: 10px;
    }

    .session-details {
        padding: 25px;
        background: #fafbfc;
        border-top: 1px solid #e9ecef;
        transition: all 0.4s ease;
    }

    .session-card.expanded {
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        transform: translateY(-5px);
    }

    .session-card.expanded .session-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .session-card.expanded .session-title h6,
    .session-card.expanded .session-meta {
        color: white;
    }

    .session-card.expanded .session-phase {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    .session-card.expanded .session-difficulty {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    /* Activities Timeline */
    .activities-timeline {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .activity-item {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        padding: 15px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .activity-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .activity-content {
        flex-grow: 1;
    }

    .activity-name {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 4px;
    }

    .activity-duration {
        font-size: 0.8rem;
        color: #667eea;
        font-weight: 500;
        margin-bottom: 6px;
    }

    .activity-description {
        font-size: 0.9rem;
        color: #495057;
        line-height: 1.4;
    }

    /* Objectives and Exercises */
    .objectives-list {
        list-style: none;
        padding: 0;
    }

    .objectives-list li {
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
        position: relative;
        padding-left: 25px;
    }

    .objectives-list li:before {
        content: "🎯";
        position: absolute;
        left: 0;
        top: 8px;
    }

    .exercises-grid {
        display: grid;
        gap: 12px;
    }

    .exercise-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .exercise-check {
        color: #28a745;
        margin-top: 2px;
        flex-shrink: 0;
    }

    .success-criteria {
        display: grid;
        gap: 10px;
    }

    .criterion-item {
        padding: 10px 15px;
        background: #fff5f5;
        border-radius: 8px;
        border-left: 4px solid #ffc107;
        font-size: 0.9rem;
    }

    /* Study Sidebar */
    .study-sidebar {
        position: sticky;
        top: 20px;
    }

    .milestones-card,
    .success-metrics-card,
    .repetition-schedule-card,
    .completion-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .milestones-card .card-title,
    .success-metrics-card .card-title,
    .repetition-schedule-card .card-title,
    .completion-card .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }

    /* Milestone Items */
    .milestone-item {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        padding: 15px 0;
        border-bottom: 1px solid #f1f3f4;
    }

    .milestone-item:last-child {
        border-bottom: none;
    }

    .milestone-progress {
        flex-shrink: 0;
    }

    .progress-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: conic-gradient(#667eea 0deg, #667eea calc(var(--progress, 0) * 3.6deg), #e9ecef calc(var(--progress, 0) * 3.6deg));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
        color: #667eea;
    }

    .milestone-content h6 {
        margin-bottom: 5px;
        color: #2d3748;
    }

    .milestone-content p {
        margin-bottom: 5px;
        font-size: 0.9rem;
        color: #495057;
    }

    /* Success Metrics */
    .metrics-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .metric-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .metric-label {
        font-size: 0.9rem;
        color: #495057;
    }

    .metric-value {
        font-weight: 600;
        color: #667eea;
    }

    /* Repetition Schedule */
    .repetition-intervals {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .interval-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    /* Completion Card */
    .completion-date {
        font-size: 1.1rem;
        font-weight: 600;
        color: #28a745;
        margin-bottom: 15px;
    }

    .adaptive-features h6 {
        font-size: 0.9rem;
        color: #495057;
        margin-bottom: 10px;
    }

    .feature-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .feature-list li {
        padding: 5px 0;
        font-size: 0.85rem;
        color: #495057;
    }

    /* Responsive Design for Study Plan */
    @media (max-width: 768px) {
        .study-plan-modern {
            padding: 20px;
        }

        .path-timeline {
            justify-content: flex-start;
        }

        .timeline-item {
            min-width: 100px;
        }

        .session-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .session-actions {
            width: 100%;
            justify-content: space-between;
        }

        .session-meta {
            flex-direction: column;
            gap: 8px;
        }

        .activities-timeline {
            gap: 10px;
        }

        .activity-item {
            padding: 12px;
        }

        .exercises-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Enhanced Math Support Styles - Beautiful Typography */
    .math-formula {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: 2px solid #e3f2fd;
        border-radius: 15px;
        padding: 25px 30px;
        margin: 20px 0;
        font-family: 'Cambria', 'Times New Roman', serif;
        font-size: 1.4em;
        text-align: center;
        position: relative;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        border-left: 6px solid #667eea;
        line-height: 1.6;
        color: #2c3e50;
        transition: all 0.3s ease;
    }

    .math-formula:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
    }

    .math-formula::before {
        content: "📐";
        position: absolute;
        top: 12px;
        right: 18px;
        font-size: 1.4rem;
        opacity: 0.7;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    .math-inline {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        padding: 4px 10px;
        border-radius: 8px;
        font-family: 'Cambria', 'Times New Roman', serif;
        color: #1565c0;
        font-weight: 600;
        margin: 0 4px;
        display: inline-block;
        transition: all 0.3s ease;
        border: 1px solid rgba(21, 101, 192, 0.2);
        font-size: 1.05em;
    }

    .math-inline:hover {
        background: linear-gradient(135deg, #bbdefb 0%, #e1bee7 100%);
        transform: scale(1.08);
        box-shadow: 0 4px 12px rgba(21, 101, 192, 0.3);
        border-color: #1565c0;
    }

    .math-symbol {
        font-family: 'Cambria', 'Times New Roman', serif;
        font-size: 1.3em;
        color: #667eea;
        font-weight: 700;
        background: linear-gradient(135deg, #e8eaf6 0%, #f3e5f5 100%);
        padding: 3px 8px;
        border-radius: 6px;
        margin: 0 3px;
        display: inline-block;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.2);
        transition: all 0.2s ease;
    }

    .math-symbol:hover {
        transform: scale(1.1);
        background: linear-gradient(135deg, #c5cae9 0%, #e1bee7 100%);
    }

    .math-fraction {
        font-family: 'Cambria', 'Times New Roman', serif;
        color: #667eea;
        font-weight: 600;
        background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%);
        padding: 6px 12px;
        border-radius: 8px;
        margin: 0 4px;
        display: inline-block;
        position: relative;
        border: 1px solid rgba(156, 39, 176, 0.2);
        font-size: 1.1em;
    }

    /* Beautiful fraction display */
    .math-frac {
        display: inline-block;
        vertical-align: middle;
        text-align: center;
        margin: 0 6px;
        position: relative;
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 152, 0, 0.3);
    }

    .math-frac .numerator {
        display: block;
        font-size: 0.9em;
        padding-bottom: 3px;
        border-bottom: 2px solid #667eea;
        margin-bottom: 3px;
        color: #2c3e50;
        font-weight: 700;
    }

    .math-frac .denominator {
        display: block;
        font-size: 0.9em;
        padding-top: 3px;
        color: #2c3e50;
        font-weight: 700;
    }

    /* Superscript and subscript styling */
    .math-sup {
        font-size: 0.7em;
        vertical-align: super;
        color: #e91e63;
        font-weight: 700;
        margin-left: 1px;
        background: rgba(233, 30, 99, 0.1);
        padding: 1px 3px;
        border-radius: 3px;
    }

    .math-sub {
        font-size: 0.7em;
        vertical-align: sub;
        color: #3f51b5;
        font-weight: 700;
        margin-left: 1px;
        background: rgba(63, 81, 181, 0.1);
        padding: 1px 3px;
        border-radius: 3px;
    }

    /* Parentheses styling */
    .math-paren {
        font-size: 1.3em;
        color: #795548;
        font-weight: 600;
        margin: 0 2px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Function names styling */
    .math-func {
        font-family: 'Cambria', serif;
        color: #4caf50;
        font-weight: 700;
        font-style: italic;
        margin-right: 2px;
        background: rgba(76, 175, 80, 0.1);
        padding: 1px 4px;
        border-radius: 3px;
    }

    /* Enhanced Chat Styles */
    .chat-container {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 24px;
        padding: 0;
        box-shadow: 
            0 20px 60px rgba(0, 0, 0, 0.08),
            0 8px 25px rgba(99, 102, 241, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        height: 850px;
        min-height: 850px;
        display: flex;
        flex-direction: column;
        border: 2px solid rgba(255, 255, 255, 0.3);
        overflow: hidden;
        backdrop-filter: blur(20px);
        position: relative;
    }

    .chat-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 15% 15%, rgba(99, 102, 241, 0.08) 0%, transparent 40%),
            radial-gradient(circle at 85% 85%, rgba(139, 92, 246, 0.08) 0%, transparent 40%);
        pointer-events: none;
        z-index: 0;
    }

    .chat-header {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        padding: 25px 30px;
        margin: 0;
        border-radius: 24px 24px 0 0;
        position: relative;
        z-index: 1;
        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
    }

    .chat-header::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 0;
        right: 0;
        height: 10px;
        background: linear-gradient(to bottom, rgba(99, 102, 241, 0.1), transparent);
    }

    .chat-header h4 {
        color: white;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        font-weight: 700;
        font-size: 1.3rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .chat-header h4 i {
        color: rgba(255, 255, 255, 0.9);
        margin-right: 12px;
        font-size: 1.4rem;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .chat-header small {
        font-weight: 500;
        color: rgba(255, 255, 255, 0.8);
        margin-left: 12px;
        background: rgba(255, 255, 255, 0.15);
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        backdrop-filter: blur(10px);
    }

    .chat-header p {
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 0;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 25px 30px;
        margin: 0;
        background: transparent;
        position: relative;
        z-index: 1;
    }

    .welcome-message {
        margin-bottom: 25px;
        animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
        0% {
            opacity: 0;
            transform: translateY(20px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .chat-message {
        margin-bottom: 25px;
        display: flex;
        align-items: flex-start;
        gap: 15px;
        animation: messageSlideIn 0.5s ease-out;
    }

    @keyframes messageSlideIn {
        0% {
            opacity: 0;
            transform: translateY(15px) scale(0.95);
        }
        100% {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .user-message {
        justify-content: flex-end;
        flex-direction: row-reverse;
    }

    .user-message .message-content {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        border-radius: 24px 24px 8px 24px;
        max-width: 75%;
        box-shadow: 
            0 8px 25px rgba(99, 102, 241, 0.3),
            0 4px 15px rgba(0, 0, 0, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    .user-message .message-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
        pointer-events: none;
    }

    .ai-message {
        justify-content: flex-start;
    }

    .ai-message .message-content {
        background: rgba(255, 255, 255, 0.95);
        color: #2d3748;
        border-radius: 24px 24px 24px 8px;
        border: 2px solid rgba(16, 185, 129, 0.2);
        max-width: 80%;
        box-shadow: 
            0 8px 25px rgba(16, 185, 129, 0.15),
            0 4px 15px rgba(0, 0, 0, 0.08);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    .ai-message .message-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .message-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 1.3rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .message-avatar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
        pointer-events: none;
    }

    .user-message .message-avatar {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .ai-message .message-avatar {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .message-avatar:hover {
        transform: scale(1.05) rotate(5deg);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }

    .message-content {
        padding: 18px 24px;
        position: relative;
        z-index: 1;
        transition: all 0.3s ease;
    }

    .message-content:hover {
        transform: translateY(-2px);
        box-shadow: 
            0 12px 35px rgba(0, 0, 0, 0.15),
            0 6px 20px rgba(0, 0, 0, 0.1);
    }

    .message-text {
        line-height: 1.7;
        margin-bottom: 10px;
        font-size: 0.95rem;
        font-weight: 500;
    }

    .message-text:last-child {
        margin-bottom: 0;
    }

    .user-message .message-text {
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .message-text strong {
        font-weight: 700;
    }

    .message-text em {
        font-style: italic;
        color: inherit;
        opacity: 0.9;
    }

    .message-text code {
        background: rgba(0, 0, 0, 0.1);
        padding: 2px 6px;
        border-radius: 6px;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 0.85em;
    }

    .user-message .message-text code {
        background: rgba(255, 255, 255, 0.2);
    }

    .message-text ul {
        margin: 8px 0;
        padding-left: 20px;
    }

    .message-text li {
        margin: 4px 0;
        line-height: 1.6;
    }

    .message-time {
        font-size: 0.75rem;
        opacity: 0.6;
        display: flex;
        align-items: center;
        margin-top: 10px;
        font-weight: 500;
        letter-spacing: 0.3px;
    }

    .message-time i {
        margin-right: 6px;
        font-size: 0.7rem;
    }

    .user-message .message-time {
        color: rgba(255, 255, 255, 0.8);
    }

    .ai-message .message-time {
        color: #64748b;
    }

    .chat-input-container {
        background: rgba(255, 255, 255, 0.95);
        border-top: 2px solid rgba(99, 102, 241, 0.1);
        padding: 25px 30px;
        margin: 0;
        border-radius: 0 0 24px 24px;
        position: relative;
        z-index: 1;
        backdrop-filter: blur(10px);
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
    }

    .chat-input-container::before {
        content: '';
        position: absolute;
        top: -10px;
        left: 0;
        right: 0;
        height: 10px;
        background: linear-gradient(to top, rgba(99, 102, 241, 0.05), transparent);
    }

    .chat-input-container .input-group {
        position: relative;
        background: white;
        border-radius: 28px;
        padding: 4px;
        box-shadow: 
            0 8px 25px rgba(0, 0, 0, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        border: 2px solid rgba(99, 102, 241, 0.1);
        transition: all 0.3s ease;
    }

    .chat-input-container .input-group:focus-within {
        border-color: #6366f1;
        box-shadow: 
            0 0 0 4px rgba(99, 102, 241, 0.1),
            0 12px 35px rgba(99, 102, 241, 0.2);
        transform: translateY(-2px);
    }

    .chat-input-container .form-control {
        border: none;
        border-radius: 24px;
        padding: 16px 24px;
        font-size: 1rem;
        font-weight: 500;
        color: #2d3748;
        background: transparent;
        transition: all 0.3s ease;
        line-height: 1.5;
    }

    .chat-input-container .form-control:focus {
        border: none;
        box-shadow: none;
        outline: none;
        background: transparent;
    }

    .chat-input-container .form-control::placeholder {
        color: #9ca3af;
        font-weight: 400;
        font-style: italic;
    }

    .chat-input-container .btn {
        border-radius: 50%;
        width: 52px;
        height: 52px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border: none;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 
            0 8px 20px rgba(99, 102, 241, 0.3),
            0 4px 10px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
        margin-left: 8px;
    }

    .chat-input-container .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .chat-input-container .btn:hover {
        transform: scale(1.08) rotate(5deg);
        box-shadow: 
            0 12px 30px rgba(99, 102, 241, 0.4),
            0 6px 15px rgba(0, 0, 0, 0.15);
        background: linear-gradient(135deg, #5b21b6 0%, #7c3aed 100%);
    }

    .chat-input-container .btn:hover::before {
        opacity: 1;
    }

    .chat-input-container .btn:active {
        transform: scale(1.02) rotate(2deg);
        box-shadow: 
            0 6px 20px rgba(99, 102, 241, 0.3),
            0 3px 8px rgba(0, 0, 0, 0.1);
    }

    .chat-input-container .btn i {
        font-size: 1.2rem;
        color: white;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        transition: transform 0.3s ease;
    }

    .chat-input-container .btn:hover i {
        transform: scale(1.1);
    }

    .chat-suggestions {
        margin-top: 25px;
        padding: 20px 0 0 0;
        border-top: 2px solid rgba(99, 102, 241, 0.1);
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.02) 0%, rgba(139, 92, 246, 0.02) 100%);
        border-radius: 16px;
        padding: 20px;
        margin-top: 20px;
        position: relative;
        overflow: hidden;
    }

    .chat-suggestions::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #6366f1, #8b5cf6, #06b6d4, #10b981);
        border-radius: 16px 16px 0 0;
    }

    .chat-suggestions small {
        color: #475569;
        font-weight: 700;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-bottom: 18px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .chat-suggestions small::before,
    .chat-suggestions small::after {
        content: '';
        width: 30px;
        height: 2px;
        background: linear-gradient(90deg, #6366f1, #8b5cf6);
        border-radius: 1px;
        box-shadow: 0 1px 3px rgba(99, 102, 241, 0.3);
    }

    .suggestion-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        justify-items: center;
        max-width: 800px;
        margin: 0 auto;
    }

    .suggestion-buttons .btn {
        width: 100%;
        min-width: 180px;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 12px 20px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.9) 100%);
        border: 2px solid rgba(99, 102, 241, 0.3);
        color: #6366f1;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(15px);
        box-shadow: 
            0 4px 15px rgba(99, 102, 241, 0.1),
            0 2px 8px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-align: center;
        line-height: 1.4;
    }

    .suggestion-buttons .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
        transition: left 0.6s ease;
        z-index: 1;
    }

    .suggestion-buttons .btn::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #06b6d4 100%);
        opacity: 0;
        transition: opacity 0.4s ease;
        border-radius: 23px;
        z-index: 0;
    }

    .suggestion-buttons .btn i {
        font-size: 1rem;
        transition: all 0.3s ease;
        z-index: 2;
        position: relative;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
    }

    .suggestion-buttons .btn span {
        z-index: 2;
        position: relative;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .suggestion-buttons .btn:hover {
        color: white;
        border-color: transparent;
        transform: translateY(-4px) scale(1.05);
        box-shadow: 
            0 12px 35px rgba(99, 102, 241, 0.4),
            0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .suggestion-buttons .btn:hover::before {
        left: 100%;
    }

    .suggestion-buttons .btn:hover::after {
        opacity: 1;
    }

    .suggestion-buttons .btn:hover i {
        transform: scale(1.2) rotate(5deg);
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .suggestion-buttons .btn:hover span {
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .suggestion-buttons .btn:active {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 
            0 8px 25px rgba(99, 102, 241, 0.3),
            0 4px 15px rgba(0, 0, 0, 0.1);
    }

    /* Индивидуальные цвета для кнопок */
    .suggestion-buttons .btn:nth-child(1):hover::after {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }

    .suggestion-buttons .btn:nth-child(2):hover::after {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .suggestion-buttons .btn:nth-child(3):hover::after {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .suggestion-buttons .btn:nth-child(4):hover::after {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 25px;
        animation: fadeInUp 0.5s ease-out;
    }

    .typing-indicator .message-avatar {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: 3px solid rgba(255, 255, 255, 0.3);
        position: relative;
    }

    .typing-indicator .message-avatar::after {
        content: '';
        position: absolute;
        top: -2px;
        right: -2px;
        width: 12px;
        height: 12px;
        background: #10b981;
        border: 2px solid white;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .typing-dots {
        background: rgba(255, 255, 255, 0.95);
        border: 2px solid rgba(16, 185, 129, 0.2);
        border-radius: 24px 24px 24px 8px;
        padding: 18px 24px;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 
            0 8px 25px rgba(16, 185, 129, 0.15),
            0 4px 15px rgba(0, 0, 0, 0.08);
        backdrop-filter: blur(10px);
        position: relative;
    }

    .typing-dots::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 2px 0 0 2px;
    }

    .typing-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        animation: typingAnimation 1.6s infinite ease-in-out;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }

    .typing-dot:nth-child(2) {
        animation-delay: 0.3s;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 0.6s;
    }

    @keyframes typingAnimation {
        0%, 60%, 100% {
            transform: translateY(0) scale(1);
            opacity: 0.5;
        }
        30% {
            transform: translateY(-12px) scale(1.2);
            opacity: 1;
        }
    }

    .chat-error {
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        color: #991b1b;
        border: 2px solid #fecaca;
        border-radius: 16px;
        padding: 16px 20px;
        margin: 15px 0;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.1);
        backdrop-filter: blur(10px);
        animation: errorSlideIn 0.5s ease-out;
    }

    @keyframes errorSlideIn {
        0% {
            opacity: 0;
            transform: translateX(-20px);
        }
        100% {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .chat-error i {
        color: #dc2626;
        font-size: 1.2rem;
        filter: drop-shadow(0 2px 4px rgba(220, 38, 38, 0.2));
    }

    .chat-error span {
        font-weight: 500;
        line-height: 1.5;
    }

    /* Enhanced Chat for Large Screens */
    @media (min-width: 1400px) {
        .chat-container {
            height: 950px;
            min-height: 950px;
        }
    }

    @media (min-width: 1200px) and (max-width: 1399px) {
        .chat-container {
            height: 900px;
            min-height: 900px;
        }
    }

    /* Responsive Chat */
    @media (max-width: 1024px) {
        .chat-container {
            height: 750px;
            min-height: 750px;
            border-radius: 20px;
        }

        .chat-header {
            padding: 22px 25px;
            border-radius: 20px 20px 0 0;
        }

        .chat-header h4 {
            font-size: 1.2rem;
        }

        .chat-messages {
            padding: 20px 25px;
        }

        .chat-input-container {
            padding: 20px 25px;
            border-radius: 0 0 20px 20px;
        }

        .message-avatar {
            width: 44px;
            height: 44px;
            font-size: 1.2rem;
        }

        .user-message .message-content,
        .ai-message .message-content {
            max-width: 80%;
        }
    }

    @media (max-width: 768px) {
        .chat-container {
            height: 700px;
            min-height: 700px;
            border-radius: 18px;
            margin: 0 -10px;
        }

        .chat-header {
            padding: 20px;
            border-radius: 18px 18px 0 0;
        }

        .chat-header h4 {
            font-size: 1.1rem;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .chat-header h4 i {
            margin-right: 8px;
            font-size: 1.2rem;
        }

        .chat-header small {
            margin-left: 0;
            font-size: 0.8rem;
            padding: 3px 10px;
        }

        .chat-messages {
            padding: 18px 20px;
        }

        .chat-message {
            margin-bottom: 20px;
            gap: 12px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            font-size: 1.1rem;
        }

        .message-content {
            padding: 15px 18px;
        }

        .user-message .message-content,
        .ai-message .message-content {
            max-width: 85%;
        }

        .message-text {
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .message-time {
            font-size: 0.7rem;
            margin-top: 8px;
        }

        .chat-input-container {
            padding: 18px 20px;
            border-radius: 0 0 18px 18px;
        }

        .chat-input-container .input-group {
            flex-wrap: nowrap;
        }

        .chat-input-container .form-control {
            font-size: 16px; /* Prevents zoom on iOS */
            padding: 14px 20px;
        }

        .chat-input-container .btn {
            width: 48px;
            height: 48px;
            margin-left: 6px;
        }

        .chat-input-container .btn i {
            font-size: 1.1rem;
        }

        .chat-suggestions {
            padding: 15px;
            margin-top: 15px;
        }

        .chat-suggestions small {
            font-size: 0.85rem;
            margin-bottom: 15px;
        }

        .suggestion-buttons {
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }

        .suggestion-buttons .btn {
            min-width: 160px;
            padding: 10px 16px;
            font-size: 0.85rem;
        }

        .suggestion-buttons .btn i {
            font-size: 0.9rem;
        }

        .typing-dots {
            padding: 15px 20px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
        }
    }

    @media (max-width: 576px) {
        .chat-container {
            height: 550px;
            border-radius: 16px;
            margin: 0 -15px;
        }

        .chat-header {
            padding: 18px;
            border-radius: 16px 16px 0 0;
        }

        .chat-header h4 {
            font-size: 1rem;
        }

        .chat-header h4 i {
            font-size: 1.1rem;
        }

        .chat-header small {
            font-size: 0.75rem;
            padding: 2px 8px;
        }

        .chat-header p {
            font-size: 0.85rem;
            margin-top: 8px;
        }

        .chat-messages {
            padding: 15px 18px;
        }

        .chat-message {
            margin-bottom: 18px;
            gap: 10px;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            font-size: 1rem;
        }

        .message-content {
            padding: 12px 16px;
        }

        .user-message .message-content,
        .ai-message .message-content {
            max-width: 90%;
        }

        .message-text {
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .message-time {
            font-size: 0.65rem;
            margin-top: 6px;
        }

        .chat-input-container {
            padding: 15px 18px;
            border-radius: 0 0 16px 16px;
        }

        .chat-input-container .form-control {
            padding: 12px 18px;
            font-size: 15px;
        }

        .chat-input-container .btn {
            width: 44px;
            height: 44px;
            margin-left: 4px;
        }

        .chat-input-container .btn i {
            font-size: 1rem;
        }

        .chat-suggestions {
            margin-top: 15px;
            padding-top: 12px;
        }

        .chat-suggestions small {
            font-size: 0.8rem;
            margin-bottom: 10px;
        }

        .chat-suggestions {
            padding: 12px;
            margin-top: 12px;
        }

        .chat-suggestions small {
            font-size: 0.8rem;
            margin-bottom: 12px;
        }

        .chat-suggestions small::before,
        .chat-suggestions small::after {
            width: 20px;
        }

        .suggestion-buttons {
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .suggestion-buttons .btn {
            min-width: auto;
            padding: 8px 12px;
            font-size: 0.8rem;
            border-radius: 18px;
        }

        .suggestion-buttons .btn span {
            font-size: 0.75rem;
        }

        .suggestion-buttons .btn i {
            font-size: 0.85rem;
        }

        .typing-indicator {
            margin-bottom: 20px;
            gap: 10px;
        }

        .typing-indicator .message-avatar {
            width: 36px;
            height: 36px;
        }

        .typing-dots {
            padding: 12px 16px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
        }

        .chat-error {
            padding: 12px 16px;
            margin: 12px 0;
            border-radius: 12px;
            font-size: 0.85rem;
        }

        .chat-error i {
            font-size: 1rem;
        }
    }

    /* Enhanced Scrollbar Styling for Chat */
    .chat-messages::-webkit-scrollbar {
        width: 8px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: rgba(241, 245, 249, 0.5);
        border-radius: 12px;
        margin: 8px 0;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
        border-radius: 12px;
        border: 2px solid transparent;
        background-clip: content-box;
        transition: all 0.3s ease;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
        background-clip: content-box;
    }

    /* Firefox scrollbar */
    .chat-messages {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 rgba(241, 245, 249, 0.5);
    }

    /* Smooth scrolling behavior */
    .chat-messages {
        scroll-behavior: smooth;
    }

    /* Loading state for chat */
    .chat-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #64748b;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .chat-loading i {
        margin-right: 8px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Empty chat state */
    .chat-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        text-align: center;
        color: #64748b;
    }

    .chat-empty i {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.5;
        color: #6366f1;
    }

    .chat-empty h4 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: #374151;
    }

    .chat-empty p {
        font-size: 0.9rem;
        line-height: 1.5;
        max-width: 300px;
        margin: 0;
    } 0.1);
        padding: 2px 6px;
        border-radius: 4px;
    }

    .math-toolbar {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 15px;
        border: 1px solid #dee2e6;
    }

    .math-toolbar .alert {
        margin-bottom: 0;
        border: none;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
    }

    /* MathJax Override Styles */
    mjx-container[jax="CHTML"][display="true"] {
        margin: 1.5em 0 !important;
        padding: 20px !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        border-radius: 12px !important;
        border-left: 5px solid #667eea !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
        position: relative !important;
    }

    mjx-container[jax="CHTML"][display="true"]::before {
        content: "📐";
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        opacity: 0.6;
    }

    mjx-container[jax="CHTML"] {
        color: #2c3e50 !important;
        font-size: 1.1em !important;
    }

    mjx-container[jax="CHTML"]:not([display="true"]) {
        background: #e3f2fd !important;
        padding: 3px 8px !important;
        border-radius: 6px !important;
        margin: 0 3px !important;
        display: inline-block !important;
        color: #1565c0 !important;
        font-weight: 500 !important;
        transition: all 0.2s ease !important;
    }

    mjx-container[jax="CHTML"]:not([display="true"]):hover {
        background: #bbdefb !important;
        transform: scale(1.05) !important;
        box-shadow: 0 2px 8px rgba(21, 101, 192, 0.2) !important;
    }

    /* Math in different contexts */
    .summary-content-enhanced mjx-container[jax="CHTML"][display="true"] {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%) !important;
        border-left-color: #ff9800 !important;
    }

    .flashcard-advanced mjx-container[jax="CHTML"][display="true"] {
        background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%) !important;
        border-left-color: #9c27b0 !important;
    }

    .accordion-body mjx-container[jax="CHTML"][display="true"] {
        background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%) !important;
        border-left-color: #4caf50 !important;
    }

    /* Math processing indicators */
    .math-processing {
        position: relative;
    }

    .math-processing::after {
        content: "⚡ Обработка формул...";
        position: absolute;
        top: 0;
        right: 0;
        background: #667eea;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    .math-processed {
        position: relative;
    }

    .math-processed::after {
        content: "✓";
        position: absolute;
        top: -5px;
        right: -5px;
        background: #28a745;
        color: white;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        animation: fadeInOut 2s ease-in-out;
    }

    @keyframes fadeInOut {

        0%,
        100% {
            opacity: 0;
        }

        20%,
        80% {
            opacity: 1;
        }
    }

    /* Math toolbar responsive */
    @media (max-width: 768px) {
        .math-toolbar .row {
            flex-direction: column;
        }

        .math-toolbar .col-md-6 {
            margin-bottom: 10px;
        }

        mjx-container[jax="CHTML"][display="true"] {
            padding: 15px !important;
            margin: 1em 0 !important;
        }

        mjx-container[jax="CHTML"]:not([display="true"]) {
            font-size: 0.9em !important;
            padding: 2px 6px !important;
        }
    }

    /* ФИНАЛЬНЫЕ ПРАВИЛА ДЛЯ ЦИФР СТАТИСТИКИ - МАКСИМАЛЬНЫЙ ПРИОРИТЕТ */
    #wordCount, #readingTime, #sectionCount, #keyPoints {
        color: #ffffff !important;
        font-size: 2rem !important;
        font-weight: bold !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
        background: transparent !important;
        border: none !important;
        outline: none !important;
    }

    /* Дополнительные правила с максимальной специфичностью */
    .summary-stats .stat-item .stat-number {
        color: #ffffff !important;
        font-size: 2rem !important;
        font-weight: bold !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
    }

    /* Переопределение любых Bootstrap стилей */
    .summary-stats .text-muted,
    .summary-stats .text-dark,
    .summary-stats .text-primary,
    .summary-stats .text-secondary {
        color: #ffffff !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Header with Quality Score -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-success mb-2">
                <i class="fas fa-check-circle me-2"></i>Глубокий анализ завершен!
            </h2>
            <p class="text-muted mb-0">
                <i class="fas fa-file me-2"></i>{{ filename }}
                {% if file_type == '.mp4' or file_type == '.mov' or file_type == '.mkv' %}
                <span class="badge bg-info ms-2">Видео</span>
                {% else %}
                <span class="badge bg-danger ms-2">PDF</span>
                {% if page_info and page_info.page_range %}
                    <span class="badge bg-primary ms-1">
                        <i class="fas fa-file-alt me-1"></i>Страницы: {{ page_info.page_range }}
                    </span>
                {% endif %}
                {% endif %}
            </p>
        </div>
        <div class="text-center">
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-plus me-2"></i>Новый файл
            </a>
        </div>
    </div>



    <!-- Navigation Tabs -->
    <ul class="nav nav-pills mb-4" id="resultTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="topics-tab" data-bs-toggle="tab" data-bs-target="#topics" type="button">
                <i class="fas fa-list me-2"></i>Темы и структура
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button">
                <i class="fas fa-file-alt me-2"></i>Резюме
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="flashcards-tab" data-bs-toggle="tab" data-bs-target="#flashcards"
                type="button">
                <i class="fas fa-clone me-2"></i>Флеш-карты
                <span class="badge bg-danger ms-1">{{ flashcards|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="mindmap-tab" data-bs-toggle="tab" data-bs-target="#mindmap" type="button">
                <i class="fas fa-share-alt me-2"></i>Mind Map
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="studyplan-tab" data-bs-toggle="tab" data-bs-target="#studyplan" type="button">
                <i class="fas fa-graduation-cap me-2"></i>План обучения
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button">
                <i class="fas fa-robot me-2"></i>Чат с лекцией
                <span class="badge bg-success ms-1">AI</span>
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="resultTabContent">
        <!-- Topics Tab -->
        <div class="tab-pane fade show active" id="topics" role="tabpanel">
            <h4 class="mb-3">
                <i class="fas fa-sitemap me-2"></i>Иерархия тем
                <small class="text-muted">({{ topics_data.main_topics|length }} основных тем)</small>
            </h4>

            {% for topic in topics_data.main_topics %}
            <div class="topic-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h5 class="mb-2">
                            <i class="fas fa-lightbulb text-warning me-2"></i>
                            {{ topic.title }}
                        </h5>
                        <p class="text-muted mb-3">{{ topic.summary }}</p>

                        {% if topic.subtopics %}
                        <h6 class="text-secondary mb-2">Подтемы:</h6>
                        {% for subtopic in topic.subtopics %}
                        <div class="subtopic">{{ subtopic }}</div>
                        {% endfor %}
                        {% endif %}

                        {% if topic.key_concepts %}
                        <h6 class="text-secondary mb-2 mt-3">Ключевые концепции:</h6>
                        <div>
                            {% for concept in topic.key_concepts %}
                            <span class="concept-badge">{{ concept }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {% if topic.examples %}
                        <h6 class="text-secondary mb-2 mt-3">Примеры:</h6>
                        <ul class="mb-0">
                            {% for example in topic.examples %}
                            <li class="text-muted">{{ example }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    <div>
                        <span
                            class="badge bg-{% if topic.complexity == 'сложный' %}danger{% elif topic.complexity == 'средний' %}warning{% else %}success{% endif %}">
                            {% if topic.complexity == 'сложный' %}Сложный{% elif topic.complexity == 'средний' %}Средний{% else %}Базовый{% endif %}
                        </span>
                    </div>
                </div>
            </div>
            {% endfor %}

            {% if topics_data.concept_map.relationships %}
            <h5 class="mt-4 mb-3"><i class="fas fa-link me-2"></i>Связи между темами</h5>
            <div class="relationships-container">
                {% for rel in topics_data.concept_map.relationships %}
                <div class="relationship-flow">
                    <span class="rel-from">{{ rel.from }}</span>
                    <i class="fas fa-arrow-right rel-arrow"></i>
                    <span class="rel-type">{{ rel.type }}</span>
                    <i class="fas fa-arrow-right rel-arrow"></i>
                    <span class="rel-to">{{ rel.to }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Summary Tab -->
        <div class="tab-pane fade" id="summary" role="tabpanel">
            <div class="summary-modern">
                <div class="summary-header mb-4">
                    <h4 class="mb-2">
                        <i class="fas fa-file-text text-primary me-2"></i>
                        Структурированное резюме
                    </h4>
                    <div class="summary-actions">
                        <button class="btn btn-outline-success btn-sm me-2" onclick="copySummary()">
                            <i class="fas fa-copy me-1"></i>Копировать
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="printSummary()">
                            <i class="fas fa-print me-1"></i>Печать
                        </button>
                    </div>
                </div>

                <div class="summary-content-enhanced" id="summaryContent">
                    <!-- Content will be populated by JavaScript -->
                </div>




            </div>
        </div>

        <!-- Enhanced Flashcards Tab -->
        <div class="tab-pane fade" id="flashcards" role="tabpanel">
            <!-- Header with Statistics -->
            <div class="flashcards-header-modern mb-4">
                <!-- Enhanced Header Section -->
                <div class="header-top-section">
                    <!-- Floating Particles -->
                    <div class="floating-particle"></div>
                    <div class="floating-particle"></div>
                    <div class="floating-particle"></div>
                    
                    <div class="header-title-wrapper">
                        <div class="title-icon-container">
                            <i class="fas fa-layer-group title-icon"></i>
                            <div class="icon-glow"></div>
                        </div>
                        <div class="title-content">
                            <h3 class="main-title">
                                🧠 Умные флеш-карты
                                <div class="title-underline"></div>
                            </h3>
                            <div class="cards-counter">
                                <span class="counter-number">{{ flashcards|length }}</span>
                                <span class="counter-label">карт готово к изучению</span>
                                <div class="counter-pulse"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons Section -->
                <div class="header-actions-section">
                    <div class="buttons-layout">
                        <!-- Primary Action Buttons -->
                        <div class="primary-buttons-row">
                            <!-- Interactive Study Button -->
                            <button class="btn-interactive-study" onclick="startInteractiveStudy()">
                                <div class="btn-icon-wrapper">
                                    <i class="fas fa-play"></i>
                                    <div class="btn-sparkle"></div>
                                </div>
                                <div class="btn-content">
                                    <div class="btn-title">🎯 Интерактивное изучение</div>
                                    <div class="btn-subtitle">Умный режим с адаптацией</div>
                                </div>
                                <div class="btn-badge">SMART</div>
                            </button>

                            <!-- Test Mode Button -->
                            <a href="{{ url_for('test_mode', result_id=result_id) }}" class="btn-test-mode" title="Готовые тестовые вопросы ждут вас!">
                                <div class="btn-icon-wrapper">
                                    <i class="fas fa-brain"></i>
                                    <div class="btn-pulse"></div>
                                </div>
                                <div class="btn-content">
                                    <div class="btn-title">🧠 Режим теста</div>
                                    <div class="btn-subtitle">Проверь свои знания</div>
                                </div>
                                <div class="btn-badge">HOT</div>
                            </a>
                        </div>

                        <!-- Secondary Action Buttons -->
                        <div class="secondary-buttons-row">
                            <button class="btn-secondary-enhanced" onclick="showCreateCardModal()">
                                <i class="fas fa-plus"></i>
                                <span>Создать карту</span>
                            </button>
                            <a href="{{ url_for('download_flashcards', result_id=result_id) }}" class="btn-secondary-enhanced">
                                <i class="fas fa-download"></i>
                                <span>Экспорт</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Progress Statistics -->
                <div class="flashcards-stats mb-4">
                    <div class="row g-3">
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card-modern mastered-card">
                                <div class="stat-icon-wrapper">
                                    <i class="fas fa-check-circle stat-icon"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="masteredCount">0</div>
                                    <div class="stat-label">ИЗУЧЕНО</div>
                                </div>
                                <div class="stat-progress">
                                    <div class="progress-bar mastered-progress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card-modern review-card">
                                <div class="stat-icon-wrapper">
                                    <i class="fas fa-redo-alt stat-icon"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="reviewCount">0</div>
                                    <div class="stat-label">НА ПОВТОРЕНИЕ</div>
                                </div>
                                <div class="stat-progress">
                                    <div class="progress-bar review-progress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card-modern new-card">
                                <div class="stat-icon-wrapper">
                                    <i class="fas fa-plus-circle stat-icon"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="newCount">{{ flashcards|length }}</div>
                                    <div class="stat-label">НОВЫЕ</div>
                                </div>
                                <div class="stat-progress">
                                    <div class="progress-bar new-progress" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card-modern progress-card">
                                <div class="stat-icon-wrapper">
                                    <i class="fas fa-chart-line stat-icon"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="progressPercent">0%</div>
                                    <div class="stat-label">ПРОГРЕСС</div>
                                </div>
                                <div class="stat-progress">
                                    <div class="progress-bar overall-progress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Modern Controls -->
            <div class="flashcards-controls-modern mb-4">
                <!-- Search Section -->
                <div class="search-section mb-3">
                    <div class="search-container">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="Поиск по картам..." id="flashcardSearch">
                            <button class="search-clear-btn" onclick="clearSearch()" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filters Section -->
                <div class="filters-section">
                    <div class="filters-row">
                        <!-- Type Filters -->
                        <div class="filter-group">
                            <div class="filter-pills">
                                <button class="filter-pill active" onclick="filterCards('all')" data-filter="all">
                                    <i class="fas fa-th-large"></i>
                                    <span>Все</span>
                                </button>
                                <button class="filter-pill" onclick="filterCards('definition')" data-filter="definition">
                                    <i class="fas fa-book"></i>
                                    <span>Определения</span>
                                </button>
                                <button class="filter-pill" onclick="filterCards('concept')" data-filter="concept">
                                    <i class="fas fa-lightbulb"></i>
                                    <span>Концепции</span>
                                </button>
                                <button class="filter-pill" onclick="filterCards('application')" data-filter="application">
                                    <i class="fas fa-cogs"></i>
                                    <span>Применение</span>
                                </button>
                                <button class="filter-pill" onclick="filterCards('comparison')" data-filter="comparison">
                                    <i class="fas fa-balance-scale"></i>
                                    <span>Сравнение</span>
                                </button>
                                <button class="filter-pill" onclick="filterCards('problem')" data-filter="problem">
                                    <i class="fas fa-puzzle-piece"></i>
                                    <span>Задачи</span>
                                </button>
                            </div>
                        </div>

                        <!-- Sort and View Controls -->
                        <div class="control-group">
                            <div class="sort-dropdown">
                                <button class="sort-btn dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-sort"></i>
                                    <span>По сложности</span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="sortCards('difficulty')">
                                        <i class="fas fa-sort-amount-up me-2"></i>По сложности
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="sortCards('type')">
                                        <i class="fas fa-tags me-2"></i>По типу
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="sortCards('progress')">
                                        <i class="fas fa-chart-line me-2"></i>По прогрессу
                                    </a></li>
                                </ul>
                            </div>

                            <div class="view-controls">
                                <button class="view-btn" onclick="expandAll()" title="Развернуть все">
                                    <i class="fas fa-expand-alt"></i>
                                </button>
                                <button class="view-btn" onclick="collapseAll()" title="Свернуть все">
                                    <i class="fas fa-compress-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Counter -->
                <div class="results-counter">
                    <span class="counter-text">
                        <i class="fas fa-layer-group me-1"></i>
                        Показано: <span id="visibleCardsCount">{{ flashcards|length }}</span> из {{ flashcards|length }} карт
                    </span>
                </div>
            </div>

            <!-- Enhanced Flashcards Container -->
            <div class="flashcards-container">
                <div class="accordion" id="flashcardsAccordion">
                    {% for card in flashcards %}
                    <div class="accordion-item flashcard-advanced difficulty-{{ card.difficulty }}"
                        id="flashcard-{{ loop.index0 }}"
                        data-type="{{ card.type }}" data-difficulty="{{ card.difficulty }}"
                        data-card-id="{{ loop.index0 }}"
                        data-card="{{ loop.index0 }}">
                        <div class="flashcard-header">
                            <div class="d-flex align-items-center flex-grow-1">
                                <button class="accordion-button collapsed p-0 bg-transparent border-0 text-start"
                                    type="button" data-bs-toggle="collapse" data-bs-target="#card{{ loop.index }}">
                                    <div class="flashcard-question-container">
                                        <div class="d-flex align-items-center mb-1">
                                            <i class="fas fa-question-circle text-primary me-2"></i>
                                            <span class="card-number text-muted me-2">#{{ loop.index }}</span>
                                            <span class="flashcard-question">{{ card.q }}</span>
                                        </div>
                                        {% if card.hint %}
                                        <small class="text-muted d-block">
                                            <i class="fas fa-lightbulb me-1"></i>Подсказка: {{ card.hint }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </button>
                            </div>
                            <div class="flashcard-meta d-flex align-items-center gap-2">
                                <span class="badge bg-secondary">
                                    {% if card.type == 'definition' %}Определение
                                    {% elif card.type == 'concept' %}Концепция
                                    {% elif card.type == 'application' %}Применение
                                    {% elif card.type == 'comparison' %}Сравнение
                                    {% elif card.type == 'problem' %}Задача
                                    {% else %}{{ card.type }}{% endif %}
                                </span>
                                <span
                                    class="badge bg-{% if card.difficulty == 3 %}danger{% elif card.difficulty == 2 %}warning{% else %}success{% endif %}">
                                    <i
                                        class="fas fa-{% if card.difficulty == 3 %}fire{% elif card.difficulty == 2 %}bolt{% else %}leaf{% endif %} me-1"></i>
                                    {% if card.difficulty == 3 %}Сложная{% elif card.difficulty == 2 %}Средняя{% else %}Легкая{% endif %}
                                </span>
                                <div class="flashcard-progress-indicator" data-card="{{ loop.index0 }}">
                                    <i class="fas fa-circle text-muted" title="Не изучено"></i>
                                </div>
                            </div>
                        </div>
                        <div id="card{{ loop.index }}" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <!-- Answer Section -->
                                <div class="flashcard-answer mb-3">
                                    <h6 class="text-success mb-2">
                                        <i class="fas fa-check-circle me-2"></i>Ответ:
                                    </h6>
                                    <div class="answer-content p-3 bg-light rounded">
                                        {{ card.a }}
                                    </div>
                                </div>

                                <!-- Additional Information -->
                                {% if card.memory_hook %}
                                <div class="alert alert-info mb-3">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-brain me-2 mt-1"></i>
                                        <div>
                                            <strong>Запоминалка:</strong>
                                            <p class="mb-0 mt-1">{{ card.memory_hook }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                {% if card.common_mistakes %}
                                <div class="alert alert-warning mb-3">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                                        <div>
                                            <strong>Частая ошибка:</strong>
                                            <p class="mb-0 mt-1">{{ card.common_mistakes }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Related Topics -->
                                {% if card.related_topics %}
                                <div class="related-topics mb-3">
                                    <h6 class="text-secondary mb-2">
                                        <i class="fas fa-tags me-1"></i>Связанные темы:
                                    </h6>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% for topic in card.related_topics %}
                                        <span class="badge bg-light text-dark border">{{ topic }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Action Buttons -->
                                <div
                                    class="flashcard-actions d-flex justify-content-between align-items-center pt-3 border-top">
                                    <div class="confidence-buttons">
                                        <small class="text-muted me-2">Насколько хорошо знаете?</small>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-danger"
                                                onclick="markCardReviewed('{{ result_id }}', '{{ loop.index0 }}', false, 1)">
                                                <i class="fas fa-times me-1"></i>Не знаю
                                            </button>
                                            <button class="btn btn-outline-warning"
                                                onclick="markCardReviewed('{{ result_id }}', '{{ loop.index0 }}', true, 2)">
                                                <i class="fas fa-question me-1"></i>Частично
                                            </button>
                                            <button class="btn btn-outline-success"
                                                onclick="markCardReviewed('{{ result_id }}', '{{ loop.index0 }}', true, 3)">
                                                <i class="fas fa-check me-1"></i>Хорошо знаю
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-tools">
                                        <button class="btn btn-sm btn-outline-primary"
                                            onclick="addToFavorites('{{ loop.index0 }}')" title="В избранное">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info"
                                            onclick="shareCard('{{ loop.index0 }}')" title="Поделиться">
                                            <i class="fas fa-share"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- No cards message -->
                <div id="noCardsMessage" class="text-center py-5" style="display: none;">
                    <i class="fas fa-search text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3">Карты не найдены</h5>
                    <p class="text-muted">Попробуйте изменить фильтры или поисковый запрос</p>
                </div>
            </div>

            <!-- Interactive Study Modal -->
            <div class="modal fade" id="interactiveStudyModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-play me-2"></i>Интерактивное изучение
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="studyModalBody">
                            <!-- Study content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Card Modal -->
            <div class="modal fade" id="createCardModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-plus me-2"></i>Создать флеш-карту
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="createCardForm">
                                <div class="mb-3">
                                    <label class="form-label">Вопрос</label>
                                    <textarea class="form-control" id="newCardQuestion" rows="2" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Ответ</label>
                                    <textarea class="form-control" id="newCardAnswer" rows="3" required></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Тип</label>
                                        <select class="form-select" id="newCardType">
                                            <option value="definition">Определение</option>
                                            <option value="concept">Концепция</option>
                                            <option value="application">Применение</option>
                                            <option value="comparison">Сравнение</option>
                                            <option value="problem">Задача</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Сложность</label>
                                        <select class="form-select" id="newCardDifficulty">
                                            <option value="1">Легкая</option>
                                            <option value="2">Средняя</option>
                                            <option value="3">Сложная</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3 mt-3">
                                    <label class="form-label">Подсказка (необязательно)</label>
                                    <input type="text" class="form-control" id="newCardHint">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                            <button type="button" class="btn btn-primary" onclick="createNewCard()">Создать
                                карту</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mind Map Tab -->
        <div class="tab-pane fade" id="mindmap" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="fas fa-project-diagram me-2"></i>Интерактивная ментальная карта</h4>
                <div>
                    <button class="btn btn-outline-info btn-sm me-2" onclick="initMindMap()">
                        <i class="fas fa-sync-alt me-1"></i>Перезагрузить
                    </button>
                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="resetMindMapView()">
                        <i class="fas fa-expand-arrows-alt me-1"></i>Сбросить вид
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="downloadMindMap()">
                        <i class="fas fa-download me-1"></i>Скачать PNG
                    </button>
                </div>
            </div>

            <div class="mind-map-modern" id="mindMapContainer">
                <!-- Enhanced Controls -->
                <div class="mind-map-controls mb-3">
                    <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
                        <!-- Layout Controls -->
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active"
                                onclick="setMindMapLayout('radial')">
                                <i class="fas fa-sun me-1"></i>Радиальная
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="setMindMapLayout('tree')">
                                <i class="fas fa-sitemap me-1"></i>Дерево
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="setMindMapLayout('force')">
                                <i class="fas fa-project-diagram me-1"></i>Сеть
                            </button>
                        </div>

                        <!-- Search -->
                        <div class="input-group input-group-sm" style="width: 200px;">
                            <input type="text" class="form-control" placeholder="Поиск узлов..." id="mindMapSearch">
                            <button class="btn btn-outline-secondary" type="button" onclick="searchMindMapNodes()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>

                        <!-- Filter Controls -->
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-info active" onclick="filterNodes('all')"
                                data-filter="all">
                                <i class="fas fa-eye me-1"></i>Все
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="filterNodes('branch')"
                                data-filter="branch">
                                <i class="fas fa-sitemap me-1"></i>Ветки
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="filterNodes('child')"
                                data-filter="child">
                                <i class="fas fa-leaf me-1"></i>Подтемы
                            </button>
                        </div>

                        <!-- Size Controls -->
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="adjustMindMapSize('small')">
                                <i class="fas fa-compress-arrows-alt me-1"></i>Мал.
                            </button>
                            <button type="button" class="btn btn-outline-secondary active"
                                onclick="adjustMindMapSize('medium')">
                                <i class="fas fa-arrows-alt me-1"></i>Сред.
                            </button>
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="adjustMindMapSize('large')">
                                <i class="fas fa-expand-arrows-alt me-1"></i>Бол.
                            </button>
                        </div>
                    </div>

                    <!-- Statistics and Info -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex gap-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Кликните на узел для детальной информации
                            </small>
                            <small class="text-muted" id="mindMapStats">
                                <i class="fas fa-chart-bar me-1"></i>
                                Узлов: <span id="nodeCount">0</span> | Связей: <span id="linkCount">0</span>
                            </small>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-success" onclick="fitToScreen()">
                                <i class="fas fa-expand me-1"></i>По размеру
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="centerView()">
                                <i class="fas fa-crosshairs me-1"></i>Центр
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mind-map-svg-container"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 20px; position: relative; overflow: hidden;">
                    <svg id="mindMapSvg" width="100%" height="600"
                        style="background: rgba(255,255,255,0.95); border-radius: 10px;">
                        <!-- Mind map will be rendered here -->
                    </svg>

                    <!-- Loading indicator -->
                    <div id="mindMapLoading" class="position-absolute top-50 start-50 translate-middle text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <div class="mt-2 text-white">Создание ментальной карты...</div>
                    </div>
                </div>

                <!-- Enhanced Node details panel -->
                <div id="nodeDetailsPanel" class="mt-3" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0" id="nodeTitle">
                                <i class="fas fa-info-circle me-2"></i>Детали узла
                            </h6>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-light"
                                    onclick="createFlashcardFromNode()" title="Создать флеш-карту">
                                    <i class="fas fa-layer-group"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-light" onclick="addToStudyPlan()"
                                    title="Добавить в план обучения">
                                    <i class="fas fa-calendar-plus"></i>
                                </button>
                                <button type="button" class="btn-close" onclick="hideNodeDetails()"></button>
                            </div>
                        </div>
                        <div class="card-body" id="nodeContent">
                            <!-- Enhanced node details will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Study Plan Tab -->
        <div class="tab-pane fade" id="studyplan" role="tabpanel">
            <div class="study-plan-modern">
                <!-- Header with Analytics -->
                <div class="study-plan-header mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="mb-2">
                                <i class="fas fa-graduation-cap text-primary me-2"></i>
                                Персональный план обучения
                            </h4>
                            <p class="text-muted mb-0">
                                Научно обоснованный план с учетом сложности материала и кривой забывания
                            </p>
                        </div>

                    </div>
                </div>

                <!-- Material Analysis -->
                {% if study_plan.material_analysis %}
                <div class="material-analysis mb-4">
                    <h5 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Анализ материала</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="analysis-card">
                                <div class="analysis-icon">📊</div>
                                <div class="analysis-title">Сложность</div>
                                <div class="analysis-value">
                                    {% if study_plan.difficulty_level < 1.5 %} <span class="badge bg-success">
                                        Базовый</span>
                                        {% elif study_plan.difficulty_level < 2.5 %} <span class="badge bg-warning">
                                            Средний</span>
                                            {% else %}
                                            <span class="badge bg-danger">Продвинутый</span>
                                            {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="analysis-card">
                                <div class="analysis-icon">⏱️</div>
                                <div class="analysis-title">Время изучения</div>
                                <div class="analysis-value">{{
                                    study_plan.material_analysis.estimated_study_time.study_time }} мин</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="analysis-card">
                                <div class="analysis-icon">🔄</div>
                                <div class="analysis-title">Повторения</div>
                                <div class="analysis-value">{{
                                    study_plan.material_analysis.estimated_study_time.review_time }} мин</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="analysis-card">
                                <div class="analysis-icon">📚</div>
                                <div class="analysis-title">Чтение</div>
                                <div class="analysis-value">{{
                                    study_plan.material_analysis.estimated_study_time.reading_time }} мин</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Learning Path Visualization -->
                <div class="learning-path mb-4">
                    <h5 class="mb-3"><i class="fas fa-route me-2"></i>Путь обучения</h5>
                    <div class="path-timeline">
                        {% for session in study_plan.sessions %}
                        <div class="timeline-item" data-session="{{ session.session_number }}">
                            <div class="timeline-marker">
                                <div class="timeline-number">{{ session.session_number }}</div>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-phase">{{ session.phase_name }}</div>
                                <div class="timeline-date">{{ session.date }} ({{ session.day_of_week }})</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Study Sessions -->
                <div class="row">
                    <div class="col-lg-8">
                        <div class="sessions-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Учебные сессии</h5>
                                <div class="session-controls">
                                    <button class="btn btn-sm btn-outline-primary" onclick="toggleSessionView()">
                                        <i class="fas fa-list me-1"></i>Компактный вид
                                    </button>
                                </div>
                            </div>

                            {% for session in study_plan.sessions %}
                            <div class="session-card enhanced" data-session="{{ session.session_number }}">
                                <div class="session-header">
                                    <div class="session-info">
                                        <div class="session-title">
                                            <span class="session-phase phase-{{ session.phase }}">{{ session.phase_name
                                                }}</span>
                                            <h6 class="mb-1">Сессия {{ session.session_number }}: {{
                                                session.main_topic.title }}</h6>
                                        </div>
                                        <div class="session-meta">
                                            <span class="session-date">
                                                <i class="fas fa-calendar me-1"></i>{{ session.date }}
                                            </span>
                                            <span class="session-duration">
                                                <i class="fas fa-clock me-1"></i>{{ session.duration_minutes }} мин
                                            </span>
                                            <span
                                                class="session-difficulty difficulty-{{ session.estimated_difficulty }}">
                                                <i class="fas fa-signal me-1"></i>{{ session.estimated_difficulty }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="session-actions">
                                        <button class="btn btn-primary btn-sm"
                                            onclick="startSession({{ session.session_number }})">
                                            <i class="fas fa-play me-1"></i>Начать
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm session-toggle-btn"
                                            data-session="{{ session.session_number }}" title="Развернуть">
                                            <i class="fas fa-chevron-down me-1"></i>Развернуть
                                        </button>
                                    </div>
                                </div>

                                <div class="session-details" id="sessionDetails{{ session.session_number }}"
                                    style="display: none;">
                                    <div class="session-focus mb-3">
                                        <h6><i class="fas fa-bullseye me-2"></i>Фокус сессии</h6>
                                        <p class="text-muted">{{ session.focus }}</p>
                                    </div>

                                    {% if session.activities %}
                                    <div class="session-activities mb-3">
                                        <h6><i class="fas fa-tasks me-2"></i>Активности</h6>
                                        <div class="activities-timeline">
                                            {% for activity in session.activities %}
                                            <div class="activity-item">
                                                <div class="activity-icon">{{ activity.icon }}</div>
                                                <div class="activity-content">
                                                    <div class="activity-name">{{ activity.name }}</div>
                                                    <div class="activity-duration">{{ activity.duration }} мин</div>
                                                    <div class="activity-description">{{ activity.description }}</div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if session.learning_objectives %}
                                    <div class="session-objectives mb-3">
                                        <h6><i class="fas fa-target me-2"></i>Цели обучения</h6>
                                        <ul class="objectives-list">
                                            {% for objective in session.learning_objectives %}
                                            <li>{{ objective }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}

                                    {% if session.exercises %}
                                    <div class="session-exercises mb-3">
                                        <h6><i class="fas fa-dumbbell me-2"></i>Упражнения</h6>
                                        <div class="exercises-grid">
                                            {% for exercise in session.exercises %}
                                            <div class="exercise-card">
                                                <i class="fas fa-check-circle exercise-check"></i>
                                                <span>{{ exercise }}</span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if session.success_criteria %}
                                    <div class="session-success">
                                        <h6><i class="fas fa-trophy me-2"></i>Критерии успеха</h6>
                                        <div class="success-criteria">
                                            {% for criterion in session.success_criteria %}
                                            <div class="criterion-item">
                                                <i class="fas fa-medal me-2"></i>{{ criterion }}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Sidebar with Milestones and Progress -->
                    <div class="col-lg-4">
                        <div class="study-sidebar">
                            <!-- Milestones -->
                            <div class="milestones-card mb-4">
                                <h5 class="card-title">
                                    <i class="fas fa-flag-checkered me-2"></i>Контрольные точки
                                </h5>
                                {% for milestone in study_plan.milestones %}
                                <div class="milestone-item">
                                    <div class="milestone-progress">
                                        <div class="progress-circle">
                                            <span>{{ milestone.progress_percent }}%</span>
                                        </div>
                                    </div>
                                    <div class="milestone-content">
                                        <h6>{{ milestone.title }}</h6>
                                        <p class="text-muted">{{ milestone.description }}</p>
                                        <small class="text-info">Сессия {{ milestone.session }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Success Metrics -->
                            {% if study_plan.success_metrics %}
                            <div class="success-metrics-card mb-4">
                                <h5 class="card-title">
                                    <i class="fas fa-chart-line me-2"></i>Целевые показатели
                                </h5>
                                <div class="metrics-list">
                                    <div class="metric-item">
                                        <span class="metric-label">Удержание знаний</span>
                                        <span class="metric-value">{{ study_plan.success_metrics.target_retention
                                            }}%</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">Завершение курса</span>
                                        <span class="metric-value">{{ study_plan.success_metrics.target_completion
                                            }}%</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">Удовлетворенность</span>
                                        <span class="metric-value">{{ study_plan.success_metrics.target_satisfaction
                                            }}/10</span>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Spaced Repetition Schedule -->
                            <div class="repetition-schedule-card mb-4">
                                <h5 class="card-title">
                                    <i class="fas fa-redo me-2"></i>График повторений
                                </h5>
                                <p class="text-muted mb-3">Интервальные повторения по кривой Эббингауза</p>
                                <div class="repetition-intervals">
                                    {% for interval in study_plan.review_schedule %}
                                    <span class="interval-badge">{{ interval }} дн.</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Completion Info -->
                            <div class="completion-card">
                                <h5 class="card-title">
                                    <i class="fas fa-calendar-check me-2"></i>Завершение
                                </h5>
                                <div class="completion-date">
                                    <i class="fas fa-flag-checkered me-2"></i>
                                    {{ study_plan.completion_date }}
                                </div>
                                {% if study_plan.adaptive_features %}
                                <div class="adaptive-features mt-3">
                                    <h6>Адаптивные функции:</h6>
                                    <ul class="feature-list">
                                        {% if study_plan.adaptive_features.difficulty_adjustment %}
                                        <li><i class="fas fa-adjust me-1"></i>Корректировка сложности</li>
                                        {% endif %}
                                        {% if study_plan.adaptive_features.personalized_pace %}
                                        <li><i class="fas fa-tachometer-alt me-1"></i>Персональный темп</li>
                                        {% endif %}
                                        {% if study_plan.adaptive_features.progress_tracking %}
                                        <li><i class="fas fa-chart-bar me-1"></i>Отслеживание прогресса</li>
                                        {% endif %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Enhanced Chat Tab -->
        <div class="tab-pane fade" id="chat" role="tabpanel">
            <div class="chat-container">
                <div class="chat-header">
                    <h4>
                        <i class="fas fa-comments"></i>
                        Чат с лекцией
                        <small>{{ filename }}</small>
                    </h4>
                    <p>
                        Задавайте вопросы по содержанию лекции. AI ответит на основе загруженного материала и поможет разобраться в сложных темах.
                    </p>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">
                        <div class="ai-message">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-text">
                                    👋 Привет! Я ваш AI-помощник по изучению материала "<strong>{{ filename }}</strong>". 
                                    <br><br>
                                    Я могу помочь вам:
                                    <ul>
                                        <li>🔍 Объяснить сложные концепции</li>
                                        <li>📝 Привести примеры и аналогии</li>
                                        <li>🎯 Выделить ключевые моменты</li>
                                        <li>❓ Ответить на любые вопросы по материалу</li>
                                    </ul>
                                    Просто задайте свой вопрос!
                                </div>
                                <div class="message-time">
                                    <i class="fas fa-clock"></i>Сейчас
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-input-container">
                    <div class="input-group">
                        <input type="text" class="form-control" id="chatInput" 
                               placeholder="Напишите ваш вопрос по лекции..." 
                               onkeypress="handleChatKeyPress(event)"
                               autocomplete="off">
                        <button class="btn btn-primary" type="button" onclick="sendChatMessage()" title="Отправить сообщение">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="chat-suggestions">
                        <small>💡 Примеры вопросов</small>
                        <div class="suggestion-buttons">
                            <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="setChatMessage('Объясни основные темы этой лекции')"
                                    title="Получить обзор основных тем">
                                <i class="fas fa-list-ul"></i>
                                <span>Основные темы</span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="setChatMessage('Какие ключевые понятия и термины рассматриваются в материале?')"
                                    title="Узнать ключевые термины">
                                <i class="fas fa-key"></i>
                                <span>Ключевые понятия</span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="setChatMessage('Приведи конкретные примеры из лекции')"
                                    title="Получить примеры">
                                <i class="fas fa-lightbulb"></i>
                                <span>Примеры</span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="setChatMessage('Что самое важное нужно запомнить из этого материала?')"
                                    title="Выделить главное">
                                <i class="fas fa-star"></i>
                                <span>Главное</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Study Progress Card -->
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">
                <i class="fas fa-chart-line me-2"></i>Прогресс изучения
            </h5>
            <div id="progressContainer">
                <div class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin"></i> Загрузка прогресса...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Load study progress
    fetch(`/api/study_progress/{{ result_id }}`)
        .then(response => response.json())
        .then(data => {
            const progressHtml = `
                <div class="row text-center">
                    <div class="col-md-4">
                        <h3 class="text-primary">${data.total_cards}</h3>
                        <p class="text-muted mb-0">Всего карточек</p>
                    </div>
                    <div class="col-md-4">
                        <h3 class="text-info">${data.reviewed_cards}</h3>
                        <p class="text-muted mb-0">Изучено</p>
                    </div>
                    <div class="col-md-4">
                        <h3 class="text-success">${data.mastered_cards}</h3>
                        <p class="text-muted mb-0">Освоено</p>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 25px;">
                    <div class="progress-bar bg-success" style="width: ${data.progress_percentage}%">
                        ${data.progress_percentage}%
                    </div>
                </div>
            `;
            document.getElementById('progressContainer').innerHTML = progressHtml;
        });

    // Enhanced Flashcard Functions
    let flashcardProgress = {};
    let currentStudySession = null;

    function filterCards(type) {
        const cards = document.querySelectorAll('.flashcard-advanced');
        let visibleCount = 0;

        cards.forEach(card => {
            if (type === 'all' || card.dataset.type === type) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        // Update active button
        document.querySelectorAll('[data-filter]').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-filter="${type}"]`).classList.add('active');

        // Show/hide no cards message
        document.getElementById('noCardsMessage').style.display = visibleCount === 0 ? 'block' : 'none';

        updateFlashcardStats();
    }

    function searchFlashcards() {
        const searchTerm = document.getElementById('flashcardSearch').value.toLowerCase();
        const cards = document.querySelectorAll('.flashcard-advanced');
        let visibleCount = 0;

        cards.forEach(card => {
            const question = card.querySelector('.flashcard-question').textContent.toLowerCase();
            const answer = card.querySelector('.answer-content').textContent.toLowerCase();

            if (question.includes(searchTerm) || answer.includes(searchTerm)) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        document.getElementById('noCardsMessage').style.display = visibleCount === 0 ? 'block' : 'none';
    }

    function sortCards(criteria) {
        const container = document.getElementById('flashcardsAccordion');
        const cards = Array.from(container.querySelectorAll('.flashcard-advanced'));

        cards.sort((a, b) => {
            switch (criteria) {
                case 'difficulty':
                    return parseInt(a.dataset.difficulty) - parseInt(b.dataset.difficulty);
                case 'type':
                    return a.dataset.type.localeCompare(b.dataset.type);
                case 'progress':
                    const progressA = flashcardProgress[a.dataset.cardId] || 0;
                    const progressB = flashcardProgress[b.dataset.cardId] || 0;
                    return progressB - progressA;
                default:
                    return 0;
            }
        });

        // Re-append sorted cards
        cards.forEach(card => container.appendChild(card));

        // Show toast notification
        showToast(`Карты отсортированы по ${criteria === 'difficulty' ? 'сложности' : criteria === 'type' ? 'типу' : 'прогрессу'}`, 'info');
    }

    function startInteractiveStudy() {
        const modal = new bootstrap.Modal(document.getElementById('interactiveStudyModal'));
        const modalBody = document.getElementById('studyModalBody');

        // Get cards that need review
        const cards = Array.from(document.querySelectorAll('.flashcard-advanced')).filter(card =>
            card.style.display !== 'none'
        );

        if (cards.length === 0) {
            showToast('Нет доступных карт для изучения', 'warning');
            return;
        }

        currentStudySession = {
            cards: cards,
            currentIndex: 0,
            correct: 0,
            total: cards.length
        };

        modalBody.innerHTML = `
            <div class="study-session-container">
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%" id="studyProgress"></div>
                </div>
                <div class="text-center mb-3">
                    <span class="badge bg-primary">Карта 1 из ${cards.length}</span>
                </div>
                <div class="study-card" id="studyCard">
                    <!-- Study card content will be loaded here -->
                </div>
                <div class="study-controls mt-4 text-center">
                    <button class="btn btn-outline-secondary" onclick="showStudyAnswer()" id="showAnswerBtn">
                        <i class="fas fa-eye me-1"></i>Показать ответ
                    </button>
                    <div id="studyAnswerControls" style="display: none;">
                        <button class="btn btn-danger me-2" onclick="studyCardResult(false)">
                            <i class="fas fa-times me-1"></i>Не знаю
                        </button>
                        <button class="btn btn-success" onclick="studyCardResult(true)">
                            <i class="fas fa-check me-1"></i>Знаю
                        </button>
                    </div>
                </div>
            </div>
        `;

        loadStudyCard();
        modal.show();
    }

    function loadStudyCard() {
        if (!currentStudySession) return;

        const card = currentStudySession.cards[currentStudySession.currentIndex];
        const question = card.querySelector('.flashcard-question').textContent;
        const cardNumber = currentStudySession.currentIndex + 1;
        const total = currentStudySession.total;

        document.getElementById('studyCard').innerHTML = `
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-question-circle text-primary me-2"></i>
                        ${question}
                    </h5>
                    <div id="studyAnswer" style="display: none;">
                        <hr>
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            ${card.querySelector('.answer-content').textContent}
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Update progress
        const progress = (cardNumber / total) * 100;
        document.getElementById('studyProgress').style.width = progress + '%';
        document.querySelector('.badge.bg-primary').textContent = `Карта ${cardNumber} из ${total}`;

        // Reset controls
        document.getElementById('showAnswerBtn').style.display = 'block';
        document.getElementById('studyAnswerControls').style.display = 'none';
    }

    function showStudyAnswer() {
        document.getElementById('studyAnswer').style.display = 'block';
        document.getElementById('showAnswerBtn').style.display = 'none';
        document.getElementById('studyAnswerControls').style.display = 'block';
    }

    function studyCardResult(correct) {
        if (!currentStudySession) return;

        if (correct) {
            currentStudySession.correct++;
        }

        currentStudySession.currentIndex++;

        if (currentStudySession.currentIndex >= currentStudySession.total) {
            // Session complete
            const accuracy = Math.round((currentStudySession.correct / currentStudySession.total) * 100);
            document.getElementById('studyModalBody').innerHTML = `
                <div class="text-center">
                    <i class="fas fa-trophy text-warning" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">Сессия завершена!</h4>
                    <p class="lead">Правильных ответов: ${currentStudySession.correct} из ${currentStudySession.total}</p>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-${accuracy >= 80 ? 'success' : accuracy >= 60 ? 'warning' : 'danger'}" 
                             style="width: ${accuracy}%">${accuracy}%</div>
                    </div>
                    <button class="btn btn-primary" onclick="startInteractiveStudy()">
                        <i class="fas fa-redo me-1"></i>Повторить сессию
                    </button>
                </div>
            `;
            currentStudySession = null;
        } else {
            loadStudyCard();
        }
    }

    function startQuizMode() {
        showToast('Режим теста будет добавлен в следующей версии', 'info');
    }

    function showCreateCardModal() {
        const modal = new bootstrap.Modal(document.getElementById('createCardModal'));
        modal.show();
    }

    function createNewCard() {
        const question = document.getElementById('newCardQuestion').value.trim();
        const answer = document.getElementById('newCardAnswer').value.trim();
        const type = document.getElementById('newCardType').value;
        const difficulty = parseInt(document.getElementById('newCardDifficulty').value);
        const hint = document.getElementById('newCardHint').value.trim();

        if (!question || !answer) {
            showToast('Заполните вопрос и ответ', 'warning');
            return;
        }

        // Создаем новую карту
        const newCard = {
            q: question,
            a: answer,
            type: type,
            difficulty: difficulty,
            hint: hint || 'Подсказка не указана',
            related_topics: [],
            memory_hook: '',
            common_mistakes: '',
            text_reference: 'Создано пользователем',
            next_review: new Date().toISOString(),
            ease_factor: 2.5
        };

        console.log('Creating new card:', newCard);

        // Отправляем на сервер
        fetch('/api/create_flashcard', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                result_id: {{ result_id }},
                card: newCard
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Добавляем карту в DOM
                addCardToDOM(newCard, data.card_id);
                
                showToast('Флеш-карта создана и сохранена!', 'success');
                
                // Обновляем статистику
                updateFlashcardStats();
                
                // Закрываем модальное окно и сбрасываем форму
                bootstrap.Modal.getInstance(document.getElementById('createCardModal')).hide();
                document.getElementById('createCardForm').reset();
            } else {
                throw new Error(data.error || 'Ошибка создания карты');
            }
        })
        .catch(error => {
            console.error('Error creating flashcard:', error);
            showToast('Ошибка при создании карты: ' + error.message, 'danger');
        });
    }

    function addCardToDOM(card, cardId) {
        const flashcardsContainer = document.getElementById('flashcardsAccordion');
        if (!flashcardsContainer) {
            console.error('Flashcards container not found');
            return;
        }

        const cardIndex = flashcardsContainer.children.length;
        const difficultyClass = `difficulty-${card.difficulty}`;
        const difficultyText = card.difficulty === 1 ? 'Легкая' : card.difficulty === 2 ? 'Средняя' : 'Сложная';
        const typeText = {
            'definition': 'Определение',
            'concept': 'Концепция', 
            'application': 'Применение',
            'comparison': 'Сравнение',
            'problem': 'Задача'
        }[card.type] || card.type;

        const cardHtml = `
            <div class="accordion-item flashcard-advanced ${difficultyClass}">
                <h2 class="accordion-header" id="heading${cardIndex}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse${cardIndex}" aria-expanded="false" aria-controls="collapse${cardIndex}">
                        <div class="flashcard-header w-100">
                            <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                <div class="flashcard-question">
                                    <strong>${card.q}</strong>
                                </div>
                                <div class="flashcard-meta">
                                    <span class="badge bg-secondary me-2">${typeText}</span>
                                    <span class="badge bg-info">${difficultyText}</span>
                                </div>
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="collapse${cardIndex}" class="accordion-collapse collapse" aria-labelledby="heading${cardIndex}"
                    data-bs-parent="#flashcardsAccordion">
                    <div class="accordion-body">
                        <div class="answer-content mb-3">
                            <h6><i class="fas fa-lightbulb me-2"></i>Ответ:</h6>
                            <p>${card.a}</p>
                        </div>
                        ${card.hint && card.hint !== 'Подсказка не указана' ? `
                        <div class="hint-content mb-3">
                            <h6><i class="fas fa-question-circle me-2"></i>Подсказка:</h6>
                            <p class="text-muted">${card.hint}</p>
                        </div>
                        ` : ''}
                        <div class="card-actions d-flex justify-content-between align-items-center">
                            <div class="review-buttons">
                                <small class="text-muted me-2">Насколько хорошо знаете?</small>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-danger"
                                        onclick="markCardReviewed('{{ result_id }}', '${cardIndex}', false, 1)">
                                        <i class="fas fa-times me-1"></i>Не знаю
                                    </button>
                                    <button class="btn btn-outline-warning"
                                        onclick="markCardReviewed('{{ result_id }}', '${cardIndex}', true, 2)">
                                        <i class="fas fa-question me-1"></i>Частично
                                    </button>
                                    <button class="btn btn-outline-success"
                                        onclick="markCardReviewed('{{ result_id }}', '${cardIndex}', true, 3)">
                                        <i class="fas fa-check me-1"></i>Хорошо знаю
                                    </button>
                                </div>
                            </div>
                            <div class="card-tools">
                                <button class="btn btn-sm btn-outline-primary"
                                    onclick="addToFavorites('${cardIndex}')" title="В избранное">
                                    <i class="fas fa-star"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info"
                                    onclick="shareCard('${cardIndex}')" title="Поделиться">
                                    <i class="fas fa-share"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        flashcardsContainer.insertAdjacentHTML('beforeend', cardHtml);
        
        // Скрыть сообщение "карты не найдены" если оно есть
        const noCardsMessage = document.getElementById('noCardsMessage');
        if (noCardsMessage) {
            noCardsMessage.style.display = 'none';
        }
    }

    function updateFlashcardStats() {
        const totalCards = document.querySelectorAll('#flashcardsAccordion .accordion-item').length;
        
        // Считаем статистику по иконкам прогресса
        let masteredCards = 0;
        let reviewCards = 0;
        let newCards = 0;
        
        document.querySelectorAll('[data-card]').forEach(indicator => {
            const icon = indicator.querySelector('i');
            if (icon) {
                if (icon.classList.contains('fa-check-circle')) {
                    masteredCards++;
                } else if (icon.classList.contains('fa-clock')) {
                    reviewCards++;
                } else {
                    newCards++;
                }
            }
        });
        
        // Обновляем статистику в карточках
        const masteredElement = document.getElementById('masteredCount');
        const reviewElement = document.getElementById('reviewCount');
        const newElement = document.getElementById('newCount');
        const progressElement = document.getElementById('progressPercent');
        
        if (masteredElement) masteredElement.textContent = masteredCards;
        if (reviewElement) reviewElement.textContent = reviewCards;
        if (newElement) newElement.textContent = newCards;
        
        // Вычисляем процент прогресса
        const progressPercent = totalCards > 0 ? Math.round((masteredCards / totalCards) * 100) : 0;
        if (progressElement) progressElement.textContent = progressPercent + '%';
        
        // Обновляем счетчик в заголовке вкладки
        const flashcardsTab = document.querySelector('[href="#flashcards"]');
        if (flashcardsTab) {
            const badge = flashcardsTab.querySelector('.badge');
            if (badge) {
                badge.textContent = totalCards;
            }
        }
        
        // Обновляем статистику в заголовке секции
        const flashcardsHeader = document.querySelector('#flashcards h4');
        if (flashcardsHeader) {
            const countSpan = flashcardsHeader.querySelector('.text-muted');
            if (countSpan) {
                countSpan.textContent = `(${totalCards} карт)`;
            }
        }
        
        console.log(`Updated flashcard stats: ${totalCards} total, ${masteredCards} mastered, ${reviewCards} review, ${newCards} new`);
    }

    function showToast(message, type = 'info') {
        // Создаем toast уведомление
        const toastId = 'toast-' + Date.now();
        const bgClass = {
            'success': 'bg-success',
            'danger': 'bg-danger', 
            'warning': 'bg-warning',
            'info': 'bg-info'
        }[type] || 'bg-info';
        
        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        // Создаем контейнер для toast если его нет
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        // Добавляем toast
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // Показываем toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 3000
        });
        toast.show();
        
        // Удаляем элемент после скрытия
        toastElement.addEventListener('hidden.bs.toast', function() {
            this.remove();
        });
    }

    function addCardToDOM(card, cardId) {
        const accordion = document.getElementById('flashcardsAccordion');
        const cardIndex = accordion.children.length;
        
        const cardHtml = `
            <div class="accordion-item flashcard-advanced difficulty-${card.difficulty}"
                 id="flashcard-${cardId}"
                 data-type="${card.type}" 
                 data-difficulty="${card.difficulty}"
                 data-card-id="${cardId}"
                 data-card="${cardId}">
                <div class="flashcard-header">
                    <div class="d-flex align-items-center flex-grow-1">
                        <button class="accordion-button collapsed p-0 bg-transparent border-0 text-start"
                                type="button" data-bs-toggle="collapse" data-bs-target="#card${cardIndex + 1}">
                            <div class="flashcard-question-container">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-question-circle text-primary me-2"></i>
                                    <span class="card-number text-muted me-2">#${cardIndex + 1}</span>
                                    <span class="flashcard-question">${card.q}</span>
                                </div>
                                <div class="flashcard-meta">
                                    <span class="badge bg-${getTypeColor(card.type)} me-1">${getTypeLabel(card.type)}</span>
                                    <span class="badge bg-${getDifficultyColor(card.difficulty)} me-1">
                                        ${'★'.repeat(card.difficulty)}
                                    </span>
                                    <span class="badge bg-success">Новая</span>
                                </div>
                            </div>
                        </button>
                        <div class="flashcard-actions ms-2">
                            <i class="fas fa-circle text-muted" data-card="${cardId}" title="Не изучена"></i>
                        </div>
                    </div>
                </div>
                <div id="card${cardIndex + 1}" class="accordion-collapse collapse" data-bs-parent="#flashcardsAccordion">
                    <div class="accordion-body">
                        <div class="answer-content">
                            <h6><i class="fas fa-lightbulb text-warning me-2"></i>Ответ:</h6>
                            <div class="answer-text">${card.a}</div>
                        </div>
                        ${card.hint ? `
                        <div class="hint-content mt-3">
                            <h6><i class="fas fa-info-circle text-info me-2"></i>Подсказка:</h6>
                            <div class="hint-text">${card.hint}</div>
                        </div>
                        ` : ''}
                        <div class="card-actions mt-4">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="mb-2">Насколько хорошо знаете?</h6>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-danger"
                                                onclick="markCardReviewed('{{ result_id }}', '${cardId}', false, 1)">
                                            <i class="fas fa-times me-1"></i>Не знаю
                                        </button>
                                        <button class="btn btn-outline-warning"
                                                onclick="markCardReviewed('{{ result_id }}', '${cardId}', true, 2)">
                                            <i class="fas fa-question me-1"></i>Частично
                                        </button>
                                        <button class="btn btn-outline-success"
                                                onclick="markCardReviewed('{{ result_id }}', '${cardId}', true, 3)">
                                            <i class="fas fa-check me-1"></i>Хорошо знаю
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" onclick="addToFavorites('${cardId}')" title="В избранное">
                                            <i class="fas fa-heart"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="shareCard('${cardId}')" title="Поделиться">
                                            <i class="fas fa-share"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        accordion.insertAdjacentHTML('beforeend', cardHtml);
    }

    function getTypeColor(type) {
        const colors = {
            'definition': 'success',
            'concept': 'info', 
            'application': 'warning',
            'comparison': 'danger',
            'problem': 'primary'
        };
        return colors[type] || 'secondary';
    }

    function getTypeLabel(type) {
        const labels = {
            'definition': 'Определение',
            'concept': 'Концепция',
            'application': 'Применение', 
            'comparison': 'Сравнение',
            'problem': 'Задача'
        };
        return labels[type] || 'Другое';
    }

    function getDifficultyColor(difficulty) {
        const colors = {
            1: 'success',
            2: 'warning', 
            3: 'danger'
        };
        return colors[difficulty] || 'secondary';
    }

    function addToFavorites(cardId) {
        showToast('Карта добавлена в избранное', 'success');
        // Here you would save to favorites
    }

    function shareCard(cardId) {
        if (navigator.share) {
            navigator.share({
                title: 'Флеш-карта',
                text: 'Изучаем вместе!',
                url: window.location.href
            });
        } else {
            // Fallback - copy to clipboard
            navigator.clipboard.writeText(window.location.href);
            showToast('Ссылка скопирована в буфер обмена', 'info');
        }
    }



    // Enhanced mark card as reviewed with confidence levels
    function markCardReviewed(resultId, cardId, correct, confidence = 2) {
        console.log('Marking card as reviewed:', { resultId, cardId, correct, confidence });
        
        fetch('/api/flashcard_progress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                result_id: parseInt(resultId),
                flashcard_id: parseInt(cardId),
                correct: correct,
                confidence: confidence
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Progress update response:', data);
                
                if (data.success) {
                    // Update progress indicator
                    const progressIndicator = document.querySelector(`.flashcard-progress-indicator[data-card="${cardId}"]`);
                    if (progressIndicator) {
                        const icon = progressIndicator.querySelector('i');
                        if (icon) {
                            if (correct && confidence >= 3) {
                                icon.className = 'fas fa-check-circle text-success';
                                icon.title = 'Изучено';
                            } else if (correct && confidence >= 2) {
                                icon.className = 'fas fa-clock text-warning';
                                icon.title = 'На повторение';
                            } else {
                                icon.className = 'fas fa-times-circle text-danger';
                                icon.title = 'Требует изучения';
                            }
                        }
                    }

                    // Find and update buttons for this specific card
                    const cardElement = document.querySelector(`#flashcard-${cardId}`);
                    if (cardElement) {
                        const buttons = cardElement.querySelectorAll('.btn-group button');
                        buttons.forEach(btn => {
                            btn.disabled = true;
                            btn.classList.remove('btn-outline-danger', 'btn-outline-warning', 'btn-outline-success');
                            btn.classList.add('btn-secondary');
                        });
                    }

                    // Update progress in memory
                    if (typeof flashcardProgress !== 'undefined') {
                        flashcardProgress[cardId] = confidence;
                    }

                    // Show feedback
                    let message = '';
                    let nextReview = '';

                    if (correct && confidence >= 3) {
                        message = 'Отлично! Карта помечена как изученная.';
                        nextReview = data.next_review_days ? `Повторение через ${data.next_review_days} дней` : '';
                    } else if (correct && confidence >= 2) {
                        message = 'Хорошо! Карта добавлена на повторение.';
                        nextReview = 'Повторение завтра';
                    } else {
                        message = 'Карта будет показана снова для изучения.';
                        nextReview = 'Повторение сегодня';
                    }

                    showToast(message + (nextReview ? ' ' + nextReview : ''), 'success');

                    // Update statistics
                    updateFlashcardStats();
                } else {
                    console.error('Server returned error:', data);
                    showToast(data.error || 'Ошибка при сохранении прогресса', 'danger');
                }
            })
            .catch(error => {
                console.error('Error updating flashcard progress:', error);
                showToast('Ошибка при сохранении прогресса. Проверьте подключение к интернету.', 'danger');
            });
    }

    // Modern Mind Map Implementation
    let mindMapData = null;
    let currentLayout = 'radial';
    let mindMapNodes = [];
    let mindMapLinks = [];

    function initMindMap() {
        console.log('🗺️ Initializing mind map...');
        
        // Show loading
        document.getElementById('mindMapLoading').style.display = 'block';

        fetch(`/api/mind_map/{{ result_id }}`)
            .then(response => {
                console.log('📡 Mind map API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('📊 Mind map data received:', data);
                mindMapData = data;
                document.getElementById('mindMapLoading').style.display = 'none';
                
                // Проверяем структуру данных
                if (!data || !data.branches) {
                    console.error('❌ Invalid mind map data structure:', data);
                    document.getElementById('mindMapLoading').innerHTML =
                        '<div class="text-warning"><i class="fas fa-exclamation-triangle"></i> Нет данных для mind map</div>';
                    return;
                }
                
                console.log('✅ Drawing mind map with', data.branches.length, 'branches');
                drawModernMindMap();
            })
            .catch(error => {
                console.error('❌ Error loading mind map:', error);
                document.getElementById('mindMapLoading').innerHTML =
                    '<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Ошибка загрузки: ' + error.message + '</div>';
            });
    }

    function drawModernMindMap() {
        console.log('🎨 Starting to draw mind map...');
        
        try {
            // Проверяем наличие D3
            if (typeof d3 === 'undefined') {
                console.error('❌ D3.js library not loaded');
                document.getElementById('mindMapLoading').innerHTML =
                    '<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> D3.js не загружен</div>';
                return;
            }
            
            if (!mindMapData || !mindMapData.branches) {
                console.error('❌ No mind map data or branches');
                document.getElementById('mindMapLoading').innerHTML =
                    '<div class="text-warning"><i class="fas fa-exclamation-triangle"></i> Нет данных для mind map</div>';
                return;
            }

            console.log('📊 Mind map data:', mindMapData);
            
            const svg = d3.select('#mindMapSvg');
            if (svg.empty()) {
                console.error('❌ SVG element not found');
                document.getElementById('mindMapLoading').innerHTML =
                    '<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> SVG элемент не найден</div>';
                return;
            }
            
            svg.selectAll('*').remove(); // Clear previous content

            const svgElement = document.getElementById('mindMapSvg');
            if (!svgElement) {
                console.error('❌ SVG DOM element not found');
                return;
            }
            
            const width = svgElement.clientWidth || 800;
            const height = 500;
            
            console.log('📐 SVG dimensions:', width, 'x', height);

            // Prepare data
            prepareGraphData();

            // Update statistics
            updateMindMapStats();

            // Create main group with zoom capability
            const g = svg.append('g').attr('class', 'mind-map-group');

            // Add zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.3, 3])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            // Draw based on layout
            if (currentLayout === 'radial') {
                drawRadialLayout(g, width, height);
            } else if (currentLayout === 'tree') {
                drawTreeLayout(g, width, height);
            } else {
                drawForceLayout(g, width, height);
            }
            
            console.log('✅ Mind map drawn successfully');
            
        } catch (error) {
            console.error('❌ Error drawing mind map:', error);
            document.getElementById('mindMapLoading').innerHTML =
                `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Ошибка отрисовки: ${error.message}</div>`;
        }
    }

    function prepareGraphData() {
        mindMapNodes = [];
        mindMapLinks = [];

        // Central node
        mindMapNodes.push({
            id: 'central',
            name: mindMapData.central_topic || 'Основная тема',
            type: 'central',
            level: 0,
            color: '#667eea',
            size: 35,
            details: {
                title: mindMapData.central_topic || 'Основная тема',
                description: 'Центральная тема документа',
                type: 'Основная тема'
            }
        });

        // Branch nodes and their children
        mindMapData.branches.forEach((branch, branchIndex) => {
            const branchId = `branch-${branchIndex}`;

            mindMapNodes.push({
                id: branchId,
                name: branch.name,
                type: 'branch',
                level: 1,
                color: branch.color || '#4ECDC4',
                size: 25,
                details: {
                    title: branch.name,
                    description: `Важность: ${Math.round((branch.importance || 0.5) * 100)}%`,
                    type: 'Основная ветка',
                    children: branch.children ? branch.children.length : 0
                }
            });

            // Link from central to branch
            mindMapLinks.push({
                source: 'central',
                target: branchId,
                type: 'main'
            });

            // Child nodes
            if (branch.children) {
                branch.children.forEach((child, childIndex) => {
                    const childId = `child-${branchIndex}-${childIndex}`;

                    mindMapNodes.push({
                        id: childId,
                        name: child.name,
                        type: 'child',
                        level: 2,
                        color: child.color || branch.color || '#96CEB4',
                        size: 18,
                        parent: branchId,
                        details: {
                            title: child.name,
                            description: `Подтема раздела "${branch.name}"`,
                            type: 'Подтема',
                            parent: branch.name
                        }
                    });

                    // Link from branch to child
                    mindMapLinks.push({
                        source: branchId,
                        target: childId,
                        type: 'sub'
                    });
                });
            }
        });
    }

    function drawRadialLayout(g, width, height) {
        const centerX = width / 2;
        const centerY = height / 2;

        // Position nodes
        const branches = mindMapNodes.filter(n => n.type === 'branch');
        const angleStep = (2 * Math.PI) / Math.max(branches.length, 1);

        // Position central node
        const centralNode = mindMapNodes.find(n => n.type === 'central');
        centralNode.x = centerX;
        centralNode.y = centerY;

        // Position branch nodes in circle
        branches.forEach((branch, index) => {
            const angle = index * angleStep - Math.PI / 2; // Start from top
            branch.x = centerX + Math.cos(angle) * 120;
            branch.y = centerY + Math.sin(angle) * 120;
        });

        // Position child nodes around their parents
        mindMapNodes.filter(n => n.type === 'child').forEach(child => {
            const parent = mindMapNodes.find(n => n.id === child.parent);
            if (parent) {
                const siblings = mindMapNodes.filter(n => n.parent === child.parent);
                const childIndex = siblings.indexOf(child);
                const totalSiblings = siblings.length;

                const angleOffset = (childIndex - (totalSiblings - 1) / 2) * (Math.PI / 6);
                const distance = 70;

                // Calculate angle from center to parent
                const parentAngle = Math.atan2(parent.y - centerY, parent.x - centerX);
                const childAngle = parentAngle + angleOffset;

                child.x = parent.x + Math.cos(childAngle) * distance;
                child.y = parent.y + Math.sin(childAngle) * distance;
            }
        });

        drawStaticNodes(g);
    }

    function drawTreeLayout(g, width, height) {
        // Simple tree layout
        const levels = [
            mindMapNodes.filter(n => n.level === 0),
            mindMapNodes.filter(n => n.level === 1),
            mindMapNodes.filter(n => n.level === 2)
        ];

        const levelHeight = height / (levels.length + 1);

        levels.forEach((levelNodes, levelIndex) => {
            const y = levelHeight * (levelIndex + 1);
            const spacing = width / (levelNodes.length + 1);

            levelNodes.forEach((node, nodeIndex) => {
                node.x = spacing * (nodeIndex + 1);
                node.y = y;
            });
        });

        drawStaticNodes(g);
    }

    function drawForceLayout(g, width, height) {
        console.log('🎯 drawForceLayout called with', mindMapNodes.length, 'nodes');
        
        // ПРИНУДИТЕЛЬНО удаляем все существующие текстовые элементы
        g.selectAll('text').remove();
        console.log('🧹 Все текстовые элементы удалены');
        
        // Force-directed layout
        const simulation = d3.forceSimulation(mindMapNodes)
            .force('link', d3.forceLink(mindMapLinks).id(d => d.id).distance(80))
            .force('charge', d3.forceManyBody().strength(-200))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(d => d.size + 40)); // Увеличиваем радиус коллизии

        drawDynamicNodes(g, simulation);
    }

    function drawStaticNodes(g) {
        // Draw links
        const links = g.selectAll('.mind-link')
            .data(mindMapLinks)
            .enter()
            .append('line')
            .attr('class', 'mind-link')
            .attr('x1', d => {
                const source = mindMapNodes.find(n => n.id === d.source);
                return source ? source.x : 0;
            })
            .attr('y1', d => {
                const source = mindMapNodes.find(n => n.id === d.source);
                return source ? source.y : 0;
            })
            .attr('x2', d => {
                const target = mindMapNodes.find(n => n.id === d.target);
                return target ? target.x : 0;
            })
            .attr('y2', d => {
                const target = mindMapNodes.find(n => n.id === d.target);
                return target ? target.y : 0;
            })
            .attr('stroke', d => d.type === 'main' ? '#667eea' : '#dee2e6')
            .attr('stroke-width', d => d.type === 'main' ? 3 : 2)
            .attr('opacity', 0.7);

        // Draw nodes
        const nodeGroups = g.selectAll('.mind-node')
            .data(mindMapNodes)
            .enter()
            .append('g')
            .attr('class', 'mind-node')
            .attr('transform', d => `translate(${d.x}, ${d.y})`)
            .style('cursor', 'pointer')
            .on('click', (event, d) => showNodeDetails(d))
            .on('mouseover', function (event, d) {
                d3.select(this).select('circle')
                    .transition().duration(200)
                    .attr('r', d.size * 1.3)
                    .attr('stroke-width', 4);
            })
            .on('mouseout', function (event, d) {
                d3.select(this).select('circle')
                    .transition().duration(200)
                    .attr('r', d.size)
                    .attr('stroke-width', 2);
            });

        // Node circles with gradient
        const defs = g.append('defs');
        mindMapNodes.forEach(node => {
            const gradient = defs.append('radialGradient')
                .attr('id', `gradient-${node.id}`)
                .attr('cx', '30%')
                .attr('cy', '30%');

            gradient.append('stop')
                .attr('offset', '0%')
                .attr('stop-color', d3.color(node.color).brighter(0.5));

            gradient.append('stop')
                .attr('offset', '100%')
                .attr('stop-color', node.color);
        });

        nodeGroups.append('circle')
            .attr('r', d => d.size)
            .attr('fill', d => `url(#gradient-${d.id})`)
            .attr('stroke', '#fff')
            .attr('stroke-width', 2)
            .style('filter', 'drop-shadow(0 3px 6px rgba(0,0,0,0.2))');

        // Node labels with multi-line text support - UPDATED 2024-01-05-16:00
        console.log('🔤 Создаем многострочные подписи для узлов...');
        nodeGroups.each(function(d) {
            const nodeGroup = d3.select(this);
            const text = d.name.trim();
            
            // Настройки в зависимости от типа узла
            const maxChars = d.type === 'central' ? 18 : d.type === 'branch' ? 16 : 14;
            const fontSize = d.type === 'central' ? 12 : d.type === 'branch' ? 10 : 9;
            const lineSpacing = fontSize + 4;
            const startY = d.size + 25;
            
            // Разбиваем текст на слова
            const words = text.split(' ');
            let lines = [];
            let currentLine = '';
            
            for (let word of words) {
                const testLine = currentLine ? currentLine + ' ' + word : word;
                
                if (testLine.length <= maxChars) {
                    currentLine = testLine;
                } else {
                    if (currentLine) {
                        lines.push(currentLine);
                        currentLine = word;
                    } else {
                        lines.push(word.substring(0, maxChars));
                        currentLine = '';
                    }
                    
                    if (lines.length >= 3) break;
                }
            }
            
            if (currentLine && lines.length < 3) {
                lines.push(currentLine);
            }
            
            if (lines.length === 0) {
                lines = [text.substring(0, maxChars)];
            }
            
            // Создаем текстовые элементы
            lines.forEach((line, index) => {
                nodeGroup.append('text')
                    .text(line)
                    .attr('text-anchor', 'middle')
                    .attr('x', 0)
                    .attr('y', startY + (index * lineSpacing))
                    .attr('font-size', fontSize + 'px')
                    .attr('font-weight', d.type === 'central' ? 'bold' : 'normal')
                    .attr('fill', '#333')
                    .style('text-shadow', '1px 1px 2px rgba(255,255,255,0.8)')
                    .style('font-family', 'Arial, sans-serif');
            });
        });
    }

    function drawDynamicNodes(g, simulation) {
        // Similar to drawStaticNodes but with simulation updates
        const links = g.selectAll('.mind-link')
            .data(mindMapLinks)
            .enter()
            .append('line')
            .attr('class', 'mind-link')
            .attr('stroke', d => d.type === 'main' ? '#667eea' : '#dee2e6')
            .attr('stroke-width', d => d.type === 'main' ? 3 : 2)
            .attr('opacity', 0.7);

        const nodeGroups = g.selectAll('.mind-node')
            .data(mindMapNodes)
            .enter()
            .append('g')
            .attr('class', 'mind-node')
            .style('cursor', 'pointer')
            .on('click', (event, d) => showNodeDetails(d))
            .call(d3.drag()
                .on('start', (event, d) => {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                })
                .on('drag', (event, d) => {
                    d.fx = event.x;
                    d.fy = event.y;
                })
                .on('end', (event, d) => {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }));

        nodeGroups.append('circle')
            .attr('r', d => d.size)
            .attr('fill', d => d.color)
            .attr('stroke', '#fff')
            .attr('stroke-width', 2);

        // Дублирующий код удален - используем только один блок создания многострочного текста выше

        simulation.on('tick', () => {
            links
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            nodeGroups
                .attr('transform', d => `translate(${d.x}, ${d.y})`);
        });
    }

    function showNodeDetails(d) {
        const panel = document.getElementById('nodeDetailsPanel');
        const title = document.getElementById('nodeTitle');
        const content = document.getElementById('nodeContent');

        title.innerHTML = `<i class="fas fa-info-circle me-2"></i>${d.details.title}`;

        let detailsHtml = `
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-tag me-2 text-primary"></i>
                        <strong>Тип:</strong>
                        <span class="badge ms-2" style="background-color: ${d.color}; color: white;">
                            ${d.type === 'central' ? 'Центральная тема' : d.type === 'branch' ? 'Основная ветка' : 'Подтема'}
                        </span>
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-align-left me-2 text-info"></i>
                        <strong>Описание:</strong>
                        <p class="mt-1 text-muted">${d.details.description}</p>
                    </div>
                </div>
                <div class="col-md-6">
        `;

        if (d.details.children !== undefined) {
            detailsHtml += `
                <div class="mb-2">
                    <i class="fas fa-sitemap me-2 text-success"></i>
                    <strong>Подтем:</strong> 
                    <span class="badge bg-success ms-1">${d.details.children}</span>
                </div>`;
        }
        if (d.details.parent) {
            detailsHtml += `
                <div class="mb-2">
                    <i class="fas fa-level-up-alt me-2 text-warning"></i>
                    <strong>Родитель:</strong> 
                    <span class="text-primary">${d.details.parent}</span>
                </div>`;
        }

        // Add connection info
        const connections = mindMapLinks.filter(link =>
            link.source === d.id || link.target === d.id
        ).length;

        detailsHtml += `
                <div class="mb-2">
                    <i class="fas fa-link me-2 text-secondary"></i>
                    <strong>Связей:</strong> 
                    <span class="badge bg-secondary ms-1">${connections}</span>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="border-top pt-3">
            <h6 class="mb-2"><i class="fas fa-bolt me-2"></i>Быстрые действия</h6>
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-sm btn-outline-primary" onclick="focusOnNode('${d.id}')">
                    <i class="fas fa-crosshairs me-1"></i>Фокус
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="highlightConnections('${d.id}')">
                    <i class="fas fa-project-diagram me-1"></i>Связи
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="createFlashcardFromNode('${d.id}')">
                    <i class="fas fa-layer-group me-1"></i>Флеш-карта
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="addToStudyPlan('${d.id}')">
                    <i class="fas fa-calendar-plus me-1"></i>В план
                </button>
            </div>
        </div>
        `;

        content.innerHTML = detailsHtml;
        panel.style.display = 'block';
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        // Store current selected node
        window.selectedNode = d;
    }

    function hideNodeDetails() {
        document.getElementById('nodeDetailsPanel').style.display = 'none';
    }

    function setMindMapLayout(layout) {
        console.log('🔄 Switching mind map layout to:', layout);
        
        currentLayout = layout;

        // Update active button - найдем правильные кнопки макета
        document.querySelectorAll('[onclick*="setMindMapLayout"]').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Найдем и активируем нужную кнопку
        const targetButton = document.querySelector(`[onclick="setMindMapLayout('${layout}')"]`);
        if (targetButton) {
            targetButton.classList.add('active');
        }

        // Перерисовываем mind map с новым макетом
        if (mindMapData && mindMapData.branches) {
            drawModernMindMap();
        } else {
            console.warn('⚠️ No mind map data available for layout change');
        }
    }

    function resetMindMapView() {
        console.log('🔄 Resetting mind map view...');
        
        const svg = d3.select('#mindMapSvg');
        if (svg.empty()) {
            console.error('❌ SVG element not found');
            return;
        }

        try {
            const zoom = d3.zoom()
                .scaleExtent([0.3, 3])
                .on('zoom', (event) => {
                    const g = svg.select('.mind-map-group');
                    if (!g.empty()) {
                        g.attr('transform', event.transform);
                    }
                });

            svg.call(zoom);
            
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity
            );
            
            // Сбросить активные кнопки размера на средний
            document.querySelectorAll('[onclick*="adjustMindMapSize"]').forEach(btn => {
                btn.classList.remove('active');
            });
            const mediumButton = document.querySelector(`[onclick="adjustMindMapSize('medium')"]`);
            if (mediumButton) {
                mediumButton.classList.add('active');
            }
            
            console.log('✅ Mind map view reset successfully');
        } catch (error) {
            console.error('❌ Error resetting mind map view:', error);
        }
    }

    function downloadMindMap() {
        const svgElement = document.getElementById('mindMapSvg');
        const svgData = new XMLSerializer().serializeToString(svgElement);

        // Create canvas for export
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = svgElement.clientWidth;
        canvas.height = 500;

        // Create image from SVG
        const img = new Image();
        img.onload = function () {
            // White background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);

            // Download
            const link = document.createElement('a');
            link.download = 'mind_map.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        };

        const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
        img.src = URL.createObjectURL(blob);
    }

    // New Enhanced Mind Map Functions
    function searchMindMapNodes() {
        const searchTerm = document.getElementById('mindMapSearch').value.toLowerCase();
        if (!searchTerm) {
            // Reset all nodes
            d3.selectAll('.mind-node').style('opacity', 1);
            return;
        }

        d3.selectAll('.mind-node').style('opacity', function (d) {
            return d.name.toLowerCase().includes(searchTerm) ? 1 : 0.3;
        });
    }

    function filterNodes(type) {
        // Update active button
        document.querySelectorAll('[data-filter]').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-filter="${type}"]`).classList.add('active');

        if (type === 'all') {
            d3.selectAll('.mind-node').style('opacity', 1);
            d3.selectAll('.mind-link').style('opacity', 0.6);
        } else {
            d3.selectAll('.mind-node').style('opacity', function (d) {
                return d.type === type ? 1 : 0.3;
            });
            d3.selectAll('.mind-link').style('opacity', function (d) {
                const sourceNode = mindMapNodes.find(n => n.id === d.source);
                const targetNode = mindMapNodes.find(n => n.id === d.target);
                return (sourceNode && sourceNode.type === type) || (targetNode && targetNode.type === type) ? 0.6 : 0.1;
            });
        }
    }

    function adjustMindMapSize(size) {
        console.log('🔧 Adjusting mind map size to:', size);
        
        // Update active button - найдем правильные кнопки размера
        document.querySelectorAll('[onclick*="adjustMindMapSize"]').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Найдем и активируем нужную кнопку
        const targetButton = document.querySelector(`[onclick="adjustMindMapSize('${size}')"]`);
        if (targetButton) {
            targetButton.classList.add('active');
        }

        const svg = d3.select('#mindMapSvg');
        if (svg.empty()) {
            console.error('❌ SVG element not found');
            return;
        }

        let scale;
        switch (size) {
            case 'small': scale = 0.7; break;
            case 'large': scale = 1.3; break;
            default: scale = 1; break;
        }

        console.log('📏 Applying scale:', scale);

        // Проверим, есть ли zoom behavior
        try {
            const zoom = d3.zoom()
                .scaleExtent([0.3, 3])
                .on('zoom', (event) => {
                    const g = svg.select('.mind-map-group');
                    if (!g.empty()) {
                        g.attr('transform', event.transform);
                    }
                });

            svg.call(zoom);
            
            svg.transition().duration(500).call(
                zoom.transform,
                d3.zoomIdentity.scale(scale)
            );
        } catch (error) {
            console.error('❌ Error adjusting mind map size:', error);
        }
    }

    function focusOnNode(nodeId) {
        const node = mindMapNodes.find(n => n.id === nodeId);
        if (!node) return;

        const svg = d3.select('#mindMapSvg');
        const width = document.getElementById('mindMapSvg').clientWidth;
        const height = 500;

        const scale = 1.5;
        const x = width / 2 - node.x * scale;
        const y = height / 2 - node.y * scale;

        svg.transition().duration(750).call(
            d3.zoom().transform,
            d3.zoomIdentity.translate(x, y).scale(scale)
        );

        // Highlight the node
        d3.selectAll('.mind-node').style('opacity', 0.3);
        d3.select(`[data-node-id="${nodeId}"]`).style('opacity', 1);

        setTimeout(() => {
            d3.selectAll('.mind-node').style('opacity', 1);
        }, 2000);
    }

    function highlightConnections(nodeId) {
        const connectedLinks = mindMapLinks.filter(link =>
            link.source === nodeId || link.target === nodeId
        );

        const connectedNodeIds = new Set();
        connectedLinks.forEach(link => {
            connectedNodeIds.add(link.source);
            connectedNodeIds.add(link.target);
        });

        // Highlight connected nodes and links
        d3.selectAll('.mind-node').style('opacity', function (d) {
            return connectedNodeIds.has(d.id) ? 1 : 0.3;
        });

        d3.selectAll('.mind-link').style('opacity', function (d) {
            return connectedLinks.includes(d) ? 1 : 0.1;
        }).style('stroke-width', function (d) {
            return connectedLinks.includes(d) ? 3 : 1;
        });

        // Reset after 3 seconds
        setTimeout(() => {
            d3.selectAll('.mind-node').style('opacity', 1);
            d3.selectAll('.mind-link').style('opacity', 0.6).style('stroke-width', 1);
        }, 3000);
    }

    function createFlashcardFromNode(nodeId) {
        const node = window.selectedNode || mindMapNodes.find(n => n.id === nodeId);
        if (!node) {
            console.error('Node not found for flashcard creation');
            showToast('Ошибка: узел не найден', 'danger');
            return;
        }

        console.log('Creating flashcard from node:', node);

        // Get more detailed information from topics_data
        const topicsData = {{ topics_data | tojson | safe }};
        
        // Prepare flashcard data based on node type and content
        let question, answer, type, difficulty;
        
        if (node.type === 'central') {
            question = `Какова основная тема изучаемого материала?`;
            answer = `Основная тема: ${node.name}. Это центральная концепция всего изучаемого материала, которая объединяет все остальные темы и концепции.`;
            type = 'concept';
            difficulty = 3;
        } else if (node.type === 'branch') {
            // Try to find detailed information from topics_data
            let detailedAnswer = `${node.name} - это важная тема изучаемого материала.`;
            
            // Look for matching topic in topics_data
            if (topicsData && typeof topicsData === 'object') {
                const matchingTopic = Object.entries(topicsData).find(([topicName, topicData]) => 
                    topicName.toLowerCase().includes(node.name.toLowerCase()) || 
                    node.name.toLowerCase().includes(topicName.toLowerCase())
                );
                
                if (matchingTopic) {
                    const [topicName, topicData] = matchingTopic;
                    if (topicData.summary) {
                        detailedAnswer = topicData.summary;
                    } else if (topicData.key_concepts && topicData.key_concepts.length > 0) {
                        detailedAnswer = `${node.name} включает в себя следующие ключевые концепции: ${topicData.key_concepts.slice(0, 3).join(', ')}.`;
                    } else if (topicData.subtopics && topicData.subtopics.length > 0) {
                        detailedAnswer = `${node.name} состоит из следующих подтем: ${topicData.subtopics.slice(0, 3).join(', ')}.`;
                    }
                }
            }
            
            // Fallback to basic description
            if (detailedAnswer === `${node.name} - это важная тема изучаемого материала.` && node.details.children > 0) {
                detailedAnswer += ` Эта тема включает в себя ${node.details.children} подтем и является важной частью общего понимания материала.`;
            }
            
            question = `Что представляет собой "${node.name}"?`;
            answer = detailedAnswer;
            type = 'definition';
            difficulty = 2;
        } else if (node.type === 'child') {
            question = `Объясните концепцию "${node.name}"`;
            answer = `${node.name} - это подтема раздела "${node.details.parent || 'основной темы'}". Это важная составляющая, которая помогает глубже понять основную тему и её практическое применение.`;
            type = 'concept';
            difficulty = 1;
        } else {
            question = `Что такое "${node.name}"?`;
            answer = `${node.name} - это связанная концепция в изучаемом материале, которая помогает лучше понять взаимосвязи между различными темами и их практическое применение.`;
            type = 'definition';
            difficulty = 2;
        }

        const cardData = {
            q: question,
            a: answer,
            type: type,
            difficulty: difficulty,
            hint: `Эта карта создана из mind-map узла: ${node.name}`
        };

        console.log('Sending flashcard data to API:', cardData);

        // Call the API to create the flashcard
        fetch('/api/create_flashcard', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                result_id: {{ result_id }},
                card: cardData
            })
        })
        .then(response => {
            console.log('API response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API response data:', data);
            if (data.success) {
                // Add the new card to the DOM
                addCardToDOM(cardData, data.card_id);
                
                // Update statistics
                updateFlashcardStats();
                
                // Show success message
                showToast(`Флеш-карта создана для "${node.name}"! Перейдите на вкладку "Флеш-карты" чтобы увидеть её.`, 'success');
                
                // Optionally switch to flashcards tab
                setTimeout(() => {
                    const flashcardsTab = document.getElementById('flashcards-tab');
                    if (flashcardsTab) {
                        flashcardsTab.click();
                    }
                }, 1500);
            } else {
                console.error('Server returned error:', data);
                showToast(data.error || 'Ошибка при создании флеш-карты', 'danger');
            }
        })
        .catch(error => {
            console.error('Error creating flashcard:', error);
            showToast('Ошибка при создании флеш-карты. Проверьте подключение к интернету.', 'danger');
        });
    }

    function addToStudyPlan(nodeId) {
        const node = window.selectedNode || mindMapNodes.find(n => n.id === nodeId);
        if (!node) return;

        // Show success message
        const toast = document.createElement('div');
        toast.className = 'alert alert-info position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <i class="fas fa-calendar-plus me-2"></i>
            "${node.name}" добавлено в план обучения
            <button type="button" class="btn-close ms-2" onclick="this.parentElement.remove()"></button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => toast.remove(), 3000);
    }

    function fitToScreen() {
        console.log('📏 Fitting mind map to screen...');
        
        const svg = d3.select('#mindMapSvg');
        if (svg.empty()) {
            console.error('❌ SVG element not found');
            return;
        }

        try {
            const zoom = d3.zoom()
                .scaleExtent([0.3, 3])
                .on('zoom', (event) => {
                    const g = svg.select('.mind-map-group');
                    if (!g.empty()) {
                        g.attr('transform', event.transform);
                    }
                });

            svg.call(zoom);
            
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity.scale(0.8)
            );
            
            console.log('✅ Mind map fitted to screen');
        } catch (error) {
            console.error('❌ Error fitting to screen:', error);
        }
    }

    function centerView() {
        console.log('🎯 Centering mind map view...');
        
        const svg = d3.select('#mindMapSvg');
        if (svg.empty()) {
            console.error('❌ SVG element not found');
            return;
        }

        try {
            const zoom = d3.zoom()
                .scaleExtent([0.3, 3])
                .on('zoom', (event) => {
                    const g = svg.select('.mind-map-group');
                    if (!g.empty()) {
                        g.attr('transform', event.transform);
                    }
                });

            svg.call(zoom);
            
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity
            );
            
            console.log('✅ Mind map view centered');
        } catch (error) {
            console.error('❌ Error centering view:', error);
        }
    }

    function updateMindMapStats() {
        document.getElementById('nodeCount').textContent = mindMapNodes.length;
        document.getElementById('linkCount').textContent = mindMapLinks.length;
    }

    // Start study session
    function startStudySession() {
        // TODO: Implement interactive study mode
        alert('Интерактивный режим изучения будет добавлен в следующей версии');
    }

    // Start specific session
    function startSession(day) {
        // TODO: Implement session start
        alert(`Начать сессию дня ${day}`);
    }

    // Seek to video time
    function seekToTime(seconds) {
        // TODO: Implement video player integration
        alert(`Перейти к ${Math.floor(seconds / 60)}:${Math.floor(seconds % 60).toString().padStart(2, '0')}`);
    }

    // Load progress function
    function loadProgress() {
        fetch(`/api/study_progress/{{ result_id }}`)
            .then(response => response.json())
            .then(data => {
                const progressHtml = `
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h3 class="text-primary">${data.total_cards}</h3>
                            <p class="text-muted mb-0">Всего карточек</p>
                        </div>
                        <div class="col-md-4">
                            <h3 class="text-info">${data.reviewed_cards}</h3>
                            <p class="text-muted mb-0">Изучено</p>
                        </div>
                        <div class="col-md-4">
                            <h3 class="text-success">${data.mastered_cards}</h3>
                            <p class="text-muted mb-0">Освоено</p>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 25px;">
                        <div class="progress-bar bg-success" style="width: ${data.progress_percentage}%">
                            ${data.progress_percentage}%
                        </div>
                    </div>
                `;
                document.getElementById('progressContainer').innerHTML = progressHtml;
            });
    }

    // Initialize on tab change
    document.getElementById('mindmap-tab').addEventListener('shown.bs.tab', function () {
        initMindMap();
    });

    // Expand/collapse all flashcards
    function expandAll() {
        document.querySelectorAll('.accordion-collapse').forEach(el => {
            new bootstrap.Collapse(el, { show: true });
        });
    }

    function collapseAll() {
        document.querySelectorAll('.accordion-collapse').forEach(el => {
            new bootstrap.Collapse(el, { hide: true });
        });
    }

    // Enhanced Summary Functionality
    let isCompactView = false;
    let summaryText = `{{ summary|replace('\n', '\\n')|replace('"', '\\"')|safe }}`;

    function initSummary() {
        processSummaryContent();
        calculateSummaryStats();
        initReadingProgress();
        
        // Принудительно применяем белый цвет через интервалы
        setTimeout(() => {
            forceWhiteStatsColor();
            // Повторяем каждые 500мс в течение 5 секунд
            let attempts = 0;
            const interval = setInterval(() => {
                forceWhiteStatsColor();
                attempts++;
                if (attempts >= 10) {
                    clearInterval(interval);
                }
            }, 500);
        }, 100);
    }

    function processSummaryContent() {
        const summaryContainer = document.getElementById('summaryContent');
        if (!summaryContainer || !summaryText) return;

        // Process the enhanced summary text to create beautiful structured HTML
        let processedContent = summaryText;

        // Convert ALL emoji headers to structured sections with enhanced styling
        processedContent = processedContent.replace(/🎯 ([^:]+):/g, '<div class="summary-section main-idea"><div class="section-header"><span class="section-icon">🎯</span><h2>$1</h2></div><div class="section-content">');
        processedContent = processedContent.replace(/📊 ([^:]+):/g, '</div></div><div class="summary-section key-concepts"><div class="section-header"><span class="section-icon">📊</span><h2>$1</h2></div><div class="section-content">');
        processedContent = processedContent.replace(/🔗 ([^:]+):/g, '</div></div><div class="summary-section relationships"><div class="section-header"><span class="section-icon">🔗</span><h2>$1</h2></div><div class="section-content">');
        processedContent = processedContent.replace(/💡 ([^:]+):/g, '</div></div><div class="summary-section practical"><div class="section-header"><span class="section-icon">💡</span><h2>$1</h2></div><div class="section-content">');
        processedContent = processedContent.replace(/⚡ ([^:]+):/g, '</div></div><div class="summary-section critical-facts"><div class="section-header"><span class="section-icon">⚡</span><h2>$1</h2></div><div class="section-content">');
        processedContent = processedContent.replace(/🧮 ([^:]+):/g, '</div></div><div class="summary-section formulas"><div class="section-header"><span class="section-icon">🧮</span><h2>$1</h2></div><div class="section-content">');
        processedContent = processedContent.replace(/📈 ([^:]+):/g, '</div></div><div class="summary-section results"><div class="section-header"><span class="section-icon">📈</span><h2>$1</h2></div><div class="section-content">');

        // Enhanced bullet points with different styles
        processedContent = processedContent.replace(/• ([^:]+): ([^\n]+)/g, '<div class="concept-item"><div class="concept-title">$1</div><div class="concept-description">$2</div></div>');
        processedContent = processedContent.replace(/• ([^\n]+)/g, '<div class="bullet-item"><span class="bullet-icon">▸</span>$1</div>');

        // Convert bold text with enhanced styling
        processedContent = processedContent.replace(/\*\*([^*]+)\*\*/g, '<span class="highlight-text">$1</span>');

        // Convert line breaks to proper paragraphs
        processedContent = processedContent.replace(/\n\n/g, '</p><p class="summary-paragraph">');
        processedContent = processedContent.replace(/\n/g, '<br>');

        // Wrap in paragraphs and close all sections
        processedContent = '<p class="summary-paragraph">' + processedContent + '</p></div></div>';

        // Clean up empty elements
        processedContent = processedContent.replace(/<p class="summary-paragraph"><\/p>/g, '');
        processedContent = processedContent.replace(/<p class="summary-paragraph"><br><\/p>/g, '');

        summaryContainer.innerHTML = processedContent;
        
        // Add enhanced styling and interactivity
        enhanceSummaryDisplay();
    }
    
    function enhanceSummaryDisplay() {
        // Add click-to-expand functionality for sections
        document.querySelectorAll('.section-header').forEach(header => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', function() {
                const content = this.nextElementSibling;
                const isCollapsed = content.style.display === 'none';
                
                content.style.display = isCollapsed ? 'block' : 'none';
                this.classList.toggle('collapsed', !isCollapsed);
            });
        });
        
        // Add hover effects to concept items
        document.querySelectorAll('.concept-item').forEach(item => {
            item.addEventListener('mouseenter', function() {
                this.style.transform = 'translateX(5px)';
                this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            });
            
            item.addEventListener('mouseleave', function() {
                this.style.transform = 'translateX(0)';
                this.style.boxShadow = 'none';
            });
        });
        
        // Add reading time estimation for each section
        document.querySelectorAll('.summary-section').forEach(section => {
            const wordCount = section.textContent.split(/\s+/).length;
            const readingTime = Math.ceil(wordCount / 200);
            const header = section.querySelector('.section-header h2');
            if (header && readingTime > 0) {
                header.innerHTML += ` <small class="reading-time">(${readingTime} мин)</small>`;
            }
        });
    }

    function calculateSummaryStats() {
        const wordCount = summaryText.split(/\s+/).length;
        const readingTime = Math.ceil(wordCount / 200); // Average reading speed
        const sectionCount = (summaryText.match(/##/g) || []).length;
        const keyPoints = (summaryText.match(/•/g) || []).length;

        document.getElementById('wordCount').textContent = wordCount;
        document.getElementById('readingTime').textContent = readingTime;
        document.getElementById('sectionCount').textContent = sectionCount;
        document.getElementById('keyPoints').textContent = keyPoints;

        // Принудительно устанавливаем белый цвет для цифр
        console.log('🎨 Применяем белый цвет к цифрам статистики...');
        const statElements = ['wordCount', 'readingTime', 'sectionCount', 'keyPoints'];
        statElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                console.log(`Применяем стили к элементу ${id}:`, element);
                element.style.setProperty('color', 'white', 'important');
                element.style.setProperty('font-size', '2rem', 'important');
                element.style.setProperty('font-weight', 'bold', 'important');
                element.style.setProperty('text-shadow', '0 2px 4px rgba(0, 0, 0, 0.3)', 'important');
                element.style.setProperty('background', 'transparent', 'important');
                
                // Дополнительная проверка
                setTimeout(() => {
                    if (element.style.color !== 'white') {
                        console.warn(`⚠️ Цвет элемента ${id} не белый, принудительно исправляем...`);
                        element.style.cssText = 'color: white !important; font-size: 2rem !important; font-weight: bold !important; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;';
                    }
                }, 100);
            } else {
                console.error(`❌ Элемент ${id} не найден!`);
            }
        });
    }

    // Дополнительная функция для принудительного применения белого цвета
    function forceWhiteStatsColor() {
        const statElements = ['wordCount', 'readingTime', 'sectionCount', 'keyPoints'];
        statElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.style.cssText = 'color: white !important; font-size: 2rem !important; font-weight: bold !important; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important; background: transparent !important;';
                element.setAttribute('style', element.getAttribute('style') + '; color: white !important;');
            }
        });
    }

    function initReadingProgress() {
        const summaryContainer = document.getElementById('summaryContent');
        if (!summaryContainer) return;

        // Simulate reading progress based on scroll
        summaryContainer.addEventListener('scroll', function () {
            const scrollTop = this.scrollTop;
            const scrollHeight = this.scrollHeight - this.clientHeight;
            const progress = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;

            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('readingProgress').textContent = Math.round(progress) + '%';
        });

        // Auto-progress simulation for demonstration
        let autoProgress = 0;
        const progressInterval = setInterval(() => {
            if (autoProgress < 100) {
                autoProgress += 2;
                document.getElementById('progressBar').style.width = autoProgress + '%';
                document.getElementById('readingProgress').textContent = autoProgress + '%';
            } else {
                clearInterval(progressInterval);
            }
        }, 100);
    }

    function toggleSummaryView() {
        const summaryContainer = document.querySelector('.summary-modern');
        const toggleText = document.getElementById('viewToggleText');

        isCompactView = !isCompactView;

        if (isCompactView) {
            summaryContainer.classList.add('summary-compact');
            toggleText.textContent = 'Полный вид';
        } else {
            summaryContainer.classList.remove('summary-compact');
            toggleText.textContent = 'Компактный вид';
        }
    }

    function copySummary() {
        const textToCopy = summaryText.replace(/\*\*/g, '').replace(/##/g, '').replace(/•/g, '-');

        if (navigator.clipboard) {
            navigator.clipboard.writeText(textToCopy).then(() => {
                showNotification('Резюме скопировано в буфер обмена!', 'success');
            }).catch(() => {
                fallbackCopyText(textToCopy);
            });
        } else {
            fallbackCopyText(textToCopy);
        }
    }

    function fallbackCopyText(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            document.execCommand('copy');
            showNotification('Резюме скопировано в буфер обмена!', 'success');
        } catch (err) {
            showNotification('Не удалось скопировать текст', 'error');
        }

        document.body.removeChild(textArea);
    }

    function printSummary() {
        const printContent = document.getElementById('summaryContent').innerHTML;
        const printWindow = window.open('', '_blank');

        printWindow.document.write(`
            <html>
                <head>
                    <title>Резюме - AI-конспект</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; margin: 40px; }
                        h2 { color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
                        .emoji-section { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
                        .key-point { background: #fff5f5; border: 1px solid #fed7d7; border-radius: 5px; padding: 10px; margin: 8px 0; }
                        strong { color: #2d3748; }
                        @media print { body { margin: 20px; } }
                    </style>
                </head>
                <body>
                    <h1>📄 Структурированное резюме</h1>
                    <div>${printContent}</div>
                    <div style="margin-top: 40px; text-align: center; color: #666; font-size: 12px;">
                        Создано с помощью AI-конспект Pro
                    </div>
                </body>
            </html>
        `);

        printWindow.document.close();
        printWindow.focus();

        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 250);
    }

    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        // Auto remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }

    // Initialize summary when tab is shown
    document.getElementById('summary-tab').addEventListener('shown.bs.tab', function () {
        setTimeout(initSummary, 100); // Small delay to ensure content is rendered
    });

    // Initialize if summary tab is already active
    if (document.getElementById('summary-tab').classList.contains('active')) {
        setTimeout(initSummary, 100);
    }

    // Enhanced Study Plan Functionality
    let isCompactSessionView = false;

    function initStudyPlan() {
        // Initialize progress circles for milestones
        initMilestoneProgress();

        // Set up session interactions
        setupSessionInteractions();

        // Initialize timeline interactions
        initTimelineInteractions();
    }

    function initMilestoneProgress() {
        const progressCircles = document.querySelectorAll('.progress-circle');
        progressCircles.forEach(circle => {
            const progressText = circle.textContent.trim();
            const progressValue = parseInt(progressText.replace('%', ''));
            circle.style.setProperty('--progress', progressValue);
        });
    }

    function setupSessionInteractions() {
        console.log('Session interactions will be handled by event delegation');
        // Event delegation is handled globally, no need for individual listeners
    }

    function initTimelineInteractions() {
        const timelineItems = document.querySelectorAll('.timeline-item');
        timelineItems.forEach(item => {
            item.addEventListener('click', function () {
                const sessionNumber = this.dataset.session;
                scrollToSession(sessionNumber);
                highlightSession(sessionNumber);
            });
        });
    }

    function toggleSessionDetails(sessionNumber) {
        console.log('Toggling session details for session:', sessionNumber);
        const detailsElement = document.getElementById(`sessionDetails${sessionNumber}`);
        const toggleButton = document.querySelector(`.session-toggle-btn[data-session="${sessionNumber}"]`);
        const sessionCard = detailsElement ? detailsElement.closest('.session-card') : null;

        if (!detailsElement || !toggleButton) {
            console.error('Elements not found:', { detailsElement, toggleButton });
            return;
        }

        console.log('Details element found:', detailsElement);
        console.log('Toggle button found:', toggleButton);
        console.log('Current display:', detailsElement.style.display);

        const isHidden = detailsElement.style.display === 'none' ||
            getComputedStyle(detailsElement).display === 'none';

        if (isHidden) {
            console.log('Showing details...');
            // Show details
            detailsElement.style.display = 'block';
            detailsElement.style.maxHeight = '0';
            detailsElement.style.opacity = '0';
            detailsElement.style.overflow = 'hidden';
            detailsElement.style.transition = 'all 0.4s ease-out';

            // Force reflow
            detailsElement.offsetHeight;

            // Animate in
            detailsElement.style.maxHeight = '2000px';
            detailsElement.style.opacity = '1';

            // Update button
            toggleButton.innerHTML = '<i class="fas fa-chevron-up me-1"></i>Свернуть';
            toggleButton.setAttribute('title', 'Свернуть');

            // Add expanded class for styling
            if (sessionCard) {
                sessionCard.classList.add('expanded');
            }

            // Clean up after animation
            setTimeout(() => {
                detailsElement.style.maxHeight = '';
                detailsElement.style.overflow = 'visible';
                detailsElement.style.transition = '';
            }, 400);

        } else {
            console.log('Hiding details...');
            // Hide details
            detailsElement.style.maxHeight = detailsElement.scrollHeight + 'px';
            detailsElement.style.overflow = 'hidden';
            detailsElement.style.transition = 'all 0.4s ease-out';

            // Force reflow
            detailsElement.offsetHeight;

            // Animate out
            detailsElement.style.maxHeight = '0';
            detailsElement.style.opacity = '0';

            // Update button
            toggleButton.innerHTML = '<i class="fas fa-chevron-down me-1"></i>Развернуть';
            toggleButton.setAttribute('title', 'Развернуть');

            setTimeout(() => {
                detailsElement.style.display = 'none';
                detailsElement.style.maxHeight = '';
                detailsElement.style.opacity = '';
                detailsElement.style.transition = '';
                if (sessionCard) {
                    sessionCard.classList.remove('expanded');
                }
            }, 400);
        }
    }

    function toggleSessionView() {
        const sessionsContainer = document.querySelector('.sessions-container');
        const toggleButton = document.querySelector('[onclick="toggleSessionView()"]');

        isCompactSessionView = !isCompactSessionView;

        if (isCompactSessionView) {
            sessionsContainer.classList.add('compact-view');
            toggleButton.innerHTML = '<i class="fas fa-expand me-1"></i>Полный вид';

            // Hide all expanded details
            document.querySelectorAll('.session-details').forEach(details => {
                details.style.display = 'none';
            });
        } else {
            sessionsContainer.classList.remove('compact-view');
            toggleButton.innerHTML = '<i class="fas fa-list me-1"></i>Компактный вид';
        }
    }

    function startSession(sessionNumber) {
        // Create session modal or redirect to session page
        showSessionModal(sessionNumber);
    }

    function showSessionModal(sessionNumber) {
        // Find session data
        const sessionCard = document.querySelector(`[data-session="${sessionNumber}"]`);
        if (!sessionCard) return;

        const sessionTitle = sessionCard.querySelector('.session-title h6').textContent;
        const sessionPhase = sessionCard.querySelector('.session-phase').textContent;
        const sessionDuration = sessionCard.querySelector('.session-duration').textContent;

        // Create modal content
        const modalContent = `
            <div class="modal fade" id="sessionModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-play-circle me-2"></i>
                                Начать ${sessionTitle}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="session-start-info">
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="info-card">
                                            <div class="info-icon">📚</div>
                                            <div class="info-label">Фаза</div>
                                            <div class="info-value">${sessionPhase}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="info-card">
                                            <div class="info-icon">⏱️</div>
                                            <div class="info-label">Длительность</div>
                                            <div class="info-value">${sessionDuration}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="info-card">
                                            <div class="info-icon">🎯</div>
                                            <div class="info-label">Сессия</div>
                                            <div class="info-value">#${sessionNumber}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="session-checklist">
                                    <h6><i class="fas fa-clipboard-check me-2"></i>Подготовка к сессии</h6>
                                    <div class="checklist-items">
                                        <label class="checklist-item">
                                            <input type="checkbox" class="form-check-input me-2">
                                            Подготовить рабочее место и материалы
                                        </label>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="form-check-input me-2">
                                            Убрать отвлекающие факторы (телефон, уведомления)
                                        </label>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="form-check-input me-2">
                                            Настроить таймер на ${sessionDuration}
                                        </label>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="form-check-input me-2">
                                            Подготовить воду и перекус
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Отмена
                            </button>
                            <button type="button" class="btn btn-success" onclick="beginSession(${sessionNumber})">
                                <i class="fas fa-rocket me-1"></i>Начать изучение!
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal
        const existingModal = document.getElementById('sessionModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalContent);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('sessionModal'));
        modal.show();

        // Add styles for modal content
        const modalStyles = `
            <style>
                .session-start-info .info-card {
                    text-align: center;
                    padding: 15px;
                    background: #f8f9fa;
                    border-radius: 10px;
                    margin-bottom: 15px;
                }
                .session-start-info .info-icon {
                    font-size: 2rem;
                    margin-bottom: 8px;
                }
                .session-start-info .info-label {
                    font-size: 0.9rem;
                    color: #495057;
                    margin-bottom: 4px;
                }
                .session-start-info .info-value {
                    font-weight: 600;
                    color: #495057;
                }
                .session-checklist {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 10px;
                    margin-top: 20px;
                }
                .checklist-items {
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                    margin-top: 15px;
                }
                .checklist-item {
                    display: flex;
                    align-items: center;
                    padding: 8px 12px;
                    background: white;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: background-color 0.2s;
                }
                .checklist-item:hover {
                    background: #e9ecef;
                }
            </style>
        `;

        if (!document.getElementById('sessionModalStyles')) {
            document.head.insertAdjacentHTML('beforeend', modalStyles.replace('<style>', '<style id="sessionModalStyles">'));
        }
    }

    function beginSession(sessionNumber) {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('sessionModal'));
        modal.hide();

        // Mark session as started
        const sessionCard = document.querySelector(`[data-session="${sessionNumber}"]`);
        if (sessionCard) {
            sessionCard.classList.add('session-started');

            // Update button
            const startButton = sessionCard.querySelector('[onclick*="startSession"]');
            if (startButton) {
                startButton.innerHTML = '<i class="fas fa-check me-1"></i>В процессе';
                startButton.classList.remove('btn-primary');
                startButton.classList.add('btn-success');
            }
        }

        // Show success notification
        showNotification('Сессия начата! Удачного изучения! 🚀', 'success');

        // Optional: Start timer or redirect to study interface
        startSessionTimer(sessionNumber);
    }

    function startSessionTimer(sessionNumber) {
        // This could integrate with a Pomodoro timer or study tracker
        console.log(`Starting timer for session ${sessionNumber}`);

        // Example: Show a floating timer
        const timerHtml = `
            <div id="studyTimer" class="study-timer">
                <div class="timer-content">
                    <div class="timer-icon">⏱️</div>
                    <div class="timer-text">
                        <div class="timer-session">Сессия ${sessionNumber}</div>
                        <div class="timer-time" id="timerDisplay">45:00</div>
                    </div>
                    <button class="timer-close" onclick="closeTimer()">×</button>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', timerHtml);

        // Add timer styles
        const timerStyles = `
            <style id="timerStyles">
                .study-timer {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 1050;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 15px;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
                    animation: slideInRight 0.3s ease-out;
                }
                .timer-content {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }
                .timer-icon {
                    font-size: 1.5rem;
                }
                .timer-session {
                    font-size: 0.8rem;
                    opacity: 0.9;
                }
                .timer-time {
                    font-size: 1.2rem;
                    font-weight: bold;
                }
                .timer-close {
                    background: none;
                    border: none;
                    color: white;
                    font-size: 1.2rem;
                    cursor: pointer;
                    opacity: 0.7;
                    margin-left: 10px;
                }
                .timer-close:hover {
                    opacity: 1;
                }
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            </style>
        `;

        if (!document.getElementById('timerStyles')) {
            document.head.insertAdjacentHTML('beforeend', timerStyles);
        }
    }

    function closeTimer() {
        const timer = document.getElementById('studyTimer');
        if (timer) {
            timer.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => timer.remove(), 300);
        }
    }

    function scrollToSession(sessionNumber) {
        const sessionCard = document.querySelector(`[data-session="${sessionNumber}"]`);
        if (sessionCard) {
            sessionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function highlightSession(sessionNumber) {
        // Remove previous highlights
        document.querySelectorAll('.session-card.highlighted').forEach(card => {
            card.classList.remove('highlighted');
        });

        // Add highlight to selected session
        const sessionCard = document.querySelector(`[data-session="${sessionNumber}"]`);
        if (sessionCard) {
            sessionCard.classList.add('highlighted');
            setTimeout(() => {
                sessionCard.classList.remove('highlighted');
            }, 2000);
        }
    }

    // Initialize study plan when tab is shown
    document.getElementById('studyplan-tab').addEventListener('shown.bs.tab', function () {
        setTimeout(initStudyPlan, 100);
    });

    // Initialize mind map when tab is shown
    document.getElementById('mindmap-tab').addEventListener('shown.bs.tab', function () {
        setTimeout(initMindMap, 100);
    });

    // Add CSS animations for session interactions
    const studyPlanStyles = `
        <style id="studyPlanInteractionStyles">
            @keyframes slideDown {
                from { opacity: 0; max-height: 0; }
                to { opacity: 1; max-height: 1000px; }
            }
            @keyframes slideUp {
                from { opacity: 1; max-height: 1000px; }
                to { opacity: 0; max-height: 0; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .session-card.highlighted {
                transform: scale(1.02);
                box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3) !important;
                border: 2px solid #667eea;
                transition: all 0.3s ease;
            }
            .session-card.session-started {
                border-left: 5px solid #28a745;
            }
            .sessions-container.compact-view .session-details {
                display: none !important;
            }
            .sessions-container.compact-view .session-card {
                margin-bottom: 10px;
            }
            .sessions-container.compact-view .session-header {
                padding: 15px;
            }
        </style>
    `;

    if (!document.getElementById('studyPlanInteractionStyles')) {
        document.head.insertAdjacentHTML('beforeend', studyPlanStyles);
    }

    // Simple direct event delegation for session toggle buttons
    let isToggling = false;

    document.addEventListener('click', function (e) {
        // Check if clicked element is a session toggle button
        if (e.target.closest('.session-toggle-btn')) {
            e.preventDefault();
            e.stopPropagation();

            // Prevent double clicks
            if (isToggling) {
                console.log('Toggle already in progress, ignoring click');
                return;
            }

            const button = e.target.closest('.session-toggle-btn');
            const sessionNumber = button.getAttribute('data-session');

            console.log('Session toggle clicked for session:', sessionNumber);
            isToggling = true;

            toggleSessionDetails(sessionNumber);

            // Reset flag after animation
            setTimeout(() => {
                isToggling = false;
            }, 500);
        }
    });

    // Initialize study plan functionality when page loads
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM loaded, initializing study plan...');
        initStudyPlan();
        initMathSupport();
    });

    // Beautiful Math Support - Enhanced Visual Display
    function initMathSupport() {
        console.log('Initializing beautiful MathJax support...');

        // Wait for MathJax to be ready
        if (window.MathJax && window.MathJax.typesetPromise) {
            processBeautifulMath();
        } else {
            // Listen for MathJax ready event
            document.addEventListener('mathjax-ready', function () {
                console.log('MathJax ready event received');
                processBeautifulMath();
            });

            // Fallback timeout
            setTimeout(() => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    processBeautifulMath();
                } else {
                    console.log('MathJax not available, trying again...');
                    setTimeout(initMathSupport, 2000);
                }
            }, 2000);
        }

        // Also process when tabs are switched
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function () {
                setTimeout(() => {
                    processBeautifulMath();
                }, 500);
            });
        });
    }

    function processBeautifulMath() {
        console.log('Processing math with beautiful MathJax formatting...');

        // Find all text content that might contain math formulas
        const contentElements = document.querySelectorAll(
            '.summary-content-enhanced, .flashcard-question, .answer-content, .accordion-body, .topic-card'
        );

        contentElements.forEach(element => {
            if (element.textContent && !element.classList.contains('math-processed')) {
                element.classList.add('math-processing');

                let content = element.innerHTML;

                // Process LaTeX formulas only (conservative approach)
                content = createBeautifulMathFormulas(content);
                content = conservativeMathDetection(content);

                element.innerHTML = content;
                element.classList.remove('math-processing');
                element.classList.add('math-processed');
            }
        });

        // Re-render math with MathJax
        renderMathWithMathJax();
    }

    // Простая и эффективная система распознавания математики
    function smartMathDetection(content) {
        console.log('Smart math detection starting...');

        // Стратегия: найти целые предложения с математикой и обернуть их полностью

        // Паттерны для поиска математических предложений
        const patterns = [
            // Уравнения с греческими буквами и функциями
            /([^.!?\n]*(?:ξi|λi|σ|max|min|exp|sign)[^.!?\n]*[.!?]?)/gi,
            // Выражения с неравенствами и математическими символами  
            /([^.!?\n]*(?:[<>=]|[*+\-/]|\^|\|)[^.!?\n]*(?:λ|σ|ξ|C)[^.!?\n]*[.!?]?)/gi,
            // Функции и формулы
            /([^.!?\n]*(?:[a-zA-Z]\([^)]*\)|K\([^)]*\))[^.!?\n]*[.!?]?)/gi
        ];

        patterns.forEach(pattern => {
            content = content.replace(pattern, (match) => {
                const trimmed = match.trim();

                // Пропустить если уже обработано или слишком короткое
                if (trimmed.includes('<') || trimmed.includes('mjx-') || trimmed.length < 10) {
                    return match;
                }

                // Проверить, содержит ли математические элементы
                if (containsMathElements(trimmed)) {
                    console.log('Converting to math:', trimmed);
                    return `$${cleanMathExpression(trimmed)}$`;
                }

                return match;
            });
        });

        return content;
    }

    function containsMathElements(text) {
        const mathIndicators = [
            /[ξλσπφμωαβγδθ]/i,  // Греческие буквы
            /exp\(|sign\(|max\s|min\s/i,  // Функции
            /[<>=]/,  // Операторы сравнения
            /\^[0-9]/,  // Степени
            /_[a-zA-Z0-9]/,  // Индексы
            /\|\|/,  // Нормы
            /[*]/  // Умножение
        ];

        return mathIndicators.some(pattern => pattern.test(text));
    }

    function cleanMathExpression(text) {
        let cleaned = text;

        // Убрать точки в конце
        cleaned = cleaned.replace(/[.!?]+$/, '');

        // Преобразовать в LaTeX
        cleaned = cleaned.replace(/ξi/g, '\\xi_i');
        cleaned = cleaned.replace(/λi/g, '\\lambda_i');
        cleaned = cleaned.replace(/σ²/g, '\\sigma^2');
        cleaned = cleaned.replace(/σ/g, '\\sigma');
        cleaned = cleaned.replace(/λ/g, '\\lambda');
        cleaned = cleaned.replace(/μ/g, '\\mu');
        cleaned = cleaned.replace(/ξ/g, '\\xi');
        cleaned = cleaned.replace(/exp\(/g, '\\exp(');
        cleaned = cleaned.replace(/sign\(/g, '\\text{sign}(');
        cleaned = cleaned.replace(/max\s/g, '\\max ');
        cleaned = cleaned.replace(/min\s/g, '\\min ');
        cleaned = cleaned.replace(/\*/g, ' \\cdot ');
        cleaned = cleaned.replace(/\|\|/g, '\\|');
        cleaned = cleaned.replace(/\^2/g, '^2');
        cleaned = cleaned.replace(/\^([0-9]+)/g, '^{$1}');
        cleaned = cleaned.replace(/([0-9]+)\/([0-9]+)/g, '\\frac{$1}{$2}');

        return cleaned;
    }

    // УНИВЕРСАЛЬНАЯ система распознавания математики - обрабатывает ЛЮБЫЕ формулы
    function universalMathDetection(content) {
        console.log('Universal math detection starting...');
        
        // Стратегия: найти ВСЕ возможные математические паттерны
        
        // 1. Сначала защитим уже существующие LaTeX формулы
        const protectedMath = [];
        content = content.replace(/\$\$([^$]+)\$\$/g, (match) => {
            protectedMath.push(match);
            return `__PROTECTED_DISPLAY_${protectedMath.length - 1}__`;
        });
        content = content.replace(/\$([^$]+)\$/g, (match) => {
            protectedMath.push(match);
            return `__PROTECTED_INLINE_${protectedMath.length - 1}__`;
        });
        
        // 2. Универсальные паттерны для ЛЮБЫХ математических выражений
        const universalPatterns = [
            // Любые выражения с греческими буквами
            /([^<>\n]*[ξλσμπφωαβγδθΦΠΩΛΔΓΒΑ][^<>\n]*)/gi,
            
            // Любые выражения с математическими функциями
            /([^<>\n]*(?:exp|sign|cos|sin|tan|log|ln|sqrt|max|min)\s*\([^)]*\)[^<>\n]*)/gi,
            
            // Любые выражения с операторами и символами
            /([^<>\n]*(?:[=<>≤≥≠±∞∑∏∫]|[*+\-/\^]|[0-9]+\/[0-9]+|\|\|)[^<>\n]*)/gi,
            
            // Любые выражения с индексами и степенями
            /([^<>\n]*[a-zA-Z][_\^][a-zA-Z0-9]+[^<>\n]*)/gi,
            
            // Любые выражения в скобках с переменными
            /([a-zA-Z]\s*\([^)]*[a-zA-Z][^)]*\)\s*[=<>][^<>\n]*)/gi,
            
            // Любые числовые выражения с операторами
            /([^<>\n]*[0-9]+\s*[+\-*/\^]\s*[0-9]+[^<>\n]*)/gi
        ];
        
        universalPatterns.forEach((pattern, index) => {
            content = content.replace(pattern, (match) => {
                const trimmed = match.trim();
                
                // Пропустить если уже защищено или обработано
                if (trimmed.includes('__PROTECTED_') || trimmed.includes('<') || 
                    trimmed.includes('mjx-') || trimmed.length < 3) {
                    return match;
                }
                
                // Пропустить если это обычный текст (слишком много букв подряд)
                if (isPlainText(trimmed)) {
                    return match;
                }
                
                // Проверить, что это математическое выражение
                if (isMathematicalContent(trimmed)) {
                    console.log(`Pattern ${index + 1} found math:`, trimmed);
                    return `$${universalLatexConversion(trimmed)}$`;
                }
                
                return match;
            });
        });
        
        // 3. Восстановить защищенные формулы
        protectedMath.forEach((formula, index) => {
            content = content.replace(`__PROTECTED_DISPLAY_${index}__`, formula);
            content = content.replace(`__PROTECTED_INLINE_${index}__`, formula);
        });
        
        return content;
    }
    
    function isPlainText(text) {
        // Проверить, является ли текст обычным (не математическим)
        const plainTextIndicators = [
            /^[а-яёa-z\s]{15,}$/gi,  // Длинные последовательности обычных букв
            /\b(?:и|в|на|с|для|от|по|к|из|при|что|как|если|то|или|но|а|да|нет)\b/gi,  // Обычные слова
            /[.!?]{2,}/,  // Множественная пунктуация
        ];
        
        return plainTextIndicators.some(pattern => pattern.test(text));
    }
    
    function isMathematicalContent(text) {
        // Проверить, содержит ли текст математические элементы
        const mathScore = [
            /[ξλσμπφωαβγδθΦΠΩΛΔΓΒΑ]/.test(text) ? 3 : 0,  // Греческие буквы
            /(?:exp|sign|cos|sin|tan|log|ln|sqrt|max|min)\s*\(/.test(text) ? 3 : 0,  // Функции
            /[=<>≤≥≠±∞∑∏∫]/.test(text) ? 2 : 0,  // Математические операторы
            /[a-zA-Z][_\^][a-zA-Z0-9]/.test(text) ? 2 : 0,  // Индексы/степени
            /\|\|/.test(text) ? 2 : 0,  // Нормы
            /[0-9]+\/[0-9]+/.test(text) ? 1 : 0,  // Дроби
            /[*+\-/\^]/.test(text) ? 1 : 0,  // Арифметические операторы
        ].reduce((a, b) => a + b, 0);
        
        return mathScore >= 2;  // Минимум 2 балла для математики
    }
    
    function universalLatexConversion(text) {
        let latex = text;
        
        // Универсальные преобразования в LaTeX
        
        // Греческие буквы (все возможные)
        const greekLetters = {
            'α': '\\alpha', 'β': '\\beta', 'γ': '\\gamma', 'δ': '\\delta',
            'ε': '\\varepsilon', 'ζ': '\\zeta', 'η': '\\eta', 'θ': '\\theta',
            'ι': '\\iota', 'κ': '\\kappa', 'λ': '\\lambda', 'μ': '\\mu',
            'ν': '\\nu', 'ξ': '\\xi', 'ο': 'o', 'π': '\\pi',
            'ρ': '\\rho', 'σ': '\\sigma', 'τ': '\\tau', 'υ': '\\upsilon',
            'φ': '\\phi', 'χ': '\\chi', 'ψ': '\\psi', 'ω': '\\omega',
            'Α': 'A', 'Β': 'B', 'Γ': '\\Gamma', 'Δ': '\\Delta',
            'Ε': 'E', 'Ζ': 'Z', 'Η': 'H', 'Θ': '\\Theta',
            'Ι': 'I', 'Κ': 'K', 'Λ': '\\Lambda', 'Μ': 'M',
            'Ν': 'N', 'Ξ': '\\Xi', 'Ο': 'O', 'Π': '\\Pi',
            'Ρ': 'P', 'Σ': '\\Sigma', 'Τ': 'T', 'Υ': '\\Upsilon',
            'Φ': '\\Phi', 'Χ': 'X', 'Ψ': '\\Psi', 'Ω': '\\Omega'
        };
        
        Object.entries(greekLetters).forEach(([greek, latexCmd]) => {
            latex = latex.replace(new RegExp(greek, 'g'), latexCmd);
        });
        
        // Математические функции
        latex = latex.replace(/\b(exp|sin|cos|tan|log|ln|sqrt|max|min|sign)\s*\(/g, '\\$1(');
        
        // Операторы
        latex = latex.replace(/≤/g, '\\leq');
        latex = latex.replace(/≥/g, '\\geq');
        latex = latex.replace(/≠/g, '\\neq');
        latex = latex.replace(/±/g, '\\pm');
        latex = latex.replace(/∞/g, '\\infty');
        latex = latex.replace(/∑/g, '\\sum');
        latex = latex.replace(/∏/g, '\\prod');
        latex = latex.replace(/∫/g, '\\int');
        
        // Индексы и степени
        latex = latex.replace(/([a-zA-Z\\]+)_([a-zA-Z0-9]+)/g, '$1_{$2}');
        latex = latex.replace(/([a-zA-Z\\]+)\^([a-zA-Z0-9]+)/g, '$1^{$2}');
        
        // Дроби
        latex = latex.replace(/([a-zA-Z0-9\\]+)\/([a-zA-Z0-9\\]+)/g, '\\frac{$1}{$2}');
        
        // Нормы
        latex = latex.replace(/\|\|([^|]+)\|\|/g, '\\|$1\\|');
        
        // Умножение
        latex = latex.replace(/\*/g, '\\cdot');
        
        // Убрать лишние пробелы и знаки препинания в конце
        latex = latex.replace(/[.!?]+$/, '').trim();
        
        return latex;
    }

    // КОНСЕРВАТИВНАЯ система распознавания математики - только очевидные формулы
    function conservativeMathDetection(content) {
        console.log('Conservative math detection starting...');
        
        // Очень осторожные паттерны - только явные математические выражения
        const conservativePatterns = [
            // Только конкретные неравенства: ξi = 0, 0 < λi < C
            /(\b[ξλσμ][a-zA-Z0-9]*\s*[=<>]\s*[0-9]+(?:\s*[,;]\s*[0-9]+\s*[<>]\s*[ξλσμ][a-zA-Z0-9]*\s*[<>]\s*[A-Z])?)/g,
            
            // Только функции с явными математическими символами: exp(-||x||^2)
            /(\b(?:exp|sign|cos|sin|log|max|min)\s*\([^)]*(?:\|\||[ξλσμπ]|[0-9]+\/[0-9]+)[^)]*\))/gi,
            
            // Только выражения с нормами: ||w||^2
            /(\|\|[a-zA-Z]+\|\|(?:\^[0-9]+)?)/g,
            
            // Только дроби с числами: 1/2, 3/4
            /(\b[0-9]+\/[0-9]+\b)/g
        ];
        
        conservativePatterns.forEach((pattern, index) => {
            content = content.replace(pattern, (match) => {
                const trimmed = match.trim();
                
                // Пропустить если уже обработано
                if (trimmed.includes('<') || trimmed.includes('mjx-') || trimmed.length < 3) {
                    return match;
                }
                
                console.log(`Conservative pattern ${index + 1} found:`, trimmed);
                return `$${cleanMathExpression(trimmed)}$`;
            });
        });
        
        return content;
    }

    // Точная система распознавания математики - избегает обычных слов
    function preciseMathDetection(content) {
        console.log('Precise math detection starting...');

        // Очень специфичные паттерны для математических выражений
        const precisePatterns = [
            // Конкретные неравенства с греческими буквами: ξi = 0, 0 < λi < C
            /([ξλσμ][a-zA-Z0-9]*\s*[=<>]\s*[0-9.,\s<>ξλσμCa-zA-Z]*[,;.]?)/g,
            // Выражения с max/min и суммами: max λ Σ(λi) - 1/2 ΣΣ(...)
            /((?:max|min)\s+[λσξμ][^.!?\n]*(?:Σ|∑)[^.!?\n]*)/gi,
            // Математические функции с операторами: exp(-||x||^2)
            /([a-zA-Z]*\s*(?:exp|sign|cos|sin|log)\s*\([^)]*\|\|[^)]*\)[^.!?\n]*)/gi,
            // Функции потерь: L(w, b, ξ, λ, μ) = ...
            /([L]\s*\([^)]*[ξλσμ][^)]*\)\s*=\s*[^.!?\n]*(?:Σ|∑|exp|sign)[^.!?\n]*)/gi,
            // Функции активации: a(x) = sign(...)
            /([a-zA-Z]\s*\([^)]*\)\s*=\s*(?:sign|exp|cos|sin)\s*\([^.!?\n]*\))/gi,
            // Выражения с нормами: ||w||^2
            /([^.!?\n]*\|\|[^|]*\|\|(?:\^[0-9])?[^.!?\n]*)/gi
        ];

        precisePatterns.forEach(pattern => {
            content = content.replace(pattern, (match) => {
                const trimmed = match.trim();

                // Пропустить если уже обработано
                if (trimmed.includes('<') || trimmed.includes('mjx-') || trimmed.length < 5) {
                    return match;
                }

                // Пропустить если содержит слишком много обычных букв подряд
                if (hasLongWordSequences(trimmed)) {
                    return match;
                }

                console.log('Converting precise math:', trimmed);
                return `$${cleanMathExpression(trimmed)}$`;
            });
        });

        return content;
    }

    function hasLongWordSequences(text) {
        // Проверить, есть ли длинные последовательности обычных букв (вероятно, слова)
        const longWordPattern = /[а-яёa-z]{8,}/gi;
        const matches = text.match(longWordPattern);
        return matches && matches.length > 0;
    }

    function autoDetectMathExpressions(content) {
        console.log('Auto-detecting math in content:', content.substring(0, 200));

        // Improved math detection - wrap mathematical expressions in MathJax delimiters
        // This will catch expressions like: w(i,x) = λ(i) exp(-||x - x(i)||^2 / (2σ^2))

        // Pattern to match mathematical expressions
        const mathPatterns = [
            // Complex expressions with functions and Greek letters
            /([a-zA-Z]\s*\([^)]+\)\s*=\s*[^.]*(?:[ΣσλπφμωαβγδθΦΠΩΛΔΓΒΑ]|exp|sign|cos|sin|log|sqrt)[^.]*)/gi,
            // Expressions with Greek letters and mathematical operators
            /([^<>\n]*(?:[ΣσλπφμωαβγδθΦΠΩΛΔΓΒΑ]|exp|sign|cos|sin|log|sqrt)[^<>\n]*(?:\^[0-9]|_[a-zA-Z0-9]|\|\|)[^<>\n]*)/gi,
            // Simple expressions with powers and subscripts
            /([a-zA-Z]+(?:\^[0-9]+|_[a-zA-Z0-9]+))/g
        ];

        mathPatterns.forEach(pattern => {
            content = content.replace(pattern, (match) => {
                // Skip if already processed or contains HTML
                if (match.includes('<') || match.includes('mjx-') || match.includes('class=') || match.trim().length < 5) {
                    return match;
                }

                // Skip if it's just a single character
                if (match.trim().length < 3) {
                    return match;
                }

                console.log('Found math expression:', match.trim());

                // Convert to proper LaTeX and wrap in MathJax delimiters
                const latexFormula = convertToLatex(match.trim());
                return `$${latexFormula}$`;
            });
        });

        return content;
    }

    function convertToLatex(text) {
        let latex = text;

        // Convert common mathematical expressions to LaTeX

        // Greek letters
        latex = latex.replace(/λ/g, '\\lambda');
        latex = latex.replace(/σ/g, '\\sigma');
        latex = latex.replace(/Σ/g, '\\sum');
        latex = latex.replace(/π/g, '\\pi');
        latex = latex.replace(/φ/g, '\\phi');
        latex = latex.replace(/μ/g, '\\mu');
        latex = latex.replace(/ω/g, '\\omega');
        latex = latex.replace(/α/g, '\\alpha');
        latex = latex.replace(/β/g, '\\beta');
        latex = latex.replace(/γ/g, '\\gamma');
        latex = latex.replace(/δ/g, '\\delta');
        latex = latex.replace(/θ/g, '\\theta');

        // Functions
        latex = latex.replace(/exp\(/g, '\\exp(');
        latex = latex.replace(/sign\(/g, '\\text{sign}(');
        latex = latex.replace(/cos\(/g, '\\cos(');
        latex = latex.replace(/sin\(/g, '\\sin(');
        latex = latex.replace(/log\(/g, '\\log(');
        latex = latex.replace(/sqrt\(/g, '\\sqrt{');

        // Norms and absolute values
        latex = latex.replace(/\|\|([^|]+)\|\|/g, '\\|$1\\|');

        // Powers and subscripts
        latex = latex.replace(/\^([0-9]+)/g, '^{$1}');
        latex = latex.replace(/\^([a-zA-Z])/g, '^{$1}');
        latex = latex.replace(/_([a-zA-Z0-9]+)/g, '_{$1}');

        // Fractions
        latex = latex.replace(/(\d+)\/(\d+)/g, '\\frac{$1}{$2}');
        latex = latex.replace(/([a-zA-Z]+)\/([a-zA-Z0-9]+)/g, '\\frac{$1}{$2}');

        // Special cases for your example
        latex = latex.replace(/w\s*\(\s*i\s*,\s*x\s*\)/g, 'w(i,x)');
        latex = latex.replace(/x\s*-\s*x\s*\(\s*i\s*\)/g, 'x - x(i)');

        return latex;
    }

    function containsMathSymbols(text) {
        // Check if text contains mathematical symbols
        const mathIndicators = [
            /[Σσλπφμωαβγδθ]/,  // Greek letters
            /\^[0-9]/,           // Powers like ^2
            /[a-zA-Z]_[a-zA-Z0-9]/, // Subscripts like x_i
            /exp\(/,             // Functions like exp(
            /sin\(|cos\(|tan\(/, // Trig functions
            /\|\|/,              // Norms like ||x||
            /sqrt\(/,            // Square root
            /log\(|ln\(/,        // Logarithms
            /sign\(/             // Sign function
        ];

        return mathIndicators.some(pattern => pattern.test(text));
    }

    function beautifyAutoDetectedFormula(formula) {
        let processed = formula;

        // Replace Greek letters
        processed = processed.replace(/Σ/g, '<span class="math-symbol">Σ</span>');
        processed = processed.replace(/σ/g, '<span class="math-symbol">σ</span>');
        processed = processed.replace(/λ/g, '<span class="math-symbol">λ</span>');
        processed = processed.replace(/π/g, '<span class="math-symbol">π</span>');
        processed = processed.replace(/φ/g, '<span class="math-symbol">φ</span>');
        processed = processed.replace(/μ/g, '<span class="math-symbol">μ</span>');
        processed = processed.replace(/ω/g, '<span class="math-symbol">ω</span>');
        processed = processed.replace(/α/g, '<span class="math-symbol">α</span>');
        processed = processed.replace(/β/g, '<span class="math-symbol">β</span>');
        processed = processed.replace(/γ/g, '<span class="math-symbol">γ</span>');
        processed = processed.replace(/δ/g, '<span class="math-symbol">δ</span>');
        processed = processed.replace(/θ/g, '<span class="math-symbol">θ</span>');

        // Replace mathematical functions
        processed = processed.replace(/\b(sin|cos|tan|log|ln|exp|sign)\(/g, '<span class="math-func">$1</span>(');

        // Replace powers
        processed = processed.replace(/\^([0-9]+)/g, '<span class="math-sup">$1</span>');
        processed = processed.replace(/\^2/g, '<span class="math-sup">2</span>');
        processed = processed.replace(/\^3/g, '<span class="math-sup">3</span>');

        // Replace subscripts
        processed = processed.replace(/([a-zA-Z])_([a-zA-Z0-9]+)/g, '$1<span class="math-sub">$2</span>');
        processed = processed.replace(/([a-zA-Z])i/g, '$1<span class="math-sub">i</span>');

        // Replace norms and absolute values
        processed = processed.replace(/\|\|([^|]+)\|\|/g, '<span class="math-symbol">||</span>$1<span class="math-symbol">||</span>');

        // Replace fractions (simple pattern like a/b)
        processed = processed.replace(/([^/\s]+)\s*\/\s*([^/\s]+)/g, (match, num, den) => {
            // Only if it looks like a mathematical fraction
            if (/^[0-9a-zA-Z^_σλπφμωαβγδθΣ\s]+$/.test(num + den)) {
                return `<span class="math-frac"><span class="numerator">${num.trim()}</span><span class="denominator">${den.trim()}</span></span>`;
            }
            return match;
        });

        // Style parentheses
        processed = processed.replace(/\(/g, '<span class="math-paren">(</span>');
        processed = processed.replace(/\)/g, '<span class="math-paren">)</span>');

        return processed;
    }

    function createBeautifulMathFormulas(content) {
        // Handle display formulas ($$...$$) with beautiful formatting
        content = content.replace(/\$\$([^$]+)\$\$/g, (match, formula) => {
            console.log('Processing formula:', formula);
            return `<div class="math-formula">${beautifyFormula(formula)}</div>`;
        });

        // Handle inline formulas ($...$)
        content = content.replace(/\$([^$]+)\$/g, (match, formula) => {
            return `<span class="math-inline">${beautifyFormula(formula, true)}</span>`;
        });

        return content;
    }

    function beautifyFormula(formula, isInline = false) {
        let processed = formula;

        // Handle fractions with beautiful styling
        processed = processed.replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, (match, num, den) => {
            if (isInline) {
                return `<span class="math-fraction"><sup>${beautifyContent(num)}</sup>⁄<sub>${beautifyContent(den)}</sub></span>`;
            } else {
                return `<span class="math-frac"><span class="numerator">${beautifyContent(num)}</span><span class="denominator">${beautifyContent(den)}</span></span>`;
            }
        });

        // Handle parentheses with styling
        processed = processed.replace(/\\left\(/g, '<span class="math-paren">(</span>');
        processed = processed.replace(/\\right\)/g, '<span class="math-paren">)</span>');
        processed = processed.replace(/\\left\[/g, '<span class="math-paren">[</span>');
        processed = processed.replace(/\\right\]/g, '<span class="math-paren">]</span>');
        processed = processed.replace(/\\left\{/g, '<span class="math-paren">{</span>');
        processed = processed.replace(/\\right\}/g, '<span class="math-paren">}</span>');

        // Handle mathematical functions
        processed = processed.replace(/\\?(sin|cos|tan|log|ln|exp|sign)\b/g, '<span class="math-func">$1</span>');

        // Handle Greek letters with beautiful styling
        const greekReplacements = [
            ['\\\\sum', '<span class="math-symbol">Σ</span>'],
            ['\\\\Sigma', '<span class="math-symbol">Σ</span>'],
            ['\\\\lambda', '<span class="math-symbol">λ</span>'],
            ['\\\\sigma', '<span class="math-symbol">σ</span>'],
            ['\\\\pi', '<span class="math-symbol">π</span>'],
            ['\\\\alpha', '<span class="math-symbol">α</span>'],
            ['\\\\beta', '<span class="math-symbol">β</span>'],
            ['\\\\gamma', '<span class="math-symbol">γ</span>'],
            ['\\\\delta', '<span class="math-symbol">δ</span>'],
            ['\\\\phi', '<span class="math-symbol">φ</span>'],
            ['\\\\Phi', '<span class="math-symbol">Φ</span>'],
            ['\\\\mu', '<span class="math-symbol">μ</span>'],
            ['\\\\omega', '<span class="math-symbol">ω</span>'],
            ['\\\\theta', '<span class="math-symbol">θ</span>']
        ];

        greekReplacements.forEach(([pattern, replacement]) => {
            processed = processed.replace(new RegExp(pattern, 'g'), replacement);
        });

        // Handle superscripts and subscripts with beautiful styling
        processed = processed.replace(/([a-zA-Z0-9]+)\^([a-zA-Z0-9]+)/g, '$1<span class="math-sup">$2</span>');
        processed = processed.replace(/([a-zA-Z0-9]+)_([a-zA-Z0-9]+)/g, '$1<span class="math-sub">$2</span>');

        // Handle special cases
        processed = processed.replace(/\^2/g, '<span class="math-sup">2</span>');
        processed = processed.replace(/\^3/g, '<span class="math-sup">3</span>');
        processed = processed.replace(/_i/g, '<span class="math-sub">i</span>');
        processed = processed.replace(/_j/g, '<span class="math-sub">j</span>');

        // Handle mathematical operators
        processed = processed.replace(/\|\|/g, '<span class="math-symbol">||</span>');
        processed = processed.replace(/\*/g, '<span class="math-symbol">·</span>');

        return processed;
    }

    function beautifyContent(content) {
        // Process content inside fractions, superscripts, etc.
        let processed = content;

        // Greek letters (simple replacements)
        const simpleGreek = [
            ['\\sum', 'Σ'], ['\\lambda', 'λ'], ['\\sigma', 'σ'], ['\\pi', 'π'],
            ['\\alpha', 'α'], ['\\beta', 'β'], ['\\gamma', 'γ'], ['\\delta', 'δ'],
            ['\\phi', 'φ'], ['\\Phi', 'Φ'], ['\\mu', 'μ'], ['\\omega', 'ω']
        ];

        simpleGreek.forEach(([latex, symbol]) => {
            processed = processed.replace(new RegExp(latex, 'g'), symbol);
        });

        // Subscripts and superscripts
        processed = processed.replace(/([a-zA-Z0-9]+)_([a-zA-Z0-9]+)/g, '$1<sub>$2</sub>');
        processed = processed.replace(/([a-zA-Z0-9]+)\^([a-zA-Z0-9]+)/g, '$1<sup>$2</sup>');
        processed = processed.replace(/\^2/g, '²');
        processed = processed.replace(/\^3/g, '³');
        processed = processed.replace(/_i/g, 'ᵢ');
        processed = processed.replace(/_j/g, 'ⱼ');

        return processed;

        // Wait for KaTeX to be ready
        if (window.katex && window.renderMathInElement) {
            processMathFormulas();
        } else {
            // Wait for KaTeX to load
            setTimeout(() => {
                if (window.katex && window.renderMathInElement) {
                    processMathFormulas();
                } else {
                    console.log('KaTeX not available, trying again...');
                    setTimeout(initMathSupport, 1000);
                }
            }, 1000);
        }
    }

    function processMathFormulas() {
        console.log('Processing math formulas with advanced recognition...');

        // Find all text content that might contain math formulas
        const contentElements = document.querySelectorAll(
            '.summary-content-enhanced, .flashcard-question, .answer-content, .accordion-body, .topic-card'
        );

        contentElements.forEach(element => {
            if (element.textContent && !element.classList.contains('math-processed')) {
                element.classList.add('math-processing');

                let content = element.innerHTML;

                // Advanced Wolfram-style pattern matching
                content = enhanceMathContentAdvanced(content);

                element.innerHTML = content;
                element.classList.remove('math-processing');
                element.classList.add('math-processed');
            }
        });

        // Render math with MathJax
        renderMathWithMathJax();
    }

    function enhanceMathContentAdvanced(content) {
        // Protect existing math expressions
        const mathExpressions = [];
        content = content.replace(/\$\$([^$]+)\$\$/g, (match) => {
            mathExpressions.push(match);
            return `__MATH_DISPLAY_${mathExpressions.length - 1}__`;
        });
        content = content.replace(/\$([^$]+)\$/g, (match) => {
            mathExpressions.push(match);
            return `__MATH_INLINE_${mathExpressions.length - 1}__`;
        });

        // Advanced mathematical pattern recognition (Wolfram-style)
        const advancedPatterns = [
            // Complex functions like φ(x) = (1/√n)(cos(w1^{T} x), ..., cos(wn^{T} x), sin(w1^{T} x), ..., sin(wn^{T} x))
            {
                pattern: /([φϕΦ])\s*\(\s*([^)]+)\)\s*=\s*\(([^)]+)\)\s*\\\s*\(([^)]+)\)/g,
                replacement: '$$\\$1($2) = \\left(\\frac{1}{\\sqrt{n}}\\right)\\left(\\cos(w_1^T x), \\ldots, \\cos(w_n^T x), \\sin(w_1^T x), \\ldots, \\sin(w_n^T x)\\right)$$'
            },
            // Functions with equals like K(x, z) = ...
            {
                pattern: /([A-Za-zφϕΦ]+)\s*\(\s*([^)]+)\)\s*=\s*([^.]+\.[^.]*)/g,
                replacement: (match, func, args, expr) => {
                    // Clean up the expression
                    let cleanExpr = expr.replace(/\.$/, ''); // Remove trailing dot
                    cleanExpr = processComplexExpression(cleanExpr);
                    return `$$${func}(${args}) = ${cleanExpr}$$`;
                }
            },
            // Fractions with square root like 1/√n
            {
                pattern: /(\d+)\/√([a-zA-Z]+)/g,
                replacement: '\\frac{$1}{\\sqrt{$2}}'
            },
            // Regular fractions
            {
                pattern: /(\d+)\/([a-zA-Z]+)/g,
                replacement: '\\frac{$1}{$2}'
            },
            // Powers with braces like w1^{T}
            {
                pattern: /([a-zA-Z0-9]+)\^\{([^}]+)\}/g,
                replacement: '$1^{$2}'
            },
            // Simple powers like w1^T
            {
                pattern: /([a-zA-Z0-9]+)\^([A-Za-z])/g,
                replacement: '$1^{$2}'
            },
            // Subscripts like w_j
            {
                pattern: /([a-zA-Z]+)_([a-zA-Z0-9]+)/g,
                replacement: '$1_{$2}'
            },
            // Greek letters
            {
                pattern: /\bphi\b/g,
                replacement: '\\phi'
            },
            {
                pattern: /\bPhi\b/g,
                replacement: '\\Phi'
            },
            {
                pattern: /\bSigma\b/g,
                replacement: '\\Sigma'
            },
            {
                pattern: /\bsum\b/g,
                replacement: '\\sum'
            },
            // Trigonometric functions
            {
                pattern: /\\cos\(/g,
                replacement: '\\cos('
            },
            {
                pattern: /\\sin\(/g,
                replacement: '\\sin('
            },
            {
                pattern: /\bcos\(/g,
                replacement: '\\cos('
            },
            {
                pattern: /\bsin\(/g,
                replacement: '\\sin('
            },
            // Mathematical operators
            {
                pattern: /\*\s*/g,
                replacement: ' \\cdot '
            },
            {
                pattern: /\+\/-/g,
                replacement: '\\pm'
            },
            {
                pattern: /<=/g,
                replacement: '\\leq'
            },
            {
                pattern: />=/g,
                replacement: '\\geq'
            },
            {
                pattern: /!=/g,
                replacement: '\\neq'
            },
            // Ellipsis
            {
                pattern: /\.\.\./g,
                replacement: '\\ldots'
            },
            {
                pattern: /,\s*\.\.\.\s*,/g,
                replacement: ', \\ldots, '
            }
        ];

        // Apply advanced patterns
        advancedPatterns.forEach(({ pattern, replacement }) => {
            if (typeof replacement === 'function') {
                content = content.replace(pattern, replacement);
            } else {
                content = content.replace(pattern, replacement);
            }
        });

        // Restore protected math expressions
        mathExpressions.forEach((expr, index) => {
            content = content.replace(`__MATH_DISPLAY_${index}__`, expr);
            content = content.replace(`__MATH_INLINE_${index}__`, expr);
        });

        return content;
    }

    function processComplexExpression(expr) {
        // Process complex mathematical expressions
        let processed = expr;

        // Handle parentheses with fractions
        processed = processed.replace(/\(([^)]+)\/([^)]+)\)/g, '\\left(\\frac{$1}{$2}\\right)');

        // Handle Σ summation
        processed = processed.replace(/Σ/g, '\\sum');

        // Handle multiplication
        processed = processed.replace(/\s*\*\s*/g, ' \\cdot ');

        // Handle trigonometric functions
        processed = processed.replace(/cos\(/g, '\\cos(');
        processed = processed.replace(/sin\(/g, '\\sin(');

        // Handle subscripts and superscripts
        processed = processed.replace(/([a-zA-Z]+)_([a-zA-Z0-9]+)/g, '$1_{$2}');
        processed = processed.replace(/([a-zA-Z0-9]+)\^([A-Za-z])/g, '$1^{$2}');

        // Handle square root
        processed = processed.replace(/√([a-zA-Z]+)/g, '\\sqrt{$1}');

        return processed;
    }

    function renderMathWithMathJax() {
        if (window.MathJax && window.MathJax.typesetPromise) {
            try {
                // Get all processed elements
                const processedElements = document.querySelectorAll('.math-processed');

                if (processedElements.length > 0) {
                    // Re-render math in processed elements
                    window.MathJax.typesetPromise(processedElements).then(() => {
                        console.log('Math formulas rendered successfully with MathJax');
                        addMathInteractivity();
                    }).catch((error) => {
                        console.error('MathJax rendering error:', error);
                    });
                } else {
                    // Render all math on the page
                    window.MathJax.typesetPromise().then(() => {
                        console.log('Math formulas rendered successfully with MathJax');
                        addMathInteractivity();
                    }).catch((error) => {
                        console.error('MathJax rendering error:', error);
                    });
                }
            } catch (error) {
                console.error('MathJax rendering error:', error);
            }
        }
    }

    function addMathInteractivity() {
        // Add click handlers to MathJax expressions for copying
        document.querySelectorAll('mjx-container[jax="CHTML"]').forEach(mathElement => {
            mathElement.style.cursor = 'pointer';
            mathElement.title = 'Нажмите, чтобы скопировать формулу';

            mathElement.addEventListener('click', function () {
                // Try to get the original LaTeX source
                const mathText = this.getAttribute('data-mjx-texclass') || this.textContent || this.innerText;
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(mathText);
                    showToast('Формула скопирована в буфер обмена', 'success');
                }
            });
        });

        // Add hover effects to math expressions
        document.querySelectorAll('mjx-container[jax="CHTML"]').forEach(mathElement => {
            mathElement.addEventListener('mouseenter', function () {
                this.style.filter = 'brightness(1.1)';
            });

            mathElement.addEventListener('mouseleave', function () {
                this.style.filter = 'brightness(1)';
            });
        });
    }

    // Additional utility functions that might be called from HTML
    function expandAll() {
        document.querySelectorAll('.accordion-collapse').forEach(el => {
            new bootstrap.Collapse(el, { show: true });
        });
    }

    function collapseAll() {
        document.querySelectorAll('.accordion-collapse').forEach(el => {
            new bootstrap.Collapse(el, { hide: true });
        });
    }

    function filterCards(type) {
        const cards = document.querySelectorAll('.flashcard-advanced');
        cards.forEach(card => {
            if (type === 'all' || card.dataset.type === type) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    function searchCards() {
        const searchTerm = document.getElementById('cardSearch')?.value.toLowerCase() || '';
        const cards = document.querySelectorAll('.flashcard-advanced');
        
        cards.forEach(card => {
            const question = card.querySelector('.flashcard-question')?.textContent.toLowerCase() || '';
            const answer = card.querySelector('.answer-text')?.textContent.toLowerCase() || '';
            
            if (question.includes(searchTerm) || answer.includes(searchTerm)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    function startStudySession() {
        showToast('Интерактивный режим изучения будет добавлен в следующей версии', 'info');
    }

    function startSession(sessionNumber) {
        showToast(`Начинаем сессию ${sessionNumber}`, 'info');
    }

    function seekToTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        showToast(`Переход к ${minutes}:${remainingSeconds.toString().padStart(2, '0')}`, 'info');
    }

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing application...');
        
        // Initialize math support
        if (typeof initMathSupport === 'function') {
            initMathSupport();
        }
        
        // Initialize study plan if on that tab
        if (typeof initStudyPlan === 'function') {
            initStudyPlan();
        }
        
        // Load progress data
        if (typeof loadProgress === 'function') {
            loadProgress();
        }
        
        console.log('Application initialized successfully');
    });

    // Chat functionality
    let chatHistory = [];
    const resultId = {{ result_id }};

    function loadChatHistory() {
        fetch(`/api/chat_history/${resultId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.history.length > 0) {
                    const chatMessages = document.getElementById('chatMessages');
                    // Очищаем приветственное сообщение
                    chatMessages.innerHTML = '';
                    
                    data.history.forEach(item => {
                        addMessageToChat(item.user_message, 'user', item.timestamp);
                        addMessageToChat(item.ai_response, 'ai', item.timestamp);
                    });
                    
                    chatHistory = data.history;
                    scrollChatToBottom();
                }
            })
            .catch(error => {
                console.error('Error loading chat history:', error);
            });
    }

    function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Добавляем сообщение пользователя
        addMessageToChat(message, 'user');
        input.value = '';
        
        // Показываем индикатор печати
        showTypingIndicator();
        
        // Отправляем запрос к API
        fetch(`/api/chat/${resultId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            hideTypingIndicator();
            
            if (data.success) {
                addMessageToChat(data.response, 'ai', data.timestamp);
                chatHistory.push({
                    user_message: message,
                    ai_response: data.response,
                    timestamp: data.timestamp
                });
            } else {
                showChatError(data.error || 'Произошла ошибка при отправке сообщения');
            }
        })
        .catch(error => {
            hideTypingIndicator();
            console.error('Error sending message:', error);
            showChatError('Ошибка соединения. Попробуйте еще раз.');
        });
    }

    function addMessageToChat(message, type, timestamp = null) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${type}-message`;
        
        const currentTime = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
        const avatar = type === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
        
        messageDiv.innerHTML = `
            <div class="message-avatar">
                ${avatar}
            </div>
            <div class="message-content">
                <div class="message-text">${formatMessageText(message)}</div>
                <div class="message-time">
                    <i class="fas fa-clock me-1"></i>${currentTime}
                </div>
            </div>
        `;
        
        chatMessages.appendChild(messageDiv);
        scrollChatToBottom();
    }

    function formatMessageText(text) {
        // Базовое форматирование текста
        let formatted = text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/\n/g, '<br>');
        
        // Обработка списков
        formatted = formatted.replace(/^- (.+)$/gm, '<li>$1</li>');
        formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
        
        return formatted;
    }

    function showTypingIndicator() {
        const chatMessages = document.getElementById('chatMessages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'typing-indicator';
        typingDiv.id = 'typingIndicator';
        
        typingDiv.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        `;
        
        chatMessages.appendChild(typingDiv);
        scrollChatToBottom();
    }

    function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    function showChatError(message) {
        const chatMessages = document.getElementById('chatMessages');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'chat-error';
        
        errorDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <span>${message}</span>
        `;
        
        chatMessages.appendChild(errorDiv);
        scrollChatToBottom();
        
        // Удаляем ошибку через 5 секунд
        setTimeout(() => {
            errorDiv.remove();
        }, 5000);
    }

    function scrollChatToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function handleChatKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendChatMessage();
        }
    }

    function setChatMessage(message) {
        const input = document.getElementById('chatInput');
        input.value = message;
        input.focus();
    }

    // Загружаем историю чата при переходе на вкладку
    document.addEventListener('DOMContentLoaded', function() {
        const chatTab = document.getElementById('chat-tab');
        if (chatTab) {
            chatTab.addEventListener('shown.bs.tab', function() {
                if (chatHistory.length === 0) {
                    loadChatHistory();
                }
            });
        }
    });

</script>
{% endblock %}    //
 Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Page loaded, initializing components...');
        
        // Инициализируем mind-map при переключении на вкладку
        const mindmapTab = document.getElementById('mindmap-tab');
        if (mindmapTab) {
            mindmapTab.addEventListener('shown.bs.tab', function() {
                console.log('🗺️ Mind map tab activated');
                if (!mindMapData) {
                    initMindMap();
                }
            });
            
            // Если вкладка mind-map уже активна при загрузке
            if (mindmapTab.classList.contains('active')) {
                console.log('🗺️ Mind map tab is already active, initializing...');
                setTimeout(initMindMap, 100);
            }
        }
        
        // Инициализируем чат при переключении на вкладку
        const chatTab = document.getElementById('chat-tab');
        if (chatTab) {
            chatTab.addEventListener('shown.bs.tab', function() {
                if (chatHistory.length === 0) {
                    loadChatHistory();
                }
            });
        }
    });

    // ===== ENHANCED MIND MAP FUNCTIONALITY =====
    
    let mindMapData = null;
    let mindMapSvg = null;
    let mindMapSimulation = null;
    let currentLayout = 'radial';
    let mindMapNodes = [];
    let mindMapLinks = [];
    let mindMapZoom = null;
    let selectedNode = null;

    // Initialize Enhanced Mind Map (renamed to avoid conflict)
    function initEnhancedMindMap() {
        console.log('🧠 Initializing Enhanced Mind Map...');
        
        // Show loading state
        showMindMapLoading(true);
        
        // Clear previous visualization
        clearMindMapVisualization();
        
        // Prepare mind map data
        prepareMindMapData();
        
        // Create visualization after short delay
        setTimeout(() => {
            createMindMapVisualization();
            showMindMapLoading(false);
        }, 1000);
    }

    function showMindMapLoading(show) {
        const loading = document.getElementById('mindMapLoading');
        if (loading) {
            loading.style.display = show ? 'flex' : 'none';
        }
    }

    function clearMindMapVisualization() {
        const svg = d3.select('#mindMapSvg');
        svg.selectAll('*').remove();
        
        // Reset zoom
        if (mindMapZoom) {
            mindMapZoom.transform(svg, d3.zoomIdentity);
        }
    }

    function prepareMindMapData() {
        console.log('📊 Preparing mind map data...');
        
        // Extract data from topics_data
        const topicsData = {{ topics_data | tojson | safe }};
        const mindMapRaw = {{ mind_map | tojson | safe }};
        
        mindMapNodes = [];
        mindMapLinks = [];
        
        // Create central node
        const centralName = 'Основные концепции';
        mindMapNodes.push({
            id: 'center',
            name: centralName,
            type: 'center',
            level: 0,
            size: Math.max(35, Math.min(50, centralName.length * 2 + 20)), // Динамический размер
            color: '#6366f1',
            description: 'Центральная тема материала'
        });
        
        // Add main topics as primary nodes
        if (topicsData && typeof topicsData === 'object') {
            Object.entries(topicsData).forEach(([topicName, topicData], index) => {
                const nodeId = `topic_${index}`;
                
                mindMapNodes.push({
                    id: nodeId,
                    name: topicName,
                    type: 'main-topic',
                    level: 1,
                    size: 30,
                    color: '#10b981',
                    description: topicData.summary || 'Основная тема',
                    subtopics: topicData.subtopics || [],
                    concepts: topicData.key_concepts || [],
                    complexity: topicData.complexity || 'средний'
                });
                
                // Link to center
                mindMapLinks.push({
                    source: 'center',
                    target: nodeId,
                    strength: 1.0,
                    type: 'primary'
                });
                
                // Add subtopics
                if (topicData.subtopics && Array.isArray(topicData.subtopics)) {
                    topicData.subtopics.forEach((subtopic, subIndex) => {
                        const subNodeId = `${nodeId}_sub_${subIndex}`;
                        
                        mindMapNodes.push({
                            id: subNodeId,
                            name: subtopic,
                            type: 'subtopic',
                            level: 2,
                            size: 20,
                            color: '#f59e0b',
                            description: `Подтема: ${subtopic}`,
                            parent: nodeId
                        });
                        
                        mindMapLinks.push({
                            source: nodeId,
                            target: subNodeId,
                            strength: 0.8,
                            type: 'secondary'
                        });
                    });
                }
                
                // Add key concepts
                if (topicData.key_concepts && Array.isArray(topicData.key_concepts)) {
                    topicData.key_concepts.forEach((concept, conceptIndex) => {
                        const conceptNodeId = `${nodeId}_concept_${conceptIndex}`;
                        
                        mindMapNodes.push({
                            id: conceptNodeId,
                            name: concept,
                            type: 'concept',
                            level: 2,
                            size: 15,
                            color: '#8b5cf6',
                            description: `Ключевая концепция: ${concept}`,
                            parent: nodeId
                        });
                        
                        mindMapLinks.push({
                            source: nodeId,
                            target: conceptNodeId,
                            strength: 0.6,
                            type: 'concept'
                        });
                    });
                }
            });
        }
        
        // Add relationships from mind_map data
        if (mindMapRaw && mindMapRaw.concept_map && mindMapRaw.concept_map.relationships) {
            mindMapRaw.concept_map.relationships.forEach((rel, relIndex) => {
                // Find or create nodes for relationship
                const fromNodeId = findOrCreateRelationshipNode(rel.from, relIndex);
                const toNodeId = findOrCreateRelationshipNode(rel.to, relIndex);
                
                if (fromNodeId && toNodeId && fromNodeId !== toNodeId) {
                    mindMapLinks.push({
                        source: fromNodeId,
                        target: toNodeId,
                        strength: 0.4,
                        type: 'relationship',
                        relationshipType: rel.type,
                        description: rel.description
                    });
                }
            });
        }
        
        console.log(`📊 Mind map prepared: ${mindMapNodes.length} nodes, ${mindMapLinks.length} links`);
        updateMindMapStats();
    }

    function findOrCreateRelationshipNode(nodeName, relIndex) {
        // Try to find existing node by name
        let existingNode = mindMapNodes.find(node => 
            node.name.toLowerCase().includes(nodeName.toLowerCase()) ||
            nodeName.toLowerCase().includes(node.name.toLowerCase())
        );
        
        if (existingNode) {
            return existingNode.id;
        }
        
        // Create new relationship node
        const nodeId = `rel_${relIndex}_${nodeName.replace(/\s+/g, '_')}`;
        mindMapNodes.push({
            id: nodeId,
            name: nodeName,
            type: 'relationship',
            level: 3,
            size: 12,
            color: '#ef4444',
            description: `Связанная концепция: ${nodeName}`
        });
        
        return nodeId;
    }

    function createMindMapVisualization() {
        console.log('🎨 Creating mind map visualization...');
        console.log('📊 Узлов для обработки:', mindMapNodes.length);
        
        // Принудительно очищаем все существующие SVG элементы
        d3.select('#mindMapSvg').selectAll('*').remove();
        
        const container = document.getElementById('mindMapVisualization');
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        // Create SVG
        const svg = d3.select('#mindMapSvg')
            .attr('width', width)
            .attr('height', height);
        
        // Setup zoom behavior
        mindMapZoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => {
                svg.select('.mind-map-group').attr('transform', event.transform);
            });
        
        svg.call(mindMapZoom);
        
        // Create main group
        const g = svg.append('g').attr('class', 'mind-map-group');
        
        // Create links group
        const linksGroup = g.append('g').attr('class', 'links');
        
        // Create nodes group
        const nodesGroup = g.append('g').attr('class', 'nodes');
        
        // Setup force simulation based on layout
        setupForceSimulation(width, height);
        
        // Create links
        const links = linksGroup.selectAll('.mind-link')
            .data(mindMapLinks)
            .enter().append('line')
            .attr('class', 'mind-link')
            .attr('stroke', d => getLinkColor(d.type))
            .attr('stroke-width', d => getLinkWidth(d.strength))
            .attr('stroke-opacity', 0.6)
            .attr('marker-end', 'url(#arrowhead)');
        
        // Create arrow markers
        svg.append('defs').append('marker')
            .attr('id', 'arrowhead')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 15)
            .attr('refY', 0)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', '#999');
        
        // Create nodes
        const nodes = nodesGroup.selectAll('.mind-node')
            .data(mindMapNodes)
            .enter().append('g')
            .attr('class', 'mind-node')
            .style('cursor', 'pointer')
            .call(d3.drag()
                .on('start', dragStarted)
                .on('drag', dragged)
                .on('end', dragEnded))
            .on('click', nodeClicked)
            .on('mouseover', nodeMouseOver)
            .on('mouseout', nodeMouseOut);
        
        // Add circles to nodes
        nodes.append('circle')
            .attr('r', d => d.size)
            .attr('fill', d => d.color)
            .attr('stroke', '#fff')
            .attr('stroke-width', 2)
            .style('filter', 'drop-shadow(0 2px 4px rgba(0,0,0,0.2))');
        
        // НОВЫЙ ПОДХОД: Создаем многострочные подписи для узлов
        console.log('🔧 Создаем многострочный текст для узлов...');
        
        // Удаляем все существующие текстовые элементы
        nodes.selectAll('text').remove();
        
        // Создаем новые многострочные подписи
        nodes.each(function(d) {
            const nodeGroup = d3.select(this);
            let text = d.name || 'Без названия';
            
            console.log('📝 Обрабатываем узел:', text);
            
            // Настройки для разных типов узлов
            let maxCharsPerLine, maxLines, fontSize, lineHeight, yOffset;
            
            if (d.type === 'center') {
                maxCharsPerLine = 20;
                maxLines = 2;
                fontSize = 12;
                lineHeight = 16;
                yOffset = d.size + 60;
            } else if (d.type === 'main-topic') {
                maxCharsPerLine = 16;
                maxLines = 3;
                fontSize = 11;
                lineHeight = 15;
                yOffset = d.size + 55;
            } else {
                maxCharsPerLine = 14;
                maxLines = 3;
                fontSize = 10;
                lineHeight = 14;
                yOffset = d.size + 50;
            }
            
            // Разбиваем текст на строки
            const words = text.split(/\s+/);
            let lines = [];
            let currentLine = '';
            
            for (let word of words) {
                const testLine = currentLine ? currentLine + ' ' + word : word;
                
                if (testLine.length <= maxCharsPerLine) {
                    currentLine = testLine;
                } else {
                    if (currentLine) {
                        lines.push(currentLine);
                        currentLine = word;
                    } else {
                        // Очень длинное слово - разбиваем
                        lines.push(word.substring(0, maxCharsPerLine));
                        currentLine = '';
                    }
                    
                    if (lines.length >= maxLines) {
                        break;
                    }
                }
            }
            
            // Добавляем последнюю строку
            if (currentLine && lines.length < maxLines) {
                lines.push(currentLine);
            }
            
            // Гарантируем хотя бы одну строку
            if (lines.length === 0) {
                lines = [text.substring(0, maxCharsPerLine)];
            }
            
            console.log('📋 Строки для узла:', lines);
            
            // Создаем текстовые элементы для каждой строки
            lines.forEach((line, index) => {
                nodeGroup.append('text')
                    .text(line)
                    .attr('text-anchor', 'middle')
                    .attr('x', 0)
                    .attr('y', yOffset + (index * lineHeight))
                    .attr('font-size', fontSize + 'px')
                    .attr('font-weight', 'bold')
                    .attr('fill', '#1a202c')
                    .style('pointer-events', 'none')
                    .style('font-family', '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif')
                    .style('text-shadow', '0 1px 3px rgba(255,255,255,0.9)')
                    .style('letter-spacing', '0.5px');
            });
        });
        
        console.log('✅ Многострочный текст создан для всех узлов');
        
        // Update simulation
        mindMapSimulation.nodes(mindMapNodes);
        mindMapSimulation.force('link').links(mindMapLinks);
        
        // Simulation tick
        mindMapSimulation.on('tick', () => {
            links
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);
            
            nodes.attr('transform', d => `translate(${d.x},${d.y})`);
        });
        
        // Center the view
        setTimeout(() => {
            centerMindMapView();
        }, 1000);
    }

    function setupForceSimulation(width, height) {
        mindMapSimulation = d3.forceSimulation()
            .force('link', d3.forceLink().id(d => d.id).distance(d => getLinkDistance(d)))
            .force('charge', d3.forceManyBody().strength(d => getNodeCharge(d)))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(d => d.size + 50)); // Увеличиваем радиус коллизии для многострочного текста
        
        // Adjust forces based on layout
        switch (currentLayout) {
            case 'radial':
                mindMapSimulation.force('radial', d3.forceRadial(d => d.level * 100, width / 2, height / 2));
                break;
            case 'tree':
                mindMapSimulation.force('x', d3.forceX(d => d.level * 150).strength(0.3));
                mindMapSimulation.force('y', d3.forceY(height / 2).strength(0.1));
                break;
            case 'force':
                // Default force layout
                break;
            case 'circular':
                mindMapSimulation.force('radial', d3.forceRadial(200, width / 2, height / 2));
                break;
        }
    }

    function getLinkDistance(link) {
        switch (link.type) {
            case 'primary': return 180; // Еще больше увеличено для предотвращения наложения текста
            case 'secondary': return 150; // Еще больше увеличено
            case 'concept': return 120; // Еще больше увеличено
            case 'relationship': return 200; // Еще больше увеличено
            default: return 160; // Еще больше увеличено
        }
    }

    function getNodeCharge(node) {
        switch (node.type) {
            case 'center': return -2000; // Максимальное отталкивание
            case 'main-topic': return -1000; // Максимальное отталкивание
            case 'subtopic': return -600; // Максимальное отталкивание
            case 'concept': return -400; // Максимальное отталкивание
            case 'relationship': return -300; // Максимальное отталкивание
            default: return -400; // Максимальное отталкивание
        }
    }

    function getLinkColor(type) {
        switch (type) {
            case 'primary': return '#6366f1';
            case 'secondary': return '#10b981';
            case 'concept': return '#8b5cf6';
            case 'relationship': return '#ef4444';
            default: return '#9ca3af';
        }
    }

    function getLinkWidth(strength) {
        return Math.max(1, strength * 3);
    }

    // Node interaction handlers
    function nodeClicked(event, d) {
        event.stopPropagation();
        selectedNode = d;
        showNodeDetails(d);
        highlightConnectedNodes(d);
    }

    function nodeMouseOver(event, d) {
        // Highlight node
        d3.select(event.currentTarget).select('circle')
            .transition().duration(200)
            .attr('r', d.size * 1.2)
            .style('filter', 'drop-shadow(0 4px 8px rgba(0,0,0,0.3))');
        
        // Show tooltip
        showNodeTooltip(event, d);
    }

    function nodeMouseOut(event, d) {
        // Reset node
        d3.select(event.currentTarget).select('circle')
            .transition().duration(200)
            .attr('r', d.size)
            .style('filter', 'drop-shadow(0 2px 4px rgba(0,0,0,0.2))');
        
        // Hide tooltip
        hideNodeTooltip();
    }

    function showNodeDetails(node) {
        const panel = document.getElementById('nodeDetailsPanel');
        const title = document.getElementById('nodeTitle');
        const content = document.getElementById('nodeDetailsContent');
        
        if (!panel || !title || !content) return;
        
        title.textContent = node.name;
        
        let detailsHtml = `
            <div class="node-detail-item">
                <strong>Тип:</strong> ${getNodeTypeLabel(node.type)}
            </div>
            <div class="node-detail-item">
                <strong>Уровень:</strong> ${node.level}
            </div>
            <div class="node-detail-item">
                <strong>Описание:</strong> ${node.description}
            </div>
        `;
        
        if (node.subtopics && node.subtopics.length > 0) {
            detailsHtml += `
                <div class="node-detail-item">
                    <strong>Подтемы:</strong>
                    <ul class="mt-2">
                        ${node.subtopics.map(sub => `<li>${sub}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        if (node.concepts && node.concepts.length > 0) {
            detailsHtml += `
                <div class="node-detail-item">
                    <strong>Ключевые концепции:</strong>
                    <ul class="mt-2">
                        ${node.concepts.map(concept => `<li>${concept}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        if (node.complexity) {
            detailsHtml += `
                <div class="node-detail-item">
                    <strong>Сложность:</strong> 
                    <span class="complexity-badge complexity-${node.complexity}">${node.complexity}</span>
                </div>
            `;
        }
        
        content.innerHTML = detailsHtml;
        panel.style.display = 'block';
    }

    function hideNodeDetails() {
        const panel = document.getElementById('nodeDetailsPanel');
        if (panel) {
            panel.style.display = 'none';
        }
        selectedNode = null;
        unhighlightAllNodes();
    }

    function highlightConnectedNodes(node) {
        // Reset all nodes
        d3.selectAll('.mind-node circle').style('opacity', 0.3);
        d3.selectAll('.mind-link').style('opacity', 0.1);
        
        // Highlight selected node
        d3.selectAll('.mind-node').filter(d => d.id === node.id)
            .select('circle').style('opacity', 1);
        
        // Highlight connected nodes and links
        mindMapLinks.forEach(link => {
            if (link.source.id === node.id || link.target.id === node.id) {
                d3.selectAll('.mind-link').filter(d => d === link).style('opacity', 0.8);
                d3.selectAll('.mind-node').filter(d => d.id === link.source.id || d.id === link.target.id)
                    .select('circle').style('opacity', 1);
            }
        });
    }

    function unhighlightAllNodes() {
        d3.selectAll('.mind-node circle').style('opacity', 1);
        d3.selectAll('.mind-link').style('opacity', 0.6);
    }

    function showNodeTooltip(event, node) {
        // Create or update tooltip
        let tooltip = d3.select('body').select('.mind-map-tooltip');
        if (tooltip.empty()) {
            tooltip = d3.select('body').append('div')
                .attr('class', 'mind-map-tooltip')
                .style('position', 'absolute')
                .style('background', 'rgba(0,0,0,0.8)')
                .style('color', 'white')
                .style('padding', '8px 12px')
                .style('border-radius', '6px')
                .style('font-size', '12px')
                .style('pointer-events', 'none')
                .style('z-index', '1000')
                .style('opacity', 0);
        }
        
        tooltip.html(`
            <strong>${node.name}</strong><br>
            ${node.description}
        `)
        .style('left', (event.pageX + 10) + 'px')
        .style('top', (event.pageY - 10) + 'px')
        .transition().duration(200)
        .style('opacity', 1);
    }

    function hideNodeTooltip() {
        d3.select('.mind-map-tooltip')
            .transition().duration(200)
            .style('opacity', 0);
    }

    function getNodeTypeLabel(type) {
        switch (type) {
            case 'center': return 'Центральная тема';
            case 'main-topic': return 'Основная тема';
            case 'subtopic': return 'Подтема';
            case 'concept': return 'Концепция';
            case 'relationship': return 'Связанная концепция';
            default: return 'Узел';
        }
    }

    // Drag handlers
    function dragStarted(event, d) {
        if (!event.active) mindMapSimulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }

    function dragEnded(event, d) {
        if (!event.active) mindMapSimulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }

    // Layout controls
    function setMindMapLayout(layout) {
        console.log(`🔄 Switching to ${layout} layout`);
        currentLayout = layout;
        
        // Update active button
        document.querySelectorAll('.layout-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-layout="${layout}"]`).classList.add('active');
        
        // Recreate visualization with new layout
        if (mindMapNodes.length > 0) {
            createMindMapVisualization();
        }
    }

    // Search and filter functions
    function filterMindMapNodes(filter) {
        console.log(`🔍 Filtering nodes: ${filter}`);
        
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
        
        // Apply filter
        d3.selectAll('.mind-node').style('display', 'block');
        d3.selectAll('.mind-link').style('display', 'block');
        
        if (filter !== 'all') {
            d3.selectAll('.mind-node').filter(d => {
                switch (filter) {
                    case 'main': return d.type !== 'center' && d.type !== 'main-topic';
                    case 'related': return d.type !== 'relationship';
                    default: return false;
                }
            }).style('display', 'none');
        }
    }

    function clearMindMapSearch() {
        const searchInput = document.getElementById('mindMapSearch');
        if (searchInput) {
            searchInput.value = '';
            document.querySelector('.search-clear-btn').style.display = 'none';
        }
        
        // Show all nodes
        d3.selectAll('.mind-node').style('opacity', 1);
        d3.selectAll('.mind-link').style('opacity', 0.6);
    }

    // View controls
    function toggleMindMapLabels() {
        const btn = document.querySelector('[data-option="labels"]');
        const isActive = btn.classList.contains('active');
        
        if (isActive) {
            btn.classList.remove('active');
            d3.selectAll('.mind-node text').style('display', 'none');
        } else {
            btn.classList.add('active');
            d3.selectAll('.mind-node text').style('display', 'block');
        }
    }

    function toggleMindMapConnections() {
        const btn = document.querySelector('[data-option="connections"]');
        const isActive = btn.classList.contains('active');
        
        if (isActive) {
            btn.classList.remove('active');
            d3.selectAll('.mind-link').style('display', 'none');
        } else {
            btn.classList.add('active');
            d3.selectAll('.mind-link').style('display', 'block');
        }
    }

    function toggleMindMapDetails() {
        const btn = document.querySelector('[data-option="details"]');
        const isActive = btn.classList.contains('active');
        
        if (isActive) {
            btn.classList.remove('active');
            hideNodeDetails();
        } else {
            btn.classList.add('active');
            // Details will be shown on node click
        }
    }

    // Zoom controls
    function zoomMindMap(action) {
        const svg = d3.select('#mindMapSvg');
        const transition = svg.transition().duration(300);
        
        switch (action) {
            case 'in':
                svg.call(mindMapZoom.scaleBy, transition, 1.5);
                break;
            case 'out':
                svg.call(mindMapZoom.scaleBy, transition, 1 / 1.5);
                break;
            case 'fit':
                centerMindMapView();
                break;
        }
    }

    function centerMindMapView() {
        const svg = d3.select('#mindMapSvg');
        const container = document.getElementById('mindMapVisualization');
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        // Calculate bounds of all nodes
        if (mindMapNodes.length === 0) return;
        
        const bounds = {
            x: d3.extent(mindMapNodes, d => d.x),
            y: d3.extent(mindMapNodes, d => d.y)
        };
        
        const dx = bounds.x[1] - bounds.x[0];
        const dy = bounds.y[1] - bounds.y[0];
        const x = (bounds.x[0] + bounds.x[1]) / 2;
        const y = (bounds.y[0] + bounds.y[1]) / 2;
        
        const scale = Math.min(width / dx, height / dy) * 0.8;
        const translate = [width / 2 - scale * x, height / 2 - scale * y];
        
        svg.transition().duration(750).call(
            mindMapZoom.transform,
            d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
        );
    }

    function resetMindMapView() {
        const svg = d3.select('#mindMapSvg');
        svg.transition().duration(500).call(
            mindMapZoom.transform,
            d3.zoomIdentity
        );
    }

    // Export function
    function downloadMindMap() {
        const svg = document.getElementById('mindMapSvg');
        const svgData = new XMLSerializer().serializeToString(svg);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        canvas.width = svg.clientWidth;
        canvas.height = svg.clientHeight;
        
        img.onload = function() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            const link = document.createElement('a');
            link.download = 'mind-map.png';
            link.href = canvas.toDataURL();
            link.click();
        };
        
        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
    }

    // Update statistics
    function updateMindMapStats() {
        document.getElementById('nodeCount').textContent = mindMapNodes.length;
        document.getElementById('connectionCount').textContent = mindMapLinks.length;
        
        const levels = [...new Set(mindMapNodes.map(n => n.level))].length;
        document.getElementById('levelCount').textContent = levels;
    }

    // Helper function to measure text width more accurately
    function getTextWidth(text, fontSize, fontWeight = 'normal') {
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        context.font = `${fontWeight} ${fontSize}px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif`;
        return context.measureText(text).width;
    }

    // Enhanced text wrapping utility with better multi-line support
    function wrapText(text, content, width) {
        const words = content.split(/\s+/);
        
        // Clear existing text
        text.text(null);
        
        // Configuration for text wrapping
        const fontSize = parseFloat(text.style('font-size')) || 12;
        const fontWeight = text.style('font-weight') || 'bold';
        const lineHeight = 1.3; // Better line spacing
        const maxLines = 5; // Allow more lines for better display
        const padding = 12; // More padding for better appearance
        const availableWidth = width - padding;
        
        // If text is very short, just display it as is
        if (content.length <= 15) {
            text.append('tspan')
                .attr('x', 0)
                .attr('dy', '0.35em')
                .text(content)
                .style('text-anchor', 'middle')
                .style('dominant-baseline', 'central');
            return;
        }
        
        let lines = [];
        let currentLine = [];
        
        // Process each word
        for (let i = 0; i < words.length; i++) {
            const word = words[i];
            const testLine = [...currentLine, word].join(' ');
            const testWidth = getTextWidth(testLine, fontSize, fontWeight);
            
            // Check if adding this word would exceed the available width
            if (testWidth > availableWidth && currentLine.length > 0) {
                // Start a new line
                lines.push(currentLine.join(' '));
                currentLine = [word];
                
                // If we've reached max lines, handle the remaining text
                if (lines.length >= maxLines) {
                    // For the last line, try to fit remaining words without ellipsis first
                    const remainingWords = words.slice(i);
                    const remainingText = remainingWords.join(' ');
                    const remainingWidth = getTextWidth(remainingText, fontSize, fontWeight);
                    
                    if (remainingWidth <= availableWidth) {
                        // All remaining text fits
                        lines.push(remainingText);
                    } else {
                        // Need to truncate with ellipsis
                        let truncatedLine = currentLine.join(' ');
                        const ellipsisWidth = getTextWidth('...', fontSize, fontWeight);
                        
                        // Try to add more words until we need ellipsis
                        for (let j = i + 1; j < words.length; j++) {
                            const testTruncated = [...currentLine, ...words.slice(i, j)].join(' ') + '...';
                            const testWidth = getTextWidth(testTruncated, fontSize, fontWeight);
                            
                            if (testWidth <= availableWidth) {
                                truncatedLine = [...currentLine, ...words.slice(i, j)].join(' ') + '...';
                            } else {
                                break;
                            }
                        }
                        
                        lines.push(truncatedLine);
                    }
                    break;
                }
            } else {
                // Add word to current line
                currentLine.push(word);
            }
        }
        
        // Add the last line if it has content and we haven't exceeded max lines
        if (currentLine.length > 0 && lines.length < maxLines) {
            lines.push(currentLine.join(' '));
        }
        
        // If no lines were created, use original content
        if (lines.length === 0) {
            lines = [content];
        }
        
        // Calculate vertical positioning for multi-line text
        const totalLines = lines.length;
        const totalHeight = (totalLines - 1) * lineHeight;
        const startY = -(totalHeight / 2);
        
        // Create tspan elements for each line
        lines.forEach((line, index) => {
            const yOffset = startY + (index * lineHeight);
            text.append('tspan')
                .attr('x', 0)
                .attr('dy', index === 0 ? `${yOffset}em` : `${lineHeight}em`)
                .text(line)
                .style('text-anchor', 'middle')
                .style('dominant-baseline', 'central')
                .style('font-size', 'inherit')
                .style('font-weight', 'inherit');
        });
    }

    // Improved text wrapping function with better line breaking
    function wrapTextImproved(text, content, width) {
        // Clear existing text
        text.text(null);
        
        // Configuration
        const fontSize = parseFloat(text.style('font-size')) || 12;
        const fontWeight = text.style('font-weight') || 'bold';
        const lineHeight = 1.4; // Increased line height for better readability
        const maxLines = 6; // More lines allowed
        const padding = 15; // More padding
        const availableWidth = width - padding;
        
        // For very short text, display as single line
        if (content.length <= 12) {
            text.append('tspan')
                .attr('x', 0)
                .attr('dy', '0.35em')
                .text(content)
                .style('text-anchor', 'middle')
                .style('dominant-baseline', 'central');
            return;
        }
        
        // Split text into words
        const words = content.split(/\s+/);
        let lines = [];
        let currentLine = [];
        
        // Smart word wrapping
        for (let i = 0; i < words.length; i++) {
            const word = words[i];
            const testLine = [...currentLine, word].join(' ');
            const testWidth = getTextWidth(testLine, fontSize, fontWeight);
            
            if (testWidth > availableWidth && currentLine.length > 0) {
                // Current line is full, start new line
                lines.push(currentLine.join(' '));
                currentLine = [word];
                
                // Check if we've reached the maximum number of lines
                if (lines.length >= maxLines - 1) {
                    // This is the last line, fit remaining words or add ellipsis
                    const remainingWords = words.slice(i + 1);
                    if (remainingWords.length > 0) {
                        // Try to fit more words on the last line
                        for (let j = 0; j < remainingWords.length; j++) {
                            const testLastLine = [...currentLine, ...remainingWords.slice(0, j + 1)].join(' ');
                            const testLastWidth = getTextWidth(testLastLine, fontSize, fontWeight);
                            
                            if (testLastWidth <= availableWidth) {
                                currentLine = [...currentLine, ...remainingWords.slice(0, j + 1)];
                            } else {
                                // Add ellipsis if there are more words
                                if (j === 0 && remainingWords.length > 0) {
                                    const ellipsisLine = currentLine.join(' ') + '...';
                                    const ellipsisWidth = getTextWidth(ellipsisLine, fontSize, fontWeight);
                                    if (ellipsisWidth <= availableWidth) {
                                        currentLine = [currentLine.join(' ') + '...'];
                                    }
                                }
                                break;
                            }
                        }
                    }
                    break;
                }
            } else {
                currentLine.push(word);
            }
        }
        
        // Add the final line
        if (currentLine.length > 0) {
            lines.push(currentLine.join(' '));
        }
        
        // Ensure we have at least one line
        if (lines.length === 0) {
            lines = [content.substring(0, 20) + (content.length > 20 ? '...' : '')];
        }
        
        // Calculate vertical centering
        const totalLines = lines.length;
        const totalHeight = (totalLines - 1) * lineHeight;
        const startOffset = -(totalHeight / 2);
        
        // Create tspan elements for each line
        lines.forEach((line, index) => {
            const yOffset = startOffset + (index * lineHeight);
            text.append('tspan')
                .attr('x', 0)
                .attr('dy', index === 0 ? `${yOffset}em` : `${lineHeight}em`)
                .text(line)
                .style('text-anchor', 'middle')
                .style('dominant-baseline', 'central')
                .style('font-size', 'inherit')
                .style('font-weight', 'inherit')
                .style('line-height', lineHeight);
        });
    }

    // Search functionality
    document.getElementById('mindMapSearch').addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase();
        const clearBtn = document.querySelector('.search-clear-btn');
        
        if (query.length > 0) {
            clearBtn.style.display = 'block';
            
            // Filter nodes based on search
            d3.selectAll('.mind-node').style('opacity', d => {
                return d.name.toLowerCase().includes(query) || 
                       d.description.toLowerCase().includes(query) ? 1 : 0.2;
            });
        } else {
            clearBtn.style.display = 'none';
            d3.selectAll('.mind-node').style('opacity', 1);
        }
    });

    // Add CSS for node details
    const mindMapStyles = `
        <style id="mindMapEnhancedStyles">
            .node-detail-item {
                margin-bottom: 12px;
                padding-bottom: 8px;
                border-bottom: 1px solid #f1f5f9;
            }
            
            .node-detail-item:last-child {
                border-bottom: none;
                margin-bottom: 0;
            }
            
            .complexity-badge {
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
            }
            
            .complexity-базовый {
                background: #d1fae5;
                color: #065f46;
            }
            
            .complexity-средний {
                background: #fef3c7;
                color: #92400e;
            }
            
            .complexity-сложный {
                background: #fee2e2;
                color: #991b1b;
            }
            
            .mind-map-tooltip {
                max-width: 200px;
                word-wrap: break-word;
            }
        </style>
    `;

    if (!document.getElementById('mindMapEnhancedStyles')) {
        document.head.insertAdjacentHTML('beforeend', mindMapStyles);
    }

    console.log('🧠 Enhanced Mind Map functionality loaded');