{% extends "base.html" %}

{% block title %}AI-конспект Pro - Глубокий анализ{% endblock %}

{% block extra_styles %}
<style>
    .feature-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 15px;
        transition: transform 0.3s ease;
    }
    .feature-card:hover {
        transform: translateY(-5px);
    }
    .feature-icon {
        font-size: 2rem;
        margin-bottom: 10px;
    }
    .stats-card {
        background: #f8f9fa;
        border: none;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .upload-area {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    .upload-area:hover {
        background: linear-gradient(135deg, #e9ecef 0%, #b8c6db 100%);
    }
    .badge-new {
        background: #ff6b6b;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        margin-left: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="text-center mb-5">
        <h1 class="display-4">
            <i class="fas fa-brain text-primary me-3"></i>AI-конспект 
            <span class="badge bg-primary">Pro</span>
        </h1>
        <p class="lead text-muted">
            Глубокий анализ с иерархией тем, ментальными картами и персональным планом обучения
        </p>
    </div>

    <!-- New Features Section -->
    <div class="row mb-5">
        <div class="col-md-3">
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-sitemap"></i>
                </div>
                <h5>Иерархия тем</h5>
                <small>Структурированное дерево знаний</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-project-diagram"></i>
                </div>
                <h5>Mind Map</h5>
                <small>Визуальные связи концепций</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <h5>План обучения</h5>
                <small>Персональное расписание</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-layer-group"></i>
                </div>
                <h5>Умные карточки</h5>
                <small>5 типов с уровнями сложности</small>
            </div>
        </div>
    </div>

    <!-- Upload Options -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <ul class="nav nav-pills nav-justified mb-4" id="upload-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="file-tab" data-bs-toggle="pill" data-bs-target="#file-upload" type="button" role="tab">
                                <i class="fas fa-upload me-2"></i>Загрузить файл
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="url-tab" data-bs-toggle="pill" data-bs-target="#url-upload" type="button" role="tab">
                                <i class="fas fa-link me-2"></i>Видео по ссылке
                                <span class="badge bg-success ms-2">NEW</span>
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="upload-content">
                        <!-- File Upload Tab -->
                        <div class="tab-pane fade show active" id="file-upload" role="tabpanel">
                            <form id="upload-form" action="{{ url_for('upload_file') }}" method="POST" enctype="multipart/form-data">
                                <input type="file" name="file" id="file-input" accept=".pdf,.mp4,.mov,.mkv" style="display: none;" required>
                                
                                <div class="upload-area" id="upload-area">
                                    <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                                    <h3>Перетащите файл сюда или нажмите для выбора</h3>
                                    <p class="text-muted mt-3">
                                        <i class="fas fa-file-pdf text-danger me-2"></i>PDF (до 30 МБ)
                                        <span class="mx-2">|</span>
                                        <i class="fas fa-video text-info me-2"></i>MP4, MOV, MKV (до {{ config.MAX_CONTENT_LENGTH // (1024*1024) }} МБ)
                                    </p>
                                    <button type="button" class="btn btn-primary btn-lg mt-3" onclick="document.getElementById('file-input').click()">
                                        <i class="fas fa-upload me-2"></i>Выбрать файл
                                    </button>
                                </div>
                                
                                <div id="file-selected" style="display: none;" class="text-center mt-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <i class="fas fa-file-check fa-3x text-success mb-3"></i>
                                            <h4 id="file-name"></h4>
                                            <p class="text-muted" id="file-size"></p>
                                            
                                            <!-- Page Selection Section -->
                                            <div id="page-selection" style="display: none;" class="mt-4 mb-4">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h5 class="card-title">
                                                            <i class="fas fa-file-alt me-2"></i>Выбор страниц для анализа
                                                        </h5>
                                                        <p class="text-muted small mb-3">
                                                            Укажите диапазон страниц для обработки. Это поможет сосредоточиться на нужных разделах и ускорить анализ.
                                                        </p>
                                                        
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <label for="page-range" class="form-label">Диапазон страниц:</label>
                                                                <input type="text" class="form-control" id="page-range" name="page_range" 
                                                                       placeholder="1-20, 50-100" value="1-20">
                                                                <div class="form-text">
                                                                    Примеры: "1-10", "5-25", "1-10,15-20", "все"
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Быстрый выбор:</label>
                                                                <div class="d-flex flex-wrap gap-2">
                                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPageRange('1-10')">
                                                                        Первые 10
                                                                    </button>
                                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPageRange('1-20')">
                                                                        Первые 20
                                                                    </button>
                                                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPageRange('все')">
                                                                        Все страницы
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="alert alert-info mt-3 mb-0">
                                                            <i class="fas fa-info-circle me-2"></i>
                                                            <strong>Рекомендация:</strong> Для оптимального качества анализа рекомендуется обрабатывать не более 20-30 страниц за раз.
                                                            Большие документы лучше разбивать на логические части.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-success btn-lg mt-3">
                                                <i class="fas fa-rocket me-2"></i>Начать глубокий анализ
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="resetUpload()">
                                                Выбрать другой файл
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- URL Upload Tab -->
                        <div class="tab-pane fade" id="url-upload" role="tabpanel">
                            <form id="url-form" action="{{ url_for('upload_video_url') }}" method="POST">
                                <div class="text-center">
                                    <i class="fas fa-link fa-4x text-success mb-3"></i>
                                    <h3>Загрузить видео по ссылке</h3>
                                    <p class="text-muted mt-3 mb-4">
                                        Поддерживаемые платформы: YouTube, Vimeo, RuTube, VK, OK.ru, Dailymotion и другие
                                    </p>
                                    
                                    <div class="row justify-content-center">
                                        <div class="col-md-8">
                                            <div class="input-group input-group-lg mb-3">
                                                <span class="input-group-text">
                                                    <i class="fas fa-link"></i>
                                                </span>
                                                <input type="url" class="form-control" id="video-url" name="video_url" 
                                                       placeholder="https://www.youtube.com/watch?v=..." required>
                                            </div>
                                            
                                            <div class="alert alert-info text-start">
                                                <h6><i class="fas fa-info-circle me-2"></i>Ограничения:</h6>
                                                <ul class="mb-0">
                                                    <li>Максимальная длительность: 2 часа</li>
                                                    <li>Качество загрузки: до 720p</li>
                                                    <li>Время обработки: 3-7 минут</li>
                                                </ul>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-success btn-lg">
                                                <i class="fas fa-download me-2"></i>Загрузить и анализировать
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h6>Примеры поддерживаемых ссылок:</h6>
                                        <div class="row text-start">
                                            <div class="col-md-6">
                                                <small class="text-muted">
                                                    <i class="fab fa-youtube text-danger me-1"></i> YouTube:<br>
                                                    youtube.com/watch?v=...<br>
                                                    youtu.be/...
                                                </small>
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted">
                                                    <i class="fab fa-vimeo text-info me-1"></i> Vimeo:<br>
                                                    vimeo.com/...<br>
                                                    <i class="fas fa-globe me-1"></i> RuTube, VK, OK.ru
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- What's New Section -->
    <div class="mt-5">
        <h4 class="text-center mb-4">🚀 Что нового в Pro версии</h4>
        <div class="row">
            <div class="col-md-4">
                <div class="stats-card">
                    <i class="fas fa-brain fa-2x text-primary mb-2"></i>
                    <h5>Глубокий анализ</h5>
                    <p class="text-muted mb-0">10+ тем с подтемами и примерами</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <i class="fas fa-chart-line fa-2x text-success mb-2"></i>
                    <h5>Оценка качества</h5>
                    <p class="text-muted mb-0">4 метрики глубины анализа</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <i class="fas fa-sync fa-2x text-info mb-2"></i>
                    <h5>Spaced Repetition</h5>
                    <p class="text-muted mb-0">Алгоритм SuperMemo для карточек</p>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4 text-center text-muted">
        <p><i class="fas fa-magic me-2"></i>Обработка включает: иерархию тем, связи между концепциями, практические примеры</p>
        <p><i class="fas fa-clock me-2"></i>Глубокий анализ занимает 2-5 минут в зависимости от объема материала</p>
    </div>
</div>

<!-- Enhanced Processing Modal -->
<div class="modal fade" id="processingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="mb-4">
                    <div class="spinner-grow text-primary" role="status"></div>
                    <div class="spinner-grow text-success" role="status"></div>
                    <div class="spinner-grow text-info" role="status"></div>
                    <div class="spinner-grow text-warning" role="status"></div>
                </div>
                <h4>🧠 Проводим глубокий анализ с помощью ИИ</h4>
                <div class="mt-4">
                    <div class="text-start" style="max-width: 500px; margin: 0 auto;">
                        <p class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Извлечение текста...</p>
                        <p class="mb-2 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Анализ структуры и иерархии тем...</p>
                        <p class="mb-2 text-muted"><i class="far fa-circle me-2"></i>Генерация ментальной карты...</p>
                        <p class="mb-2 text-muted"><i class="far fa-circle me-2"></i>Создание умных флеш-карт...</p>
                        <p class="mb-2 text-muted"><i class="far fa-circle me-2"></i>Составление плана обучения...</p>
                    </div>
                </div>
                <div class="progress mt-4" style="height: 10px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-gradient" style="width: 100%"></div>
                </div>
                <p class="text-muted mt-3 mb-0">Это может занять 2-5 минут для глубокого анализа</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const uploadForm = document.getElementById('upload-form');
    const fileSelectedDiv = document.getElementById('file-selected');

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect();
        }
    });

    // Click to upload
    uploadArea.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON' && !e.target.closest('button')) {
            fileInput.click();
        }
    });

    // File selection
    fileInput.addEventListener('change', handleFileSelect);

    function handleFileSelect() {
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const fileName = file.name;
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            const fileExtension = fileName.split('.').pop().toLowerCase();
            
            // Show file info
            document.getElementById('file-name').textContent = fileName;
            document.getElementById('file-size').textContent = `Размер: ${fileSize} МБ`;
            
            // Show page selection only for PDF files
            const pageSelection = document.getElementById('page-selection');
            if (fileExtension === 'pdf') {
                pageSelection.style.display = 'block';
                
                // Set smart default based on file size (примерно 1 МБ = 20-30 страниц)
                const estimatedPages = Math.ceil(fileSize * 25); // Примерная оценка
                let defaultRange;
                
                if (estimatedPages <= 20) {
                    defaultRange = 'все';
                } else if (estimatedPages <= 50) {
                    defaultRange = '1-20';
                } else {
                    defaultRange = '1-20';
                }
                
                document.getElementById('page-range').value = defaultRange;
                
                // Update info text
                const infoText = document.querySelector('#page-selection .alert-info');
                if (estimatedPages > 30) {
                    infoText.innerHTML = `
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Рекомендация:</strong> Документ содержит примерно ${estimatedPages} страниц. 
                        Для оптимального качества анализа рекомендуется обрабатывать не более 20-30 страниц за раз.
                        Большие документы лучше разбивать на логические части.
                    `;
                } else {
                    infoText.innerHTML = `
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Информация:</strong> Документ содержит примерно ${estimatedPages} страниц. 
                        Вы можете обработать весь документ или выбрать конкретные разделы.
                    `;
                }
            } else {
                pageSelection.style.display = 'none';
            }
            
            // Hide upload area and show file selected
            uploadArea.style.display = 'none';
            fileSelectedDiv.style.display = 'block';
        }
    }

    function setPageRange(range) {
        document.getElementById('page-range').value = range;
        
        // Visual feedback
        const buttons = document.querySelectorAll('#page-selection .btn-outline-primary, #page-selection .btn-outline-secondary');
        buttons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.includes(range) || (range === 'все' && btn.textContent.includes('Все'))) {
                btn.classList.add('active');
            }
        });
    }

    function validatePageRange() {
        const pageRange = document.getElementById('page-range').value.trim();
        if (!pageRange) return true; // Empty is OK for video files
        
        // Allow "все" or "all"
        if (pageRange.toLowerCase() === 'все' || pageRange.toLowerCase() === 'all') {
            return true;
        }
        
        // Validate format: numbers, ranges, and commas
        const pattern = /^(\d+(-\d+)?)(\s*,\s*\d+(-\d+)?)*$/;
        if (!pattern.test(pageRange)) {
            alert('Неверный формат диапазона страниц. Используйте формат: "1-10", "5-25", "1-10,15-20" или "все"');
            return false;
        }
        
        return true;
    }

    function resetUpload() {
        fileInput.value = '';
        uploadArea.style.display = 'block';
        fileSelectedDiv.style.display = 'none';
    }

    // Show enhanced processing modal on form submit
    uploadForm.addEventListener('submit', (e) => {
        if (fileInput.files.length === 0) {
            e.preventDefault();
            alert('Пожалуйста, выберите файл');
            return false;
        }
        
        // Validate page range for PDF files
        if (!validatePageRange()) {
            e.preventDefault();
            return false;
        }
        
        showProcessingModal();
    });

    // URL form handling
    const urlForm = document.getElementById('url-form');
    urlForm.addEventListener('submit', (e) => {
        const videoUrl = document.getElementById('video-url').value.trim();
        
        if (!videoUrl) {
            e.preventDefault();
            alert('Пожалуйста, введите ссылку на видео');
            return false;
        }
        
        // Basic URL validation
        try {
            new URL(videoUrl);
        } catch {
            e.preventDefault();
            alert('Введите корректную ссылку на видео');
            return false;
        }
        
        showProcessingModal('video');
    });

    function showProcessingModal(type = 'file') {
        const modal = new bootstrap.Modal(document.getElementById('processingModal'));
        
        // Update modal content based on type
        if (type === 'video') {
            document.querySelector('#processingModal h4').innerHTML = '🎥 Загружаем и анализируем видео с помощью ИИ';
            document.querySelectorAll('.modal-body p')[0].innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Загрузка видео...';
            document.querySelectorAll('.modal-body p')[1].innerHTML = '<i class="far fa-circle me-2"></i>Извлечение аудио и транскрипция...';
            document.querySelector('.modal-body .text-muted:last-child').textContent = 'Это может занять 3-7 минут для загрузки и анализа видео';
        }
        
        modal.show();
        
        // Animate processing steps
        setTimeout(() => {
            if (type === 'video') {
                document.querySelectorAll('.modal-body p')[0].innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Загрузка видео...';
                document.querySelectorAll('.modal-body p')[1].innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Извлечение аудио и транскрипция...';
                document.querySelectorAll('.modal-body p')[2].innerHTML = '<i class="far fa-circle me-2"></i>Анализ структуры и иерархии тем...';
            } else {
                document.querySelectorAll('.modal-body p')[1].innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Анализ структуры и иерархии тем...';
                document.querySelectorAll('.modal-body p')[2].innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Генерация ментальной карты...';
            }
        }, 10000);
        
        setTimeout(() => {
            if (type === 'video') {
                document.querySelectorAll('.modal-body p')[1].innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Извлечение аудио и транскрипция...';
                document.querySelectorAll('.modal-body p')[2].innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Анализ структуры и иерархии тем...';
                document.querySelectorAll('.modal-body p')[3].innerHTML = '<i class="far fa-circle me-2"></i>Генерация ментальной карты...';
            } else {
                document.querySelectorAll('.modal-body p')[2].innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Генерация ментальной карты...';
                document.querySelectorAll('.modal-body p')[3].innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Создание умных флеш-карт...';
            }
        }, 20000);
        
        setTimeout(() => {
            if (type === 'video') {
                document.querySelectorAll('.modal-body p')[2].innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Анализ структуры и иерархии тем...';
                document.querySelectorAll('.modal-body p')[3].innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Генерация ментальной карты...';
                document.querySelectorAll('.modal-body p')[4].innerHTML = '<i class="far fa-circle me-2"></i>Создание умных флеш-карт...';
            } else {
                document.querySelectorAll('.modal-body p')[3].innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Создание умных флеш-карт...';
                document.querySelectorAll('.modal-body p')[4].innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Составление плана обучения...';
            }
        }, 30000);
    }
</script>
{% endblock %}