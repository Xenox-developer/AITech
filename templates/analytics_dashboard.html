{% extends "base.html" %}

{% block title %}Аналитика использования - AI-конспект{% endblock %}

{% block extra_styles %}
<style>
    .analytics-header {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        padding: 40px 0;
        border-radius: 20px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .analytics-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 10px;
    }
    
    .analytics-subtitle {
        opacity: 0.9;
        font-size: 1.1rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }
    
    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        border-left: 4px solid;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .stat-card.primary {
        border-left-color: #6366f1;
    }
    
    .stat-card.success {
        border-left-color: #10b981;
    }
    
    .stat-card.warning {
        border-left-color: #f59e0b;
    }
    
    .stat-card.info {
        border-left-color: #06b6d4;
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: white;
        margin-bottom: 16px;
    }
    
    .stat-icon.primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }
    
    .stat-icon.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .stat-icon.warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    .stat-icon.info {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 900;
        color: #1f2937;
        margin-bottom: 4px;
    }
    
    .stat-label {
        color: #6b7280;
        font-weight: 500;
    }
    
    .analytics-section {
        background: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .section-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1rem;
    }
    
    .filters-bar {
        display: flex;
        gap: 16px;
        margin-bottom: 30px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .filter-label {
        font-weight: 500;
        color: #374151;
    }
    
    .filter-select {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        background: white;
        color: #374151;
        font-size: 0.9rem;
    }
    
    .filter-select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .popular-elements-list {
        display: grid;
        gap: 16px;
    }
    
    .element-item {
        display: flex;
        align-items: center;
        padding: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    
    .element-item:hover {
        border-color: #6366f1;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.1);
        transform: translateY(-2px);
    }
    
    .element-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 16px;
        font-size: 1rem;
        color: white;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }
    
    .element-info {
        flex: 1;
    }
    
    .element-name {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 4px;
    }
    
    .element-meta {
        color: #6b7280;
        font-size: 0.85rem;
        display: flex;
        gap: 16px;
    }
    
    .element-stats {
        display: flex;
        gap: 16px;
        align-items: center;
    }
    
    .stat-badge {
        background: #f3f4f6;
        color: #374151;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .stat-badge.primary {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .stat-badge.success {
        background: #dcfce7;
        color: #166534;
    }
    
    .chart-container {
        height: 300px;
        margin-top: 20px;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f4f6;
        border-radius: 50%;
        border-top-color: #6366f1;
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 16px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6b7280;
    }
    
    .empty-icon {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    
    @media (max-width: 768px) {
        .analytics-title {
            font-size: 1.5rem;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .filters-bar {
            flex-direction: column;
            align-items: stretch;
        }
        
        .element-item {
            flex-direction: column;
            text-align: center;
        }
        
        .element-icon {
            margin-right: 0;
            margin-bottom: 12px;
        }
        
        .element-meta {
            justify-content: center;
        }
        
        .element-stats {
            justify-content: center;
            margin-top: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-header">
    <div class="container">
        <h1 class="analytics-title">
            <i class="fas fa-chart-bar me-3"></i>
            Аналитика использования
        </h1>
        <p class="analytics-subtitle">Статистика взаимодействий пользователей с элементами интерфейса</p>
    </div>
</div>

<div class="container">
    <!-- Общая статистика -->
    <div class="stats-grid" id="overallStats">
        <div class="stat-card primary">
            <div class="stat-icon primary">
                <i class="fas fa-mouse-pointer"></i>
            </div>
            <div class="stat-number" id="totalInteractions">-</div>
            <div class="stat-label">Всего взаимодействий</div>
        </div>
        
        <div class="stat-card success">
            <div class="stat-icon success">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-number" id="uniqueUsers">-</div>
            <div class="stat-label">Уникальных пользователей</div>
        </div>
        
        <div class="stat-card warning">
            <div class="stat-icon warning">
                <i class="fas fa-calendar-day"></i>
            </div>
            <div class="stat-number" id="activeDays">-</div>
            <div class="stat-label">Активных дней</div>
        </div>
        
        <div class="stat-card info">
            <div class="stat-icon info">
                <i class="fas fa-desktop"></i>
            </div>
            <div class="stat-number" id="uniqueSessions">-</div>
            <div class="stat-label">Уникальных сессий</div>
        </div>
    </div>
    
    <!-- Фильтры -->
    <div class="analytics-section">
        <div class="filters-bar">
            <div class="filter-group">
                <label class="filter-label">Период:</label>
                <select class="filter-select" id="periodFilter">
                    <option value="7">Последние 7 дней</option>
                    <option value="30" selected>Последние 30 дней</option>
                    <option value="90">Последние 90 дней</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Тип элемента:</label>
                <select class="filter-select" id="elementTypeFilter">
                    <option value="">Все типы</option>
                    <option value="button">Кнопки</option>
                    <option value="link">Ссылки</option>
                    <option value="form">Формы</option>
                    <option value="navigation">Навигация</option>
                    <option value="content">Контент</option>
                </select>
            </div>
            
            <button class="btn btn-primary" onclick="refreshAnalytics()">
                <i class="fas fa-sync-alt me-2"></i>Обновить
            </button>
        </div>
    </div>
    
    <!-- Популярные элементы -->
    <div class="analytics-section">
        <h2 class="section-title">
            <div class="section-icon">
                <i class="fas fa-fire"></i>
            </div>
            Самые популярные элементы
        </h2>
        
        <div id="popularElementsContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Загрузка данных...</p>
            </div>
        </div>
    </div>
    
    <!-- График активности по дням -->
    <div class="analytics-section">
        <h2 class="section-title">
            <div class="section-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            Активность по дням
        </h2>
        
        <div class="chart-container" id="dailyActivityChart">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Загрузка графика...</p>
            </div>
        </div>
    </div>
    
    <!-- Статистика по типам действий -->
    <div class="analytics-section">
        <h2 class="section-title">
            <div class="section-icon">
                <i class="fas fa-chart-pie"></i>
            </div>
            Типы взаимодействий
        </h2>
        
        <div class="chart-container" id="actionTypesChart">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Загрузка графика...</p>
            </div>
        </div>
    </div>
</div>

<script>
// Глобальные переменные
let currentPeriod = 30;
let currentElementType = '';

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics();
    
    // Обработчики фильтров
    document.getElementById('periodFilter').addEventListener('change', function() {
        currentPeriod = parseInt(this.value);
        loadAnalytics();
    });
    
    document.getElementById('elementTypeFilter').addEventListener('change', function() {
        currentElementType = this.value;
        loadAnalytics();
    });
});

// Загрузка аналитических данных
async function loadAnalytics() {
    try {
        // Загружаем общую статистику
        await loadOverallStats();
        
        // Загружаем популярные элементы
        await loadPopularElements();
        
        // Загружаем графики
        await loadDailyActivityChart();
        await loadActionTypesChart();
        
    } catch (error) {
        console.error('Error loading analytics:', error);
        showError('Ошибка загрузки данных аналитики');
    }
}

// Загрузка общей статистики
async function loadOverallStats() {
    try {
        const params = new URLSearchParams({
            days: currentPeriod,
            element_type: currentElementType
        });
        
        const response = await fetch(`/api/analytics/element_stats?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('totalInteractions').textContent = data.total_interactions || 0;
            document.getElementById('uniqueUsers').textContent = data.unique_users || 0;
            document.getElementById('activeDays').textContent = data.active_days || 0;
            document.getElementById('uniqueSessions').textContent = data.unique_sessions || 0;
        } else {
            throw new Error(data.error || 'Ошибка загрузки статистики');
        }
    } catch (error) {
        console.error('Error loading overall stats:', error);
    }
}

// Загрузка популярных элементов
async function loadPopularElements() {
    try {
        const params = new URLSearchParams({
            days: currentPeriod,
            limit: 20
        });
        
        const response = await fetch(`/api/analytics/popular_elements?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            renderPopularElements(data.popular_elements || []);
        } else {
            throw new Error(data.error || 'Ошибка загрузки популярных элементов');
        }
    } catch (error) {
        console.error('Error loading popular elements:', error);
        showError('Ошибка загрузки популярных элементов');
    }
}

// Отображение популярных элементов
function renderPopularElements(elements) {
    const container = document.getElementById('popularElementsContainer');
    
    if (elements.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h3>Нет данных</h3>
                <p>За выбранный период нет данных о взаимодействиях</p>
            </div>
        `;
        return;
    }
    
    const elementsHtml = elements.map((element, index) => {
        const iconClass = getElementIcon(element.element_type);
        const rank = index + 1;
        
        return `
            <div class="element-item">
                <div class="element-icon">
                    <i class="fas fa-${iconClass}"></i>
                </div>
                <div class="element-info">
                    <div class="element-name">
                        #${rank} ${element.element_type}.${element.element_id || 'unknown'}
                    </div>
                    <div class="element-meta">
                        <span>Действие: ${element.action_type}</span>
                    </div>
                </div>
                <div class="element-stats">
                    <div class="stat-badge primary">
                        ${element.total_interactions} взаимодействий
                    </div>
                    <div class="stat-badge success">
                        ${element.unique_users} пользователей
                    </div>
                    <div class="stat-badge">
                        ${element.unique_sessions} сессий
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `<div class="popular-elements-list">${elementsHtml}</div>`;
}

// Загрузка графика активности по дням
async function loadDailyActivityChart() {
    try {
        const params = new URLSearchParams({
            days: currentPeriod,
            element_type: currentElementType
        });
        
        const response = await fetch(`/api/analytics/element_stats?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            renderDailyActivityChart(data.daily_stats || []);
        } else {
            throw new Error(data.error || 'Ошибка загрузки данных графика');
        }
    } catch (error) {
        console.error('Error loading daily activity chart:', error);
        showError('Ошибка загрузки графика активности');
    }
}

// Отображение графика активности по дням
function renderDailyActivityChart(dailyStats) {
    const container = document.getElementById('dailyActivityChart');
    
    if (dailyStats.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h3>Нет данных</h3>
                <p>За выбранный период нет данных об активности</p>
            </div>
        `;
        return;
    }
    
    // Простая визуализация с помощью CSS
    const maxInteractions = Math.max(...dailyStats.map(d => d.interactions));
    
    const chartHtml = dailyStats.map(day => {
        const height = maxInteractions > 0 ? (day.interactions / maxInteractions) * 100 : 0;
        const date = new Date(day.date).toLocaleDateString('ru-RU', { 
            month: 'short', 
            day: 'numeric' 
        });
        
        return `
            <div style="display: inline-block; margin: 0 2px; text-align: center; vertical-align: bottom;">
                <div style="
                    width: 20px; 
                    height: ${height}%; 
                    max-height: 200px;
                    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); 
                    margin-bottom: 5px;
                    border-radius: 2px;
                    position: relative;
                " title="${day.interactions} взаимодействий, ${day.unique_users} пользователей"></div>
                <div style="font-size: 0.7rem; color: #6b7280; transform: rotate(-45deg); white-space: nowrap;">
                    ${date}
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div style="display: flex; align-items: end; justify-content: center; height: 250px; padding: 20px;">
            ${chartHtml}
        </div>
    `;
}

// Загрузка графика типов действий
async function loadActionTypesChart() {
    try {
        const params = new URLSearchParams({
            days: currentPeriod,
            element_type: currentElementType
        });
        
        const response = await fetch(`/api/analytics/element_stats?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            renderActionTypesChart(data.action_stats || []);
        } else {
            throw new Error(data.error || 'Ошибка загрузки данных графика');
        }
    } catch (error) {
        console.error('Error loading action types chart:', error);
        showError('Ошибка загрузки графика типов действий');
    }
}

// Отображение графика типов действий
function renderActionTypesChart(actionStats) {
    const container = document.getElementById('actionTypesChart');
    
    if (actionStats.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <h3>Нет данных</h3>
                <p>За выбранный период нет данных о типах действий</p>
            </div>
        `;
        return;
    }
    
    const total = actionStats.reduce((sum, action) => sum + action.interactions, 0);
    
    const chartHtml = actionStats.map((action, index) => {
        const percentage = total > 0 ? ((action.interactions / total) * 100).toFixed(1) : 0;
        const colors = ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4'];
        const color = colors[index % colors.length];
        
        return `
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                <div style="
                    width: 16px; 
                    height: 16px; 
                    background: ${color}; 
                    border-radius: 4px; 
                    margin-right: 12px;
                "></div>
                <div style="flex: 1;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="font-weight: 500;">${action.action_type}</span>
                        <span style="color: #6b7280;">${percentage}%</span>
                    </div>
                    <div style="
                        width: 100%; 
                        height: 8px; 
                        background: #f3f4f6; 
                        border-radius: 4px; 
                        overflow: hidden;
                    ">
                        <div style="
                            width: ${percentage}%; 
                            height: 100%; 
                            background: ${color};
                        "></div>
                    </div>
                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 2px;">
                        ${action.interactions} взаимодействий, ${action.unique_users} пользователей
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `<div style="padding: 20px;">${chartHtml}</div>`;
}

// Получение иконки для типа элемента
function getElementIcon(elementType) {
    const icons = {
        'button': 'hand-pointer',
        'link': 'link',
        'form': 'wpforms',
        'navigation': 'bars',
        'content': 'file-alt',
        'input': 'keyboard',
        'select': 'list',
        'checkbox': 'check-square',
        'radio': 'dot-circle'
    };
    
    return icons[elementType] || 'mouse-pointer';
}

// Обновление аналитики
function refreshAnalytics() {
    loadAnalytics();
}

// Показ ошибки
function showError(message) {
    console.error(message);
    // Можно добавить toast уведомление
}
</script>
{% endblock %}